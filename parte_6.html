
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6 - Os DAGs assombrados &amp; O Terror Causal &#8212; Statistical Rethinking</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="7 - Compasso de Ulisses" href="parte_7.html" />
    <link rel="prev" title="5 - Muitas VariÃ¡veis e os Waffles EspÃºrios" href="parte_5.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="capa.html">
   Estatistica Bayesiana
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_pt-BR.html">
   Intro - EstatÃ­stica Bayesiana (ðŸ‡§ðŸ‡·)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intro_en.html">
   Intro - Bayesian Statistics (ðŸ‡ºðŸ‡¸)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_1.html">
   1- IntroduÃ§Ã£o
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_2.html">
   2 - Engenharia de Golems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_3.html">
   3- Modelos GeocÃªntricos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_4.html">
   4 - FunÃ§Ãµes Wiggly
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_5.html">
   5 - Muitas VariÃ¡veis e os Waffles EspÃºrios
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   6 - Os DAGs assombrados &amp; O Terror Causal
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_7.html">
   7 - Compasso de Ulisses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_8.html">
   8 - Os peixes-bois condicionais
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_9.html">
   9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_10.html">
   10 - Grande Entropia e Modelos Lineares Generalizados
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_11.html">
   11 - A cravada de Deus e Inteiros
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_12.html">
   12 - Monstros e Misturas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_13.html">
   13 - Modelos com MemÃ³ria
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_14.html">
   14 - Aventuras na CovariÃ¢ncias
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/parte_6.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR/issues/new?title=Issue%20on%20page%20%2Fparte_6.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/rodolphomacedo/statistical_rethinking_pt_BR/main?urlpath=tree/parte_6.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rcode-6-1-pag-162">
   RCode 6.1 - Pag 162
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rcode-6-2-pag163">
   RCode 6.2 - pag163
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rcode-6-4-pag164">
   RCode 6.4 - pag164
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rcode-6-5-pag164">
   RCode 6.5 - pag164
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rcode-6-6-pag-165">
   RCode 6.6 - pag 165
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rcode-6-7-pag-166">
   RCode 6.7 - Pag 166
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-8">
   R Code 6.8
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-9-pag-167">
   R Code 6.9 - Pag 167
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-10-pag-167">
   R Code 6.10  -  pag 167
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-11-pag-168-figure-6-3">
   R Code 6.11 - Pag 168 - Figure 6.3
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-12-overthinking-rever">
   R Code 6.12 - Overthinking - Rever
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-13">
   R Code 6.13
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-14">
   R Code 6.14
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-15">
   R Code 6.15
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#rcode-6-16">
   RCode 6.16
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-17">
   R Code 6.17
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-18">
   R Code 6.18
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-19">
   R Code 6.19
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-6-20">
   R Code 6.20
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#collider-bias">
   Collider Bias
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     6.21
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-22">
     R Code 6.22
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-23">
     R Code 6.23
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-24">
     R Code 6.24
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rcode-6-25">
     RCode 6.25
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-26">
     R Code 6.26
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-27">
     R Code 6.27
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-28">
     R Code 6.28
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-29">
     R Code 6.29
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-30">
     R Code 6.30
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-6-31">
     R Code 6.31
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="os-dags-assombrados-o-terror-causal">
<h1>6 - Os DAGs assombrados &amp; O Terror Causal<a class="headerlink" href="#os-dags-assombrados-o-terror-causal" title="Permalink to this headline">Â¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">videpy</span> <span class="kn">import</span> <span class="n">Vide</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="c1"># from causalgraphicalmodels import CausalGraphicalModel</span>

<span class="kn">import</span> <span class="nn">stan</span>
<span class="kn">import</span> <span class="nn">nest_asyncio</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span>

<span class="c1"># To DAG&#39;s</span>
<span class="kn">import</span> <span class="nn">daft</span>
<span class="kn">from</span> <span class="nn">causalgraphicalmodels</span> <span class="kn">import</span> <span class="n">CausalGraphicalModel</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To running the stan in jupyter notebook</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="rcode-6-1-pag-162">
<h2>RCode 6.1 - Pag 162<a class="headerlink" href="#rcode-6-1-pag-162" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1914</span><span class="p">)</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">p</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="c1"># NÃ£o correlacionado noticiabilidade(newsworthiness) e confiabilidade(trustworthiness)</span>
<span class="n">nw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">tw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="c1"># Selecionando os 10% melhores</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">nw</span> <span class="o">+</span> <span class="n">tw</span>  <span class="c1"># Score total</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span>  <span class="c1"># Top 10% </span>
<span class="n">selected</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">s_i</span> <span class="o">&gt;=</span> <span class="n">q</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">s_i</span> <span class="ow">in</span> <span class="n">s</span> <span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Noticiabilidade(newsworthiness): </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nw</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Confiabilidade(trustworthiness):</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tw</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CorrelaÃ§Ã£o: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">tw</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="n">nw</span><span class="p">[</span><span class="n">selected</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Noticiabilidade(newsworthiness): 

 [ 0.82456357  1.85614543  0.85556981  1.4066898   1.6026727   1.42256068
  0.71166144  1.30222516  0.56454812  3.02039213  0.93879118  1.04202561
 -0.4640972   0.12272254  1.99579665  1.59807671  1.82853378  1.15394068
  1.48966066  1.22640255] 


Confiabilidade(trustworthiness):

 [ 1.24510334  1.29709756  2.10293057  0.66088341  1.76728533  0.64448519
  1.17598088  0.35356094  1.08805257 -0.72327249  1.31462133  1.54253157
  2.8128998   1.51862223  1.18048237  2.31948695 -0.09763283  0.87205345
  0.74979249  0.46329186] 


CorrelaÃ§Ã£o:  [19.93737242]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tw</span><span class="p">,</span> <span class="n">nw</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tw</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="n">nw</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Figure 6.1 - Pag162&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Noticiabilidade ($newsworthiness$)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Confiabilidade ($trustworthiness$)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_5_0.png" src="_images/parte_6_5_0.png" />
</div>
</div>
</div>
<div class="section" id="rcode-6-2-pag163">
<h2>RCode 6.2 - pag163<a class="headerlink" href="#rcode-6-2-pag163" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">909</span><span class="p">)</span>  <span class="c1"># Teste com outras sementes</span>

<span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>  <span class="n">N</span><span class="p">)</span>

<span class="n">leg_proportion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">leg_left</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">leg_proportion</span> <span class="o">*</span> <span class="n">height</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">leg_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">leg_proportion</span> <span class="o">*</span> <span class="n">height</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>


<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span> 
                   <span class="s1">&#39;leg_left&#39;</span><span class="p">:</span> <span class="n">leg_left</span><span class="p">,</span> 
                   <span class="s1">&#39;leg_right&#39;</span><span class="p">:</span> <span class="n">leg_right</span><span class="p">})</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>height</th>
      <th>leg_left</th>
      <th>leg_right</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>8.463728</td>
      <td>4.094675</td>
      <td>4.078446</td>
    </tr>
    <tr>
      <th>1</th>
      <td>9.854070</td>
      <td>4.776475</td>
      <td>4.687749</td>
    </tr>
    <tr>
      <th>2</th>
      <td>8.668694</td>
      <td>4.192607</td>
      <td>4.256472</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7.523768</td>
      <td>3.088674</td>
      <td>3.088206</td>
    </tr>
    <tr>
      <th>4</th>
      <td>9.381352</td>
      <td>4.093217</td>
      <td>4.048181</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">leg_right</span><span class="p">,</span> <span class="n">leg_left</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Dados dos legs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Leg Right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Leg Left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_8_0.png" src="_images/parte_6_8_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">leg_left</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">leg_right</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_9_0.png" src="_images/parte_6_9_0.png" />
<img alt="_images/parte_6_9_1.png" src="_images/parte_6_9_1.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int&lt;lower=0&gt; N;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">        vector[N] leg_left;</span>
<span class="s2">        vector[N] leg_right;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta_left;</span>
<span class="s2">        real beta_right;</span>
<span class="s2">        real&lt;lower=0&gt; sigma; </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(10, 100);</span>
<span class="s2">        beta_left ~ normal(2, 10);</span>
<span class="s2">        beta_right ~ normal(2, 10);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        height ~ normal(alpha + beta_left * leg_left + beta_right * leg_right, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
    <span class="s1">&#39;leg_left&#39;</span><span class="p">:</span> <span class="n">leg_left</span><span class="p">,</span>
    <span class="s1">&#39;leg_right&#39;</span><span class="p">:</span> <span class="n">leg_right</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_left</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;beta_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_right</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;beta_right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="rcode-6-4-pag164">
<h2>RCode 6.4 - pag164<a class="headerlink" href="#rcode-6-4-pag164" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.94</td>
      <td>0.33</td>
      <td>0.29</td>
      <td>1.48</td>
    </tr>
    <tr>
      <th>beta_left</th>
      <td>-1.38</td>
      <td>2.08</td>
      <td>-5.23</td>
      <td>2.34</td>
    </tr>
    <tr>
      <th>beta_right</th>
      <td>3.38</td>
      <td>2.06</td>
      <td>-0.21</td>
      <td>7.31</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.66</td>
      <td>0.05</td>
      <td>0.58</td>
      <td>0.74</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Leg right &amp; Leg left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_13_0.png" src="_images/parte_6_13_0.png" />
</div>
</div>
</div>
<div class="section" id="rcode-6-5-pag164">
<h2>RCode 6.5 - pag164<a class="headerlink" href="#rcode-6-5-pag164" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">beta_right</span><span class="p">,</span> <span class="n">beta_left</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori Beta legs&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Beta Right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Beta Left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_15_0.png" src="_images/parte_6_15_0.png" />
</div>
</div>
</div>
<div class="section" id="rcode-6-6-pag-165">
<h2>RCode 6.6 - pag 165<a class="headerlink" href="#rcode-6-6-pag-165" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">((</span><span class="n">beta_left</span> <span class="o">+</span> <span class="n">beta_right</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Soma de Beta_left e beta_right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Densidade&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_17_0.png" src="_images/parte_6_17_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ComparaÃ§Ã£o com os beta indivÃ­duais</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta_left</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>  <span class="c1"># Beta left</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta_right</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>  <span class="c1"># Beta Right</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Comparativo entre as Posterioris de Beta Left e Beta Right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Betas&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Densidade&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_18_0.png" src="_images/parte_6_18_0.png" />
</div>
</div>
</div>
<div class="section" id="rcode-6-7-pag-166">
<h2>RCode 6.7 - Pag 166<a class="headerlink" href="#rcode-6-7-pag-166" title="Permalink to this headline">Â¶</a></h2>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] leg_left;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta_left;</span>
<span class="s2">        real sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(10, 100);</span>
<span class="s2">        beta_left ~ normal(2, 10);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        height ~ normal(alpha + beta_left * leg_left, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">height</span><span class="p">),</span>
    <span class="s1">&#39;leg_left&#39;</span><span class="p">:</span> <span class="n">leg_left</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_left</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;beta_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RCode 6.7 - ContinuaÃ§Ã£o</span>
<span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.83</td>
      <td>0.33</td>
      <td>0.28</td>
      <td>1.43</td>
    </tr>
    <tr>
      <th>beta_left</th>
      <td>2.02</td>
      <td>0.07</td>
      <td>1.90</td>
      <td>2.14</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.67</td>
      <td>0.05</td>
      <td>0.58</td>
      <td>0.75</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Leg Left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_22_0.png" src="_images/parte_6_22_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-8">
<h2>R Code 6.8<a class="headerlink" href="#r-code-6-8" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/milk.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>

<span class="n">df_std</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">,</span> <span class="s1">&#39;perc.fat&#39;</span><span class="p">,</span> <span class="s1">&#39;perc.lactose&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.lactose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.lactose&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.lactose&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.lactose&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="n">df_std</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>kcal.per.g</th>
      <th>perc.fat</th>
      <th>perc.lactose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.940041</td>
      <td>-1.217243</td>
      <td>1.307262</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-0.816126</td>
      <td>-1.030355</td>
      <td>1.011285</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-1.125913</td>
      <td>-1.391531</td>
      <td>1.382679</td>
    </tr>
    <tr>
      <th>3</th>
      <td>-1.001998</td>
      <td>-1.335535</td>
      <td>1.586874</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-0.258511</td>
      <td>-0.469693</td>
      <td>0.257115</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NÃ£o tem nenhum &#39;missing values&#39;</span>

<span class="n">df_std</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>kcal.per.g      0
perc.fat        0
perc.lactose    0
dtype: int64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-6-9-pag-167">
<h2>R Code 6.9 - Pag 167<a class="headerlink" href="#r-code-6-9-pag-167" title="Permalink to this headline">Â¶</a></h2>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># kcal.per.g  regredido em perc.fat</span>

<span class="n">model_kf</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] outcome;</span>
<span class="s2">        vector[N] predictor;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(0, 0.2);</span>
<span class="s2">        beta ~ normal(0, 0.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        outcome ~ normal(alpha + beta * predictor, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data_kf</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;outcome&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="s1">&#39;predictor&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">posteriori_kf</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_kf</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kf</span><span class="p">)</span>
<span class="n">samples_kf</span> <span class="o">=</span> <span class="n">posteriori_kf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># kcal.per.g  regredido em  perc.lactose</span>

<span class="n">model_kl</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] outcome;</span>
<span class="s2">        vector[N] predictor;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(0, 0.2);</span>
<span class="s2">        beta ~ normal(0, 0.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        outcome ~ normal(alpha + beta * predictor, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data_kl</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;outcome&#39;</span><span class="p">:</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;predictor&#39;</span><span class="p">:</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.lactose&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_kl</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_kl</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kl</span><span class="p">)</span>
<span class="n">samples_kl</span> <span class="o">=</span> <span class="n">posteriori_kl</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples_kf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.00</td>
      <td>0.08</td>
      <td>-0.14</td>
      <td>0.16</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>0.86</td>
      <td>0.09</td>
      <td>0.68</td>
      <td>1.02</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.49</td>
      <td>0.07</td>
      <td>0.37</td>
      <td>0.62</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples_kf</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_30_0.png" src="_images/parte_6_30_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples_kl</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.00</td>
      <td>0.07</td>
      <td>-0.12</td>
      <td>0.14</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>-0.90</td>
      <td>0.08</td>
      <td>-1.05</td>
      <td>-0.77</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.41</td>
      <td>0.06</td>
      <td>0.31</td>
      <td>0.52</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples_kl</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;perc.lactose&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_32_0.png" src="_images/parte_6_32_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-10-pag-167">
<h2>R Code 6.10  -  pag 167<a class="headerlink" href="#r-code-6-10-pag-167" title="Permalink to this headline">Â¶</a></h2>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] F;  // Fat</span>
<span class="s2">        vector[N] L;  // Lactose</span>
<span class="s2">        vector[N] K;  // kcal/g</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real bF;</span>
<span class="s2">        real bL;</span>
<span class="s2">        real sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(0, 0.2);</span>
<span class="s2">        bF ~ normal(0, 0.5);</span>
<span class="s2">        bL ~ normal(0, 0.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        K ~ normal(alpha + bF*F + bL*L, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]),</span>
    <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;perc.lactose&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">df_std</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_FL</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples_FL</span> <span class="o">=</span> <span class="n">posteriori_FL</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples_FL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.00</td>
      <td>0.07</td>
      <td>-0.13</td>
      <td>0.12</td>
    </tr>
    <tr>
      <th>bF</th>
      <td>0.25</td>
      <td>0.19</td>
      <td>-0.11</td>
      <td>0.58</td>
    </tr>
    <tr>
      <th>bL</th>
      <td>-0.66</td>
      <td>0.19</td>
      <td>-1.00</td>
      <td>-0.31</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.41</td>
      <td>0.06</td>
      <td>0.31</td>
      <td>0.51</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples_FL</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Perc.Fat &amp; Perc.Lactose&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_36_0.png" src="_images/parte_6_36_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-11-pag-168-figure-6-3">
<h2>R Code 6.11 - Pag 168 - Figure 6.3<a class="headerlink" href="#r-code-6-11-pag-168-figure-6-3" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">scatter_matrix</span><span class="p">(</span><span class="n">df_std</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_38_0.png" src="_images/parte_6_38_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-12-overthinking-rever">
<h2>R Code 6.12 - Overthinking - Rever<a class="headerlink" href="#r-code-6-12-overthinking-rever" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] kcal_per_g;</span>
<span class="s2">        vector[N] perc_fat;</span>
<span class="s2">        vector[N] new_predictor_X;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real bF;</span>
<span class="s2">        real bX;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        kcal_per_g ~ normal(alpha + bF * perc_fat + bX * new_predictor_X, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_predictor_x</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
    <span class="n">mean</span> <span class="o">=</span> <span class="n">r</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># New Predictor X</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_data_dict</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;kcal_per_g&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;kcal.per.g&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;perc_fat&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;perc.fat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;new_predictor_X&#39;</span><span class="p">:</span> <span class="n">generate_predictor_x</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">adjust_model</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="mf">0.9</span><span class="p">):</span>
    
    <span class="n">parameter_mean_samples</span>  <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># In book running 100x</span>
        <span class="c1"># Runnning the model</span>
        <span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">generate_data_dict</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">))</span>
        <span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        <span class="c1"># Get parameter slope mean</span>
        <span class="n">parameter_mean_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;bF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
            
    <span class="k">return</span> <span class="n">parameter_mean_samples</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stddev</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">r_sequence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># In book using 0.01</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_sequence</span><span class="p">:</span>
    <span class="n">parameter</span> <span class="o">=</span> <span class="n">adjust_model</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
    <span class="n">stddev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">parameter</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_sequence</span><span class="p">,</span> <span class="n">stddev</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;correlation&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;stddev&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_45_0.png" src="_images/parte_6_45_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-13">
<h2>R Code 6.13<a class="headerlink" href="#r-code-6-13" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="c1"># Quantidade de plantas</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># SimulaÃ§Ã£o inicial das alturas</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="c1"># Atribuindo tratamentos e simulando fungos e tratamentos</span>
<span class="n">treatment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="n">fungus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">treatment</span><span class="o">*</span><span class="mf">0.4</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">h1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">fungus</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="c1"># Dataframe</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;h0&#39;</span><span class="p">:</span> <span class="n">h0</span><span class="p">,</span> 
                            <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span> 
                            <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="n">treatment</span><span class="p">,</span> 
                            <span class="s1">&#39;fungus&#39;</span><span class="p">:</span> <span class="n">fungus</span><span class="p">})</span>
<span class="n">d</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>h0</th>
      <td>100.0</td>
      <td>9.782726</td>
      <td>2.138707</td>
      <td>4.168524</td>
      <td>8.279903</td>
      <td>9.642072</td>
      <td>11.353860</td>
      <td>14.316299</td>
    </tr>
    <tr>
      <th>h1</th>
      <td>100.0</td>
      <td>14.209396</td>
      <td>2.766929</td>
      <td>6.881795</td>
      <td>12.512818</td>
      <td>14.190085</td>
      <td>15.688766</td>
      <td>20.786965</td>
    </tr>
    <tr>
      <th>treatment</th>
      <td>100.0</td>
      <td>0.500000</td>
      <td>0.502519</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.500000</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>fungus</th>
      <td>100.0</td>
      <td>0.270000</td>
      <td>0.446196</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-6-14">
<h2>R Code 6.14<a class="headerlink" href="#r-code-6-14" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sim_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e4</span><span class="p">))</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">sim_p</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sim_p&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sim_p</th>
      <td>10000.0</td>
      <td>1.02366</td>
      <td>0.259148</td>
      <td>0.391611</td>
      <td>0.83898</td>
      <td>0.993265</td>
      <td>1.174575</td>
      <td>2.781105</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-6-15">
<h2>R Code 6.15<a class="headerlink" href="#r-code-6-15" title="Permalink to this headline">Â¶</a></h2>
<p>Modelo:</p>
<div class="math notranslate nohighlight">
\[ h_{1,i} \sim Normal(\mu_i, \sigma) \]</div>
<div class="math notranslate nohighlight">
\[ \mu_i = h_{0, i} \times p \]</div>
<p>Prioris:</p>
<div class="math notranslate nohighlight">
\[ p \sim LogNormal(0, 0.25) \]</div>
<div class="math notranslate nohighlight">
\[ sigma \sim Exponential(1) \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N; </span>
<span class="s2">        vector[N] h1;</span>
<span class="s2">        vector[N] h0;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; p;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">        </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        mu = h0 * p;</span>
<span class="s2">        </span>
<span class="s2">        h1 ~ normal(mu, sigma);</span>
<span class="s2">        </span>
<span class="s2">        // Prioris</span>
<span class="s2">        p ~ lognormal(0, 0.25);</span>
<span class="s2">        sigma ~ exponential(1); </span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span>
    <span class="s1">&#39;h0&#39;</span><span class="p">:</span> <span class="n">h0</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>p</th>
      <td>1.43</td>
      <td>0.02</td>
      <td>1.40</td>
      <td>1.46</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.99</td>
      <td>0.15</td>
      <td>1.72</td>
      <td>2.25</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="rcode-6-16">
<h2>RCode 6.16<a class="headerlink" href="#rcode-6-16" title="Permalink to this headline">Â¶</a></h2>
<p>Modelo <em>post-treatment bias</em>:</p>
<div class="math notranslate nohighlight">
\[ h_{1, i} \sim Normal(\mu_i, \sigma) \]</div>
<div class="math notranslate nohighlight">
\[ \mu_i = h_{0, i} \times p \]</div>
<div class="math notranslate nohighlight">
\[ p = \alpha + \beta_T T_i + \beta_F F_i \]</div>
<p>prioris:</p>
<div class="math notranslate nohighlight">
\[ \alpha \sim LogNormal(0, 0.25) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_T \sim Normal(0, 0.5) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_F \sim Normal(0, 0.5) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma \sim Exponential(1) \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">To mu definition below</span>
<span class="sd">----------------------</span>

<span class="sd">vector[N] a;</span>
<span class="sd">vector[N] b;</span>
<span class="sd">vector[N] c; </span>

<span class="sd">These operation:</span>
<span class="sd">c = a .* b;</span>

<span class="sd">Is the same operation:</span>
<span class="sd">for (n in 1:N) {</span>
<span class="sd">  c[n] = a[n] * b[n];</span>
<span class="sd">}</span>

<span class="sd">Reference:</span>
<span class="sd">https://mc-stan.org/docs/reference-manual/arithmetic-expressions.html</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] h0;</span>
<span class="s2">        vector[N] h1;</span>
<span class="s2">        vector[N] T;  // Treatment</span>
<span class="s2">        vector[N] F;  // Fungus</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real bT;</span>
<span class="s2">        real bF;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        p = alpha + bT * T + bF * F;</span>
<span class="s2">        mu = h0 .* p;  </span>
<span class="s2">    </span>
<span class="s2">        // likelihood</span>
<span class="s2">        h1 ~ normal(mu, sigma);</span>
<span class="s2">    </span>
<span class="s2">        // prioris</span>
<span class="s2">        alpha ~ lognormal(0, 0.25);</span>
<span class="s2">        bT ~ normal(0, 0.5);</span>
<span class="s2">        bF ~ normal(0, 0.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;h0&#39;</span><span class="p">:</span> <span class="n">h0</span><span class="p">,</span>
    <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">treatment</span><span class="p">,</span>
    <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">fungus</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>1.53</td>
      <td>0.03</td>
      <td>1.48</td>
      <td>1.59</td>
    </tr>
    <tr>
      <th>bT</th>
      <td>-0.03</td>
      <td>0.04</td>
      <td>-0.09</td>
      <td>0.03</td>
    </tr>
    <tr>
      <th>bF</th>
      <td>-0.32</td>
      <td>0.04</td>
      <td>-0.39</td>
      <td>-0.25</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.44</td>
      <td>0.11</td>
      <td>1.26</td>
      <td>1.64</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Treatment and Fungus&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_58_0.png" src="_images/parte_6_58_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-17">
<h2>R Code 6.17<a class="headerlink" href="#r-code-6-17" title="Permalink to this headline">Â¶</a></h2>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] h0;</span>
<span class="s2">        vector[N] h1;</span>
<span class="s2">        vector[N] T;  // Treatment</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; alpha;</span>
<span class="s2">        real bT;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        vector[N] p;</span>

<span class="s2">        p = alpha + bT * T;</span>
<span class="s2">        mu = h0 .* p;</span>

<span class="s2">        h1 ~ normal(mu, sigma);</span>

<span class="s2">        alpha ~ lognormal(0, 0.2);</span>
<span class="s2">        bT ~ normal(0, 0.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;h0&#39;</span><span class="p">:</span> <span class="n">h0</span><span class="p">,</span>
    <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">treatment</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>1.36</td>
      <td>0.03</td>
      <td>1.31</td>
      <td>1.41</td>
    </tr>
    <tr>
      <th>bT</th>
      <td>0.13</td>
      <td>0.04</td>
      <td>0.06</td>
      <td>0.20</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.89</td>
      <td>0.14</td>
      <td>1.65</td>
      <td>2.14</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Treatment without fungus&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_62_0.png" src="_images/parte_6_62_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-18">
<h2>R Code 6.18<a class="headerlink" href="#r-code-6-18" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;$H_0$&#39;</span><span class="p">,</span> 
         <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;$H_1$&#39;</span><span class="p">,</span> 
         <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> 
         <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;T&#39;</span><span class="p">}</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">edges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
         <span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
         <span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>

<span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>

<span class="c1"># explicitly set positions</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
       <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
       <span class="n">nodes</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
       <span class="n">nodes</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>

<span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;font_size&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
    <span class="s2">&quot;node_size&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
    <span class="s2">&quot;node_color&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="s2">&quot;edgecolors&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linewidths&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>

<span class="c1"># Set margins for the axes so that nodes aren&#39;t clipped</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="c1"># ax.margins(0.01)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_64_0.png" src="_images/parte_6_64_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-19">
<h2>R Code 6.19<a class="headerlink" href="#r-code-6-19" title="Permalink to this headline">Â¶</a></h2>
<div class="math notranslate nohighlight">
\[F \_||\_ H_0\]</div>
<div class="math notranslate nohighlight">
\[H_0 \_||\_ T\]</div>
<div class="math notranslate nohighlight">
\[ H_1 \_||\_ T | F \]</div>
</div>
<div class="section" id="r-code-6-20">
<h2>R Code 6.20<a class="headerlink" href="#r-code-6-20" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># np.random.seed(3)</span>

<span class="c1"># Quantidade de plantas</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># SimulaÃ§Ã£o inicial das alturas</span>
<span class="n">h0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="c1"># Atribuindo tratamentos e simulando fungos e tratamentos</span>
<span class="n">treatment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>

<span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>  <span class="c1"># Moisture -&gt; Bernoulli(p=0.5)</span>

<span class="n">fungus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">treatment</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span> <span class="mf">0.4</span> <span class="o">*</span> <span class="n">M</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">h1</span> <span class="o">=</span> <span class="n">h0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((</span><span class="mi">5</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">M</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="c1"># Dataframe</span>
<span class="n">d2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;h0&#39;</span><span class="p">:</span> <span class="n">h0</span><span class="p">,</span> 
                            <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">h1</span><span class="p">,</span> 
                            <span class="s1">&#39;treatment&#39;</span><span class="p">:</span> <span class="n">treatment</span><span class="p">,</span> 
                            <span class="s1">&#39;fungus&#39;</span><span class="p">:</span> <span class="n">fungus</span><span class="p">})</span>
<span class="n">d2</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">T</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>h0</th>
      <td>100.0</td>
      <td>10.091610</td>
      <td>1.976358</td>
      <td>6.313914</td>
      <td>8.850678</td>
      <td>10.169278</td>
      <td>11.369749</td>
      <td>15.273222</td>
    </tr>
    <tr>
      <th>h1</th>
      <td>100.0</td>
      <td>16.510702</td>
      <td>2.715874</td>
      <td>10.105379</td>
      <td>14.711143</td>
      <td>15.899131</td>
      <td>18.671828</td>
      <td>22.662508</td>
    </tr>
    <tr>
      <th>treatment</th>
      <td>100.0</td>
      <td>0.500000</td>
      <td>0.502519</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.500000</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>fungus</th>
      <td>100.0</td>
      <td>0.480000</td>
      <td>0.502117</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>0.000000</td>
      <td>1.000000</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RCode 6.17 with new database</span>

<span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] h0;</span>
<span class="s2">        vector[N] h1;</span>
<span class="s2">        vector[N] T;  // Treatment</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; alpha;</span>
<span class="s2">        real bT;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        vector[N] p;</span>

<span class="s2">        p = alpha + bT * T;</span>
<span class="s2">        mu = h0 .* p;</span>

<span class="s2">        h1 ~ normal(mu, sigma);</span>

<span class="s2">        alpha ~ lognormal(0, 0.2);</span>
<span class="s2">        bT ~ normal(0, 0.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;h0&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="o">.</span><span class="n">h0</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="o">.</span><span class="n">treatment</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>1.60</td>
      <td>0.03</td>
      <td>1.55</td>
      <td>1.65</td>
    </tr>
    <tr>
      <th>bT</th>
      <td>0.02</td>
      <td>0.04</td>
      <td>-0.05</td>
      <td>0.09</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>2.16</td>
      <td>0.15</td>
      <td>1.87</td>
      <td>2.43</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Only Treatment using d2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_71_0.png" src="_images/parte_6_71_0.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RCode 6.16 with new database</span>

<span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] h0;</span>
<span class="s2">        vector[N] h1;</span>
<span class="s2">        vector[N] T;  // Treatment</span>
<span class="s2">        vector[N] F;  // Fungus</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real bT;</span>
<span class="s2">        real bF;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        p = alpha + bT * T + bF * F;</span>
<span class="s2">        mu = h0 .* p;  </span>
<span class="s2">    </span>
<span class="s2">        // likelihood</span>
<span class="s2">        h1 ~ normal(mu, sigma);</span>
<span class="s2">    </span>
<span class="s2">        // prioris</span>
<span class="s2">        alpha ~ lognormal(0, 0.25);</span>
<span class="s2">        bT ~ normal(0, 0.5);</span>
<span class="s2">        bF ~ normal(0, 0.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;h0&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="o">.</span><span class="n">h0</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;h1&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="o">.</span><span class="n">h1</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="o">.</span><span class="n">treatment</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;F&#39;</span><span class="p">:</span> <span class="n">d2</span><span class="o">.</span><span class="n">fungus</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>1.53</td>
      <td>0.04</td>
      <td>1.46</td>
      <td>1.60</td>
    </tr>
    <tr>
      <th>bT</th>
      <td>0.06</td>
      <td>0.04</td>
      <td>-0.02</td>
      <td>0.14</td>
    </tr>
    <tr>
      <th>bF</th>
      <td>0.11</td>
      <td>0.04</td>
      <td>0.03</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>2.10</td>
      <td>0.15</td>
      <td>1.83</td>
      <td>2.36</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Treatments and Fungus&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_74_0.png" src="_images/parte_6_74_0.png" />
</div>
</div>
</div>
<div class="section" id="collider-bias">
<h2>Collider Bias<a class="headerlink" href="#collider-bias" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="id1">
<h3>6.21<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h3>
<p><strong>SimulaÃ§Ã£o</strong></p>
<ol class="simple">
<li><p>Cada ano, <span class="math notranslate nohighlight">\(20\)</span> pessoas nascem com valores de felicidade uniformente distribuÃ­dos</p></li>
<li><p>Cada ano, cada uma das pessoas envelhece <span class="math notranslate nohighlight">\(1\)</span> ano. A sua felicidade nÃ£o muda.</p></li>
<li><p>Aos <span class="math notranslate nohighlight">\(18\)</span> anos, um indivÃ­duo de casa com a probabilidade de porporcional a sua felicidade.</p></li>
<li><p>Uma vez casado, o indivÃ­duo se mantÃ©m casado.</p></li>
<li><p>Aos 65 anos, o indivÃ­duo deixa a amostra (Vai morar na Espanha)</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function based in https://github.com/rmcelreath/rethinking/blob/master/R/sim_happiness.R</span>
<span class="c1"># Inv_logit R-function in https://stat.ethz.ch/R-manual/R-devel/library/boot/html/inv.logit.html</span>

<span class="k">def</span> <span class="nf">inv_logit</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">sim_happiness</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1977</span> <span class="p">,</span> <span class="n">N_years</span><span class="o">=</span><span class="mi">1000</span> <span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">65</span> <span class="p">,</span> <span class="n">N_births</span><span class="o">=</span><span class="mi">20</span> <span class="p">,</span> <span class="n">aom</span><span class="o">=</span><span class="mi">18</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;married&#39;</span><span class="p">,</span> <span class="s1">&#39;happiness&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_years</span><span class="p">):</span>
        <span class="c1"># Update age</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Move to Spain when age == max_age</span>
        <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">max_age</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1"># Will marry?</span>
        <span class="n">index_unmarried_aom</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;age&gt;=</span><span class="si">{</span><span class="n">aom</span><span class="si">}</span><span class="s1"> and married==0&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">weddings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_unmarried_aom</span><span class="p">,</span> <span class="s1">&#39;happiness&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index_unmarried_aom</span><span class="p">,</span> <span class="s1">&#39;married&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weddings</span>
        
        <span class="c1"># New borns</span>
        <span class="n">df_aux</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;married&#39;</span><span class="p">,</span> <span class="s1">&#39;happiness&#39;</span><span class="p">])</span>

        <span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_births</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;married&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_births</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df_aux</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;happiness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">N_births</span><span class="p">)</span>  <span class="c1"># np.random.uniform(0, 1, N_births)</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_aux</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">sim_happiness</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">1997</span><span class="p">,</span> <span class="n">N_years</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">(</span><span class="n">percentiles</span><span class="o">=</span><span class="p">[</span><span class="mf">0.055</span><span class="p">,</span> <span class="mf">0.945</span><span class="p">],</span> <span class="n">include</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>unique</th>
      <th>top</th>
      <th>freq</th>
      <th>mean</th>
      <th>std</th>
      <th>min</th>
      <th>5.5%</th>
      <th>50%</th>
      <th>94.5%</th>
      <th>max</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>age</th>
      <td>1300.0</td>
      <td>65.0</td>
      <td>64.0</td>
      <td>20.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>married</th>
      <td>1300.0</td>
      <td>2.0</td>
      <td>0.0</td>
      <td>950.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>happiness</th>
      <td>1300.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-8.335213e-17</td>
      <td>1.214421</td>
      <td>-2.0</td>
      <td>-1.789474</td>
      <td>-1.110223e-16</td>
      <td>1.789474</td>
      <td>2.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 6.21</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;white&#39;</span> <span class="k">if</span> <span class="n">is_married</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;blue&#39;</span> <span class="k">for</span> <span class="n">is_married</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">married</span> <span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">age</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">happiness</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;White - Unmarried   |    Blue - Married&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Happiness&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_80_0.png" src="_images/parte_6_80_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-22">
<h3>R Code 6.22<a class="headerlink" href="#r-code-6-22" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Only adults</span>
<span class="n">df2</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">age</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">65</span> <span class="o">-</span> <span class="mi">18</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-6-23">
<h3>R Code 6.23<a class="headerlink" href="#r-code-6-23" title="Permalink to this headline">Â¶</a></h3>
<p>Modelo:</p>
<div class="math notranslate nohighlight">
\[ happiness \sim Normal(\mu_i, \sigma) \]</div>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha_{_{MID}[i]} + \beta_A \times A_i \]</div>
<p>prioris:</p>
<div class="math notranslate nohighlight">
\[ \alpha_{_{MID}[i]} \sim Normal(0, 1)\]</div>
<div class="math notranslate nohighlight">
\[ \beta_A \sim Normal(0, 2) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma \sim Exponential(1); \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] age;</span>
<span class="s2">        vector[N] happiness;</span>
<span class="s2">        array[N] int married;  // Must be integer because this is index to alpha. </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[2] alpha;  // can also be written like this: real alpha[2] or array[2] int alpha;</span>
<span class="s2">        real beta_age;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = alpha[ married[i] ] + beta_age * age[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        happiness ~ normal(mu, sigma);</span>
<span class="s2">        </span>
<span class="s2">        // Prioris</span>
<span class="s2">        alpha ~ normal(0, 1);</span>
<span class="s2">        beta_age ~normal(0, 2);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">happiness</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">df2</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;happiness&#39;</span><span class="p">:</span> <span class="n">df2</span><span class="o">.</span><span class="n">happiness</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;married&#39;</span><span class="p">:</span> <span class="n">df2</span><span class="o">.</span><span class="n">married</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Because the index in stan starting with 1 </span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.19</td>
      <td>0.06</td>
      <td>-0.30</td>
      <td>-0.07</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>1.38</td>
      <td>0.09</td>
      <td>1.22</td>
      <td>1.53</td>
    </tr>
    <tr>
      <th>beta_age</th>
      <td>-0.81</td>
      <td>0.11</td>
      <td>-1.02</td>
      <td>-0.62</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.97</td>
      <td>0.02</td>
      <td>0.93</td>
      <td>1.02</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Married and Unmarried&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_87_0.png" src="_images/parte_6_87_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-24">
<h3>R Code 6.24<a class="headerlink" href="#r-code-6-24" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] age;</span>
<span class="s2">        vector[N] happiness;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta_age;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = alpha + beta_age * age[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        happiness ~ normal(mu, sigma);</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1);</span>
<span class="s2">        beta_age ~ normal(0, 2);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">happiness</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="s1">&#39;happiness&#39;</span><span class="p">:</span> <span class="n">df2</span><span class="o">.</span><span class="n">happiness</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="n">df2</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.00</td>
      <td>0.08</td>
      <td>-0.15</td>
      <td>0.14</td>
    </tr>
    <tr>
      <th>beta_age</th>
      <td>0.00</td>
      <td>0.14</td>
      <td>-0.23</td>
      <td>0.27</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.22</td>
      <td>0.03</td>
      <td>1.17</td>
      <td>1.27</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Without married variable&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_91_0.png" src="_images/parte_6_91_0.png" />
</div>
</div>
</div>
<div class="section" id="rcode-6-25">
<h3>RCode 6.25<a class="headerlink" href="#rcode-6-25" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">200</span>  <span class="c1"># Qty of triads  (G, P, C)</span>

<span class="n">b_GP</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Direct effect of G on P </span>
<span class="n">b_GC</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Direct effect of G on C</span>
<span class="n">b_PC</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Direct effect of P on C</span>
<span class="n">b_U</span>  <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Direct effect of U on  P and C</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-6-26">
<h3>R Code 6.26<a class="headerlink" href="#r-code-6-26" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">U</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># {-1, 1}</span>
<span class="c1"># U = np.random.normal(0, 1, N)  # Simulation more realistic example </span>

<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>  <span class="c1"># Has not influence</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">b_GP</span><span class="o">*</span><span class="n">G</span> <span class="o">+</span> <span class="n">b_U</span><span class="o">*</span><span class="n">U</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">b_PC</span><span class="o">*</span><span class="n">P</span> <span class="o">+</span> <span class="n">b_GC</span><span class="o">*</span><span class="n">G</span> <span class="o">+</span> <span class="n">b_U</span><span class="o">*</span><span class="n">U</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="n">C</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="n">P</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span><span class="n">G</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="n">U</span><span class="p">})</span>

<span class="n">d</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>C</th>
      <th>P</th>
      <th>G</th>
      <th>U</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.986995</td>
      <td>1.197787</td>
      <td>-0.795915</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5.715446</td>
      <td>3.573636</td>
      <td>0.072746</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-4.387763</td>
      <td>-3.131400</td>
      <td>-0.261240</td>
      <td>-1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.598454</td>
      <td>0.462321</td>
      <td>-1.298047</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>6.614388</td>
      <td>4.931193</td>
      <td>2.676112</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-6-27">
<h3>R Code 6.27<a class="headerlink" href="#r-code-6-27" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># C ~ P + G</span>

<span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] C;</span>
<span class="s2">        vector[N] P;</span>
<span class="s2">        vector[N] G;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real b_PC;</span>
<span class="s2">        real b_GC;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = alpha + b_PC*P[i] + b_GC*G[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        C ~ normal(mu, sigma);</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1);</span>
<span class="s2">        b_PC ~ normal(0, 1);</span>
<span class="s2">        b_GC ~ normal(0, 1);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.07</td>
      <td>0.10</td>
      <td>-0.10</td>
      <td>0.24</td>
    </tr>
    <tr>
      <th>b_PC</th>
      <td>1.77</td>
      <td>0.04</td>
      <td>1.70</td>
      <td>1.84</td>
    </tr>
    <tr>
      <th>b_GC</th>
      <td>-0.82</td>
      <td>0.10</td>
      <td>-1.01</td>
      <td>-0.65</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.33</td>
      <td>0.07</td>
      <td>1.20</td>
      <td>1.45</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_99_0.png" src="_images/parte_6_99_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Figure 6.5</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;black&#39;</span> <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;blue&#39;</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">U</span><span class="p">]</span>  <span class="c1"># Unobserved</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;b_GC&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">x</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Granparent Education (G)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;GranChild Education (C)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Educations - Bias Collider&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_100_0.png" src="_images/parte_6_100_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-28">
<h3>R Code 6.28<a class="headerlink" href="#r-code-6-28" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] C;</span>
<span class="s2">        vector[N] P;</span>
<span class="s2">        vector[N] G;</span>
<span class="s2">        vector[N] U;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real b_PC;</span>
<span class="s2">        real b_GC;</span>
<span class="s2">        real b_U;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = alpha + b_PC*P[i] + b_GC*G[i] + b_U*U[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        C ~ normal(mu, sigma);</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1);</span>
<span class="s2">        b_GC ~ normal(0, 1);</span>
<span class="s2">        b_PC ~ normal(0, 1);</span>
<span class="s2">        b_U  ~ normal(0, 1);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
    <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>7.0%</th>
      <th>93.0%</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.07</td>
      <td>0.07</td>
      <td>-0.06</td>
      <td>0.21</td>
    </tr>
    <tr>
      <th>b_PC</th>
      <td>1.00</td>
      <td>0.07</td>
      <td>0.86</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>b_GC</th>
      <td>-0.03</td>
      <td>0.10</td>
      <td>-0.22</td>
      <td>0.15</td>
    </tr>
    <tr>
      <th>b_U</th>
      <td>1.97</td>
      <td>0.17</td>
      <td>1.68</td>
      <td>2.27</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.02</td>
      <td>0.05</td>
      <td>0.93</td>
      <td>1.11</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Vide</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_104_0.png" src="_images/parte_6_104_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-6-29">
<h3>R Code 6.29<a class="headerlink" href="#r-code-6-29" title="Permalink to this headline">Â¶</a></h3>
<p>Reference: <a class="reference external" href="https://colab.research.google.com/github/ksachdeva/rethinking-tensorflow-probability/blob/master/notebooks/06_the_haunted_dag_and_the_causal_terror.ipynb#scrollTo=wyUj47f7-kLy"><em>ksachdeva</em></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_6_1</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;U&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;X&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;Y&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_6_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_6_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_106_0.png" src="_images/parte_6_106_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_adjustment_sets</span> <span class="o">=</span> <span class="n">dag_6_1</span><span class="o">.</span><span class="n">get_all_backdoor_adjustment_sets</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="p">{</span><span class="s2">&quot;U&quot;</span><span class="p">}:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>frozenset({&#39;C&#39;})
frozenset({&#39;A&#39;})
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-6-30">
<h3>R Code 6.30<a class="headerlink" href="#r-code-6-30" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_6_2</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;W&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;M&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;M&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Drawing the DAG</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;W&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;D&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_6_109_0.png" src="_images/parte_6_109_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># R Code 6.30</span>

<span class="n">all_adjustment_sets</span> <span class="o">=</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">get_all_backdoor_adjustment_sets</span><span class="p">(</span><span class="s2">&quot;W&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_adjustment_sets</span> <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>frozenset({&#39;A&#39;, &#39;M&#39;})
frozenset({&#39;S&#39;})
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-6-31">
<h3>R Code 6.31<a class="headerlink" href="#r-code-6-31" title="Permalink to this headline">Â¶</a></h3>
<p>Reference: <a class="reference external" href="https://github.com/fehiepsi/rethinking-numpyro/blob/master/notebooks/06_the_haunted_dag_and_the_causal_terror.ipynb"><em>Fehiepsi - Numpyro</em></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_independencies</span> <span class="o">=</span> <span class="n">dag_6_2</span><span class="o">.</span><span class="n">get_all_independence_relationships</span><span class="p">()</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">all_independencies</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">all_independencies</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">s</span>
    <span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;M&#39;, &#39;W&#39;, {&#39;S&#39;})
(&#39;W&#39;, &#39;A&#39;, {&#39;S&#39;})
(&#39;S&#39;, &#39;D&#39;, {&#39;W&#39;, &#39;A&#39;, &#39;M&#39;})
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="parte_5.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">5 - Muitas VariÃ¡veis e os Waffles EspÃºrios</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="parte_7.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">7 - Compasso de Ulisses</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Rodolpho Macedo dos Santos<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>