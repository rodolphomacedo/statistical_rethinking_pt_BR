
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>11 - A cravada de Deus e Inteiros &#8212; Statistical Rethinking</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="12 - Monstros e Misturas" href="parte_12.html" />
    <link rel="prev" title="10 - Grande Entropia e Modelos Lineares Generalizados" href="parte_10.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="capa.html">
   Estatistica Bayesiana
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_pt-BR.html">
   Intro - Estatística Bayesiana (🇧🇷)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intro_en.html">
   Intro - Bayesian Statistics (🇺🇸)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_1.html">
   1- Introdução
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_2.html">
   2 - Engenharia de Golems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_3.html">
   3- Modelos Geocêntricos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_4.html">
   4 - Funções Wiggly
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_5.html">
   5 - Muitas Variáveis e os Waffles Espúrios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_6.html">
   6 - Os DAGs assombrados &amp; O Terror Causal
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_7.html">
   7 - Compasso de Ulisses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_8.html">
   8 - Os peixes-bois condicionais
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_9.html">
   9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_10.html">
   10 - Grande Entropia e Modelos Lineares Generalizados
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   11 - A cravada de Deus e Inteiros
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_12.html">
   12 - Monstros e Misturas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_13.html">
   13 - Modelos com Memória
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_14.html">
   14 - Aventuras na Covariâncias
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/parte_11.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR/issues/new?title=Issue%20on%20page%20%2Fparte_11.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/rodolphomacedo/statistical_rethinking_pt_BR/main?urlpath=tree/parte_11.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-1">
   R Code 11.1
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-2">
   R Code 11.2
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-3">
   R Code 11.3
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-4">
   R Code 11.4
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-5">
   R Code 11.5
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-6">
   R Code 11.6
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-7">
   R Code 11.7
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-8">
   R Code 11.8
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-9">
   R Code 11.9
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-10">
   R Code 11.10
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-11">
   R Code 11.11
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-12">
   R Code 11.12
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-13">
   R Code 11.13
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-8-14">
   R Code 8.14
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-15">
   R Code 11.15
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-16-and-r-code-11-17">
   R Code 11.16 and R Code 11.17
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-18">
   R Code 11.18
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-19">
   R Code 11.19
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-21">
   R Code 11.21
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-22">
   R Code 11.22
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-23">
   R Code 11.23
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-24">
   R Code 11.24
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-25">
   R Code 11.25
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-26">
   R Code 11.26
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-27">
   R Code 11.27
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#my-tests">
   My Tests
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-28">
   R Code 11.28
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-29">
   R Code 11.29
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-30">
   R Code 11.30
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-31">
   R Code 11.31
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-32">
   R Code 11.32
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#r-code-11-33">
   R Code 11.33
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#poisson-regression">
   Poisson Regression
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-35">
     R Code 11.35
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-36">
     R Code 11.36
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-37">
     R Code 11.37
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#model-poisson-regression">
       Model - Poisson Regression
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-38">
     R Code 11.38
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-39">
     R Code 11.39
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-40">
     R Code 11.40
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-41">
     R Code 11.41
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-42">
     R Code 11.42
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-43">
     R Code 11.43
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-44">
     R Code 11.44
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#curiosidade-do-python">
       Curiosidade do python
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-45">
     R Code 11.45
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#model">
       Model:
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Model:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-46">
     R Code 11.46
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-47">
     R Code 11.47
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-48">
     R Code 11.48
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-49-overthinking-modeling-tool-innovation-pg-356">
     R Code 11.49 - Overthinking: Modeling tool innovation - Pg 356
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-exposure-and-the-offset">
   Example: Exposure and the offset:
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-50">
     R Code 11.50
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-51">
     R Code 11.51
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-52">
     R Code 11.52
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     R Code 11.52
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-54">
     R Code 11.54
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#predictors-matched-to-outcomes">
   Predictors matched to outcomes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-55">
     R Code 11.55
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-56">
     R Code 11.56
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-57">
     R Code 11.57
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-58">
     R Code 11.58
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#predictors-matched-to-observations-pg-362">
   Predictors Matched to observations (pg 362)
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-59">
     R Code 11.59
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multinomial-disguise-as-poisson">
   Multinomial disguise as Poisson
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-60">
     R Code 11.60
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-62">
     R Code 11.62
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-11-63">
     R Code 11.63
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="a-cravada-de-deus-e-inteiros">
<h1>11 - A cravada de Deus e Inteiros<a class="headerlink" href="#a-cravada-de-deus-e-inteiros" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="c1"># from causalgraphicalmodels import CausalGraphicalModel</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="c1"># ArviZ ships with style sheets!</span>
<span class="c1"># https://python.arviz.org/en/stable/examples/styles.html#example-styles</span>
<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">import</span> <span class="nn">stan</span>
<span class="kn">import</span> <span class="nn">nest_asyncio</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span>

<span class="c1"># To DAG&#39;s</span>
<span class="kn">import</span> <span class="nn">daft</span>
<span class="kn">from</span> <span class="nn">causalgraphicalmodels</span> <span class="kn">import</span> <span class="n">CausalGraphicalModel</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add fonts to matplotlib to run xkcd</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">font_manager</span>

<span class="n">font_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fonts/&quot;</span><span class="p">]</span>  <span class="c1"># The path to the custom font file.</span>
<span class="n">font_files</span> <span class="o">=</span> <span class="n">font_manager</span><span class="o">.</span><span class="n">findSystemFonts</span><span class="p">(</span><span class="n">fontpaths</span><span class="o">=</span><span class="n">font_dirs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">font_file</span> <span class="ow">in</span> <span class="n">font_files</span><span class="p">:</span>
    <span class="n">font_manager</span><span class="o">.</span><span class="n">fontManager</span><span class="o">.</span><span class="n">addfont</span><span class="p">(</span><span class="n">font_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To make plots like drawing </span>
<span class="c1"># plt.xkcd()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To running the stan in jupyter notebook</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="r-code-11-1">
<h2>R Code 11.1<a class="headerlink" href="#r-code-11-1" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/chimpanzees.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pulled_left:</span></code> Outcome <span class="math notranslate nohighlight">\({0, 1}\)</span> - indicator if the animal pulled the left-hand lever.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prosoc_left:</span></code> Predict <span class="math notranslate nohighlight">\({0, 1}\)</span> - Indicator if left-hand lever was(1) or not(0) the prosocial options.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">condition:</span></code> Predict <span class="math notranslate nohighlight">\({0, 1}\)</span> - Indicator if there is a partner (1) or not (0) in the end table.</p></li>
</ul>
</div>
<div class="section" id="r-code-11-2">
<h2>R Code 11.2<a class="headerlink" href="#r-code-11-2" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prosoc_left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<ul class="simple">
<li><p>treatment= <span class="math notranslate nohighlight">\(1\)</span>: prosoc_left = <span class="math notranslate nohighlight">\(0\)</span> and contition= <span class="math notranslate nohighlight">\(0\)</span>: Two food items on <strong>right</strong> and <strong>no partner</strong>.</p></li>
<li><p>treatment= <span class="math notranslate nohighlight">\(2\)</span>: prosoc_left = <span class="math notranslate nohighlight">\(1\)</span> and contition= <span class="math notranslate nohighlight">\(0\)</span>: Two food items on <strong>left</strong> and <strong>no partner</strong>.</p></li>
<li><p>treatment= <span class="math notranslate nohighlight">\(3\)</span>: prosoc_left = <span class="math notranslate nohighlight">\(0\)</span> and contition= <span class="math notranslate nohighlight">\(1\)</span>: Two food items on <strong>right</strong> and <strong>has partner</strong>.</p></li>
<li><p>treatment= <span class="math notranslate nohighlight">\(4\)</span>: prosoc_left = <span class="math notranslate nohighlight">\(1\)</span> and contition= <span class="math notranslate nohighlight">\(1\)</span>: Two food items on <strong>left</strong> and <strong>has partner</strong>.</p></li>
</ul>
</div>
<div class="section" id="r-code-11-3">
<h2>R Code 11.3<a class="headerlink" href="#r-code-11-3" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">([</span><span class="s1">&#39;prosoc_left&#39;</span><span class="p">,</span> <span class="s1">&#39;condition&#39;</span><span class="p">],</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">margins</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>condition</th>
      <th>prosoc_left</th>
    </tr>
    <tr>
      <th>treatment</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>126</td>
      <td>126</td>
    </tr>
    <tr>
      <th>2</th>
      <td>126</td>
      <td>126</td>
    </tr>
    <tr>
      <th>3</th>
      <td>126</td>
      <td>126</td>
    </tr>
    <tr>
      <th>4</th>
      <td>126</td>
      <td>126</td>
    </tr>
    <tr>
      <th>All</th>
      <td>504</td>
      <td>504</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">logit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">inv_logit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="math notranslate nohighlight">
\[ L_i \sim Binomial(1, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{ACTOR[i]} + \beta_{TREATEMENT[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim \mbox{to be determined} \]</div>
<div class="math notranslate nohighlight">
\[ \beta_k \sim \mbox{to be determined} \]</div>
<p><strong>Entendimento:</strong>:</p>
<ul>
<li><p><strong>Likelihood</strong>:</p>
<p>Para esse caso os dados da resposta, <em>outcome</em>, são do tipo binários <span class="math notranslate nohighlight">\(0\)</span> ou <span class="math notranslate nohighlight">\(1\)</span>. A função de likelihood apropriada para esses caso é a <span class="math notranslate nohighlight">\(Bernoulli(p)\)</span>, ou no caso <span class="math notranslate nohighlight">\(Binomial(1, p)\)</span>.</p>
<p>Como <span class="math notranslate nohighlight">\(p\)</span> é uma probabilidade, está entre <span class="math notranslate nohighlight">\(0\)</span> e <span class="math notranslate nohighlight">\(1\)</span>, usamos uma <em>função de ligação</em> para <strong>transformar</strong> os resultados dos preditores para a escala de probabilidade. Nesse caso a função que faz essa transformação é:</p>
</li>
</ul>
<div class="math notranslate nohighlight">
\[ logit(p) = log(\frac{p}{1-p}) \]</div>
<ul>
<li><p><strong>Parameter <span class="math notranslate nohighlight">\(\alpha\)</span></strong>:</p>
<p>Na função de ligação o parâmetro <span class="math notranslate nohighlight">\(\alpha\)</span> é na verdade definido no modelo como um vetor (<em>vector</em>). O que estamos modelando aqui é que existe um parâmetro <span class="math notranslate nohighlight">\(\alpha\)</span> para cada chimpanzé, ou seja, para cada <em>actor</em>.</p>
<div class="math notranslate nohighlight">
\[ \alpha[1] := \mbox{ Para o chimpanzé } 1 \]</div>
<div class="math notranslate nohighlight">
\[ \alpha[2] := \mbox{ Para o chimpanzé } 2 \]</div>
<div class="math notranslate nohighlight">
\[ \alpha[3] := \mbox{ Para o chimpanzé } 3 \]</div>
<div class="math notranslate nohighlight">
\[ \alpha[4] := \mbox{ Para o chimpanzé } 4 \]</div>
<div class="math notranslate nohighlight">
\[ \alpha[5] := \mbox{ Para o chimpanzé } 5 \]</div>
<div class="math notranslate nohighlight">
\[ \alpha[6] := \mbox{ Para o chimpanzé } 6 \]</div>
<div class="math notranslate nohighlight">
\[ \alpha[7] := \mbox{ Para o chimpanzé } 7 \]</div>
<p>Cada um dos parâmetros <span class="math notranslate nohighlight">\(\alpha\)</span> tem um priori <span class="math notranslate nohighlight">\(Normal(\mu_i, \sigma_i)\)</span> e essas prioris são idênticas.</p>
<p>O que estamos inferindo com cada um desses <span class="math notranslate nohighlight">\(\alpha\)</span>’s é a localização (<span class="math notranslate nohighlight">\(\mu_i\)</span>) de cada uma das prioris e seu desvio padrão (<span class="math notranslate nohighlight">\(\sigma_i\)</span>)</p>
</li>
<li><p><strong>Parameter <span class="math notranslate nohighlight">\(\beta\)</span></strong>:</p>
<p>O <span class="math notranslate nohighlight">\(\beta\)</span> é a representação de um vetor de <span class="math notranslate nohighlight">\(\beta\)</span>’s que mapeiam cada um dos tratamentos:</p>
<div class="math notranslate nohighlight">
\[ \beta[1] := \mbox{ Para o tratamento } 1 \]</div>
<div class="math notranslate nohighlight">
\[ \beta[2] := \mbox{ Para o tratamento } 2 \]</div>
<div class="math notranslate nohighlight">
\[ \beta[3] := \mbox{ Para o tratamento } 3 \]</div>
<div class="math notranslate nohighlight">
\[ \beta[4] := \mbox{ Para o tratamento } 4 \]</div>
<p>No experimento existe uma hipóstese a ser testada: <strong>Os chimpanzés tendem a puxar mais a alavanca do lado pro-social quando tem um outro chimpanzé do outro lado da mesa</strong>, o <em>partner</em>?</p>
<p>Os <span class="math notranslate nohighlight">\(\alpha\)</span>’s são independentes entre eles, porém quando colocamos os <span class="math notranslate nohighlight">\(\beta\)</span>’s estamos medindo qual é a inteção conjunta dos chimpanzés em cada tratamento.</p>
<p>A variável tratamento (<em>treatment</em>) é a construção de uma <strong>variável sintética que indexa</strong> o conjunto de duas variáveis <em>{prosoc_left, condition}</em>, isto é, a <strong>interação</strong> entre elas. Então temos que a variável <span class="math notranslate nohighlight">\(treatment = 1\)</span> indica que o experimento foi realizado usando dois pratos com comida no lado direito e que não tinha parceiro.</p>
<p>Portando <span class="math notranslate nohighlight">\(\beta_{treatment = 1}\)</span> terá o valor do <em>efeito de todos os experimentos</em> que os chimpanzés fizeram nesse tipo de tratamento.</p>
</li>
</ul>
</div>
<div class="section" id="r-code-11-4">
<h2>R Code 11.4<a class="headerlink" href="#r-code-11-4" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight">
\[ L_i \sim Binomial(1, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha \]</div>
<div class="math notranslate nohighlight">
\[ \alpha \sim Normal(0, \omega) \]</div>
<p><span class="math notranslate nohighlight">\(\omega = 10\)</span> to start</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating data list to model</span>
<span class="n">data_list_partial</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">data_list_partial</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">data_list_partial</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">data_list_partial</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;pulled_left&#39;, &#39;actor&#39;, &#39;N&#39;, &#39;qty_chimpanzees&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_partial</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int pulled_left[N];</span>
<span class="s2">        int actor[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_chimpanzees] alpha;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        // Prioris</span>
<span class="s2">        alpha ~ normal(0, 10);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori_partial</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_partial</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list_partial</span><span class="p">)</span>
<span class="n">samples_partial</span> <span class="o">=</span> <span class="n">posteriori_partial</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples_partial</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.338</td>
      <td>0.238</td>
      <td>-0.688</td>
      <td>0.063</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3019.0</td>
      <td>1984.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>11.098</td>
      <td>5.205</td>
      <td>3.856</td>
      <td>18.170</td>
      <td>0.139</td>
      <td>0.107</td>
      <td>1828.0</td>
      <td>1409.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.636</td>
      <td>0.253</td>
      <td>-1.034</td>
      <td>-0.235</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3580.0</td>
      <td>2903.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.639</td>
      <td>0.251</td>
      <td>-1.040</td>
      <td>-0.246</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3621.0</td>
      <td>2664.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.338</td>
      <td>0.244</td>
      <td>-0.722</td>
      <td>0.066</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3560.0</td>
      <td>2618.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.579</td>
      <td>0.244</td>
      <td>0.208</td>
      <td>0.983</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3508.0</td>
      <td>2257.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>2.141</td>
      <td>0.392</td>
      <td>1.495</td>
      <td>2.730</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>3185.0</td>
      <td>2189.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples_partial</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori_partial</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples_partial</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-5">
<h2>R Code 11.5<a class="headerlink" href="#r-code-11-5" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># extract prior from quap</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">norm_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-6">
<h2>R Code 11.6<a class="headerlink" href="#r-code-11-6" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">norm_prior</span><span class="p">)</span>

<span class="n">omega</span> <span class="o">=</span> <span class="mf">1.5</span>

<span class="n">better_p</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="p">)</span> 

<span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">([</span><span class="n">p</span><span class="p">,</span> <span class="n">better_p</span><span class="p">],</span>
                <span class="n">data_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a~normal(0, 10)&#39;</span><span class="p">,</span> <span class="s1">&#39;a~normal(0, 1.5)&#39;</span><span class="p">],</span> 
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;prior prob pull left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_25_0.png" src="_images/parte_11_25_0.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_partial_better</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int pulled_left[N];</span>
<span class="s2">        int actor[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_chimpanzees] alpha;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        // Prioris</span>
<span class="s2">        alpha ~ normal(0, 1.5);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori_partial_better</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_partial_better</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list_partial</span><span class="p">)</span>
<span class="n">samples_partial_better</span> <span class="o">=</span> <span class="n">posteriori_partial_better</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples_partial_better</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.335</td>
      <td>0.230</td>
      <td>-0.698</td>
      <td>0.027</td>
      <td>0.003</td>
      <td>0.003</td>
      <td>6221.0</td>
      <td>3145.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>3.926</td>
      <td>0.733</td>
      <td>2.836</td>
      <td>5.104</td>
      <td>0.011</td>
      <td>0.009</td>
      <td>4498.0</td>
      <td>2492.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.623</td>
      <td>0.247</td>
      <td>-1.039</td>
      <td>-0.242</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>7013.0</td>
      <td>2992.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.625</td>
      <td>0.254</td>
      <td>-1.036</td>
      <td>-0.229</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>6910.0</td>
      <td>3005.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.331</td>
      <td>0.232</td>
      <td>-0.695</td>
      <td>0.032</td>
      <td>0.003</td>
      <td>0.003</td>
      <td>6917.0</td>
      <td>2863.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.563</td>
      <td>0.243</td>
      <td>0.187</td>
      <td>0.954</td>
      <td>0.003</td>
      <td>0.003</td>
      <td>5784.0</td>
      <td>2874.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>2.009</td>
      <td>0.360</td>
      <td>1.436</td>
      <td>2.577</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>6087.0</td>
      <td>2897.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples_parcial_better</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples_partial_better</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-7">
<h2>R Code 11.7<a class="headerlink" href="#r-code-11-7" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight">
\[ L_i \sim Binomial(1, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{ACTOR[i]} + \beta_{TREATEMENT[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(0, 0.15) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_k \sim Normal(0, 10) \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># quap code to get priori</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-8">
<h2>R Code 11.8<a class="headerlink" href="#r-code-11-8" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>

<span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span> <span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">betas</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;prior diff between treatments&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_34_0.png" src="_images/parte_11_34_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-9">
<h2>R Code 11.9<a class="headerlink" href="#r-code-11-9" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight">
\[ L_i \sim Binomial(1, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{ACTOR[i]} + \beta_{TREATEMENT[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(0, 0.15) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_k \sim Normal(0, 0.5) \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">better_p</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>

<span class="n">better_p</span> <span class="o">=</span> <span class="p">[</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span> <span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">betas</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> 
        <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">better_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">better_p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="p">],</span> 
    <span class="n">data_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;b ~ normal(0, 10)&#39;</span><span class="p">,</span> <span class="s1">&#39;b ~ normal(0, 0.5)&#39;</span><span class="p">],</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;prior diff between treatments&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_38_0.png" src="_images/parte_11_38_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">better_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">better_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.10040888662896558
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the 4 prior</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">([</span>
        <span class="n">better_p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
        <span class="n">better_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
        <span class="n">better_p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> 
        <span class="n">better_p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
    <span class="p">],</span>
    <span class="n">data_labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;prior_1&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_2&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_3&#39;</span><span class="p">,</span> <span class="s1">&#39;prior_4&#39;</span><span class="p">],</span> 
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;prior diff between treatments&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_40_0.png" src="_images/parte_11_40_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-10">
<h2>R Code 11.10<a class="headerlink" href="#r-code-11-10" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;qty_treatment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">treatment</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">data_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;pulled_left&#39;, &#39;actor&#39;, &#39;treatment&#39;, &#39;N&#39;, &#39;qty_chimpanzees&#39;, &#39;qty_treatment&#39;])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-11">
<h2>R Code 11.11<a class="headerlink" href="#r-code-11-11" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int qty_treatment;</span>
<span class="s2">        int pulled_left[N];</span>
<span class="s2">        int actor[N];</span>
<span class="s2">        int treatment[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_chimpanzees] alpha;</span>
<span class="s2">        vector[qty_treatment] beta;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        // Prioris</span>
<span class="s2">        alpha ~ normal(0, 1.5);</span>
<span class="s2">        beta ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ] + beta[ treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples_chimpanzees</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.461</td>
      <td>0.340</td>
      <td>-1.003</td>
      <td>0.072</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>1693.0</td>
      <td>2221.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>3.899</td>
      <td>0.745</td>
      <td>2.798</td>
      <td>5.136</td>
      <td>0.013</td>
      <td>0.009</td>
      <td>3877.0</td>
      <td>2485.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.759</td>
      <td>0.342</td>
      <td>-1.265</td>
      <td>-0.181</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>1654.0</td>
      <td>2520.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.757</td>
      <td>0.337</td>
      <td>-1.269</td>
      <td>-0.205</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>1665.0</td>
      <td>2450.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.457</td>
      <td>0.328</td>
      <td>-0.944</td>
      <td>0.100</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>1527.0</td>
      <td>2448.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.460</td>
      <td>0.336</td>
      <td>-0.091</td>
      <td>0.978</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>1758.0</td>
      <td>2497.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>1.948</td>
      <td>0.423</td>
      <td>1.258</td>
      <td>2.606</td>
      <td>0.009</td>
      <td>0.006</td>
      <td>2220.0</td>
      <td>2804.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta[0]</th>
      <td>-0.028</td>
      <td>0.290</td>
      <td>-0.494</td>
      <td>0.424</td>
      <td>0.008</td>
      <td>0.005</td>
      <td>1494.0</td>
      <td>2154.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta[1]</th>
      <td>0.489</td>
      <td>0.286</td>
      <td>0.039</td>
      <td>0.953</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>1501.0</td>
      <td>2514.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta[2]</th>
      <td>-0.374</td>
      <td>0.286</td>
      <td>-0.813</td>
      <td>0.088</td>
      <td>0.008</td>
      <td>0.005</td>
      <td>1422.0</td>
      <td>2233.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta[3]</th>
      <td>0.380</td>
      <td>0.286</td>
      <td>-0.063</td>
      <td>0.839</td>
      <td>0.008</td>
      <td>0.005</td>
      <td>1409.0</td>
      <td>2394.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-11-12">
<h2>R Code 11.12<a class="headerlink" href="#r-code-11-12" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="p">,</span> 
                    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Joint all chains </span>
                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;forestplot&quot;</span><span class="p">,</span> <span class="c1"># or ridgeplot to plot densities</span>
                    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> 
                    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">,</span>
                    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_48_0.png" src="_images/parte_11_48_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">([</span><span class="n">samples_chimpanzees</span><span class="p">,</span> <span class="n">samples_parcial_better</span><span class="p">,</span> <span class="n">samples_partial</span><span class="p">],</span> 
                    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Joint all chains </span>
                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;forestplot&quot;</span><span class="p">,</span> <span class="c1"># or ridgeplot to plot densities,</span>
                    <span class="n">model_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;samples_chimpanzees&#39;</span><span class="p">,</span> <span class="s1">&#39;samples_parcial_better&#39;</span><span class="p">,</span> <span class="s1">&#39;samples_parcial&#39;</span><span class="p">],</span>
                    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> 
                    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">,</span>
                    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;All predicts to alpha&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_49_0.png" src="_images/parte_11_49_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-13">
<h2>R Code 11.13<a class="headerlink" href="#r-code-11-13" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="p">,</span> 
                    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Joint all chains </span>
                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;forestplot&quot;</span><span class="p">,</span> <span class="c1"># or ridgeplot to plot densities</span>
                    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> 
                    <span class="c1"># transform=inv_logit,</span>
                    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_51_0.png" src="_images/parte_11_51_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-8-14">
<h2>R Code 8.14<a class="headerlink" href="#r-code-8-14" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta_0</span> <span class="o">=</span> <span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">beta_1</span> <span class="o">=</span> <span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">beta_2</span> <span class="o">=</span> <span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">beta_3</span> <span class="o">=</span> <span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<span class="n">diff_beta_0_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">beta_0</span> <span class="o">-</span> <span class="n">beta_2</span><span class="p">)</span>
<span class="n">diff_beta_1_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">beta_1</span> <span class="o">-</span> <span class="n">beta_3</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span>
    <span class="p">[</span><span class="n">diff_beta_0_2</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">diff_beta_1_3</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">],</span>
    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Joint all chains </span>
    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;forestplot&quot;</span><span class="p">,</span> <span class="c1"># or ridgeplot to plot densities</span>
    <span class="c1"># transform=inv_logit,</span>
    <span class="n">model_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;db13&#39;</span><span class="p">,</span> <span class="s1">&#39;db24&#39;</span><span class="p">],</span>
    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_53_0.png" src="_images/parte_11_53_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="p">,</span> 
                    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Joint all chains </span>
                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;forestplot&quot;</span><span class="p">,</span> <span class="c1"># or ridgeplot to plot densities</span>
                    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">],</span> 
                    <span class="c1"># transform=inv_logit,</span>
                    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_54_0.png" src="_images/parte_11_54_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-15">
<h2>R Code 11.15<a class="headerlink" href="#r-code-11-15" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pl</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">])[[</span><span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;pulled_left&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">])</span>

<span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">actor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>actor</th>
      <th>treatment</th>
      <th>pulled_left</th>
    </tr>
    <tr>
      <th>actor</th>
      <th>treatment</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="4" valign="top">1</th>
      <th>1</th>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.333333</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.0</td>
      <td>2.0</td>
      <td>0.500000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.0</td>
      <td>3.0</td>
      <td>0.277778</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>4.0</td>
      <td>0.555556</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-11-16-and-r-code-11-17">
<h2>R Code 11.16 and R Code 11.17<a class="headerlink" href="#r-code-11-16-and-r-code-11-17" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># R Code 11.16</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Actor </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="n">RN</span><span class="p">,</span> <span class="n">LN</span><span class="p">,</span> <span class="n">RP</span><span class="p">,</span> <span class="n">LP</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">actor</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;pulled_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.8</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">RN</span><span class="p">,</span> <span class="n">RP</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">RN</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">RP</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">LN</span><span class="p">,</span> <span class="n">LP</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">LN</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    
    <span class="c1"># Labels for only first points</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.17</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">RN</span> <span class="o">-</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;R/N&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.77</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">RP</span> <span class="o">-</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;R/P&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.17</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">LN</span> <span class="o">+</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;L/N&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.77</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">LP</span> <span class="o">+</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;L/P&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Observed Proportions&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Proportion left lever&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># R Code 11.17</span>
<span class="c1"># ============</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Actor </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
    <span class="n">alpha_chimp</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">alpha_dim_0</span><span class="o">=</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">RN</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_chimp</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">LN</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_chimp</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">RP</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_chimp</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">LP</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_chimp</span> <span class="o">+</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
    <span class="c1"># To R/N and R/P</span>
    <span class="c1"># ===============</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.8</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">RN</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">RP</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    
    <span class="c1"># Plot hdi compatibility interval</span>
    <span class="n">RN_hdi_min</span><span class="p">,</span> <span class="n">RN_hdi_max</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">RN</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
    <span class="n">RP_hdi_min</span><span class="p">,</span> <span class="n">RP_hdi_max</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">RP</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">RN_hdi_min</span><span class="p">,</span> <span class="n">RN_hdi_max</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.8</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.8</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">RP_hdi_min</span><span class="p">,</span> <span class="n">RP_hdi_max</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    
    <span class="c1"># Plot points</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">RN</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">RP</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    
    <span class="c1"># To L/N and L/P</span>
    <span class="c1"># ===============</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">LN</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">LP</span><span class="o">.</span><span class="n">mean</span><span class="p">()],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># Plot hdi compatibility interval</span>
    <span class="n">LN_hdi_min</span><span class="p">,</span> <span class="n">LN_hdi_max</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">LN</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
    <span class="n">LP_hdi_min</span><span class="p">,</span> <span class="n">LP_hdi_max</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">LP</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">LN_hdi_min</span><span class="p">,</span> <span class="n">LN_hdi_max</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.9</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">LP_hdi_min</span><span class="p">,</span> <span class="n">LP_hdi_max</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.3</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">LN</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">LP</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
    
    <span class="c1"># Labels for only first points</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">RN</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;R/N&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.68</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">RP</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;R/P&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.17</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">LN</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;L/N&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.77</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">LP</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.08</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;L/P&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posterior Predictions&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Proportion left lever&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_58_0.png" src="_images/parte_11_58_0.png" />
<img alt="_images/parte_11_58_1.png" src="_images/parte_11_58_1.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-18">
<h2>R Code 11.18<a class="headerlink" href="#r-code-11-18" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">prosoc_left</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># Right 1, Left 2  - Because R start index in 1</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">condition</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># no partner 1, partner 2 - Because R start index in 1</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-19">
<h2>R Code 11.19<a class="headerlink" href="#r-code-11-19" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Creating data list 2 to model</span>
<span class="n">data_list2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="s1">&#39;cond&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">data_list2</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">data_list2</span><span class="p">[</span><span class="s1">&#39;qty_actors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">data_list2</span><span class="p">[</span><span class="s1">&#39;qty_side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">side</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">data_list2</span><span class="p">[</span><span class="s1">&#39;qty_cond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">cond</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">data_list2</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;pulled_left&#39;, &#39;actor&#39;, &#39;side&#39;, &#39;cond&#39;, &#39;N&#39;, &#39;qty_actors&#39;, &#39;qty_side&#39;, &#39;qty_cond&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model2</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_actors;</span>
<span class="s2">        int qty_side;</span>
<span class="s2">        int qty_cond;</span>
<span class="s2">        </span>
<span class="s2">        int pulled_left[N];</span>
<span class="s2">        int actor[N];</span>
<span class="s2">        int side[N];</span>
<span class="s2">        int cond[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_actors] alpha;</span>
<span class="s2">        vector[qty_side] bs;</span>
<span class="s2">        vector[qty_cond] bc;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        // Prioris</span>
<span class="s2">        alpha ~ normal(0, 1.5);</span>
<span class="s2">        bs ~ normal(0, 0.5);</span>
<span class="s2">        bc ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ] + bs[ side[i] ] + bc[ cond[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori2</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list2</span><span class="p">)</span>
<span class="n">samples2</span> <span class="o">=</span> <span class="n">posteriori2</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples_chimpanzees_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori2</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples2</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="s1">&#39;cond&#39;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">([</span><span class="n">samples_chimpanzees</span><span class="p">,</span> <span class="n">samples_chimpanzees_2</span><span class="p">],</span>
                    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Joint all chains </span>
                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;forestplot&quot;</span><span class="p">,</span> <span class="c1"># or ridgeplot to plot densities</span>
                    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;bs&#39;</span><span class="p">,</span> <span class="s1">&#39;bc&#39;</span><span class="p">],</span> 
                    <span class="n">model_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;samples_chimpanzees&#39;</span><span class="p">,</span> <span class="s1">&#39;samples_chimpanzees_2&#39;</span><span class="p">],</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">,</span>
                    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_65_0.png" src="_images/parte_11_65_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-21">
<h2>R Code 11.21<a class="headerlink" href="#r-code-11-21" title="Permalink to this headline">¶</a></h2>
<p>To viewing data from rethinking packages</p>
</div>
<div class="section" id="r-code-11-22">
<h2>R Code 11.22<a class="headerlink" href="#r-code-11-22" title="Permalink to this headline">¶</a></h2>
<p>Comparing two models</p>
</div>
<div class="section" id="r-code-11-23">
<h2>R Code 11.23<a class="headerlink" href="#r-code-11-23" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">beta_4</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span>
<span class="n">beta_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">samples_chimpanzees</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span>

<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">beta_4</span> <span class="o">-</span> <span class="n">beta_2</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.9304928624024834
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-24">
<h2>R Code 11.24<a class="headerlink" href="#r-code-11-24" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/chimpanzees.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">d</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;prosoc_left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span>
<span class="n">d</span><span class="p">[</span><span class="s1">&#39;side&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;prosoc_left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># right 1, left 2</span>
<span class="n">d</span><span class="p">[</span><span class="s1">&#39;cond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># no partner 1, partner 2</span>

<span class="n">d_aggregate</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="s1">&#39;cond&#39;</span><span class="p">])[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">d_aggregate</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">:</span> <span class="s1">&#39;left_pulls&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Rename columns</span>
<span class="n">d_aggregate</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">d_aggregate</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>treatment</th>
      <th>actor</th>
      <th>side</th>
      <th>cond</th>
      <th>left_pulls</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>1</td>
      <td>18</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>1</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>6</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>1</td>
      <td>14</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>7</td>
      <td>1</td>
      <td>1</td>
      <td>14</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>9</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">d_aggregate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>28
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-25">
<h2>R Code 11.25<a class="headerlink" href="#r-code-11-25" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dat</span> <span class="o">=</span> <span class="n">d_aggregate</span><span class="p">[[</span><span class="s1">&#39;left_pulls&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;side&#39;</span><span class="p">,</span> <span class="s1">&#39;cond&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_aggregate</span><span class="p">)</span>
<span class="n">dat</span><span class="p">[</span><span class="s1">&#39;qty_actors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_aggregate</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat</span><span class="p">[</span><span class="s1">&#39;qty_treatments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d_aggregate</span><span class="o">.</span><span class="n">treatment</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">dat</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dict_keys([&#39;left_pulls&#39;, &#39;treatment&#39;, &#39;actor&#39;, &#39;side&#39;, &#39;cond&#39;, &#39;N&#39;, &#39;qty_actors&#39;, &#39;qty_treatments&#39;])
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_actors;</span>
<span class="s2">        int qty_treatments;</span>
<span class="s2">        </span>
<span class="s2">        int left_pulls[N];</span>
<span class="s2">        int actor[N];</span>
<span class="s2">        int treatment[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_actors] alpha;</span>
<span class="s2">        vector[qty_treatments] beta;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1.5);</span>
<span class="s2">        beta ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ] + beta[ treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">        left_pulls ~ binomial(18, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_chimp_bin</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;left_pulls&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span>
    <span class="p">[</span><span class="n">model_chimp_bin</span><span class="p">,</span> <span class="n">samples_chimpanzees</span><span class="p">],</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span> 
    <span class="n">model_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Model Binomial&#39;</span><span class="p">,</span> <span class="s1">&#39;Model Bernoulli&#39;</span><span class="p">],</span>
    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">,</span> 
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_77_0.png" src="_images/parte_11_77_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">p_chimp_bin</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
        <span class="n">alpha_chimp_bin</span> <span class="o">=</span> <span class="n">model_chimp_bin</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">alpha_dim_0</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">beta_chimp_bin</span> <span class="o">=</span> <span class="n">model_chimp_bin</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_dim_0</span><span class="o">=</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">p_chimp_bin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_chimp_bin</span> <span class="o">+</span> <span class="n">beta_chimp_bin</span><span class="p">))</span>

    <span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">p_chimp_bin</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Treatment = </span><span class="si">{</span><span class="n">t</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_78_0.png" src="_images/parte_11_78_0.png" />
<img alt="_images/parte_11_78_1.png" src="_images/parte_11_78_1.png" />
<img alt="_images/parte_11_78_2.png" src="_images/parte_11_78_2.png" />
<img alt="_images/parte_11_78_3.png" src="_images/parte_11_78_3.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-26">
<h2>R Code 11.26<a class="headerlink" href="#r-code-11-26" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models_to_compare</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;model_chimp_bin&#39;</span><span class="p">:</span> <span class="n">model_chimp_bin</span><span class="p">,</span> <span class="s1">&#39;samples_chimpanzees&#39;</span><span class="p">:</span> <span class="n">samples_chimpanzees</span><span class="p">}</span>

<span class="c1"># az.compare(models_to_compare)  # or use &#39;elpd_waic&#39; to WAIC</span>

<span class="c1"># XXX: Need to make posteriori in model to read in arviz</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-27">
<h2>R Code 11.27<a class="headerlink" href="#r-code-11-27" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Deviance of aggregated 6-in-9</span>
<span class="n">agg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">binom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>

<span class="c1"># Deviance of dis-aggregagted</span>
<span class="n">k</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">not_agg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">bernoulli</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">not_agg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>11.790482659407832
20.652116257094463
</pre></div>
</div>
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="my-tests">
<h2>My Tests<a class="headerlink" href="#my-tests" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data{</span>
<span class="s2">        int N;</span>
<span class="s2">        int y[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        // Priori</span>
<span class="s2">        alpha ~ normal(0.5, 1);</span>
<span class="s2">    </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">                p[i] = inv_logit(alpha);</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        y ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples_test</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples_test_az</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples_test</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span>
    <span class="n">samples_test_az</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> 
    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span>
    <span class="n">samples_test_az</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)))</span>  <span class="c1"># Priori</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_86_0.png" src="_images/parte_11_86_0.png" />
<img alt="_images/parte_11_86_1.png" src="_images/parte_11_86_1.png" />
<img alt="_images/parte_11_86_2.png" src="_images/parte_11_86_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">samples_test_az</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.6395421321747394 0.5988337119128063
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">samples_test_az</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_88_0.png" src="_images/parte_11_88_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Binomial</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data{</span>
<span class="s2">        int N;</span>
<span class="s2">        int y[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        // Priori</span>
<span class="s2">        alpha ~ normal(0.5, 1);</span>
<span class="s2">    </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">                p[i] = inv_logit(alpha);</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        y ~ binomial(5, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">samples_test</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples_test_az</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples_test</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span>
    <span class="n">samples_test_az</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> 
    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span>
    <span class="n">samples_test_az</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_91_0.png" src="_images/parte_11_91_0.png" />
<img alt="_images/parte_11_91_1.png" src="_images/parte_11_91_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">samples_test_az</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.679474227457576 0.6379739000951222
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">samples_test_az</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_93_0.png" src="_images/parte_11_93_0.png" />
</div>
</div>
</div>
<hr class="docutils" />
<div class="section" id="r-code-11-28">
<h2>R Code 11.28<a class="headerlink" href="#r-code-11-28" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/UCBadmit.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dept</th>
      <th>applicant.gender</th>
      <th>admit</th>
      <th>reject</th>
      <th>applications</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>A</td>
      <td>male</td>
      <td>512</td>
      <td>313</td>
      <td>825</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
      <td>female</td>
      <td>89</td>
      <td>19</td>
      <td>108</td>
    </tr>
    <tr>
      <th>3</th>
      <td>B</td>
      <td>male</td>
      <td>353</td>
      <td>207</td>
      <td>560</td>
    </tr>
    <tr>
      <th>4</th>
      <td>B</td>
      <td>female</td>
      <td>17</td>
      <td>8</td>
      <td>25</td>
    </tr>
    <tr>
      <th>5</th>
      <td>C</td>
      <td>male</td>
      <td>120</td>
      <td>205</td>
      <td>325</td>
    </tr>
    <tr>
      <th>6</th>
      <td>C</td>
      <td>female</td>
      <td>202</td>
      <td>391</td>
      <td>593</td>
    </tr>
    <tr>
      <th>7</th>
      <td>D</td>
      <td>male</td>
      <td>138</td>
      <td>279</td>
      <td>417</td>
    </tr>
    <tr>
      <th>8</th>
      <td>D</td>
      <td>female</td>
      <td>131</td>
      <td>244</td>
      <td>375</td>
    </tr>
    <tr>
      <th>9</th>
      <td>E</td>
      <td>male</td>
      <td>53</td>
      <td>138</td>
      <td>191</td>
    </tr>
    <tr>
      <th>10</th>
      <td>E</td>
      <td>female</td>
      <td>94</td>
      <td>299</td>
      <td>393</td>
    </tr>
    <tr>
      <th>11</th>
      <td>F</td>
      <td>male</td>
      <td>22</td>
      <td>351</td>
      <td>373</td>
    </tr>
    <tr>
      <th>12</th>
      <td>F</td>
      <td>female</td>
      <td>24</td>
      <td>317</td>
      <td>341</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">total_male_applic</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">][</span><span class="s1">&#39;applications&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">total_male_admit</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">][</span><span class="s1">&#39;admit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Percentual total male =&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">total_male_admit</span> <span class="o">/</span> <span class="n">total_male_applic</span><span class="p">)),</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>

<span class="n">total_female_applic</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="s1">&#39;applications&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">total_female_admit</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="s1">&#39;admit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Percentual total female =&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">total_female_admit</span> <span class="o">/</span> <span class="n">total_female_applic</span><span class="p">)),</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percentual total male = 44 %
Percentual total female = 30 %
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-29">
<h2>R Code 11.29<a class="headerlink" href="#r-code-11-29" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight">
\[ A_i \sim Binomial(N_i, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{GID[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(0, 1.5) \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;admit&#39;</span><span class="p">,</span> <span class="s1">&#39;applications&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_genders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">gid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;admit&#39;: [512, 89, 353, 17, 120, 202, 138, 131, 53, 94, 22, 24],
 &#39;applications&#39;: [825, 108, 560, 25, 325, 593, 417, 375, 191, 393, 373, 341],
 &#39;gid&#39;: [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
 &#39;N&#39;: 12,
 &#39;qty_genders&#39;: 2}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">dept_i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dept</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DEPARTMENT ---&gt; </span><span class="si">{</span><span class="n">dept_i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="k">for</span> <span class="n">gend_i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="s1">&#39;female&#39;</span><span class="p">]:</span>
    
        <span class="n">applications</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dept_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gend_i</span><span class="p">)][</span><span class="s1">&#39;applications&#39;</span><span class="p">]</span>
        <span class="n">admit</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dept_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">gend_i</span><span class="p">)][</span><span class="s1">&#39;admit&#39;</span><span class="p">]</span>
        <span class="n">perc_admit</span> <span class="o">=</span> <span class="n">admit</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">applications</span><span class="o">.</span><span class="n">values</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The dept </span><span class="si">{</span><span class="n">dept_i</span><span class="si">}</span><span class="s1"> has </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">perc_admit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s1">% acceptions rate for </span><span class="si">{</span><span class="n">gend_i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DEPARTMENT ---&gt; A
The dept A has 62% acceptions rate for male
The dept A has 82% acceptions rate for female


DEPARTMENT ---&gt; B
The dept B has 63% acceptions rate for male
The dept B has 68% acceptions rate for female


DEPARTMENT ---&gt; C
The dept C has 36% acceptions rate for male
The dept C has 34% acceptions rate for female


DEPARTMENT ---&gt; D
The dept D has 33% acceptions rate for male
The dept D has 34% acceptions rate for female


DEPARTMENT ---&gt; E
The dept E has 27% acceptions rate for male
The dept E has 23% acceptions rate for female


DEPARTMENT ---&gt; F
The dept F has 5% acceptions rate for male
The dept F has 7% acceptions rate for female
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_genders;</span>
<span class="s2">        </span>
<span class="s2">        int admit[N];</span>
<span class="s2">        int applications[N];</span>
<span class="s2">        int gid[N];</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_genders] alpha;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1.5);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ gid[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        admit ~ binomial(applications, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">app_gender</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">app_gender</span><span class="p">)</span>  <span class="c1"># In scale inv-logit</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.22</td>
      <td>0.039</td>
      <td>-0.287</td>
      <td>-0.143</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3893.0</td>
      <td>2712.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>-0.83</td>
      <td>0.050</td>
      <td>-0.921</td>
      <td>-0.733</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4089.0</td>
      <td>2650.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">app_gender</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_105_0.png" src="_images/parte_11_105_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-30">
<h2>R Code 11.30<a class="headerlink" href="#r-code-11-30" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha_1</span> <span class="o">=</span> <span class="n">app_gender</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">gender</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">alpha_2</span> <span class="o">=</span> <span class="n">app_gender</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">gender</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">diff_a</span> <span class="o">=</span> <span class="n">alpha_1</span> <span class="o">-</span> <span class="n">alpha_2</span>
<span class="n">diff_p</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_1</span><span class="p">)</span> <span class="o">-</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_2</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">diff_a</span><span class="p">)</span>  <span class="c1"># Shark</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.61</td>
      <td>0.065</td>
      <td>0.49</td>
      <td>0.734</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4040.0</td>
      <td>2912.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">diff_p</span><span class="p">)</span>  <span class="c1"># Deer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>0.141</td>
      <td>0.015</td>
      <td>0.114</td>
      <td>0.169</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4030.0</td>
      <td>2886.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-11-31">
<h2>R Code 11.31<a class="headerlink" href="#r-code-11-31" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">5.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">depts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dept</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    
    <span class="n">dept</span> <span class="o">=</span> <span class="n">depts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Dept </span><span class="si">{</span><span class="n">dept</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">perc_male</span><span class="p">,</span> <span class="n">perc_female</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dept</span><span class="p">,</span> <span class="s1">&#39;admit&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dept</span><span class="p">,</span> <span class="s1">&#39;applications&#39;</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mf">0.7</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">perc_male</span><span class="p">,</span> <span class="n">perc_female</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>  <span class="c1"># Line</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">perc_male</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>  <span class="c1"># point male</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mf">0.7</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">perc_female</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>  <span class="c1"># point female</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">perc_male</span><span class="p">,</span> <span class="n">perc_female</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">dept</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori Validation Check&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Admit&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Case&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">5.9</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">12.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Need put points with open points from samples</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_110_0.png" src="_images/parte_11_110_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-32">
<h2>R Code 11.32<a class="headerlink" href="#r-code-11-32" title="Permalink to this headline">¶</a></h2>
<p>We want ask:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- What is the average difference in probability of admission between women and man within departments?
</pre></div>
</div>
<div class="math notranslate nohighlight">
\[ A_i \sim Binomial(N_i, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{GID[i]} + \delta_{DEPT[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(0, 1.5) \]</div>
<div class="math notranslate nohighlight">
\[ \delta_k \sim Normal(0, 1.5) \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;gid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept_idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">dept_i</span><span class="p">)</span> <span class="o">-</span> <span class="mi">64</span> <span class="k">for</span> <span class="n">dept_i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]]</span>  <span class="c1"># ord(&#39;A&#39;) = 65</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;admit&#39;</span><span class="p">,</span> <span class="s1">&#39;applications&#39;</span><span class="p">,</span> <span class="s1">&#39;gid&#39;</span><span class="p">,</span> <span class="s1">&#39;dept_idx&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_genders&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">gid</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_dept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dept_idx</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">dat_list</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;admit&#39;: [512, 89, 353, 17, 120, 202, 138, 131, 53, 94, 22, 24],
 &#39;applications&#39;: [825, 108, 560, 25, 325, 593, 417, 375, 191, 393, 373, 341],
 &#39;gid&#39;: [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
 &#39;dept_idx&#39;: [1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6],
 &#39;N&#39;: 12,
 &#39;qty_genders&#39;: 2,
 &#39;qty_dept&#39;: 6}
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_genders;</span>
<span class="s2">        int qty_dept;</span>
<span class="s2">        </span>
<span class="s2">        array[N] int admit;</span>
<span class="s2">        array[N] int applications;</span>
<span class="s2">        array[N] int gid;</span>
<span class="s2">        array[N] int dept_idx;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_genders] alpha;</span>
<span class="s2">        vector[ qty_dept ] delta;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1.5);</span>
<span class="s2">        delta ~ normal(0, 1.5);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ gid[i] ] + delta[ dept_idx[i] ];  # O Delta calcula a taxa média de admissão para o departamento i</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        admit ~ binomial(applications, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">applic_gender_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;gender&#39;</span><span class="p">],</span>
        <span class="s1">&#39;delta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;department&#39;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">applic_gender_2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>-0.602</td>
      <td>0.521</td>
      <td>-1.479</td>
      <td>0.429</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>309.0</td>
      <td>552.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>-0.506</td>
      <td>0.523</td>
      <td>-1.420</td>
      <td>0.482</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>307.0</td>
      <td>582.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>delta[0]</th>
      <td>1.183</td>
      <td>0.525</td>
      <td>0.229</td>
      <td>2.153</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>311.0</td>
      <td>597.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>delta[1]</th>
      <td>1.138</td>
      <td>0.527</td>
      <td>0.141</td>
      <td>2.098</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>313.0</td>
      <td>618.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>delta[2]</th>
      <td>-0.076</td>
      <td>0.524</td>
      <td>-1.036</td>
      <td>0.880</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>309.0</td>
      <td>579.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>delta[3]</th>
      <td>-0.108</td>
      <td>0.525</td>
      <td>-1.055</td>
      <td>0.858</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>308.0</td>
      <td>575.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>delta[4]</th>
      <td>-0.552</td>
      <td>0.528</td>
      <td>-1.580</td>
      <td>0.371</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>307.0</td>
      <td>621.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>delta[5]</th>
      <td>-2.111</td>
      <td>0.538</td>
      <td>-3.131</td>
      <td>-1.141</td>
      <td>0.03</td>
      <td>0.021</td>
      <td>323.0</td>
      <td>623.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span>
    <span class="n">applic_gender_2</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;delta&#39;</span><span class="p">],</span>
    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_118_0.png" src="_images/parte_11_118_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-33">
<h2>R Code 11.33<a class="headerlink" href="#r-code-11-33" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha_male</span> <span class="o">=</span> <span class="n">applic_gender_2</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">gender</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">alpha_female</span> <span class="o">=</span> <span class="n">applic_gender_2</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">gender</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">alpha_male</span> <span class="o">-</span> <span class="n">alpha_female</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.096</td>
      <td>0.081</td>
      <td>-0.223</td>
      <td>0.035</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>4495.0</td>
      <td>3760.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">((</span><span class="n">alpha_male</span> <span class="o">-</span> <span class="n">alpha_female</span><span class="p">),</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_121_0.png" src="_images/parte_11_121_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_male</span><span class="p">)</span> <span class="o">-</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_female</span><span class="p">),</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>-0.021</td>
      <td>0.018</td>
      <td>-0.05</td>
      <td>0.008</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3438.0</td>
      <td>3591.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">((</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_male</span><span class="p">)</span> <span class="o">-</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">alpha_female</span><span class="p">)),</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_123_0.png" src="_images/parte_11_123_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pg</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">pg</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">pg</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">dept_i</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>

<span class="k">for</span> <span class="n">dept_i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>

    <span class="n">total</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dept_i</span><span class="p">][</span><span class="s1">&#39;applications&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_male</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dept_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;male&#39;</span><span class="p">)][</span><span class="s1">&#39;applications&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">total_female</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;dept&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">dept_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;applicant.gender&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;female&#39;</span><span class="p">)][</span><span class="s1">&#39;applications&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">pg</span><span class="p">[</span><span class="s1">&#39;male&#39;</span><span class="p">][</span><span class="n">dept_i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_male</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">pg</span><span class="p">[</span><span class="s1">&#39;female&#39;</span><span class="p">][</span><span class="n">dept_i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">total_female</span> <span class="o">/</span> <span class="n">total</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>D</th>
      <th>E</th>
      <th>F</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>male</th>
      <td>0.88</td>
      <td>0.96</td>
      <td>0.35</td>
      <td>0.53</td>
      <td>0.33</td>
      <td>0.52</td>
    </tr>
    <tr>
      <th>female</th>
      <td>0.12</td>
      <td>0.04</td>
      <td>0.65</td>
      <td>0.47</td>
      <td>0.67</td>
      <td>0.48</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="poisson-regression">
<h2>Poisson Regression<a class="headerlink" href="#poisson-regression" title="Permalink to this headline">¶</a></h2>
<div class="section" id="r-code-11-35">
<h3>R Code 11.35<a class="headerlink" href="#r-code-11-35" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">p</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1000</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The mean is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s1"> and variance is </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The mean is 10.036 and variance is 10.078504
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-36">
<h3>R Code 11.36<a class="headerlink" href="#r-code-11-36" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/Kline.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>culture</th>
      <th>population</th>
      <th>contact</th>
      <th>total_tools</th>
      <th>mean_TU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Malekula</td>
      <td>1100</td>
      <td>low</td>
      <td>13</td>
      <td>3.2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Tikopia</td>
      <td>1500</td>
      <td>low</td>
      <td>22</td>
      <td>4.7</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Santa Cruz</td>
      <td>3600</td>
      <td>low</td>
      <td>24</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Yap</td>
      <td>4791</td>
      <td>high</td>
      <td>43</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Lau Fiji</td>
      <td>7400</td>
      <td>high</td>
      <td>33</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Trobriand</td>
      <td>8000</td>
      <td>high</td>
      <td>19</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Chuuk</td>
      <td>9200</td>
      <td>high</td>
      <td>40</td>
      <td>3.8</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Manus</td>
      <td>13000</td>
      <td>low</td>
      <td>28</td>
      <td>6.6</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Tonga</td>
      <td>17500</td>
      <td>high</td>
      <td>55</td>
      <td>5.4</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Hawaii</td>
      <td>275000</td>
      <td>low</td>
      <td>71</td>
      <td>6.6</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="math notranslate nohighlight">
\[ y_i \sim Poisson(\lambda) \]</div>
<p>The parameter <span class="math notranslate nohighlight">\(\lambda\)</span> is expected value of the outcome y.</p>
<p>The <em>link function</em> for poisson is the <span class="math notranslate nohighlight">\(log\)</span> link.</p>
<div class="math notranslate nohighlight">
\[ y_i \sim Poisson(\lambda_i) \]</div>
<div class="math notranslate nohighlight">
\[ log(\lambda_i) = \alpha + \beta(x_i - \bar x) \]</div>
</div>
<div class="section" id="r-code-11-37">
<h3>R Code 11.37<a class="headerlink" href="#r-code-11-37" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_population&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;population&#39;</span><span class="p">])</span>  <span class="c1"># log population</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_population&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_population&#39;</span><span class="p">]))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_population&#39;</span><span class="p">])</span>  <span class="c1">#std log population</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="k">if</span> <span class="n">contact_i</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">contact_i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="p">]</span>  <span class="c1"># CID 1:low; 2:high</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>culture</th>
      <th>population</th>
      <th>contact</th>
      <th>total_tools</th>
      <th>mean_TU</th>
      <th>log_population</th>
      <th>P</th>
      <th>contact_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Malekula</td>
      <td>1100</td>
      <td>low</td>
      <td>13</td>
      <td>3.2</td>
      <td>7.003065</td>
      <td>-1.361332</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Tikopia</td>
      <td>1500</td>
      <td>low</td>
      <td>22</td>
      <td>4.7</td>
      <td>7.313220</td>
      <td>-1.147433</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Santa Cruz</td>
      <td>3600</td>
      <td>low</td>
      <td>24</td>
      <td>4.0</td>
      <td>8.188689</td>
      <td>-0.543664</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Yap</td>
      <td>4791</td>
      <td>high</td>
      <td>43</td>
      <td>5.0</td>
      <td>8.474494</td>
      <td>-0.346558</td>
      <td>2</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Lau Fiji</td>
      <td>7400</td>
      <td>high</td>
      <td>33</td>
      <td>5.0</td>
      <td>8.909235</td>
      <td>-0.046737</td>
      <td>2</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Trobriand</td>
      <td>8000</td>
      <td>high</td>
      <td>19</td>
      <td>4.0</td>
      <td>8.987197</td>
      <td>0.007029</td>
      <td>2</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Chuuk</td>
      <td>9200</td>
      <td>high</td>
      <td>40</td>
      <td>3.8</td>
      <td>9.126959</td>
      <td>0.103416</td>
      <td>2</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Manus</td>
      <td>13000</td>
      <td>low</td>
      <td>28</td>
      <td>6.6</td>
      <td>9.472705</td>
      <td>0.341861</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Tonga</td>
      <td>17500</td>
      <td>high</td>
      <td>55</td>
      <td>5.4</td>
      <td>9.769956</td>
      <td>0.546861</td>
      <td>2</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Hawaii</td>
      <td>275000</td>
      <td>low</td>
      <td>71</td>
      <td>6.6</td>
      <td>12.524526</td>
      <td>2.446558</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="model-poisson-regression">
<h4>Model - Poisson Regression<a class="headerlink" href="#model-poisson-regression" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[ T_i \sim Poisson(\lambda_i) \]</div>
<div class="math notranslate nohighlight">
\[ log(\lambda_i) = \alpha_{CID[i]} + \beta_{CID[i]} log(P_i) \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim \mbox{to be determined} \]</div>
<div class="math notranslate nohighlight">
\[ \beta_j \sim \mbox{to be determined} \]</div>
<hr class="docutils" />
<div class="math notranslate nohighlight">
\[ T_i \sim Poisson(\lambda_i) \]</div>
<div class="math notranslate nohighlight">
\[ log(\lambda_i) = \alpha\]</div>
<div class="math notranslate nohighlight">
\[ \alpha \sim Normal(0, 10) \]</div>
</div>
</div>
<div class="section" id="r-code-11-38">
<h3>R Code 11.38<a class="headerlink" href="#r-code-11-38" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># See the docs to understanding the parameters</span>

<span class="c1"># R Code 11.40</span>
<span class="n">y_new</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># See the docs to understanding the parameters</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y_new</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Mean Number of Tools&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_137_0.png" src="_images/parte_11_137_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-39">
<h3>R Code 11.39<a class="headerlink" href="#r-code-11-39" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">lambda_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lambda_</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1877154437902.8613
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-40">
<h3>R Code 11.40<a class="headerlink" href="#r-code-11-40" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ploted in R Code 11.38</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-41">
<h3>R Code 11.41<a class="headerlink" href="#r-code-11-41" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># prior to alpha</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># prior to beta</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">prioris</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Poisson Priori </span><span class="se">\n</span><span class="s1"> beta ~ Normal(0, 10)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log population (std)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;total odds&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_143_0.png" src="_images/parte_11_143_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-42">
<h3>R Code 11.42<a class="headerlink" href="#r-code-11-42" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># prior to alpha</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># prior to beta</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">prioris</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Poisson Priori </span><span class="se">\n</span><span class="s1"> beta ~ Normal(0, 0.2)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log population (std)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;total odds&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_145_0.png" src="_images/parte_11_145_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-43">
<h3>R Code 11.43<a class="headerlink" href="#r-code-11-43" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># prior to alpha</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># prior to beta</span>

<span class="n">x_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">200000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># log(population)</span>

<span class="n">lambda_poisson</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">lambda_poisson</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x_seq</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">x_seq</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;a ~ Normal(3, 0.5), b ~ Normal(0, 0.2)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log population&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;total tools&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_147_0.png" src="_images/parte_11_147_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-44">
<h3>R Code 11.44<a class="headerlink" href="#r-code-11-44" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#N = 100</span>
<span class="c1">#a = np.random.normal(3, 0.5, N)  # prior to alpha</span>
<span class="c1">#b = np.random.normal(0, 0.2, N)  # prior to beta</span>

<span class="n">x_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">200000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># log(population)</span>

<span class="n">lambda_poisson_</span> <span class="o">=</span>  <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_seq</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_seq</span><span class="p">),</span> <span class="n">lambda_poisson_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>
<span class="c1">#plt.xlim(min(np.exp(x_seq)), max(np.exp(x_seq)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;a ~ Normal(3, 0.5), b ~ Normal(0, 0.2)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;total tools&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_149_0.png" src="_images/parte_11_149_0.png" />
</div>
</div>
<div class="section" id="curiosidade-do-python">
<h4>Curiosidade do python<a class="headerlink" href="#curiosidade-do-python" title="Permalink to this headline">¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mi">2000</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="mi">2000</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_151_0.png" src="_images/parte_11_151_0.png" />
<img alt="_images/parte_11_151_1.png" src="_images/parte_11_151_1.png" />
<img alt="_images/parte_11_151_2.png" src="_images/parte_11_151_2.png" />
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-45">
<h3>R Code 11.45<a class="headerlink" href="#r-code-11-45" title="Permalink to this headline">¶</a></h3>
<div class="section" id="model">
<h4>Model:<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[ T_i \sim Poisson(\lambda_i) \]</div>
<div class="math notranslate nohighlight">
\[ log(\lambda_i) = \alpha_{CID[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(3, 0.5) \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_9</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        array[N] int total_tools;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        // Priori</span>
<span class="s2">        alpha ~ normal(3, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        total_tools ~ poisson(exp(alpha));</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;total_tools&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_11_9</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_9_post</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_11_9_post</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>3.539</td>
      <td>0.053</td>
      <td>3.437</td>
      <td>3.634</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>1653.0</td>
      <td>2031.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_11_9_post</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_157_0.png" src="_images/parte_11_157_0.png" />
</div>
</div>
</div>
<div class="section" id="id1">
<h4>Model:<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<div class="math notranslate nohighlight">
\[ T_i \sim Poisson(\lambda_i) \]</div>
<div class="math notranslate nohighlight">
\[ log(\lambda_i) = \alpha_{CID[i]} + \beta_{CID[i]} \times log(P_i) \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(3, 0.5) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_j \sim Normal(0, 0.2) \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_9_new</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_cid;</span>
<span class="s2">        array[N] int total_tools;</span>
<span class="s2">        array[N] real P;</span>
<span class="s2">        array[N] int contact_id;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        array[qty_cid] real alpha;</span>
<span class="s2">        array[qty_cid] real beta;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] lambda;</span>
<span class="s2">        </span>
<span class="s2">        // Priori</span>
<span class="s2">        alpha ~ normal(3, 0.5);</span>
<span class="s2">        beta ~ normal(0, 0.2);</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        for(i in 1:N){</span>
<span class="s2">                lambda[i] = alpha[ contact_id[i] ] + beta[ contact_id[i] ] * P[i];</span>
<span class="s2">                lambda[i] = exp(lambda[i]);</span>
<span class="s2">        }</span>
<span class="s2">        total_tools ~ poisson(lambda);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;total_tools&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;contact_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;qty_cid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">contact_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_11_9_new</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_9_new_post</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">],</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_11_9_new_post</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>3.318</td>
      <td>0.085</td>
      <td>3.159</td>
      <td>3.475</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>3218.0</td>
      <td>3262.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>3.610</td>
      <td>0.072</td>
      <td>3.465</td>
      <td>3.737</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3837.0</td>
      <td>2567.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta[0]</th>
      <td>0.361</td>
      <td>0.049</td>
      <td>0.265</td>
      <td>0.449</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3990.0</td>
      <td>3160.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta[1]</th>
      <td>0.189</td>
      <td>0.156</td>
      <td>-0.123</td>
      <td>0.468</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>3815.0</td>
      <td>2813.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_11_9_new_post</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_162_0.png" src="_images/parte_11_162_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-46">
<h3>R Code 11.46<a class="headerlink" href="#r-code-11-46" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Need to make a generated_quantities to compute compare</span>


<span class="n">dict_to_compare</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;model_11_9_post&#39;</span><span class="p">:</span> <span class="n">model_11_9_post</span><span class="p">,</span>
    <span class="s1">&#39;model_11_9_new_post&#39;</span><span class="p">:</span> <span class="n">model_11_9_new_post</span>
<span class="p">}</span>

<span class="c1"># az.compare(dict_to_compare)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-47">
<h3>R Code 11.47<a class="headerlink" href="#r-code-11-47" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a_low</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 0 (low contact) </span>
<span class="n">b_low</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 0 (low contact)</span>

<span class="n">a_high</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 1 (high contact) </span>
<span class="n">b_high</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 1 (high contact)</span>

<span class="n">x_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># log(population)</span>

<span class="n">lambda_poisson_low</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_low</span> <span class="o">+</span> <span class="n">b_low</span> <span class="o">*</span> <span class="n">x_seq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
<span class="n">hdi_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">lambda_poisson_low</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">])</span>
            
<span class="n">lambda_poisson_high</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_high</span> <span class="o">+</span> <span class="n">b_high</span> <span class="o">*</span> <span class="n">x_seq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
<span class="n">hdi_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">lambda_poisson_high</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span><span class="n">lambda_poisson_low</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># Low</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">hdi_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdi_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">lambda_poisson_high</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High&#39;</span><span class="p">)</span>  <span class="c1"># High</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_seq</span><span class="p">,</span> <span class="n">hdi_high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdi_high</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Plot the points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Low contact&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High contact&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;log population (std)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;total tools&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_166_0.png" src="_images/parte_11_166_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-48">
<h3>R Code 11.48<a class="headerlink" href="#r-code-11-48" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a_low</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 0 (low contact) </span>
<span class="n">b_low</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 0 (low contact)</span>

<span class="n">a_high</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 1 (high contact) </span>
<span class="n">b_high</span> <span class="o">=</span> <span class="n">model_11_9_new_post</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 1 (high contact)</span>

<span class="n">p_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># 1.53 is sd of log(population)</span>
<span class="c1"># 9 is mean of log(population)</span>
<span class="n">pop_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p_seq</span> <span class="o">*</span> <span class="mf">1.53</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>

<span class="n">lambda_poisson_low</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_low</span> <span class="o">+</span> <span class="n">b_low</span> <span class="o">*</span> <span class="n">p_seq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
<span class="n">hdi_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">lambda_poisson_low</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">])</span>
            
<span class="n">lambda_poisson_high</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_high</span> <span class="o">+</span> <span class="n">b_high</span> <span class="o">*</span> <span class="n">p_seq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
<span class="n">hdi_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">lambda_poisson_high</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span><span class="n">lambda_poisson_low</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># Low</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">hdi_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdi_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">lambda_poisson_high</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High&#39;</span><span class="p">)</span>  <span class="c1"># High</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">hdi_high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdi_high</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Plot the points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Low contact&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High contact&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="c1"># Limits graphs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">300000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;total tools&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_168_0.png" src="_images/parte_11_168_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-11-49-overthinking-modeling-tool-innovation-pg-356">
<h3>R Code 11.49 - Overthinking: Modeling tool innovation - Pg 356<a class="headerlink" href="#r-code-11-49-overthinking-modeling-tool-innovation-pg-356" title="Permalink to this headline">¶</a></h3>
<p>Expected number of tools in one time step is:</p>
<div class="math notranslate nohighlight">
\[ \Delta T = \alpha P^\beta - \gamma T \]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(T\)</span>: Number of tools</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha, \beta, \gamma\)</span>: Parameters to be estimated</p></li>
</ul>
<p>The equilibrium number of tools <span class="math notranslate nohighlight">\(T\)</span>, just <span class="math notranslate nohighlight">\(\Delta T = 0\)</span> and solve for T.</p>
<div class="math notranslate nohighlight">
\[ \hat{T} = \frac{\alpha P^\beta}{\gamma} \]</div>
<p>The noise around the outcome will still be <span class="math notranslate nohighlight">\(Poisson\)</span>, because that is still maximum entropy distribution in this context - <code class="docutils literal notranslate"><span class="pre">total_tools</span></code> is a count with no clear upper bound. The linear model is:</p>
<div class="math notranslate nohighlight">
\[ T_i \sim Poisson(\lambda_i) \]</div>
<div class="math notranslate nohighlight">
\[ \lambda_i = \frac{\alpha P^\beta_i}{\gamma} \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">p_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">log_population</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="o">.</span><span class="n">log_population</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">N</span><span class="p">)</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;alpha&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_172_0.png" src="_images/parte_11_172_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">lambda_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">lambda_</span> <span class="o">=</span> <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">p_seq</span> <span class="o">**</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">/</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> 

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_seq</span><span class="p">,</span> <span class="n">lambda_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p_seq</span><span class="p">),</span> <span class="n">lambda_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_174_0.png" src="_images/parte_11_174_0.png" />
<img alt="_images/parte_11_174_1.png" src="_images/parte_11_174_1.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_cid;</span>
<span class="s2">        array[N] int total_tools;</span>
<span class="s2">        array[N] real population;</span>
<span class="s2">        array[N] int contact_id;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        array[qty_cid] real alpha;</span>
<span class="s2">        array[qty_cid] real&lt;lower=0&gt; beta;</span>
<span class="s2">        real&lt;lower=0&gt; gamma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        array[N] real lambda;</span>
<span class="s2">        </span>
<span class="s2">        // Prioris</span>
<span class="s2">        alpha ~ normal(1, 1);</span>
<span class="s2">        beta ~ exponential(1);</span>
<span class="s2">        gamma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        for(i in 1:N){</span>
<span class="s2">            lambda[i] = (exp(alpha[ contact_id[i] ]) * population[i] ^ beta[ contact_id[i] ])/gamma;</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        //likelihood</span>
<span class="s2">        total_tools ~ poisson(lambda);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">data_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;total_tools&quot;</span><span class="p">,</span> <span class="s2">&quot;contact_id&quot;</span><span class="p">,</span> <span class="s2">&quot;population&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">total_tools</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;qty_cid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">contact_id</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_11</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">],</span>
        <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_11_11</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>0.917</td>
      <td>0.685</td>
      <td>-0.346</td>
      <td>2.219</td>
      <td>0.017</td>
      <td>0.012</td>
      <td>1681.0</td>
      <td>1625.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>0.922</td>
      <td>0.857</td>
      <td>-0.682</td>
      <td>2.488</td>
      <td>0.020</td>
      <td>0.015</td>
      <td>1923.0</td>
      <td>1648.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>beta[0]</th>
      <td>0.261</td>
      <td>0.033</td>
      <td>0.198</td>
      <td>0.323</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>2336.0</td>
      <td>1623.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>beta[1]</th>
      <td>0.292</td>
      <td>0.106</td>
      <td>0.084</td>
      <td>0.481</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>1601.0</td>
      <td>1392.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>gamma</th>
      <td>1.164</td>
      <td>0.776</td>
      <td>0.107</td>
      <td>2.514</td>
      <td>0.019</td>
      <td>0.013</td>
      <td>1518.0</td>
      <td>1454.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_11_11</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;gamma&#39;</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_178_0.png" src="_images/parte_11_178_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">a_low</span> <span class="o">=</span> <span class="n">model_11_11</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 0 (low contact) </span>
<span class="n">b_low</span> <span class="o">=</span> <span class="n">model_11_11</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 0 (low contact)</span>

<span class="n">a_high</span> <span class="o">=</span> <span class="n">model_11_11</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 1 (high contact) </span>
<span class="n">b_high</span> <span class="o">=</span> <span class="n">model_11_11</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">contact_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># CID = 1 (high contact)</span>

<span class="n">g</span> <span class="o">=</span> <span class="n">model_11_11</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


<span class="n">p_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">log_population</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span><span class="mi">1</span> <span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">log_population</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">pop_seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p_seq</span><span class="p">)</span>

<span class="n">lambda_poisson_low</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_low</span><span class="p">)</span> <span class="o">*</span> <span class="n">pop_seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="n">b_low</span><span class="p">)</span><span class="o">/</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
<span class="n">hdi_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">lambda_poisson_low</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">])</span>
            
<span class="n">lambda_poisson_high</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">a_high</span><span class="p">)</span> <span class="o">*</span> <span class="n">pop_seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">**</span> <span class="n">b_high</span><span class="p">)</span><span class="o">/</span><span class="n">g</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>
<span class="n">hdi_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span> <span class="n">az</span><span class="o">.</span><span class="n">hdi</span><span class="p">(</span><span class="n">lambda_poisson_high</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span><span class="n">lambda_poisson_low</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  <span class="c1"># Low</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">hdi_low</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdi_low</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">lambda_poisson_high</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High&#39;</span><span class="p">)</span>  <span class="c1"># High</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">pop_seq</span><span class="p">,</span> <span class="n">hdi_high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hdi_high</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Plot the points</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Low contact&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;contact_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">total_tools</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;High contact&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="c1"># Limits graphs</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">290000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;population&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;total tools&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_179_0.png" src="_images/parte_11_179_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="example-exposure-and-the-offset">
<h2>Example: Exposure and the offset:<a class="headerlink" href="#example-exposure-and-the-offset" title="Permalink to this headline">¶</a></h2>
<p>Implicity, <span class="math notranslate nohighlight">\(\lambda\)</span> is equal to an expexted number of events, <span class="math notranslate nohighlight">\(\mu\)</span>,  per unit time or distance, <span class="math notranslate nohighlight">\(\tau\)</span>.</p>
<p>This implies that <span class="math notranslate nohighlight">\(\lambda = \frac{\mu}{\tau}\)</span>.</p>
<div class="math notranslate nohighlight">
\[ y_i \sim Poisson(\lambda_i) \]</div>
<div class="math notranslate nohighlight">
\[ log \lambda_i = log \frac{\mu_i}{\tau_i} = \alpha + \beta x_i \]</div>
<div class="math notranslate nohighlight">
\[ log \mu_i = \log \tau_i + \alpha + \beta x_i \]</div>
<p>The <span class="math notranslate nohighlight">\(\tau\)</span> values are the “<span class="math notranslate nohighlight">\(exposures\)</span>”. When <span class="math notranslate nohighlight">\(\tau_i=1\)</span>, then <span class="math notranslate nohighlight">\(log(\tau_i) = 0\)</span> and we’re back where we started.</p>
<p>Then the model with different exposures just by writing a model like:</p>
<div class="math notranslate nohighlight">
\[ y_i \sim Poisson(\mu_i) \]</div>
<div class="math notranslate nohighlight">
\[ log \mu_i = log \tau_i + \alpha + \beta x_i \]</div>
<div class="section" id="r-code-11-50">
<h3>R Code 11.50<a class="headerlink" href="#r-code-11-50" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_days</span> <span class="o">=</span> <span class="mi">30</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="mf">1.5</span> <span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">num_days</span><span class="p">)</span>
<span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([4, 0, 0, 4, 3, 0, 2, 2, 2, 5, 0, 1, 3, 1, 4, 3, 3, 3, 3, 1, 2, 0,
       1, 1, 2, 1, 3, 4, 0, 0])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-51">
<h3>R Code 11.51<a class="headerlink" href="#r-code-11-51" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">num_weeks</span> <span class="o">=</span> <span class="mi">4</span>

<span class="n">y_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="mi">7</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_weeks</span><span class="p">)</span>
<span class="n">y_new</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([4, 2, 3, 3])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-52">
<h3>R Code 11.52<a class="headerlink" href="#r-code-11-52" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y</span><span class="p">,</span> <span class="n">y_new</span><span class="p">])</span>
<span class="n">exposure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>
<span class="n">monastery</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y_all</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="n">exposure</span><span class="p">,</span> <span class="n">monastery</span><span class="o">=</span><span class="n">monastery</span><span class="p">))</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>y</th>
      <th>days</th>
      <th>monastery</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>4</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>5</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>4</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>3</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>4</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>30</th>
      <td>4</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>32</th>
      <td>3</td>
      <td>7</td>
      <td>1</td>
    </tr>
    <tr>
      <th>33</th>
      <td>3</td>
      <td>7</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="id2">
<h3>R Code 11.52<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        array[N] int y;</span>
<span class="s2">        array[N] real log_days;</span>
<span class="s2">        array[N] int monastery;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        array[N] real lambda;</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1);</span>
<span class="s2">        beta ~ normal(0, 1);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            lambda[i] = log_days[i] + alpha + monastery[i] * beta ;</span>
<span class="s2">            lambda[i] = exp(lambda[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        y ~poisson(lambda);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;log_days&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;days&#39;</span><span class="p">])</span>

<span class="n">data_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;log_days&#39;</span><span class="p">,</span> <span class="s1">&#39;monastery&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">data_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_12</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data_list</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-54">
<h3>R Code 11.54<a class="headerlink" href="#r-code-11-54" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_11_12</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_192_0.png" src="_images/parte_11_192_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha</span> <span class="o">=</span> <span class="n">model_11_12</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">model_11_12</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span>

<span class="n">lambda_old</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<span class="n">lambda_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span>


<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">lambda_old</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">lambda_old</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_193_0.png" src="_images/parte_11_193_0.png" />
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha</th>
      <td>1.871</td>
      <td>0.244</td>
      <td>1.444</td>
      <td>2.34</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>2097.0</td>
      <td>1945.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">lambda_new</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">lambda_new</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_194_0.png" src="_images/parte_11_194_0.png" />
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>x</th>
      <td>0.479</td>
      <td>0.126</td>
      <td>0.251</td>
      <td>0.71</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>3170.0</td>
      <td>2567.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="predictors-matched-to-outcomes">
<h2>Predictors matched to outcomes<a class="headerlink" href="#predictors-matched-to-outcomes" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">softmax</span><span class="p">(</span><span class="n">scores_list</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scores_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scores_list</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="r-code-11-55">
<h3>R Code 11.55<a class="headerlink" href="#r-code-11-55" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulate career choices among 500 individuals</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># number individuals</span>
<span class="n">income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>  <span class="c1"># expected income of each career</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">income</span> <span class="o">*</span> <span class="mf">0.5</span>  <span class="c1"># scores for each career, based on income</span>

<span class="c1"># next line converts scores to probabilities</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">([</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>

<span class="n">career</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Career choiced: &#39;</span><span class="p">,</span> <span class="n">career</span><span class="p">[:</span><span class="mi">20</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Income: &#39;</span><span class="p">,</span> <span class="n">income</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Score:  &#39;</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Career choiced:  [2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 2, 2, 3, 3, 3] 
Income:  [1 2 5] 
Score:   [0.5 1.  2.5]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-56">
<h3>R Code 11.56<a class="headerlink" href="#r-code-11-56" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;  // number of individuals - Here is 500</span>
<span class="s2">        int K;  // number of possible careers - Here is 3</span>
<span class="s2">        </span>
<span class="s2">        array[N] int career;  // outcome</span>
<span class="s2">        vector[K]  career_income;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[K-1] a;  // intercepts</span>
<span class="s2">        real&lt;lower=0&gt; b;  // association of income with choice</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[K] p;</span>
<span class="s2">        vector[K] s;</span>
<span class="s2">        </span>
<span class="s2">        a ~ normal(0, 1);</span>
<span class="s2">        b ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        s[1] = a[1] + b * career_income[1];</span>
<span class="s2">        s[2] = a[2] + b * career_income[2];</span>
<span class="s2">        s[3] = 0;  // pivot</span>
<span class="s2">        </span>
<span class="s2">        p = softmax( s );</span>
<span class="s2">        </span>
<span class="s2">        career ~ categorical(p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">career</span><span class="p">),</span> <span class="c1"># 500</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>  <span class="c1"># 3</span>
    <span class="s1">&#39;career&#39;</span><span class="p">:</span> <span class="n">career</span><span class="p">,</span>
    <span class="s1">&#39;career_income&#39;</span><span class="p">:</span> <span class="n">income</span><span class="p">,</span>
<span class="p">})</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-57">
<h3>R Code 11.57<a class="headerlink" href="#r-code-11-57" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.16525252892399064
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_13</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_11_13</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a[0]</th>
      <td>-2.073</td>
      <td>0.165</td>
      <td>-2.423</td>
      <td>-1.808</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>668.0</td>
      <td>608.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>a[1]</th>
      <td>-1.730</td>
      <td>0.216</td>
      <td>-2.145</td>
      <td>-1.361</td>
      <td>0.011</td>
      <td>0.008</td>
      <td>436.0</td>
      <td>429.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>b</th>
      <td>0.122</td>
      <td>0.096</td>
      <td>0.000</td>
      <td>0.299</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>431.0</td>
      <td>569.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>obs: This model not fitting like a book!</p>
<p><em>TODO</em>: Read this in future!</p>
<p>Explanations:
<a class="reference external" href="https://github.com/pymc-devs/pymc-resources/blob/main/Rethinking_2/Chp_11.ipynb">https://github.com/pymc-devs/pymc-resources/blob/main/Rethinking_2/Chp_11.ipynb</a></p>
<p>The model described in the book does not sample well in PyMC. It does slightly better if we change the pivot category to be the first career instead of the third, but this is still suboptimal because we are discarding predictive information from the pivoted category (i.e., its unique career income).</p>
<p>In fact, it is not necessary to pivot the coefficients of variables that are distinct for each category (what the author calls predictors matched to outcomes), as it is done for the coefficients of shared variables (what the author calles predictors matched to observations). The intercepts belong to the second category, and as such they still need to be pivoted. These two references explain this distinction clearly:</p>
<p>Hoffman, S. D., &amp; Duncan, G. J. (1988). Multinomial and conditional logit discrete-choice models in demography. Demography, 25(3), 415-427 <a class="reference external" href="https://www.jstor.org/stable/pdf/2061541.pdf">pdf link</a>
Croissant, Y. (2020). Estimation of Random Utility Models in R: The mlogit Package. Journal of Statistical Software, 95(1), 1-41 pdf <a class="reference external" href="https://www.jstatsoft.org/index.php/jss/article/view/v095i11/v95i11.pdf">pdf link</a></p>
</div>
<div class="section" id="r-code-11-58">
<h3>R Code 11.58<a class="headerlink" href="#r-code-11-58" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">model_11_13</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">a</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">model_11_13</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">b</span>


<span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">a_dim_0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">income</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">s2_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">a_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">income</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">s2_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">a_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">income</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">p_orig</span> <span class="o">=</span> <span class="p">[</span><span class="n">softmax</span><span class="p">([</span><span class="n">s1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s2_old</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span> <span class="p">]</span>
<span class="n">p_new</span>  <span class="o">=</span> <span class="p">[</span><span class="n">softmax</span><span class="p">([</span><span class="n">s1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s2_new</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span> <span class="p">]</span>

<span class="c1"># Summarize</span>
<span class="n">p_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">p_new</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">p_orig</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">p_new</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">p_orig</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p_diff</span><span class="p">],</span> <span class="n">model_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;old&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_new_to_old&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">p_diff</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_207_0.png" src="_images/parte_11_207_0.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>arviz - WARNING - Shape validation failed: input_shape: (1, 4000), minimum_shape: (chains=2, draws=4)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>x</th>
      <td>0.038</td>
      <td>0.033</td>
      <td>0.0</td>
      <td>0.101</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>436.0</td>
      <td>554.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>So on average a <span class="math notranslate nohighlight">\(5\%\)</span> increase in probability of choosing the career, when the income is doubled.</p>
</div>
</div>
<div class="section" id="predictors-matched-to-observations-pg-362">
<h2>Predictors Matched to observations (pg 362)<a class="headerlink" href="#predictors-matched-to-observations-pg-362" title="Permalink to this headline">¶</a></h2>
<div class="section" id="r-code-11-59">
<h3>R Code 11.59<a class="headerlink" href="#r-code-11-59" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">500</span>

<span class="c1"># Simulate family incomes for each individual</span>
<span class="n">family_income</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">career</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">family_income</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">([</span><span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">score</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">career</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    
<span class="n">career</span> <span class="o">=</span> <span class="n">career</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Career choiced: &#39;</span><span class="p">,</span> <span class="n">career</span><span class="p">[:</span><span class="mi">15</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Family Income: &#39;</span><span class="p">,</span> <span class="n">family_income</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Career choiced:  [3 3 1 3 3 3 3 2 3 3 2 3 2 3 3]
Family Income:  [0.88220597 0.26090131 0.41481564 0.95091294 0.31800893]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data{</span>
<span class="s2">        int N;</span>
<span class="s2">        int K;</span>
<span class="s2">        array[N] int career;</span>
<span class="s2">        array[N] real family_income;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[K-1] a; // intercepts</span>
<span class="s2">        vector[K-1] b; // coefficients on family income</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[K] p;</span>
<span class="s2">        vector[K] s;</span>
<span class="s2">        </span>
<span class="s2">        a ~ normal(1, 1.5);</span>
<span class="s2">        b ~ normal(0, 1);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N) {</span>
<span class="s2">            for (j in 1:(K-1)) s[j] = a[j] + b[j]*family_income[i];</span>
<span class="s2">            s[K] = 0;</span>
<span class="s2">            p = softmax( s );</span>
<span class="s2">            career[i] ~ categorical( p );</span>
<span class="s2">        }</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
    <span class="s1">&#39;career&#39;</span><span class="p">:</span> <span class="n">career</span><span class="p">,</span>
    <span class="s1">&#39;family_income&#39;</span><span class="p">:</span> <span class="n">family_income</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_11_14</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_11_14</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a[0]</th>
      <td>-1.306</td>
      <td>0.266</td>
      <td>-1.802</td>
      <td>-0.812</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>2149.0</td>
      <td>2219.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>a[1]</th>
      <td>-0.639</td>
      <td>0.201</td>
      <td>-1.019</td>
      <td>-0.270</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>2279.0</td>
      <td>2078.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>b[0]</th>
      <td>-2.276</td>
      <td>0.550</td>
      <td>-3.329</td>
      <td>-1.255</td>
      <td>0.012</td>
      <td>0.008</td>
      <td>2176.0</td>
      <td>2278.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>b[1]</th>
      <td>-1.536</td>
      <td>0.383</td>
      <td>-2.263</td>
      <td>-0.826</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>2294.0</td>
      <td>1994.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="multinomial-disguise-as-poisson">
<h2>Multinomial disguise as Poisson<a class="headerlink" href="#multinomial-disguise-as-poisson" title="Permalink to this headline">¶</a></h2>
<div class="section" id="r-code-11-60">
<h3>R Code 11.60<a class="headerlink" href="#r-code-11-60" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/UCBadmit.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>dept</th>
      <th>applicant.gender</th>
      <th>admit</th>
      <th>reject</th>
      <th>applications</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>A</td>
      <td>male</td>
      <td>512</td>
      <td>313</td>
      <td>825</td>
    </tr>
    <tr>
      <th>2</th>
      <td>A</td>
      <td>female</td>
      <td>89</td>
      <td>19</td>
      <td>108</td>
    </tr>
    <tr>
      <th>3</th>
      <td>B</td>
      <td>male</td>
      <td>353</td>
      <td>207</td>
      <td>560</td>
    </tr>
    <tr>
      <th>4</th>
      <td>B</td>
      <td>female</td>
      <td>17</td>
      <td>8</td>
      <td>25</td>
    </tr>
    <tr>
      <th>5</th>
      <td>C</td>
      <td>male</td>
      <td>120</td>
      <td>205</td>
      <td>325</td>
    </tr>
    <tr>
      <th>6</th>
      <td>C</td>
      <td>female</td>
      <td>202</td>
      <td>391</td>
      <td>593</td>
    </tr>
    <tr>
      <th>7</th>
      <td>D</td>
      <td>male</td>
      <td>138</td>
      <td>279</td>
      <td>417</td>
    </tr>
    <tr>
      <th>8</th>
      <td>D</td>
      <td>female</td>
      <td>131</td>
      <td>244</td>
      <td>375</td>
    </tr>
    <tr>
      <th>9</th>
      <td>E</td>
      <td>male</td>
      <td>53</td>
      <td>138</td>
      <td>191</td>
    </tr>
    <tr>
      <th>10</th>
      <td>E</td>
      <td>female</td>
      <td>94</td>
      <td>299</td>
      <td>393</td>
    </tr>
    <tr>
      <th>11</th>
      <td>F</td>
      <td>male</td>
      <td>22</td>
      <td>351</td>
      <td>373</td>
    </tr>
    <tr>
      <th>12</th>
      <td>F</td>
      <td>female</td>
      <td>24</td>
      <td>317</td>
      <td>341</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">admit</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([512,  89, 353,  17, 120, 202, 138, 131,  53,  94,  22,  24])
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_bin</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data{</span>
<span class="s2">        int N;</span>
<span class="s2">        array[N] int admit;</span>
<span class="s2">        array[N] int applications;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real a;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        real p;</span>
<span class="s2">        </span>
<span class="s2">        a ~ normal(0, 1.5);</span>
<span class="s2">        p = inv_logit(a);</span>
<span class="s2">        </span>
<span class="s2">        admit ~ binomial(applications, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list_bin</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
    <span class="s1">&#39;admit&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">admit</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;applications&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_bin</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_bin</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list_bin</span><span class="p">)</span>
<span class="n">samples_bin</span> <span class="o">=</span> <span class="n">posteriori_bin</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_bin</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples_bin</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori_bin</span> 
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-62">
<h3>R Code 11.62<a class="headerlink" href="#r-code-11-62" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span>
    <span class="n">m_bin</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span>
    <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transform</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">m_bin</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">a</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_222_0.png" src="_images/parte_11_222_0.png" />
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>0.388</td>
      <td>0.007</td>
      <td>0.374</td>
      <td>0.402</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1343.0</td>
      <td>1691.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># RCode 11.61 - Poisson model</span>

<span class="n">model_poi</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data{</span>
<span class="s2">        int N;</span>
<span class="s2">        array[N] int admit;</span>
<span class="s2">        array[N] int rej;</span>
<span class="s2">        array[N] int applications;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real a1;</span>
<span class="s2">        real a2;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        real lambda_1;</span>
<span class="s2">        real lambda_2;</span>
<span class="s2">        </span>
<span class="s2">        a1 ~ normal(0, 1.5);</span>
<span class="s2">        a2 ~ normal(0, 1.5);</span>
<span class="s2">        </span>
<span class="s2">        lambda_1 = exp(a1);</span>
<span class="s2">        lambda_2 = exp(a2);</span>
<span class="s2">        </span>
<span class="s2">        admit ~ poisson(lambda_1);</span>
<span class="s2">        rej ~ poisson(lambda_2);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list_poi</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
    <span class="s1">&#39;admit&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">admit</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;rej&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">reject</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;applications&#39;</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">applications</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_poi</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_poi</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list_poi</span><span class="p">)</span>
<span class="n">samples_poi</span> <span class="o">=</span> <span class="n">posteriori_poi</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_poi</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples_poi</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori_poi</span> 
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-11-63">
<h3>R Code 11.63<a class="headerlink" href="#r-code-11-63" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lam1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_poi</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
<span class="n">lam2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m_poi</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">a2</span><span class="p">)</span>

<span class="n">resp</span> <span class="o">=</span> <span class="n">lam1</span> <span class="o">/</span> <span class="p">(</span><span class="n">lam1</span> <span class="o">+</span> <span class="n">lam2</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> 
               <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
               <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_11_226_0.png" src="_images/parte_11_226_0.png" />
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>x</th>
      <td>0.388</td>
      <td>0.007</td>
      <td>0.374</td>
      <td>0.401</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3787.0</td>
      <td>2203.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="parte_10.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">10 - Grande Entropia e Modelos Lineares Generalizados</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="parte_12.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">12 - Monstros e Misturas</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Rodolpho Macedo dos Santos<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>