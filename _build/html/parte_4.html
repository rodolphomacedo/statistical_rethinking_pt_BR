
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4 - Funções Wiggly &#8212; Statistical Rethinking</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5 - Muitas Variáveis e os Waffles Espúrios" href="parte_5.html" />
    <link rel="prev" title="3- Modelos Geocêntricos" href="parte_3.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="capa.html">
   Estatistica Bayesiana
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_pt-BR.html">
   Intro - Estatística Bayesiana (🇧🇷)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intro_en.html">
   Intro - Bayesian Statistics (🇺🇸)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_1.html">
   1- Introdução
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_2.html">
   2 - Engenharia de Golems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_3.html">
   3- Modelos Geocêntricos
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   4 - Funções Wiggly
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_5.html">
   5 - Muitas Variáveis e os Waffles Espúrios
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/parte_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR/issues/new?title=Issue%20on%20page%20%2Fparte_4.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/rodolphomacedo/statistical_rethinking_pt_BR/main?urlpath=tree/parte_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   4 - Funções Wiggly
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-observacao-da-nossa-incerteza">
     A observação da nossa Incerteza
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#construindo-a-distribuicao-preditiva-de-mu-i-dado-um-peso-x-i">
     Construindo a Distribuição Preditiva de
     <span class="math notranslate nohighlight">
      \(\mu_i\)
     </span>
     , dado um peso
     <span class="math notranslate nohighlight">
      \(x_i\)
     </span>
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculando-a-predicao-para-todos-os-mu-i">
     Calculando a predição para todos os
     <span class="math notranslate nohighlight">
      \(\mu_i\)
     </span>
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#a-compatibilidade-da-gravata-borboleta">
       A Compatibilidade da Gravata Borboleta
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#curvas-a-partir-das-linhas-retas">
     Curvas a partir das Linhas Retas
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regressao-polinomial">
   Regressão Polinomial
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modelo-parabolico-da-altura">
     Modelo Parabólico da Altura
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#padronizar-os-preditores">
     Padronizar os Preditores
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#modelos-cubicos">
   Modelos Cúbicos
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modelo-regressao-cubico-para-a-altura">
     Modelo Regressão Cúbico para a Altura
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dores-dos-polinomios">
     Dores dos Polinômios
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#splines">
   Splines
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#agindo-localmente-b-splines">
     Agindo Localmente -
     <em>
      B-splines
     </em>
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#festival-das-flores-de-cerejeira">
     Festival das Flores de Cerejeira
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#como-as-splines-funcionam">
       Como as splines funcionam?
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#knots-como-escolher-os-pontos">
       Knots - Como escolher os pontos?
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#possibilidades-das-splines">
     Possibilidades das Splines
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="funcoes-wiggly">
<h1>4 - Funções Wiggly<a class="headerlink" href="#funcoes-wiggly" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="_images/cat_bow_tie.jpg"><img alt="_images/cat_bow_tie.jpg" src="_images/cat_bow_tie.jpg" style="width: 1000px;" /></a>
<p><a class="reference external" href="https://www.youtube.com/watch?v=ENxTrFf9a7c"></a></p>
<hr class="docutils" />
<p>No capítulo anterior vimos como construir o nosso primeiro modelo de regressão linear, no qual estimamos a altura de uma pessoa usando a informação de seu próprio peso como um auxílio informativo. Temos, assim, como resultado do nosso modelo, a distribuição à posteriori dos parâmetros que foram estimados, <span class="math notranslate nohighlight">\(\alpha\)</span>, <span class="math notranslate nohighlight">\(\beta\)</span> e o <span class="math notranslate nohighlight">\(\sigma\)</span>.</p>
<div class="admonition-modelo-linear-simples admonition">
<p class="admonition-title">Modelo Linear Simples</p>
<div class="math notranslate nohighlight">
\[ altura_i = \alpha + \beta (peso_i - peso\_medio) \]</div>
</div>
<p>Das distribuições à posteriori dos parâmetros podemos pegar apenas os valores <code class="docutils literal notranslate"><span class="pre">&quot;precisos&quot;</span></code> desses parâmetros, ou seja, geralmente nós tendemos <code class="docutils literal notranslate"><span class="pre">pensar</span> <span class="pre">apenas</span> <span class="pre">com</span> <span class="pre">os</span> <span class="pre">valores</span> <span class="pre">esperados</span></code> (<em><code class="docutils literal notranslate"><span class="pre">valores</span> <span class="pre">médios</span></code></em>) da distribuição do <span class="math notranslate nohighlight">\(\alpha\)</span> e do <span class="math notranslate nohighlight">\(\beta\)</span> e, com isso, traçar uma linha reta com esses valores.</p>
<p>Olhando para os resultados das inferências dos parâmetros, quando o <strong>peso</strong> está em seu valor médio, temos que <span class="math notranslate nohighlight">\(\alpha\)</span> significa o valor médio da altura!</p>
<p>Percebeu? Percebeu como isso é muito bonito! Agora temos uma interpretação decente para o <span class="math notranslate nohighlight">\(\alpha\)</span>!</p>
<p>Agora, o que significa o nosso <span class="math notranslate nohighlight">\(\beta\)</span>? Temos que para cada unidade de <span class="math notranslate nohighlight">\(peso\)</span> que aumentarmos a altura <span class="math notranslate nohighlight">\(h\)</span> também aumentará em <span class="math notranslate nohighlight">\(\beta\)</span> unidades. Assim, para nosso exemplo, <code class="docutils literal notranslate"><span class="pre">cada</span> <span class="pre">kilo</span> <span class="pre">que</span> <span class="pre">aumentarmos,</span> <span class="pre">a</span> <span class="pre">altura</span> <span class="pre">também</span> <span class="pre">tende</span> <span class="pre">a</span> <span class="pre">aumentar</span></code>, em média, <span class="math notranslate nohighlight">\(0.90\)</span>cm.</p>
<p>Mas sabemos que isso é insuficiente, porque queremos obter a incerteza a partir desse gráfico. A estatística bayesiana não lhe dará uma única estimativa pontual, mas sim, <code class="docutils literal notranslate"><span class="pre">dará</span> <span class="pre">a</span> <span class="pre">SUA</span> <span class="pre">incerteza,</span> <span class="pre">que</span> <span class="pre">é</span> <span class="pre">comunicada</span> <span class="pre">a</span> <span class="pre">nós</span> <span class="pre">pela</span> <span class="pre">distribuição</span> <span class="pre">à</span> <span class="pre">posteriori</span></code>. Essa incerteza é representada pelo <em>número infinito de linhas</em>, e cada uma dessas linhas são classificadas pela sua <code class="docutils literal notranslate"><span class="pre">plausibilidade</span> <span class="pre">relativa</span></code> (<em>sua probabilidade</em>) em comparação todas as outras linhas!</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>OBS: A partir de agora irei definir as variáveis em Inglês, mas os comentários continuarão em português para facilitar o entendimento seguir com o propósito do material.</p>
<p>Em ambientes profissionais é recomendado escrever tudo em inglês.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">stan</span>
<span class="kn">import</span> <span class="nn">nest_asyncio</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;pystan&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">propagate</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Desbloqueio do asyncIO do jupyter</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Definindo o plano de fundo cinza claro para todos os gráficos feitos no matplotlib</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lendo os dados</span>

<span class="c1"># Os dados podem serem obtidos em https://github.com/rmcelreath/rethinking/tree/master/data/Howell1.csv</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/Howell1.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>  

<span class="n">weight</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Filtro para pessoas com 30 anos ou mais </span>
<span class="n">height</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Filtro para pessoas com 30 anos ou mais</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_stan</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">        vector[N] weight;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta;</span>
<span class="s2">        real&lt;lower=0, upper=50&gt; sigma;  // Priori implícita Uniforme(0, 50)</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(178, 20);  // Priori para Alpha</span>
<span class="s2">        beta ~ lognormal(0, 1);  // Priori para Beta</span>
<span class="s2">        </span>
<span class="s2">        height ~ normal(alpha + beta * weight, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =============================================================</span>
<span class="c1">#    Estimativa da altura explicada com a variável peso.</span>
<span class="c1"># =============================================================</span>
<span class="c1"># Reescrevendo o modelo anterior </span>

<span class="c1"># Lembrando que estamos usando o (x_i - x_barra) e não apenas x_i</span>
<span class="n">weight_adjust</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 

<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_adjust</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Recuperando os parâmetros</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==========================================</span>
<span class="c1">#  Plotando os histogramas dos Parâmentros</span>
<span class="c1"># ==========================================</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="c1"># Parâmetro: alpha</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Alpha&#39;</span><span class="p">)</span>

<span class="c1"># Parâmetro: beta</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Beta&#39;</span><span class="p">)</span>

<span class="c1"># Parâmetro: sigma</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Sigma&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_13_0.png" src="_images/parte_4_13_0.png" />
</div>
</div>
<div class="section" id="a-observacao-da-nossa-incerteza">
<h2>A observação da nossa Incerteza<a class="headerlink" href="#a-observacao-da-nossa-incerteza" title="Permalink to this headline">¶</a></h2>
<p>Agora nós iremos fazer a amostragem das <em>posterioris</em>. Uma das razões para usarmos esse procedimento de amostragem é que isso torna mais fácil de se pensar e, também, esse procedimento pode ser aplicado a <strong>todos</strong> os tipos de modelos possíveis bayesianos que quisermos ajustar.</p>
<p>Nossa distribuição à posteriori contém muitas linhas retas lá dentro, representadas pela amostragem dos valores da distribuição dos <span class="math notranslate nohighlight">\(\alpha\)</span> e dos <span class="math notranslate nohighlight">\(\beta\)</span> com o <span class="math notranslate nohighlight">\(\sigma\)</span> informando o desvio padrão.</p>
<p>Abaixo vamos ver as primeiras linhas do conjunto de dados dessas estimativas e as suas medidas de resumo:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">[:</span><span class="mi">10</span><span class="p">]}))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        alpha      beta     sigma
0  154.971707  0.986113  5.461547
1  154.761763  0.916562  5.161238
2  154.164587  0.927024  4.896515
3  154.715754  0.890082  5.320681
4  154.612796  0.967634  5.275184
5  154.761763  0.916562  5.161238
6  154.032912  0.954426  5.001520
7  154.485128  0.933299  4.972606
8  154.198064  0.859681  5.386437
9  153.794424  0.980877  5.446497
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Para cada linha do conjunto de dados acima é uma linha reta no nosso modelo!</p>
</div>
<p>e o resumo dos dados:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">[:</span><span class="mi">10</span><span class="p">]})</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>alpha</th>
      <th>beta</th>
      <th>sigma</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>10.000000</td>
      <td>10.000000</td>
      <td>10.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>154.449890</td>
      <td>0.933226</td>
      <td>5.208346</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.382042</td>
      <td>0.040229</td>
      <td>0.202665</td>
    </tr>
    <tr>
      <th>min</th>
      <td>153.794424</td>
      <td>0.859681</td>
      <td>4.896515</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>154.172956</td>
      <td>0.916562</td>
      <td>5.041449</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>154.548962</td>
      <td>0.930161</td>
      <td>5.218211</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>154.750261</td>
      <td>0.964332</td>
      <td>5.369998</td>
    </tr>
    <tr>
      <th>max</th>
      <td>154.971707</td>
      <td>0.986113</td>
      <td>5.461547</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Nós temos muitas linhas! E as linhas <code class="docutils literal notranslate"><span class="pre">mais</span> <span class="pre">plausíveis</span> <span class="pre">são</span> <span class="pre">as</span> <span class="pre">linhas</span> <span class="pre">que</span> <span class="pre">tem</span> <span class="pre">maior</span> <span class="pre">número</span> <span class="pre">de</span> <span class="pre">maneiras</span> <span class="pre">de</span> <span class="pre">reproduzir</span> <span class="pre">os</span> <span class="pre">dados</span> <span class="pre">que</span> <span class="pre">observamos</span></code>. Essa plausabilidade é apresentada para nós através do maior acúmulo de linhas retas que se sobrepõem.</p>
<p>Quanto mais as linhas se sobreporem entre si em uma certa região, <code class="docutils literal notranslate"><span class="pre">maior</span> <span class="pre">será</span> <span class="pre">a</span> <span class="pre">plausabilidade</span> <span class="pre">dessas</span> <span class="pre">retas</span> <span class="pre">descreverem</span> <span class="pre">os</span> <span class="pre">dados</span> <span class="pre">que</span> <span class="pre">observamos</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">O</span> <span class="pre">acúmulo</span> <span class="pre">dessas</span> <span class="pre">retas</span> <span class="pre">representa</span> <span class="pre">a</span> <span class="pre">nossa</span> <span class="pre">incerteza.</span></code></p>
</div>
<p>Foi primeira vez que conseguimos realmente observar, conscientemente, a nossa incerteza em um gráfico. <em>Lindo demais</em>!!!</p>
<p>Para termos uma melhor compreensão nesse momento, nós vamos supor que ao invés de nossa amostra ter 251 indivíduos, vamos supor que temos apenas alguns subconjuntos. Nosso objetivo aqui é mostrar que quanto mais informações temos (isto é, quanto <em>maior a nossa amostra</em>), menor será a nossa incerteza!</p>
<p>Para ficar mais claro, vamos simular a essa nossa estratégia e ver as diferenças dos <strong>acúmulos das linhas</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ajustando as estimativas de um modelo linear </span>
<span class="sd">    usando os primeiros N indivíduos da amostra.</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        N: Quantidade de indivíduos que iremos </span>
<span class="sd">           utilizar na estimativa dos parâmetros.</span>
<span class="sd">    </span>
<span class="sd">    Return: </span>
<span class="sd">       Estimativas do alpha, beta e o sigma, dado os dados. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weight_adjust</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 

    <span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">[:</span><span class="n">N</span><span class="p">],</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_adjust</span><span class="p">[:</span><span class="n">N</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># Recuperando os parâmetros</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =====================================================</span>
<span class="c1">#   Rodando o modelo anterior utilizando diferentes N</span>
<span class="c1"># =====================================================</span>

<span class="n">N_10</span> <span class="o">=</span> <span class="mi">10</span>     
<span class="n">alpha_10</span><span class="p">,</span> <span class="n">beta_10</span><span class="p">,</span> <span class="n">sigma_10</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N_10</span><span class="p">);</span>


<span class="n">N_50</span> <span class="o">=</span> <span class="mi">50</span>     
<span class="n">alpha_50</span><span class="p">,</span> <span class="n">beta_50</span><span class="p">,</span> <span class="n">sigma_50</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N_50</span><span class="p">);</span>


<span class="n">N_100</span> <span class="o">=</span> <span class="mi">100</span>     
<span class="n">alpha_100</span><span class="p">,</span> <span class="n">beta_100</span><span class="p">,</span> <span class="n">sigma_100</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N_100</span><span class="p">);</span>


<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span> <span class="c1"># Com toda amostra disponível</span>
<span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Uma das vantagens do gráfico gráfico de linhas (gráfico de espaguetes) é deixar claro que os limites formados pelas retas não tem significado algum.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =============================</span>
<span class="c1">#     Gráfico de Espaguete</span>
<span class="c1"># =============================</span>
<span class="c1"># Vamos usar a variável weight_adjust igual para todos os </span>
<span class="c1"># pesos sem perda de generalidade para essa análise.</span>

<span class="c1"># Plot dos dados altura x peso</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">[[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">],</span> <span class="p">[</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>

<span class="c1"># Número de linhas retas que iremos plotar</span>
<span class="n">qty_lines</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 10 amostras</span>
<span class="c1"># ===============================================</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_10</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_10</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha_10</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_10</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_10</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>


<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 50 amostras</span>
<span class="c1"># ===============================================</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_50</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_50</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha_50</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_50</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_50</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>


<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 100 amostras</span>
<span class="c1"># ===============================================</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_100</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_100</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha_100</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_100</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>


<span class="c1"># =================================================</span>
<span class="c1">#    Estimando as curvas usando todas as amostras</span>
<span class="c1"># =================================================</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (todos) pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_23_0.png" src="_images/parte_4_23_0.png" />
</div>
</div>
<p>A divisão dos gráficos acima foi construída para conseguirmos percerber, de modo visual, <code class="docutils literal notranslate"><span class="pre">que</span> <span class="pre">quando</span> <span class="pre">mais</span> <span class="pre">amostras</span> <span class="pre">tivermos</span> <span class="pre">coletado</span></code> (isto é, <em>quanto maior número de pontos azuis nós tivermos coletados como amostra</em>), mais informações teremos e, portanto, teremos muito <code class="docutils literal notranslate"><span class="pre">menos</span> <span class="pre">incerteza</span></code> sobre o nosso objeto de estudo.</p>
<p>A nossa incerteza pode ser observada pela <em>dispersão</em> das curvas no gráfico, portanto <code class="docutils literal notranslate"><span class="pre">quanto</span> <span class="pre">maior</span> <span class="pre">for</span> <span class="pre">a</span> <span class="pre">dispersão</span> <span class="pre">maior</span> <span class="pre">será</span> <span class="pre">a</span> <span class="pre">nossa</span> <span class="pre">incerteza</span></code> sobre o que está acontecendo.</p>
</div>
<div class="section" id="construindo-a-distribuicao-preditiva-de-mu-i-dado-um-peso-x-i">
<h2>Construindo a Distribuição Preditiva de <span class="math notranslate nohighlight">\(\mu_i\)</span>, dado um peso <span class="math notranslate nohighlight">\(x_i\)</span><a class="headerlink" href="#construindo-a-distribuicao-preditiva-de-mu-i-dado-um-peso-x-i" title="Permalink to this headline">¶</a></h2>
<p>Modelo linear para a altura média <span class="math notranslate nohighlight">\(\mu_i\)</span> é:</p>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha + \beta(x_i - \bar{x}) \]</div>
<p>Agora, a ideia básica é que, dado um valor específico do peso de um indivíduo, <span class="math notranslate nohighlight">\(x_i\)</span> (<em>weight</em>), podemos obter uma distribuição preditiva do <span class="math notranslate nohighlight">\(\mu_i\)</span>. Essa distribuição preditiva nos informa quais as regiões de maior confiança que podemos esperar para a média da altura, de uma pessoa com o peso <span class="math notranslate nohighlight">\(x_i\)</span>.</p>
<p>Para exemplificar, vamos supor que queremos estimar a altura (<em>height</em>) de uma pessoa com <span class="math notranslate nohighlight">\(50 kg\)</span>, então:</p>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha + \beta(50 - \bar{x}) \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===========================================================</span>
<span class="c1">#    Construindo a distribuição preditiva de 𝜇 | x=50</span>
<span class="c1"># ===========================================================</span>

<span class="n">mu_50_kg</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mu_50_kg</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribuição de $\mu_i$ para o peso de $50 kg$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Plausabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$\mu | peso=50$&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_26_0.png" src="_images/parte_4_26_0.png" />
</div>
</div>
</div>
<div class="section" id="calculando-a-predicao-para-todos-os-mu-i">
<h2>Calculando a predição para todos os <span class="math notranslate nohighlight">\(\mu_i\)</span><a class="headerlink" href="#calculando-a-predicao-para-todos-os-mu-i" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">HPDI</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">,</span> <span class="n">credible_mass</span><span class="p">):</span>
    
    <span class="c1"># Calcula o maior intervalo de probabilidades a partir de uma amostra</span>
    
    <span class="c1"># Fonte: https://stackoverflow.com/questions/22284502/highest-posterior-density-region-and-central-credible-region</span>
    <span class="c1"># ** Refazer essa função para entender **</span>
    
    <span class="n">sorted_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">)</span>
    <span class="n">ciIdxInc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">credible_mass</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_points</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">nCIs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_points</span><span class="p">)</span> <span class="o">-</span> <span class="n">ciIdxInc</span>
    <span class="n">ciWidth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nCIs</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCIs</span><span class="p">):</span>
        <span class="n">ciWidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ciIdxInc</span><span class="p">]</span> <span class="o">-</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">HDImin</span> <span class="o">=</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">ciWidth</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ciWidth</span><span class="p">))]</span>
        <span class="n">HDImax</span> <span class="o">=</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">ciWidth</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ciWidth</span><span class="p">))</span><span class="o">+</span><span class="n">ciIdxInc</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">HDImin</span><span class="p">,</span> <span class="n">HDImax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =====================================</span>
<span class="c1">#    Calculando o HPDI dos dados</span>
<span class="c1"># =====================================</span>

<span class="n">posterioris_dict_10</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>
<span class="n">posterioris_dict_50</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>
<span class="n">posterioris_dict_100</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>
<span class="n">posterioris_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">):</span>
    <span class="n">posterioris_dict_10</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_10</span> <span class="o">+</span> <span class="n">beta_10</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">posterioris_dict_50</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_50</span> <span class="o">+</span> <span class="n">beta_50</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">posterioris_dict_100</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_100</span> <span class="o">+</span> <span class="n">beta_100</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">posterioris_dict</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
<span class="c1"># Gerando os dataframes</span>
<span class="n">posterioris_10</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict_10</span><span class="p">)</span>
<span class="n">posterioris_50</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict_50</span><span class="p">)</span>
<span class="n">posterioris_100</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict_100</span><span class="p">)</span>
<span class="n">posterioris</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict</span><span class="p">)</span>

<span class="c1"># Calculando as médias das posterioris</span>
<span class="n">posterioris_means_10</span> <span class="o">=</span> <span class="n">posterioris_10</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">posterioris_means_50</span> <span class="o">=</span> <span class="n">posterioris_50</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">posterioris_means_100</span> <span class="o">=</span> <span class="n">posterioris_100</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">posterioris_means</span> <span class="o">=</span> <span class="n">posterioris</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Calculando os intervalos de HPDI das posterioris</span>
<span class="n">posterioris_HPDIs_10</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posterioris_HPDIs_50</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posterioris_HPDIs_100</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posterioris_HPDIs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">):</span>
    <span class="n">posterioris_HPDIs_10</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris_10</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    <span class="n">posterioris_HPDIs_50</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris_50</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    <span class="n">posterioris_HPDIs_100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris_100</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    <span class="n">posterioris_HPDIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    
<span class="c1"># Tranformando os dados em um array numpy    </span>
<span class="n">posterioris_HPDIs_10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs_10</span><span class="p">)</span>  
<span class="n">posterioris_HPDIs_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs_50</span><span class="p">)</span> 
<span class="n">posterioris_HPDIs_100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs_100</span><span class="p">)</span>
<span class="n">posterioris_HPDIs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="a-compatibilidade-da-gravata-borboleta">
<h3>A Compatibilidade da Gravata Borboleta<a class="headerlink" href="#a-compatibilidade-da-gravata-borboleta" title="Permalink to this headline">¶</a></h3>
<p>Conforme os quatro gráficos plotados acima, iremos replotá-los porém agora mostrando o <code class="docutils literal notranslate"><span class="pre">intervalo</span> <span class="pre">de</span> <span class="pre">compatibilidade</span></code> (<em>estilo gravata borboleta</em>).</p>
<a class="reference internal image-reference" href="_images/bow_tie.jpg"><img alt="Bow Tie" src="_images/bow_tie.jpg" style="width: 1000px;" /></a>
<p>Ao olhar para esse gráfico é fácil cairmos na tentação de acharmos que os limites que escolhemos significa alguma coisa, <code class="docutils literal notranslate"><span class="pre">ele</span> <span class="pre">não</span> <span class="pre">tem</span> <span class="pre">nenhum</span> <span class="pre">significado</span></code> a não ser os limites de corte pelo HPDI que escolhemos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================================</span>
<span class="c1">#       Plotando os gráfico de gravata borboletas</span>
<span class="c1"># ==================================================</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">[[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">],</span> <span class="p">[</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 10 amostras</span>
<span class="c1"># ===============================================</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_10</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs_10</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_10</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_10</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means_10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média altura com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_10</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 50 amostras</span>
<span class="c1"># ===============================================</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs_50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_50</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_50</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means_50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média alturacom N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_50</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 100 amostras</span>
<span class="c1"># ===============================================</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_100</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs_100</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_100</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_100</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means_100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média altura com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ==================================================</span>
<span class="c1">#    Estimando as curvas usando todas as amostras</span>
<span class="c1"># ==================================================</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média altura com todos os pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_31_0.png" src="_images/parte_4_31_0.png" />
</div>
</div>
<p>Perceba que nos gráficos de borboletas nós usamos os cortes para os intervalos com <span class="math notranslate nohighlight">\(89\%\)</span>. Isso é apenas para mostrar que não, isso mesmo, <code class="docutils literal notranslate"><span class="pre">não</span> <span class="pre">existe</span> <span class="pre">nada</span> <span class="pre">especial</span> <span class="pre">nos</span> <span class="pre">cortes</span> <span class="pre">do</span> <span class="pre">HPDI</span></code>.</p>
<p>Porém existem alguns cortes que são mais usados como o de <span class="math notranslate nohighlight">\(50%\)</span>, <span class="math notranslate nohighlight">\(90%\)</span> ou <span class="math notranslate nohighlight">\(95%\)</span>, corriqueiramente são usados em outras escolas estatísticas, são apenas cortes que queremos visualizar. <strong>Nada mais!</strong></p>
<p>Até agora nós fizemos os gráficos apenas usando os parâmetros da média (<span class="math notranslate nohighlight">\(\mu_i\)</span>), mas podemos construir o gráfico de envelope para o sigma (<span class="math notranslate nohighlight">\(\sigma\)</span>).</p>
<p>Iremos construir ambos utilizando toda a nossa amostra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================================================</span>
<span class="c1">#     Plotando o HPDI da distribuição preditiva da alutra e de sua média</span>
<span class="c1"># ============================================================================</span>

<span class="c1"># ===========================================</span>
<span class="c1"># Nota: Altere o valor para ver a diferença.</span>
<span class="c1"># ===========================================</span>
<span class="n">HPDI_range</span> <span class="o">=</span> <span class="mf">0.93</span>  <span class="c1"># Define o tamanho do intervalo do HPDI. </span>

<span class="n">posterioris_height_HPDIs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">):</span>
    <span class="n">posteiori_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="n">posterioris_height_HPDIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posteiori_height</span><span class="p">,</span> <span class="n">HPDI_range</span><span class="p">))</span>
    
<span class="n">posterioris_height_HPDIs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_height_HPDIs</span><span class="p">)</span>

<span class="c1"># Plontando o gráfico</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_height_HPDIs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da altura - Usando  HPDI  com &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HPDI_range</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% d</span><span class="s1">e massa de probabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_34_0.png" src="_images/parte_4_34_0.png" />
</div>
</div>
<p>Como podemos ver no gráfico acima, temos duas regiões de confiança. A região mais interna - <em>azul mais escura</em> - nos indica que esse trecho contém <span class="math notranslate nohighlight">\(89\%\)</span> de probabilidade da <code class="docutils literal notranslate"><span class="pre">média</span> <span class="pre">estar</span> <span class="pre">ali</span> <span class="pre">dentro</span></code>, para cada um dos pesos.</p>
<p>Já a região mais externa - <em>aquela faixa azul mais clara</em> - nos indica que, com <span class="math notranslate nohighlight">\(93\%\)</span> probabilidade, será a região mais provável da altura de um pessoa, dado um determinado peso.</p>
<p>Como teste para uma melhor compreensão, faça alterações na variável <code class="docutils literal notranslate"><span class="pre">HPDI_range</span></code> para valores bem altos, por exemplo, <span class="math notranslate nohighlight">\(0.99\)</span> e veja o quanto a faixa mais externa cobrirá os dados (<em>os pontos vermelhos</em>). Para valores menores, isso também ocorre, por exemplo, <span class="math notranslate nohighlight">\(0.7\)</span>.</p>
<p>Verifique!</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>A utilização de valores baixos, irá demandar cálculos mais complexos e por isso pode ser muito demorado.</p>
</div>
</div>
</div>
<div class="section" id="curvas-a-partir-das-linhas-retas">
<h2>Curvas a partir das Linhas Retas<a class="headerlink" href="#curvas-a-partir-das-linhas-retas" title="Permalink to this headline">¶</a></h2>
<p>O interessante de modelos lineares é que eles <code class="docutils literal notranslate"><span class="pre">não</span> <span class="pre">são</span> <span class="pre">apenas</span> <span class="pre">lineares</span></code>, podem ser curvas também. Isso é uma coisa meio enlouquecedora sobre o termo que é convencionalmente usado para desenhar linhas retas em gráficos.</p>
<p>Mas uma regressão linear é <code class="docutils literal notranslate"><span class="pre">aditiva</span></code>, vamos ter que essa equação para média será a <code class="docutils literal notranslate"><span class="pre">soma</span> <span class="pre">de</span> <span class="pre">alguns</span> <span class="pre">parâmetros</span> <span class="pre">vezes</span> <span class="pre">algumas</span> <span class="pre">variáveis</span> <span class="pre">observadas</span></code>. Assim teremos a soma de um monte de termos.</p>
<p>Temos uma equação aditiva e coisas aditivas são lineares na matemática.</p>
<p>Mas para nós, as palavras “adtiva” e “linear” são diferentes, então chamaremos esses modelos de <code class="docutils literal notranslate"><span class="pre">Regressões</span> <span class="pre">Aditivas</span></code>. Porque, podemos usar coisas que não parecem linhas retas. E, de agora até o final do capítulo, iremos fazer isso,  <code class="docutils literal notranslate"><span class="pre">desenhar</span> <span class="pre">curvas</span> <span class="pre">a</span> <span class="pre">partir</span> <span class="pre">de</span> <span class="pre">linhas</span> <span class="pre">retas</span></code>.</p>
<p>Mas antes de continuar, gostaria de explicar o por que é interessante aprendermos a fazer esse tipo de modelagem?</p>
<p>Simples! Por que a <code class="docutils literal notranslate"><span class="pre">Natureza</span> <span class="pre">não</span> <span class="pre">se</span> <span class="pre">limita</span> <span class="pre">a</span> <span class="pre">se</span> <span class="pre">manifestar</span> <span class="pre">por</span> <span class="pre">relações</span> <span class="pre">lineares</span> <span class="pre">entre</span>&#160; <span class="pre">duas</span> <span class="pre">variáveis!</span></code> Os nossos intervalos podem ser aproximações úteis, mas geralmente são bobos.</p>
<p>No nosso caso, nós usamos as variáveis <span class="math notranslate nohighlight">\(altura\)</span> e <span class="math notranslate nohighlight">\(peso\)</span>, porém apenas para indivíduos que tivessem <span class="math notranslate nohighlight">\(30\)</span> anos ou mais. Se fossêmos usar todos os indivíduos a relação do <span class="math notranslate nohighlight">\(peso\)</span> e a <span class="math notranslate nohighlight">\(altura\)</span> não mais seria uma linha reta, mas sim uma curva!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="c1"># Indivíduos com menos de 18 anos de idade</span>
<span class="n">height_0_18</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_0_18</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Indivíduos maiores (ou iguais) de 18 anos de idade - Adultos</span>
<span class="n">height_18_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_18_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Plotando os gráficos</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_0_18</span><span class="p">,</span> <span class="n">height_0_18</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;De 0 a 17 anos de idade&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_18_</span><span class="p">,</span> <span class="n">height_18_</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;(Adultos) 18+ anos de idade&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Altura x peso | Todos os indivíduos da amostra&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_38_0.png" src="_images/parte_4_38_0.png" />
</div>
</div>
<p>Vamos ver dois modos de construir os modelos de <code class="docutils literal notranslate"><span class="pre">Regressão</span> <span class="pre">Aditivas</span></code>:</p>
<ul class="simple">
<li><p><strong>Regressão Polinomial</strong></p>
<ul>
<li><p>Usada de forma comum</p></li>
<li><p>Geralmente apresenta um comportamento bem ruim</p></li>
</ul>
</li>
</ul>
<p>Esse é um tipo bem comum de regressão, mas também é um modelo bem ruim. Não há nada de errado usar esse tipo de regressão supondo que você entenda o que <em>golem</em> está fazendo e assim usar de forma responsável. Geralmente se utilizam esse tipo de modelo sem uma devida atenção. Iremos ver o motivo dele serem mal comportados em breve.</p>
<ul class="simple">
<li><p><strong>Splines</strong></p>
<ul>
<li><p>São muito flexíveis</p></li>
<li><p>Altamente Geocêntrica</p></li>
</ul>
</li>
</ul>
<p>Existem muitos tipos de splines, mas nós iremos ver apenas as <code class="docutils literal notranslate"><span class="pre">splines</span> <span class="pre">de</span> <span class="pre">base</span></code>, que são provavelmente as mais comuns. Software de desenhos como <code class="docutils literal notranslate"><span class="pre">GIMP</span></code>, <code class="docutils literal notranslate"><span class="pre">Blender</span></code> e etc. que possuem essa ferramenta com o nome de <em>curvas de Bezier</em>, que nada mais são do que splines de base.</p>
<p>As Splines são muito flexíveis, muito mais flexíveis do que as Regressões Polinomiais, porém não apresentam a patologia que os polinômios apresentam e, por isso, são considerados, na maioria dos casos, melhores que as regressões polinômiais.</p>
<p>Porém, tanto as splines quantos as regressões polinomiais são <code class="docutils literal notranslate"><span class="pre">estratégias</span> <span class="pre">geocêntricas</span></code>, não há nada de científico nelas. São apenas aproximações como o * modelo de epiciclos de Ptolomeu*.</p>
<p>Extrapolações com esses modelos podem trazer <code class="docutils literal notranslate"><span class="pre">desastres</span> <span class="pre">nas</span> <span class="pre">predições</span></code>, por isso é necessário checar e entender o que está acontecendo com o modelo.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="regressao-polinomial">
<h1>Regressão Polinomial<a class="headerlink" href="#regressao-polinomial" title="Permalink to this headline">¶</a></h1>
<p>Estratégia puramente descritiva (<em>geocêntrica</em>) usando uma variável como preditora polinomial.</p>
<ul class="simple">
<li><p>1a Ordem (Linha): <span class="math notranslate nohighlight">\( \mu_i = \alpha + \beta_1x_i \)</span></p></li>
<li><p>2a Ordem (Parábola):  <span class="math notranslate nohighlight">\(\mu_i = \alpha + \beta_1x_i + \beta_2x^2_i\)</span></p></li>
</ul>
<div class="section" id="modelo-parabolico-da-altura">
<h2>Modelo Parabólico da Altura<a class="headerlink" href="#modelo-parabolico-da-altura" title="Permalink to this headline">¶</a></h2>
<p>O modelo parabólico pode ser definido da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ h_i \sim Normal(\mu_i, \sigma) \]</div>
<div class="math notranslate nohighlight">
\[ \mu_i =  \alpha + \beta_1x_i + \beta_2x^2_i \]</div>
<div class="math notranslate nohighlight">
\[ \alpha \sim Normal(178, 20) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_1 \sim  LogNormal(0, 1) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_2  \sim  Normal(0,  1) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma \sim Uniform(0,  50) \]</div>
<p>O problema desse modelo é que os termo <span class="math notranslate nohighlight">\(\beta_1\)</span> e <span class="math notranslate nohighlight">\(\beta_2\)</span> não tem um significado biológico, <code class="docutils literal notranslate"><span class="pre">isso</span> <span class="pre">é</span> <span class="pre">apenas</span> <span class="pre">um</span> <span class="pre">ajuste</span> <span class="pre">na</span> <span class="pre">curvatura</span> <span class="pre">da</span> <span class="pre">função</span></code>. Por esse motivo nós temos que simular para entender oque está acontecendo com à priori. Se não entendermos o que são essas variáveis, as nossas posterioris não teram sentido interpretativo.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Não é para não usar! Apenas use com responsabilidade.</p>
</div>
</div>
<div class="section" id="padronizar-os-preditores">
<h2>Padronizar os Preditores<a class="headerlink" href="#padronizar-os-preditores" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>É muito útil padronizar as variáveis preditoras antes de ajustar o modelo, temos algumas vantagens tais como:</p>
<ul>
<li><p>Torna o processo de estimação mais simples</p></li>
<li><p>Auxília na interpretação (<em>algumas vezes</em>)</p></li>
</ul>
</li>
</ul>
<p>Para padronizar as variáveis preditoras, siga os seguinte passos para todos os dados:</p>
<ul class="simple">
<li><p>subtrair cada valor da média da amostra.</p></li>
<li><p>dividir o valor obtido acima pelo desvio padrão da amostra.</p></li>
<li><p>Assim, essa operação resultará em: <span class="math notranslate nohighlight">\(Média = 0\)</span> ; <span class="math notranslate nohighlight">\(Desvio Padrão = 1\)</span></p></li>
</ul>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =================================================================</span>
<span class="c1">#       Construindo um Modelo de Regressão Parabólica | Parcial</span>
<span class="c1"># =================================================================</span>

<span class="n">weight_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># X_i</span>
<span class="n">height_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Y_i</span>

<span class="c1"># Utilizando os 10 primeiros dados para pessoas acimas dos 18 anos - Teste de ajuste</span>
<span class="n">height_full_18</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_full_18</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># Média e desvio padrão para todos os dados acima</span>
<span class="n">weight_full_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>
<span class="n">weight_full_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>

<span class="n">weight_full_18_normalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_full_18</span> <span class="o">-</span> <span class="n">weight_full_mean</span><span class="p">)</span><span class="o">/</span><span class="n">weight_full_std</span>   <span class="c1"># Padronizando as variáveis explicativa</span>

<span class="n">model_stan_regression_parabolic</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">data {</span>
<span class="s2">    int N;</span>
<span class="s2">    vector[N] weight;</span>
<span class="s2">    vector[N] weight_2;</span>
<span class="s2">    vector[N] height;</span>
<span class="s2">}</span>

<span class="s2">parameters {</span>
<span class="s2">    real alpha;</span>
<span class="s2">    real&lt;lower=0&gt; beta_1;</span>
<span class="s2">    real beta_2;</span>
<span class="s2">    real&lt;lower=0, upper=50&gt; sigma;  // Priori Uniform (0, 50)</span>
<span class="s2">}</span>

<span class="s2">model {</span>
<span class="s2">    alpha ~ normal(178, 20);</span>
<span class="s2">    beta_1 ~ lognormal(0, 1);</span>
<span class="s2">    beta_2 ~ normal(0, 1);</span>
<span class="s2">    </span>
<span class="s2">    height ~ normal(alpha + beta_1*weight + beta_2*weight_2, sigma);</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Construindo um dicionário com os dados</span>
<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight_full_18_normalized</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_full_18_normalized</span> <span class="p">,</span>
    <span class="s1">&#39;weight_2&#39;</span><span class="p">:</span> <span class="n">weight_full_18_normalized</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># x_i^2</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_full_18</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Rodando o modelo na Stan</span>
<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_regression_parabolic</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># O sufixo &#39;_rp&#39;, usado abaixo, é referênte ao modelo de Regressão Parabólica.</span>
<span class="n">alpha_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_1_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_2_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===================================================</span>
<span class="c1">#   Probabilidade à Posteriori de mu com N=10</span>
<span class="c1"># ===================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mu_poli</span> <span class="o">=</span> <span class="n">alpha_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_1_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">beta_2_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>   
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_poli</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Pontos da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_18_normalized</span><span class="p">,</span> <span class="n">height_full_18</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ajuste do modelo de Regressão Polinonimal com N=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weight_full</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; pontos da amostra.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_46_0.png" src="_images/parte_4_46_0.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Regressões</span> <span class="pre">Polinomiais</span></code> tem esse tipo de anomalia implícita que vimos no gráfico acima. Dentro da região dos pontos ela se comporta de modo aceitável, porém fora da região desses pontos, a função se torna descontrolada. Isso ocorre porque exitem muitas outras funções de segundo grau que podem ser ajustadas nesse conjunto de pontos. Isso não ocorre com tanta intensidade nas regressões com splines.</p>
<p>Perceba que para a <code class="docutils literal notranslate"><span class="pre">esquerda</span> <span class="pre">do</span> <span class="pre">zero</span></code> no eixo do peso (<em>peso está normalizado</em>) a função começa perder o controle e atinge valores que podem não ser verdadeiros.</p>
<p>Uma segundo inconveniente que ocorre com as Regressões Polinomiais é sua própria estrutura matemática. Apenas três parâmetros, o <span class="math notranslate nohighlight">\(\alpha\)</span>, o <span class="math notranslate nohighlight">\(\beta_1\)</span> e o <span class="math notranslate nohighlight">\(\beta_2\)</span>, controlam todo o comportamento da curva. Isso a torna um pouco mais rígida para situações que precisamos de mais flexibilidade. As splines padrões têm, em sua construção, o pesamento de uma estrutura que evita esse tipo de inconveniente.</p>
<p>Lembre-se, ambos modelos, tanto os polinomiais quanto modelos com splines, são modelos <em>geocêntricos</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =============================================================</span>
<span class="c1">#   Gráfico dos Histogramas das Posterioris dos Parâmentros</span>
<span class="c1"># =============================================================</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="c1"># Histograma da posteriori do alpha</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">alpha_rp</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Alpha&#39;</span><span class="p">)</span>

<span class="c1"># Histograma da posteriori do beta_1</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta_1_rp</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori $Beta_1$&#39;</span><span class="p">)</span>

<span class="c1"># Histograma da posteriori do beta_2</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta_2_rp</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori $Beta_2$&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_48_0.png" src="_images/parte_4_48_0.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================================================================</span>
<span class="c1">#       Construindo o Modelo de Regressão Parabólica | Usando a Amostra Completa</span>
<span class="c1"># ==================================================================================</span>

<span class="n">weight_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># X_i</span>
<span class="n">height_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Y_i</span>

<span class="n">weight_full_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>
<span class="n">weight_full_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>

<span class="n">weight_full_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_full</span> <span class="o">-</span> <span class="n">weight_full_mean</span><span class="p">)</span><span class="o">/</span><span class="n">weight_full_std</span>   <span class="c1"># Padronizando as variáveis explicativa</span>

<span class="n">model_stan_regression_parabolic</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] weight;</span>
<span class="s2">        vector[N] weight_2;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real&lt;lower=0&gt; beta_1;</span>
<span class="s2">        real beta_2;</span>
<span class="s2">        real&lt;lower=0, upper=50&gt; sigma;  // Priori Uniform (0, 50)</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(178, 20);</span>
<span class="s2">        beta_1 ~ lognormal(0, 1);</span>
<span class="s2">        beta_2 ~ normal(0, 1);</span>

<span class="s2">        height ~ normal(alpha + beta_1*weight + beta_2*weight_2, sigma);</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="p">,</span>
    <span class="s1">&#39;weight_2&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_full</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_regression_parabolic</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># rp := referênte ao modelo de Regressão Parabólica</span>
<span class="n">alpha_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_1_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_2_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===================================================</span>
<span class="c1">#   Probabilidade à Posteriori de mu</span>
<span class="c1"># ===================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mu_poli</span> <span class="o">=</span> <span class="n">alpha_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_1_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">beta_2_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>   
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_poli</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Pontos da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ajuste do modelo de Regressão Polinonimal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_50_0.png" src="_images/parte_4_50_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================</span>
<span class="c1">#      Probabilidade à Posteriori - HPDI</span>
<span class="c1"># ============================================</span>
<span class="n">posteriori_polinomial2_HPDI</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial2_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial2_sigma</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="n">mu_poli</span> <span class="o">=</span> <span class="n">alpha_rp</span> <span class="o">+</span> <span class="n">beta_1_rp</span> <span class="o">*</span> <span class="n">weight_i</span> <span class="o">+</span> <span class="n">beta_2_rp</span> <span class="o">*</span> <span class="n">weight_i</span><span class="o">**</span><span class="mi">2</span>  
    <span class="n">posteriori_polinomial2_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mu_poli</span><span class="p">))</span>  <span class="c1"># média</span>
    <span class="n">posteriori_polinomial2_HPDI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">mu_poli</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">))</span>  <span class="c1"># HPDI</span>
    <span class="n">posteriori_polinomial2_sigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu_poli</span><span class="p">,</span> <span class="n">sigma_rp</span><span class="p">),</span> <span class="mf">0.89</span><span class="p">))</span>
    
<span class="n">posteriori_polinomial2_HPDI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial2_HPDI</span><span class="p">)</span>
<span class="n">posteriori_polinomial2_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial2_sigma</span><span class="p">)</span>

<span class="c1"># Plontando o gráfico</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da altura - Usando  HPDI  com &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HPDI_range</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% d</span><span class="s1">e massa de probabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_51_0.png" src="_images/parte_4_51_0.png" />
</div>
</div>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="modelos-cubicos">
<h1>Modelos Cúbicos<a class="headerlink" href="#modelos-cubicos" title="Permalink to this headline">¶</a></h1>
<p>Seguindo o mesmo raciocínio acima, vamos implementar o modelo de Regressão Polinômial de grau 3. Abaixo temos a evolução dos modelos apresentados:</p>
<ul class="simple">
<li><p>1a Ordem (Linha): <span class="math notranslate nohighlight">\( \mu_i = \alpha + \beta_1x_i \)</span></p></li>
<li><p>2a Ordem (Parábola):  <span class="math notranslate nohighlight">\(\mu_i = \alpha + \beta_1x_i + \beta_2x^2_i\)</span></p></li>
<li><p>3a Ordem (Função Cúbica):  <span class="math notranslate nohighlight">\(\mu_i = \alpha + \beta_1x_i + \beta_2x^2_i + \beta_3x^3_i\)</span></p></li>
</ul>
<div class="section" id="modelo-regressao-cubico-para-a-altura">
<h2>Modelo Regressão Cúbico para a Altura<a class="headerlink" href="#modelo-regressao-cubico-para-a-altura" title="Permalink to this headline">¶</a></h2>
<p>O modelo para estimar a altura usando a função polinômial cúbica pode ser definida da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ h_i \sim Normal(\mu_i, \sigma) \]</div>
<div class="math notranslate nohighlight">
\[ \mu_i =  \alpha + \beta_1x_i + \beta_2x^2_i + \beta_3x^3_i\]</div>
<div class="math notranslate nohighlight">
\[ \alpha \sim Normal(178, 20) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_1 \sim  LogNormal(0, 1) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_2  \sim  Normal(0,  1) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_3  \sim  Normal(0,  1) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma \sim Uniform(0,  50) \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==============================================================================================</span>
<span class="c1">#       Construindo o Modelo de Regressão Parabólica de 3 Grau | Usando a Amostra Completa</span>
<span class="c1"># ==============================================================================================</span>

<span class="n">weight_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># X_i</span>
<span class="n">height_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Y_i</span>

<span class="n">weight_full_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>
<span class="n">weight_full_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>

<span class="n">weight_full_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_full</span> <span class="o">-</span> <span class="n">weight_full_mean</span><span class="p">)</span><span class="o">/</span><span class="n">weight_full_std</span>   <span class="c1"># Padronizando as variáveis explicativa</span>

<span class="n">model_stan_regression_parabolic_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">data {</span>
<span class="s2">    int N;</span>
<span class="s2">    vector[N] weight;</span>
<span class="s2">    vector[N] weight_2;</span>
<span class="s2">    vector[N] weight_3;</span>
<span class="s2">    vector[N] height;</span>
<span class="s2">}</span>

<span class="s2">parameters {</span>
<span class="s2">    real alpha;</span>
<span class="s2">    real beta_1;</span>
<span class="s2">    real beta_2;</span>
<span class="s2">    real beta_3;</span>
<span class="s2">    real&lt;lower=0, upper=50&gt; sigma;  // Priori Uniform (0, 50)</span>
<span class="s2">}</span>

<span class="s2">model {</span>
<span class="s2">    alpha ~ normal(178, 20);</span>
<span class="s2">    beta_1 ~ lognormal(0, 1);</span>
<span class="s2">    beta_2 ~ normal(0, 1);</span>
<span class="s2">    beta_3 ~ normal(0, 1);</span>
<span class="s2">    </span>
<span class="s2">    height ~ normal(alpha + beta_1*weight + beta_2*weight_2 + beta_3*weight_3, sigma);</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="p">,</span>
    <span class="s1">&#39;weight_2&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;weight_3&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_full</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_p3</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_regression_parabolic_3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>

<span class="n">fit_p3</span> <span class="o">=</span> <span class="n">posteriori_p3</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># rp := referênte ao modelo de Regressão Parabólica</span>
<span class="n">alpha_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_1_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;beta_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_2_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;beta_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_3_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;beta_3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ======================================</span>
<span class="c1">#   Probabilidade à Posteriori de mu</span>
<span class="c1"># ======================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mu_poli3</span> <span class="o">=</span> <span class="n">alpha_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
              <span class="n">beta_1_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">+</span> \
              <span class="n">beta_2_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
              <span class="n">beta_3_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_poli3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Pontos da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ajuste do modelo de Regressão Polinonimal 3 Grau&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_56_0.png" src="_images/parte_4_56_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================</span>
<span class="c1">#      Probabilidade à Posteriori - HPDI </span>
<span class="c1"># ============================================</span>
<span class="n">posteriori_polinomial3_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial3_HPDI</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial3_sigma</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="n">mu_poli3</span> <span class="o">=</span> <span class="n">alpha_rp3</span> <span class="o">+</span> <span class="n">beta_1_rp3</span> <span class="o">*</span> <span class="n">weight_i</span> <span class="o">+</span> <span class="n">beta_2_rp3</span> <span class="o">*</span> <span class="n">weight_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">beta_3_rp3</span> <span class="o">*</span> <span class="n">weight_i</span><span class="o">**</span><span class="mi">3</span> 
    <span class="n">posteriori_polinomial3_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mu_poli3</span><span class="p">))</span>  <span class="c1"># média</span>
    <span class="n">posteriori_polinomial3_HPDI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">mu_poli3</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">))</span>  <span class="c1"># HPDI</span>
    <span class="n">posteriori_polinomial3_sigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu_poli3</span><span class="p">,</span> <span class="n">sigma_rp3</span><span class="p">),</span> <span class="mf">0.89</span><span class="p">))</span>
    
<span class="n">posteriori_polinomial3_HPDI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial3_HPDI</span><span class="p">)</span>
<span class="n">posteriori_polinomial3_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial3_sigma</span><span class="p">)</span>

<span class="c1"># Plontando o gráfico</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da altura - Usando  HPDI  com &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HPDI_range</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% d</span><span class="s1">e massa de probabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_57_0.png" src="_images/parte_4_57_0.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =====================================================================================</span>
<span class="c1">#     Construindo o modelo de 1 grau (novamente) para a comparação | Regressão Linear</span>
<span class="c1"># =====================================================================================</span>

<span class="n">height_p1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_p1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>

<span class="n">weight_p1_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_p1</span> <span class="o">-</span> <span class="n">weight_p1</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_p1</span><span class="p">)</span>

<span class="n">model_stan_polinomio_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] weight;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta;</span>
<span class="s2">        real&lt;lower=0, upper=50&gt; sigma;</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(178, 20);</span>
<span class="s2">        beta ~ lognormal(0, 1);</span>
<span class="s2">        </span>
<span class="s2">        height ~ normal(alpha + beta*weight, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">height_p1</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_p1_s</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_p1</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_p1</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_polinomio_1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">fit_p1</span> <span class="o">=</span> <span class="n">posteriori_p1</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha_p1</span> <span class="o">=</span> <span class="n">fit_p1</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_p1</span> <span class="o">=</span> <span class="n">fit_p1</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_p1</span> <span class="o">=</span> <span class="n">fit_p1</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =========================================================</span>
<span class="c1">#  Calculando os intervalos de HPDI para o modelo linear</span>
<span class="c1"># =========================================================</span>

<span class="n">posterioris_height_HPDIs_p1_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mu_HPDI_p1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_HPDI_p1</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="n">posterioris_height_HPDIs_p1_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">alpha_p1</span> <span class="o">+</span> <span class="n">beta_p1</span> <span class="o">*</span> <span class="n">weight_i</span><span class="p">))</span>
    <span class="n">mu_HPDI_p1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">alpha_p1</span> <span class="o">+</span> <span class="n">beta_p1</span> <span class="o">*</span> <span class="n">weight_i</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">))</span>
    <span class="n">posteriori_HPDI_p1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha_p1</span> <span class="o">+</span> <span class="n">beta_p1</span> <span class="o">*</span> <span class="n">weight_i</span><span class="p">,</span> <span class="n">sigma_p1</span><span class="p">),</span> <span class="mf">0.85</span><span class="p">))</span>
    
<span class="n">posterioris_height_HPDIs_p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu_HPDI_p1</span><span class="p">)</span>
<span class="n">mu_HPDI_p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu_HPDI_p1</span><span class="p">)</span>
<span class="n">posteriori_HPDI_p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_HPDI_p1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================================</span>
<span class="c1">#     Comparativo dos três modelos polinomiais </span>
<span class="c1">#             de 1º, 2º e 3º grau</span>
<span class="c1">#         para estimativa das alturas!</span>
<span class="c1"># ==================================================</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">22</span><span class="p">))</span>

<span class="c1"># ===============================================================================</span>
<span class="c1">#     Plotando o gráfico de regressão polinomial de grau 1 - Modelo Linear</span>
<span class="c1"># ===============================================================================</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs_p1_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_HPDI_p1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mu_HPDI_p1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_HPDI_p1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_HPDI_p1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs_p1_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regressão Polinomial de 1 Grau&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>


<span class="c1"># ===============================================================================</span>
<span class="c1">#     Plotando o gráfico de regressão polinomial de grau 2 - Parábola</span>
<span class="c1"># ===============================================================================</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regressão Polinomial de 2 Grau&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ===============================================================================</span>
<span class="c1">#     Plotando o gráfico de regressão polinomial de grau 3 - Função Cúbica</span>
<span class="c1"># ===============================================================================</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regressão Polinomial de 3 Grau&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
<img alt="_images/parte_4_60_1.png" src="_images/parte_4_60_1.png" />
</div>
</div>
<p>O que fizemos aqui foi escolher uma forma matemática polinômial (<em>um polinômio de primeiro, de segundo ou de terceiro grau</em>) e ajustarmos a melhor estrutura em cada um deles usando os dados da amostra.</p>
<p>Como temos muitos dados, a nossa incerteza tende a ficar muito pequena, o que pode nos levar a achar que o modelo está bem ajustado.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As linhas não endossam o modelo. O que faz mais sentido é que o modelo endosse as linhas!</p>
</div>
<p>Por isso temos que saber ser críticos com os modelos e sobre a sua estrutura geral, porque o modelo nunca fará isso por si mesmo. <code class="docutils literal notranslate"><span class="pre">Ele</span> <span class="pre">não</span> <span class="pre">tem</span> <span class="pre">responsabilidade</span> <span class="pre">e</span> <span class="pre">capacidade</span> <span class="pre">para</span> <span class="pre">fazer</span> <span class="pre">isso</span></code>. É de nossa responsabilidade fazer essa crítica, senão iremos <em>destruir Praga</em>.</p>
<p>Podemos perceber que essas linhas não se ajustam, de modo geral, tão bem assim aos dados, e também não há muita incerteza de onde elas estão. Isso é bem interessante, os intervalos de confiabilidade são minúsculos, mas o ajuste nos dados foi um ajuste ruim, o<code class="docutils literal notranslate"> <span class="pre">modelo</span> <span class="pre">tem</span> <span class="pre">pouca</span> <span class="pre">incerteza,</span> <span class="pre">mas</span> <span class="pre">é</span> <span class="pre">um</span> <span class="pre">modelo</span> <span class="pre">ruim</span></code>.</p>
<p>Outro problema dos polinômios é que ele são monotônicos, ou seja, depois de certo estágio eles tendem a seguir indefinidamente até o infinito.</p>
<p>Não há oscilações desse modelo! É um modelo mais duro de manipular!</p>
</div>
<div class="section" id="dores-dos-polinomios">
<h2>Dores dos Polinômios<a class="headerlink" href="#dores-dos-polinomios" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Polinômios fazem previsões absurdas fora do range dos dados.</p></li>
<li><p>Os parâmetros influenciam cada parte do corpo da curva, isso torna difícil de se entender.</p></li>
<li><p>Não são muito flexíveis, podem ter curvas monotônicas.</p></li>
</ul>
<p>Essas perdas de estabilidade também podem ocorrer dentro do range dos dados, iremos ver bem mais para frente um exemplo disso.</p>
</div>
</div>
<div class="tex2jax_ignore mathjax_ignore section" id="splines">
<h1>Splines<a class="headerlink" href="#splines" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="_images/splines_boat.jpg"><img alt="splines in boat" src="_images/splines_boat.jpg" style="width: 1000px;" /></a>
<p>Então, o que fazer agora para não precisarmos enfrentar os maus comportamentos dos polinômios?</p>
<p>Existem muitas outras opções. A que vamos ver aqui é uma bastante comum e realmente útil no dia-a-dia. Mas, ainda assim, contínua sendo um modelo <em>geocêntrico</em>. <code class="docutils literal notranslate"><span class="pre">Assim</span> <span class="pre">como</span> <span class="pre">todos</span> <span class="pre">os</span> <span class="pre">outros</span> <span class="pre">modelos!</span></code> Por isso, precisamos ter responsabilidades com o modelo e <code class="docutils literal notranslate"><span class="pre">não</span> <span class="pre">interpreta-lo</span> <span class="pre">demais</span></code>.</p>
<p>As splines sugiram de uma motivação física. <code class="docutils literal notranslate"><span class="pre">Spline</span></code> é nome bastante estranho, mas é apenas a <em>barrinha</em> (de madeira ou de aço), como na foto acima.  Essa barra é recuada e fixada pontualmente (<em>pivot point</em>) pelos pesos de metal ao longo de seu comprimento. Vamos chamar esses pesos de <code class="docutils literal notranslate"><span class="pre">nós</span></code> (<em><code class="docutils literal notranslate"><span class="pre">knots</span></code></em>). Essa estrutura ainda hoje é usada por desenhistas para traçar a curvas de cascos de barcos.</p>
<div class="section" id="agindo-localmente-b-splines">
<h2>Agindo Localmente - <em>B-splines</em><a class="headerlink" href="#agindo-localmente-b-splines" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Splines</span> <span class="pre">de</span> <span class="pre">base</span></code>, ou no inglês <em>basis-splines</em>, naturalmente são chamadas de <code class="docutils literal notranslate"><span class="pre">B-splines</span></code>. São funções que todos os seus parâmetros têm efeitos locais apenas e não globalmente como nos foi visto nos polinômios. São funções <em>wiggly</em>. Essa classe de funções é construída com outras funções <em>wigglys</em> locais.</p>
<p>Vamos ver um exemplo, mas devemos sempre nos lembrar de que estamos construindo um modelo <em>geocêntrico</em>, e que este está apenas descrevendo o comportamento dos dados na estrutura do nosso modelo e não explicando eles. Iremos observar esses resultados para as fazer previsões, portanto, devemos ter <code class="docutils literal notranslate"><span class="pre">responsabilidades</span> <span class="pre">sobre</span> <span class="pre">como</span> <span class="pre">funciona</span> <span class="pre">um</span> <span class="pre">modelo</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">Funções</span> <span class="pre">de</span> <span class="pre">base</span></code> são apenas funções locais, e toda a spline é construída com interpolações, deslizando suavemente entre essas funções locais, ou seja, as funções de base (<em>basis functions</em>).</p>
<p>Para ficar mais claro, nós iremos construir uma grande <em>wiggly functions</em> a partir de outras <em>wiggly functions</em> menores. Mas cada uma dessas funções wiggly menores tem parâmetros locais que descrevem a sua própria importância. Nós iremos ajustá-los e poderemos observar que não ocorrerá aquelas oscilações bruscas como ocorreu nas regressões polinomiais.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Esses modelos são geralmente melhores do que os modelos polinômiais, mas igualmente <em>geocêntricos</em>!</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">B-Splines</span> <span class="pre">bayesianas</span></code> são geralmente chamadas de <code class="docutils literal notranslate"><span class="pre">P-splines</span></code>. É usado comumente em pessoas que usam <em>Machine Learning</em>. O <code class="docutils literal notranslate"><span class="pre">P</span></code> significa <em>penalidades</em> que a priori dá para os pesos, mas foram rotulados dessa forma em contextos <em>não bayesianos</em>.</p>
<p>Mais para frente no curso iremos ver melhor os conceitos de penalidades e ficará bem mais claro o seu uso.</p>
<p><code class="docutils literal notranslate"><span class="pre">B-splines</span></code> são apenas uma variação dos modelos lineares que vimos anteriormente. Também é um <code class="docutils literal notranslate"><span class="pre">modelo</span> <span class="pre">aditivo</span></code> que tem algumas variáveis sintéticas estranhas (ou seja, <em>não observáveis</em>).</p>
<p>O modelo pode ser escrito da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha + w_1B_{i, 1}+ w_2B_{i, 2}+ w_3B_{i, 3}+ ...  \]</div>
<p>Os pesos <span class="math notranslate nohighlight">\(w_i\)</span> são como as inclinações. Isso é meio estranho porque o preditor de interesse não irá aparecer no modelo, no entanto, teremos uma aproximação fantástica da relação entre os preditores de interesse e o resultado.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Parece estranho, mas funciona super bem.</p>
</div>
<p>As funções de bases (<em>basis functions</em>) <span class="math notranslate nohighlight">\(B\)</span> são variáveis sintéticas. Internamente elas são termos quadráticos ou termos cúbicos. Mas note que os dados não foram usados para construir <span class="math notranslate nohighlight">\(B\)</span>. Os valores de <span class="math notranslate nohighlight">\(B\)</span> associam pesos em diferentes regiões da variável <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>Vamos construir um exemplo, passo-a-passo, de como construir um modelos de tipo.</p>
<p>Para isso, vamos utilizar os dados do Milenar Festival de Flores de Cerejeira no Japão.</p>
</div>
<div class="section" id="festival-das-flores-de-cerejeira">
<h2>Festival das Flores de Cerejeira<a class="headerlink" href="#festival-das-flores-de-cerejeira" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/cherry_blossoms.jpg"><img alt="Cherry Blossoms" src="_images/cherry_blossoms.jpg" style="width: 1000px;" /></a>
<p><em>Cherry blossoms at Sugimura park, Hashimoto</em>
<a class="reference external" href="https://en.wikipedia.org/wiki/Cherry_blossom">Wikipedia</a></p>
<p>Agora iremos usar os dados do histórico do festival japonês das flores de cerejeiras. O primeiro registro de uma flor de cerejeira nesse festival foi registrada a <span class="math notranslate nohighlight">\(1200\)</span> anos atrás e, agora, nós temos esses dados para podermos explorar e entendê-los melhor.</p>
<p>Na nossa base de dados temos a variável tempo, <code class="docutils literal notranslate"><span class="pre">year</span></code>, correspondente a cada ano de coleta dos dados. Temos os dados da época da floração e também dados da temperatura. A temperatura tem influência direta na floração das árvores pelo natural processo biológico.</p>
<p>Como podemos imaginar, essa relação é afetada pelas oscilações dos processos climáticos ao longo dos anos. Por agora nós iremos olhar para os dados da temperatura ao longo dos anos. Mas para frente ao longo do curso, iremos relacionar mais variáveis.</p>
<p>Fique como exercício construir um modelo linear da <code class="docutils literal notranslate"><span class="pre">temperatura</span></code> explicando a <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">do</span> <span class="pre">florecimento</span></code> (<em>doy</em>), existe um relacionamento muito forte e entenderemos o porquê disso.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cherry_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/cherry_blossoms.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">cherry_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>doy</th>
      <th>temp</th>
      <th>temp_upper</th>
      <th>temp_lower</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1215.000000</td>
      <td>827.000000</td>
      <td>1124.000000</td>
      <td>1124.000000</td>
      <td>1124.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>1408.000000</td>
      <td>104.540508</td>
      <td>6.141886</td>
      <td>7.185151</td>
      <td>5.098941</td>
    </tr>
    <tr>
      <th>std</th>
      <td>350.884596</td>
      <td>6.407036</td>
      <td>0.663648</td>
      <td>0.992921</td>
      <td>0.850350</td>
    </tr>
    <tr>
      <th>min</th>
      <td>801.000000</td>
      <td>86.000000</td>
      <td>4.670000</td>
      <td>5.450000</td>
      <td>0.750000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1104.500000</td>
      <td>100.000000</td>
      <td>5.700000</td>
      <td>6.480000</td>
      <td>4.610000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>1408.000000</td>
      <td>105.000000</td>
      <td>6.100000</td>
      <td>7.040000</td>
      <td>5.145000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>1711.500000</td>
      <td>109.000000</td>
      <td>6.530000</td>
      <td>7.720000</td>
      <td>5.542500</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2015.000000</td>
      <td>124.000000</td>
      <td>8.300000</td>
      <td>12.100000</td>
      <td>7.740000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cherry Blossom </span><span class="se">\n</span><span class="s1"> Festival das Flores de Cerejeiras no Japão&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperatura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_71_0.png" src="_images/parte_4_71_0.png" />
</div>
</div>
<p>Nosso objetivo aqui é construir uma tendência com esses registros de temperaturas, o que significa que queremos estimar uma spline para esses dados.</p>
<p>Se quisermos observar uma tendência em uma determida escala para compará-lás a algum movimento, então iremos precisar construir uma tendência em uma escala específica.</p>
<p>O que iremos fazer aqui é trabalhar com a ideia de obter alguma aproximação da série com alguma qualidade arbitrária. Nós iremos começar com uma <code class="docutils literal notranslate"><span class="pre">aproximação</span> <span class="pre">bastante</span> <span class="pre">ruim</span></code> para entender as <em>wiggly functions</em> e após isso iremos construir modelos mais complexos e com melhores aproximações usando uma <em><code class="docutils literal notranslate"><span class="pre">B-splines</span></code></em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===================================================</span>
<span class="c1">#     Gráfico de Primeiro dia de Floração x anos</span>
<span class="c1"># ===================================================</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">doy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cherry Blossom </span><span class="se">\n</span><span class="s1"> Festival das Flores de Cerejeiras no Japão&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Dia do Calendário Juliano da primeira Floração&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_73_0.png" src="_images/parte_4_73_0.png" />
</div>
</div>
<div class="section" id="como-as-splines-funcionam">
<h3>Como as splines funcionam?<a class="headerlink" href="#como-as-splines-funcionam" title="Permalink to this headline">¶</a></h3>
<p>Aqui está um passo a passo de como construirmos uma splines.</p>
<ul class="simple">
<li><p><strong>Escolha alguns nós (<em>knots</em>)</strong>: localização da variável preditora onde a spline é ancorada! Assim determinaremos o local onde aquelas peças pesadas irão estar ao longo da barrinha. Matemáticamente são os pontos de base fazem o pivô e determinam as lacunas entre as splines de base.</p></li>
<li><p><strong>Escolha os graus da função de base</strong>: o quanto é <em>wiggly</em>. Iremos demonstrar graficamente esse conceito sobre a utilização dos graus no decorrer da explicação.</p></li>
<li><p><strong>Encontre a distribuição à posteriori dos pesos</strong>: como anteriormente iremos fazer a estimativa bayesiana dos pesos, muito próximos como fizemos nos outos modelos de regressão.</p></li>
</ul>
</div>
<div class="section" id="knots-como-escolher-os-pontos">
<h3>Knots - Como escolher os pontos?<a class="headerlink" href="#knots-como-escolher-os-pontos" title="Permalink to this headline">¶</a></h3>
<p>Exite uma ampla literatura sobre abordagens de como devemos escolher esses pontos. Uma dos métodos mais comuns e eficientes são distribuí-los de acordo com seus <em>quantis</em>, pois assim podemos distribuir mais pontos onde há um acúmulo maior dos dados.</p>
<p>Geralmente pacotes e livrarias computacionais já nos trazem essas escolhas de modo automático e, de uma certa forma, mágicos! Nós iremos construir todo o modelo manualmente, para que possamos entender os seus detalhes de seu funcionamento.</p>
<p>O que vamos propor é colocar um <em>knot</em> na mediana, um <em>knot</em> em cada extremidade e outros dois nos centros laterais, conforme mostrado no gráfico abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configurando a variável de tempo.</span>
<span class="n">year</span> <span class="o">=</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span>

<span class="n">qty_knots</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Quantidade de nós que iremos usar.</span>
<span class="n">knots_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">qty_knots</span><span class="p">)</span>

<span class="c1"># Ref: https://numpy.org/doc/stable/reference/generated/numpy.isfinite.html?highlight=isfinite#numpy.isfinite</span>
<span class="n">year</span> <span class="o">=</span> <span class="n">year</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">year</span><span class="p">)]</span>  <span class="c1"># Removendo os elementos NaN&#39;s</span>

<span class="c1"># Encontrando os knots tomando como base os quantiles</span>
<span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">knots_array</span><span class="p">)</span>
<span class="n">knots</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">knots</span><span class="p">]</span>  <span class="c1"># Convertendo os valores do Knots para inteiro</span>

<span class="c1"># Plotando os pontos dos nós - Knots.</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">knots</span><span class="p">))</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cherry Blossom </span><span class="se">\n</span><span class="s1"> Festival das Flores de Cerejeiras no Japão&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperatura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_76_0.png" src="_images/parte_4_76_0.png" />
</div>
</div>
<p>Vamos agora construir as splines em seus nós (<em>knots</em>). Iremos desenhar abaixo todas as variáveis sintéticas. Os valores das variáveis sintéticas são construídas ao longo de todo intervalo da variável <code class="docutils literal notranslate"><span class="pre">ano</span></code>. E então queremos interpolar os dados.</p>
<p>Uma das maneiras de se pensar a respeito disso é pensar o ano como uma variável na qual nunca iremos usar novamente, usaremos apenas para definir os <em>knots</em> como âncoras sobre alguns anos específicos, mas nunca usaremos esses dados novamente.</p>
<p>Para começar, iremos construir algumas simples <code class="docutils literal notranslate"><span class="pre">funções</span> <span class="pre">de</span> <span class="pre">base</span></code> (<em>basis functions</em>). Vamos começar com as funções de bases  mais simples, funções de base de grau 1, o que é uma linha reta. Com isso iremos construir uma <em>wiggly functions</em> composta de várias funções de base de primeiro grau, que são a junções daquelas linhas retas.</p>
<a class="reference internal image-reference" href="_images/splines_2.jpg"><img alt="splines com pesos" src="_images/splines_2.jpg" style="width: 500px;" /></a>
<p>Para a construção das splines, iremos usar a função disponível na biblioteca <em>SciKit Learn</em> e sua documentação pode ser acessada <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.SplineTransformer.html#examples-using-">clicando aqui.</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">SplineTransformer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ======================================</span>
<span class="c1">#     Construindo a Spline - Ordem 1</span>
<span class="c1"># ======================================</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">spline_1</span> <span class="o">=</span> <span class="n">SplineTransformer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_knots</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># É utilizado um intervalo equidistante entre os quantis, por padrão. </span>
<span class="n">spline_1</span> <span class="o">=</span> <span class="n">spline_1</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spline_1</span><span class="p">)</span>

<span class="n">marco_eixo_x</span> <span class="o">=</span> <span class="mi">1306</span>  <span class="c1"># Local no eixo X que a linha tracejada será plotada</span>
<span class="n">marco_eixo_y_cima</span> <span class="o">=</span> <span class="n">spline_1</span><span class="p">[</span><span class="n">marco_eixo_x</span> <span class="o">-</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">marco_eixo_y_baixo</span> <span class="o">=</span> <span class="n">spline_1</span><span class="p">[</span><span class="n">marco_eixo_x</span> <span class="o">-</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>  <span class="c1"># Linha tracejada vertical</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">,</span> <span class="n">marco_eixo_y_cima</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Ponto de marcação de cima</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">,</span> <span class="n">marco_eixo_y_baixo</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Ponto de marcação de baixo</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">marco_eixo_x</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;B-Splines de grau 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Anos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1940</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_81_0.png" src="_images/parte_4_81_0.png" />
</div>
</div>
<p>Assim como as splines para os desenhistas, nós, estatísticos, usamos elas de modos semelhantes em matemática. No gráfico acima plotamos <span class="math notranslate nohighlight">\(5\)</span> funções de bases (<em>basis-functions</em>) tendo como ponto central os nós (<em>knots</em>) que definimos anteriormente.</p>
<p>Para entendermos o funcionamento dessa estrutura, temos que perceber 2 coisas: Os dois pontos pretos que estão plotados no gráfico acima, esses pontos sempre estarão sobre 2 funções de base, por exemplo na função referente ao nó 2 <em>(<span class="math notranslate nohighlight">\(knot_2\)</span>)</em> e ao nó 3 <em>(<span class="math notranslate nohighlight">\(knot_3\)</span>)</em>. Isso sempre será verdade, exceto quando a posição do <code class="docutils literal notranslate"><span class="pre">eixo</span> <span class="pre">x</span></code> estiver exatamente sobre a posição de alguns do nós.</p>
<p>A próxima observação é que cada uma das funções de base será multiplicada por um número, esse número irá modificar a sua estrutura podendo aumenta-lá ou a encurtar. Esse peso, como veremos mais adiante, será rotulado de <span class="math notranslate nohighlight">\(w\)</span>. Assim, após essa modificação ser aplicada em todas as curvas, iremos somar todos os pontos pretos e obteremos a nossa <em>B-spline</em>, ou seja, uma nova curva que é a resultante da soma de todas as curvas multiplicadas por seus respectivos pesos.</p>
<p>O interessante que notamos aqui é que, na regressão polinomial usamos as variáveis explicativas (<em><span class="math notranslate nohighlight">\(X\)</span></em>) da nossa amostra com alguns ajustes, elevado ao quadrado ou elevado ao cubo, para construção do nosso modelo. No modelo de splines que iremos construir, a variável explicativa é uma variável sintética, ou seja, <code class="docutils literal notranslate"><span class="pre">uma</span> <span class="pre">variável</span> <span class="pre">que</span> <span class="pre">nós</span> <span class="pre">criamos</span> <span class="pre">e</span> <span class="pre">que</span> <span class="pre">não</span> <span class="pre">tem</span> <span class="pre">nenhuma</span> <span class="pre">relação</span> <span class="pre">com</span> <span class="pre">o</span> <span class="pre">modelo</span> <span class="pre">em</span> <span class="pre">si</span></code>.</p>
<p>O que buscamos com o modelo de splines é estimar <strong>quais seriam os pesos mais plausíveis</strong> que melhor descreve nossos dados. Parece muito estranho fazer isso, mais funciona muito bem!</p>
<p>Vamos ver um exemplo de como isso acontece…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histograma da Temperatura do período de Floração das Cerejeiras&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Temperatura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequências&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_83_0.png" src="_images/parte_4_83_0.png" />
</div>
</div>
<p>Com as splines definidas acima, iremos construir nosso modelo em <em>Stan</em> para estimar a temperatura em cada ano da floração das cerejeiras. Iremos supor que a temperatura é distribuída normalmente, conforme gráfico acima.</p>
<p>O modelo matemático será descrito como:</p>
<div class="math notranslate nohighlight">
\[ temperatura \sim normal(\mu, \sigma) \]</div>
<p>no qual a média, <span class="math notranslate nohighlight">\(\mu\)</span>, será construída da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ \mu = \alpha + w_1  B_{i, 1} + w_2  B_{i, 2} + w_3  B_{i, 3} + w_4  B_{i, 4} +  w_5  B_{i, 5}\]</div>
<p>Para evitar de termos que escrever todos os termos na mão dentro da <em>stan</em>, podemos reescrever a equação acima da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ \mu = \alpha + w_k  B_{i, k} \]</div>
<p>Essa notação matemática converte a equação acima para uma simples multiplicação de matrizes, conforme vimos no ensino médio, e assim, tanto evitamos reescrever todos os termos manualmente quanto conseguirmos otimizar os custos computacionais envolvidos nos cálculos. (<em>Geralmente é sempre uma boa ideia utilizar matrizes.</em>)</p>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================</span>
<span class="c1">#   Construindo o modelo b-spline</span>
<span class="c1"># ==================================</span>

<span class="n">model_spline_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int&lt;lower=0&gt; N;  // Número de observações</span>
<span class="s2">        int&lt;lower=0&gt; K;  // Número de Knots</span>
<span class="s2">        matrix[N, K] B;  // B-splines</span>
<span class="s2">        vector[N] temp;  // Variável resposta (y)</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">        real alpha;</span>
<span class="s2">        vector[K] w;  // Pesos</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(100, 10);  // Priori para alpha</span>
<span class="s2">        w ~ normal(0, 1);         // Priori para w</span>
<span class="s2">        sigma ~ exponential(1);   // Priori para sigma</span>
<span class="s2">        </span>
<span class="s2">        temp ~ normal(alpha + B * w, sigma);  // Verossimilhanças (Likelohood)</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spline_1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Número de amostras</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spline_1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Número de nós (knots)</span>

<span class="n">dados</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span>
    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">spline_1</span><span class="p">),</span>
    <span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># Colocando os valores NA como média da série.</span>
<span class="p">}</span>

<span class="n">posteriori_spline_1</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_spline_1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dados</span><span class="p">)</span>
<span class="n">fit_spline_1</span> <span class="o">=</span> <span class="n">posteriori_spline_1</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha_spline_1</span> <span class="o">=</span> <span class="n">fit_spline_1</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
<span class="n">w_spline_1</span> <span class="o">=</span> <span class="n">fit_spline_1</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
<span class="n">sigma_spline_1</span> <span class="o">=</span> <span class="n">fit_spline_1</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">Bw_spline_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">spline_1</span><span class="p">,</span> <span class="n">w_spline_1</span><span class="p">)</span>  <span class="c1"># Fazendo a multiplicação das matrizes B * w </span>
</pre></div>
</div>
</div>
</div>
<p>Com o modelo ajustado, temos a estimativa do parâmetro <span class="math notranslate nohighlight">\(w\)</span>, que são os pesos de cada uma das funções de base. Para sabermos qual o efeito gerado de cada um desses pesos, iremos aplicá-los nas funções, multiplicamos ambos:</p>
<div class="math notranslate nohighlight">
\[ \mbox{Bw_spline_1} = w_k B_{1, k} \]</div>
<p>O resultado dessa operação pode ser visto no gráfico abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ====================================================</span>
<span class="c1">#    Plot da Posteriori do Mu da B-Spline de Grau 1</span>
<span class="c1"># ====================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>  <span class="n">Bw_spline_1</span><span class="p">,</span>  <span class="c1"># Plot do B * w</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
 
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;$B*w$ da B-Spline&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$B*w$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1940</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_87_0.png" src="_images/parte_4_87_0.png" />
</div>
</div>
<p>Para conseguirmos verificar a estimativa da temperatura de modo visual, somaremos, ao valor de <code class="docutils literal notranslate"><span class="pre">Bw_spline_1</span></code> o valor <code class="docutils literal notranslate"><span class="pre">alpha_spline_1</span></code>, que é a estimativa do valor médio da temperatura. Veja a seguir o gráfico.</p>
<p>Assim como em outros modelos anteriores, temos a região de plausibilidade dada pelas retas em cada um dos nós. Apesar de termos apenas <span class="math notranslate nohighlight">\(5\)</span> nós, a estimativa para <span class="math notranslate nohighlight">\(\mu\)</span> é muito boa.</p>
<p>Para termos uma estimativa mais detalhada, <code class="docutils literal notranslate"><span class="pre">devemos</span> <span class="pre">aumentar</span> <span class="pre">o</span> <span class="pre">número</span> <span class="pre">de</span> <span class="pre">nós</span> <span class="pre">e</span> <span class="pre">também</span> <span class="pre">alterar</span> <span class="pre">o</span> <span class="pre">grau</span> <span class="pre">das</span> <span class="pre">funções</span> <span class="pre">de</span> <span class="pre">bases</span> <span class="pre">usadas</span></code>. Quando maior o número de nós e, também, maior o número do grau das funções de base, tendemos a ter um ajuste mais preciso.</p>
<p>Um ajuste preciso pode ser preocupante e estragar nosso dia., O motivo disso é um efeito conhecido como <code class="docutils literal notranslate"><span class="pre">overffiting</span></code>. Iremos tratar disso mais adiante, mas de modo geral <em>overffting</em>, ou sobreajuste, é a capacidade do modelo identificar detalhes minuciosos na amostra, mas não conseguir ser bom em identificar os detalhes na população.</p>
<a class="reference internal image-reference" href="_images/overffiting.jpg"><img alt="overffiting example" src="_images/overffiting.jpg" style="width: 500px;" /></a>
<p>Por enquanto, iremos apenas entender como é o funcionamento de uma spline e, em capítulos posteriores, veremos mais detalhes sobre o fantasma do <code class="docutils literal notranslate"><span class="pre">overffiting</span></code> em nossos modelos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ======================================================</span>
<span class="c1">#    Plot da Posteriori de mu da B-Spline de Grau 1</span>
<span class="c1"># ======================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">n_plot</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Define a quantidade de simulações para o plot</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Plot da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">alpha_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bw_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">],</span>  <span class="c1"># mu</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
 
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori de mu da B-Spline&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\mu$ </span><span class="se">\n</span><span class="s1"> (Temperatura de Março)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span>  <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1940</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_91_0.png" src="_images/parte_4_91_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==========================================================</span>
<span class="c1">#      Reamostragem da Posteriori B-Spline de Grau 1 </span>
<span class="c1"># ==========================================================</span>

<span class="n">posteriori_spline_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha_spline_1</span> <span class="o">+</span> <span class="n">Bw_spline_1</span><span class="p">,</span> <span class="n">sigma_spline_1</span><span class="p">)</span>  <span class="c1"># Amostras normal(mu, sigma)</span>

<span class="n">intervalo_credibilidade</span> <span class="o">=</span> <span class="mf">0.96</span>  <span class="c1"># Intervalo de credibilidade - HPDI</span>

<span class="n">HPDI_posteriori_spline_1</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Vetor do HPDI</span>

<span class="k">for</span> <span class="n">year_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">posteriori_spline_1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># OBS: Essa operação é um pouco demorada. </span>
    <span class="n">HPDI_posteriori_spline_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posteriori_spline_1</span><span class="p">[</span><span class="n">year_i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">intervalo_credibilidade</span><span class="p">))</span>

<span class="n">HPDI_posteriori_spline_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HPDI_posteriori_spline_1</span><span class="p">)</span>
<span class="n">mean_posteriori_spline_1</span> <span class="o">=</span> <span class="n">posteriori_spline_1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Média do HPDI por cada ano</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===============================================</span>
<span class="c1">#    Plot da Posteriori da B-Spline de Grau 1</span>
<span class="c1"># ===============================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Plot da amostra</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">HPDI_posteriori_spline_1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">HPDI_posteriori_spline_1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># Plot HPDI</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HPDI da Posteriori&#39;</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">mean_posteriori_spline_1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Média da posteriori&#39;</span><span class="p">)</span>  <span class="c1"># Plot da Média</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">alpha_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bw_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">],</span>  <span class="c1"># Plot do Intevalo da Média (Sem o HPDI)</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori da B-Spline </span><span class="se">\n</span><span class="s1"> HPDI de &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intervalo_credibilidade</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Posteriori </span><span class="se">\n</span><span class="s1"> (Temperatura de Março)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span>  <span class="mf">7.7</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">6.8</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_93_0.png" src="_images/parte_4_93_0.png" />
</div>
</div>
<p>Agora que entendemos como é a construção de uma spline e como ajustar elas aos dados, iremos construir as mesmas estimativas usando as splines que mais são usadas nos dia a dia. A capacidade de inferência de uma spline com grau maior que o utilizado no exemplo anterior e, tambéme a adição de mais pontos ao longo do eixo <span class="math notranslate nohighlight">\(x\)</span> permite um ajuste muito melhor que aquele que fizemos no exemplo anterior.</p>
<p>A seguir a descrição e a construção uma <code class="docutils literal notranslate"><span class="pre">spline</span></code> com grau 3 e 15 nós ao longo do eixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">BSpline</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cherry_not_na</span> <span class="o">=</span> <span class="n">cherry_df</span><span class="p">[</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">doy</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>  <span class="c1"># Removendo os NA&#39;s do DOY</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ======================================</span>
<span class="c1">#    Construindo a BSpline - Ordem 3</span>
<span class="c1"># ======================================</span>

<span class="n">qty_knots</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">knot_quantile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">qty_knots</span><span class="p">))</span>
<span class="n">knots_adjusts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">knot_quantile</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">)</span>
<span class="n">knots_B</span> <span class="o">=</span> <span class="n">BSpline</span><span class="p">(</span><span class="n">knots_adjusts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">qty_knots</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">knots_B</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">knots_B</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;B-Splines de grau 3&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Anos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_98_0.png" src="_images/parte_4_98_0.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =======================================================</span>
<span class="c1">#   Construindo o modelo b-spline de grau 3 com 15 nós</span>
<span class="c1"># =======================================================</span>

<span class="c1"># Perceba que o modelo de grau 3 terá a mesma estrutura do modelo de grau 1 </span>
<span class="n">model_spline_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int&lt;lower=0&gt; N;  // Número de observações</span>
<span class="s2">        int&lt;lower=0&gt; K;  // Número de Knots</span>
<span class="s2">        matrix[N, K] B;  // B-splines</span>
<span class="s2">        vector[N] temp;  // Variável resposta (y)</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">        real alpha;</span>
<span class="s2">        vector[K] w;  // Pesos</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(100, 10);  // Priori para alpha</span>
<span class="s2">        w ~ normal(0, 1);         // Priori para w</span>
<span class="s2">        sigma ~ exponential(1);   // Priori para sigma</span>
<span class="s2">        </span>
<span class="s2">        temp ~ normal(alpha + B * w, sigma);  // Verossimilhanças (Likelohood)</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">knots_B</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Número de amostras</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">knots_B</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Número de nós (knots)</span>

<span class="n">dados</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span>
    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">knots_B</span><span class="p">),</span>
    <span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="n">cherry_not_na</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># Colocando os valores NA como média da série.</span>
<span class="p">}</span>

<span class="n">posteriori_spline_3</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_spline_3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dados</span><span class="p">)</span>
<span class="n">fit_spline_3</span> <span class="o">=</span> <span class="n">posteriori_spline_3</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha_spline_3</span> <span class="o">=</span> <span class="n">fit_spline_3</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">w_spline_3</span> <span class="o">=</span> <span class="n">fit_spline_3</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
<span class="n">sigma_spline_3</span> <span class="o">=</span> <span class="n">fit_spline_3</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="c1"># Fazendo a multiplicação das matrizes B * w</span>
<span class="n">Bw_spline_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">knots_B</span><span class="p">),</span> <span class="n">w_spline_3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ====================================================</span>
<span class="c1">#    Plot da Posteriori do Mu da B-Spline de Grau 3</span>
<span class="c1"># ====================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>  <span class="n">Bw_spline_3</span><span class="p">,</span>  <span class="c1"># Plot do B * w</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
 
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;$B*w$ da B-Spline grau 3&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$B*w$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_100_0.png" src="_images/parte_4_100_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Bw_spline_3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_101_0.png" src="_images/parte_4_101_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==========================================================</span>
<span class="c1">#      Reamostragem da Posteriori B-Spline de Grau 3 </span>
<span class="c1"># ==========================================================</span>

<span class="n">posteriori_spline_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha_spline_3</span> <span class="o">+</span> <span class="n">Bw_spline_3</span><span class="p">,</span> <span class="n">sigma_spline_3</span><span class="p">)</span>  <span class="c1"># Amostras normal(mu, sigma)</span>

<span class="c1"># Intervalo de credibilidade - HPDI</span>
<span class="c1">#  Lembre-se: a velocidade do cálculo do HPDI é tão mais rápido quando </span>
<span class="c1">#             mais próximo de 1 estiver o valor do intervalo_credibilidade</span>
<span class="c1">#  Altere esses valores para perceber a abertura do intevalo de credibilidade sobre os dados.</span>
<span class="n">intervalo_credibilidade</span> <span class="o">=</span> <span class="mf">0.97</span>

<span class="n">HPDI_posteriori_spline_3</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Vetor do HPDI</span>

<span class="k">for</span> <span class="n">year_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">posteriori_spline_3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># XXX: Essa operação é um pouco demorada. </span>
    <span class="n">HPDI_posteriori_spline_3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posteriori_spline_3</span><span class="p">[</span><span class="n">year_i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">intervalo_credibilidade</span><span class="p">))</span>

<span class="n">HPDI_posteriori_spline_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HPDI_posteriori_spline_3</span><span class="p">)</span>
<span class="n">mean_posteriori_spline_3</span> <span class="o">=</span> <span class="n">posteriori_spline_3</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Média do HPDI por cada ano</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===============================================</span>
<span class="c1">#    Plot da Posteriori da B-Spline de Grau 3</span>
<span class="c1"># ===============================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_not_na</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Plot da amostra</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">HPDI_posteriori_spline_3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">HPDI_posteriori_spline_3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># Plot HPDI</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HPDI da Posteriori&#39;</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">mean_posteriori_spline_3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Média da posteriori&#39;</span><span class="p">)</span>  <span class="c1"># Plot da Média</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">alpha_spline_3</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bw_spline_3</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">],</span>  <span class="c1"># Plot do Intevalo da Média (Sem o HPDI)</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori da B-Spline </span><span class="se">\n</span><span class="s1"> HPDI de &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intervalo_credibilidade</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Posteriori </span><span class="se">\n</span><span class="s1"> (Temperatura de Março)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mf">8.1</span><span class="p">,</span> <span class="s1">&#39;Um problema que pode acontecer </span><span class="se">\n</span><span class="s1"> quando geramos a spline com a </span><span class="se">\n</span><span class="s1"> última e a primeira ponta da função </span><span class="se">\n</span><span class="s1"> &quot;presa&quot;.&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">IndexError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_81404</span><span class="o">/</span><span class="mf">1197164469.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">mean_posteriori_spline_3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Média da posteriori&#39;</span><span class="p">)</span>  <span class="c1"># Plot da Média</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> 
<span class="ne">---&gt; </span><span class="mi">13</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_not_na</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">alpha_spline_3</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bw_spline_3</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">],</span>  <span class="c1"># Plot do Intevalo da Média (Sem o HPDI)</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
<span class="g g-Whitespace">     </span><span class="mi">15</span> 

<span class="ne">IndexError</span>: too many indices for array: array is 1-dimensional, but 2 were indexed
</pre></div>
</div>
<img alt="_images/parte_4_103_1.png" src="_images/parte_4_103_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="possibilidades-das-splines">
<h2>Possibilidades das Splines<a class="headerlink" href="#possibilidades-das-splines" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A quantidade de nós e os graus das funções de base são de nossa escolha.</p></li>
</ul>
<p>Exitem muitas maneiras diferente de se definir uma <em>spline</em>, assim como existem muitos outros tipos de <em>splines</em>. As que vimos aqui foram as splines mais simples.</p>
<p>Obs: No curso a definição das b-splines são um pouco diferente das que usamos aqui. Para saber com é o formato das funções que o Richard usa ver a aula <a class="reference external" href="https://www.youtube.com/watch?v=ENxTrFf9a7c&amp;list=PLDcUM9US4XdNM4Edgs7weiyIguLSToZRI">Statistical Rethinking Winter 2019 Lecture 04</a> a partir dos 57 minutos.</p>
<ul class="simple">
<li><p>Devemos nos preocupar com o overfitting dos dados (Veremos isso no capíputo 7).</p></li>
<li><p>Outros tipos de splines não precisam de nós (<em>knots</em>)</p></li>
<li><p>Uma outra ideia de aproximação que veremos no capítulo 14 será as ideias dos <code class="docutils literal notranslate"><span class="pre">Processos</span> <span class="pre">Gaussianos</span></code>.</p></li>
<li><p>Todas as splines são descritivas e não mecanicista.</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="parte_3.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">3- Modelos Geocêntricos</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="parte_5.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">5 - Muitas Variáveis e os Waffles Espúrios</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Rodolpho Macedo dos Santos<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>