
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4 - Funções Wiggly &#8212; Statistical Rethinking</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5 - Muitas variáveis e os waffles espúrios" href="parte_5.html" />
    <link rel="prev" title="3- Modelos Geocêntricos" href="parte_3.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="capa.html">
   Estatistica Bayesiana
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_pt-BR.html">
   Intro - Estatística Bayesiana (🇧🇷)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intro_en.html">
   Intro - Bayesian Statistics (🇺🇸)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_1.html">
   1- Introdução
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_2.html">
   2 - Engenharia de Golems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_3.html">
   3- Modelos Geocêntricos
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   4 - Funções Wiggly
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_5.html">
   5 - Muitas variáveis e os waffles espúrios
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/parte_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR/issues/new?title=Issue%20on%20page%20%2Fparte_4.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/rodolphomacedo/statistical_rethinking_pt_BR/main?urlpath=tree/parte_4.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#mostrando-a-nossa-incerteza">
   Mostrando a nossa Incerteza
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#construindo-a-distribuicao-preditiva-de-mu-i-dado-um-peso-especifico-x-i">
   Construindo a Distribuição Preditiva de
   <span class="math notranslate nohighlight">
    \(\mu_i\)
   </span>
   dado um peso específico
   <span class="math notranslate nohighlight">
    \(x_i\)
   </span>
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculando-a-predicao-para-todos-os-mu">
     Calculando a predição para todos os
     <span class="math notranslate nohighlight">
      \(\mu\)
     </span>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#curvas-a-partir-das-linhas-retas">
   Curvas a partir das Linhas Retas
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regressao-polinomial">
   Regressão Polinomial
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modelo-parabolico-da-altura">
     Modelo Parabólico da Altura
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#padronizar-os-preditores">
     Padronizar os Preditores
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#modelos-cubicos">
     Modelos Cúbicos
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dores-dos-polinomios">
     Dores dos Polinômios
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#splines">
   Splines
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#agindo-localmente-b-splines">
   Agindo Localmente -
   <em>
    B-splines
   </em>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#festival-das-flores-de-cerejeira">
   Festival das Flores de Cerejeira
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#b-splines-do-clima">
     <em>
      B-splines
     </em>
     do Clima
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#como-as-splines-funcionam">
   Como as splines funcionam?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#knots-como-escolher-os-pontos">
     Knots - Como escolher os pontos?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#possibilidades-das-splines">
     Possibilidades das Splines
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="funcoes-wiggly">
<h1>4 - Funções Wiggly<a class="headerlink" href="#funcoes-wiggly" title="Permalink to this headline">¶</a></h1>
<a class="reference internal image-reference" href="_images/cat_bow_tie.jpg"><img alt="_images/cat_bow_tie.jpg" src="_images/cat_bow_tie.jpg" style="width: 1000px;" /></a>
<p>No capítulo anterior vimos como construir o nosso primeiro modelo de regressão linear, no qual estimamos a altura de uma pessoa usando a informação de seu peso como auxílio. Temos assim, como resultado do nosso modelo, a distribuição à posteriori dos parâmetros que foram estimados, <span class="math notranslate nohighlight">\(\alpha\)</span>, <span class="math notranslate nohighlight">\(\beta\)</span> e o <span class="math notranslate nohighlight">\(\sigma\)</span>.</p>
<div class="math notranslate nohighlight">
\[ altura_i = \alpha + \beta (peso_i - peso\_medio) \]</div>
<p>Dessas distribuições podemos pegar apenas os valores “precisos” desses parâmentros, ou seja, geralmente nós tendemos pensar em pegar os valores esperados (<em>valores médios</em>) da distribuição do <span class="math notranslate nohighlight">\(\alpha\)</span> e do <span class="math notranslate nohighlight">\(\beta\)</span> e, com isso, traçar uma linha reta com esses valores.</p>
<p>Olhando para os resultado das estimativas, quando o <strong>peso</strong> está em seu valor médio, temos que <span class="math notranslate nohighlight">\(\alpha\)</span> significa o valor médio da altura!</p>
<p>Percebeu? Percebeu como isso é muito bonito! Agora temos uma interpretação decente para o <span class="math notranslate nohighlight">\(\alpha\)</span>.</p>
<p>Agora, o que significa o nosso <span class="math notranslate nohighlight">\(\beta\)</span>? Temos que para cada unidade de <span class="math notranslate nohighlight">\(peso\)</span> que aumentarmos a altura <span class="math notranslate nohighlight">\(h\)</span> também aumentará em <span class="math notranslate nohighlight">\(\beta\)</span> unidades. Assim, para nosso exemplo, cada kilo que aumentamos a altura tende a aumentar, em média, <span class="math notranslate nohighlight">\(0.90\)</span>.</p>
<p>Mas sabemos que isso é insuficiente, porque queremos obter a incerteza a partir desse gráfico. A estatística bayesiana não lhe dará uma única estimativa pontual, mas sim, dará a sua incerteza, que é comunicada a nós pela distribuição à posteriori, que contém <em>um número infinito linhas</em>, e cada uma dessas linhas é classificada pela sua plausibilidade relativa em comparação todas as outras linhas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">stan</span>
<span class="kn">import</span> <span class="nn">nest_asyncio</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;pystan&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">propagate</span><span class="o">=</span><span class="kc">False</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Desbloqueio do asyncIO do jupyter</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Definindo o plano de fundo cinza claro para todos os gráficos feitos no matplotlib</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lendo os dados</span>

<span class="c1"># OBS: A partir de agora irei definir as variáveis em Inglês, </span>
<span class="c1">#        mas os comentários continuarão no portuga para facilitar o entendimento.</span>

<span class="c1"># Os dados podem serem obtidos em https://github.com/rmcelreath/rethinking/tree/master/data/Howell1.csv</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/Howell1.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>  

<span class="n">weight</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Filtro para pessoas com 30 anos ou mais </span>
<span class="n">height</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Filtro para pessoas com 30 anos ou mais</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_stan</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">        vector[N] weight;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta;</span>
<span class="s2">        real&lt;lower=0, upper=50&gt; sigma;  // Priori implícita Uniforme(0, 50)</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(178, 20);  // Priori para Alpha</span>
<span class="s2">        beta ~ lognormal(0, 1);  // Priori para Beta</span>
<span class="s2">        </span>
<span class="s2">        height ~ normal(alpha + beta * weight, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reescrevendo o modelo anterior - Estimativa da altura explicado com o peso.</span>

<span class="c1"># Lembrando que estamos usando o (x_i - x_barra)</span>
<span class="n">weight_adjust</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 

<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight</span><span class="p">),</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">,</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_adjust</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
<span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># Recuperando os parâmetros</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parâmentros</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Alpha&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Beta&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Sigma&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_10_0.png" src="_images/parte_4_10_0.png" />
</div>
</div>
<div class="section" id="mostrando-a-nossa-incerteza">
<h2>Mostrando a nossa Incerteza<a class="headerlink" href="#mostrando-a-nossa-incerteza" title="Permalink to this headline">¶</a></h2>
<p>Agora nós iremos fazer uma amostragem das posterioris. Uma das razões para usarmos esse procedimento de amostragem é que isso se torna mais fácil de se pensar e, também, esse procedimento pode ser aplicado a <strong>todos</strong> os tipos modelos que quisermos ajustar.</p>
<p>Nossa distribuição à posteriori contém muitas linhas retas lá dentro, representadas pela amostragem dos valores da distribuição dos <span class="math notranslate nohighlight">\(\alpha\)</span> e dos <span class="math notranslate nohighlight">\(\beta\)</span> com o <span class="math notranslate nohighlight">\(\sigma\)</span> informando o desvio padrão.</p>
<p>Abaixo vamos ver as primeiras linhas do conjunto de dados da estimativa:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;beta&#39;</span><span class="p">:</span> <span class="n">beta</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">[:</span><span class="mi">10</span><span class="p">]}))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        alpha      beta     sigma
0  154.885770  0.984688  5.230593
1  153.920229  1.005239  5.276455
2  154.254961  0.943522  5.762119
3  154.361346  0.785949  5.294990
4  153.978757  0.883300  5.297582
5  154.425469  1.002542  4.989027
6  154.287961  0.995511  5.561409
7  154.578485  0.857395  5.037718
8  154.287385  0.850646  5.232066
9  154.271898  0.951981  5.040153
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Para cada linha do conjunto de dados acima é uma <code class="docutils literal notranslate"><span class="pre">linha</span> <span class="pre">reta</span></code>!</p></li>
</ul>
<p>Temos muitas linhas, e as linhas mais plausíveis são as linhas que tem maior número de maneiras de reproduzir os dados que observamos. Essa plausabilidade é aprensentada para nós através do maior acúmulo de linhas retas que se sobrepõem.</p>
<p>Atenção: Quanto mais as linhas se sobreporem entre si em uma certa região, maior será a plausabilidade dessas retas descreverem os dados que observamos.</p>
<p><code class="docutils literal notranslate"><span class="pre">O</span> <span class="pre">acúmulo</span> <span class="pre">dessas</span> <span class="pre">retas</span> <span class="pre">representa</span> <span class="pre">a</span> <span class="pre">nossa</span> <span class="pre">incerteza.</span></code></p>
<p>É a primeira vez que conseguimos realmente ver nossa incerteza no gráfico. <em>Lindo demais</em>!!!</p>
<p>Para termos uma melhor compreensão nesse momento, nós vamos supor que ao invés de nossa amostra ter 251 indivíduos, vamos supor que temos apenas alguns subconjuntos. Nosso objetivo aqui é mostrar que quanto mais informações temos (<em>maior a nossa amostra</em>), menor será a nossa incerteza!</p>
<p>Para ficar mais claro, vamos simular a essa nossa estratégia e ver a diferenças dos <strong>acúmulo das curvas</strong>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="c1"># ===============================================</span>
    <span class="c1">#   Ajustando as estimativas para N indivíduos</span>
    <span class="c1"># ===============================================</span>
    
    <span class="n">weight_adjust</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 

    <span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
        <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height</span><span class="p">[:</span><span class="n">N</span><span class="p">],</span>
        <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_adjust</span><span class="p">[:</span><span class="n">N</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># Recuperando os parâmetros</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =====================================================</span>
<span class="c1">#   Plotando as linhas de incerteza do nosso modelo</span>
<span class="c1"># =====================================================</span>
<span class="c1"># A saída desse modelo pode ser muito verbosa. Os resultados serão exibidos na célula abaixo.</span>

<span class="n">N_10</span> <span class="o">=</span> <span class="mi">10</span>     
<span class="n">alpha_10</span><span class="p">,</span> <span class="n">beta_10</span><span class="p">,</span> <span class="n">sigma_10</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N_10</span><span class="p">);</span>


<span class="n">N_50</span> <span class="o">=</span> <span class="mi">50</span>     
<span class="n">alpha_50</span><span class="p">,</span> <span class="n">beta_50</span><span class="p">,</span> <span class="n">sigma_50</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N_50</span><span class="p">);</span>


<span class="n">N_100</span> <span class="o">=</span> <span class="mi">100</span>     
<span class="n">alpha_100</span><span class="p">,</span> <span class="n">beta_100</span><span class="p">,</span> <span class="n">sigma_100</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N_100</span><span class="p">);</span>


<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span> <span class="c1"># Com toda amostra disponível</span>
<span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">generate_parcial_stan_models_results</span><span class="p">(</span><span class="n">N</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<p>Uma das vantagens do gráfico gráfico de linhas (<code class="docutils literal notranslate"><span class="pre">gráfico</span> <span class="pre">de</span> <span class="pre">espaguetes</span></code>) é deixar claro que os limites  formados pelas retas não tem um significado.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =============================</span>
<span class="c1">#     Gráfico de Espaguete</span>
<span class="c1"># =============================</span>

<span class="c1"># Vamos estimar na célula de cima apenas para não poluir a saĩda com o gráfico</span>
<span class="c1"># Vamos usar o weight_adjust igual para todos os pesos sem perda de generalidade</span>

<span class="c1"># Plot dos dados altura x peso</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">[[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">],</span> <span class="p">[</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>

<span class="c1"># Número de linhas retas que iremos plotar</span>
<span class="n">qty_lines</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 10 amostras</span>
<span class="c1"># ===============================================</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_10</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_10</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha_10</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_10</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_10</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>


<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 50 amostras</span>
<span class="c1"># ===============================================</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_50</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_50</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha_50</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_50</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_50</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>


<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 100 amostras</span>
<span class="c1"># ===============================================</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_100</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_100</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha_100</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_100</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>


<span class="c1"># =================================================</span>
<span class="c1">#    Estimando as curvas usando todas as amostras</span>
<span class="c1"># =================================================</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_lines</span><span class="p">):</span>
    <span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_adjust</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Estimativa com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; (todos) pontos amostrados&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (Weight)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (Height)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_18_0.png" src="_images/parte_4_18_0.png" />
</div>
</div>
<p>Essa divisão foi construída para conseguirmos percerber, de modo visual, que quando mais amostras tivermos coletado (isto é, um <em>quanto maior número de pontos azuis tivermos</em>), mais informações teremos e, portanto, teremos muito menos incerteza sobre o nosso objeto de estudo.</p>
<p>A nossa incerteza pode ser observada pela dispersão das curvas no gráfico, portanto quanto maior for a dispersão maior será a nossa incerteza sobre o que está acontecendo.</p>
</div>
<div class="section" id="construindo-a-distribuicao-preditiva-de-mu-i-dado-um-peso-especifico-x-i">
<h2>Construindo a Distribuição Preditiva de <span class="math notranslate nohighlight">\(\mu_i\)</span> dado um peso específico  <span class="math notranslate nohighlight">\(x_i\)</span><a class="headerlink" href="#construindo-a-distribuicao-preditiva-de-mu-i-dado-um-peso-especifico-x-i" title="Permalink to this headline">¶</a></h2>
<p>Modelo linear para a altura média:</p>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha + \beta(x_i - \bar{x}) \]</div>
<p>Agora a ideia básica é que para um valor específico do peso <span class="math notranslate nohighlight">\(x_i\)</span> (<em>weight</em>) existe uma distribuição preditiva de <span class="math notranslate nohighlight">\(\mu_i\)</span>. Essa densidade preditiva nos informa quais as regiões de maior confiança que podemos esperar para a média da altura de uma pessoa com esse peso específico.</p>
<p>Para exemplificar, vamos supor que queremos estimar a altura (<em>height</em>) de uma pessoa com <span class="math notranslate nohighlight">\(50 kg\)</span>.</p>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha + \beta(50 - \bar{x}) \]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===========================================================</span>
<span class="c1">#   Construindo a distribuição preditiva de mu | weight=50</span>
<span class="c1"># ===========================================================</span>

<span class="n">mu_50_kg</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mu_50_kg</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribuição de $\mu_i$ para o peso de $50 kg$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Plausabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;$\mu | peso=50$&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_21_0.png" src="_images/parte_4_21_0.png" />
</div>
</div>
<div class="section" id="calculando-a-predicao-para-todos-os-mu">
<h3>Calculando a predição para todos os <span class="math notranslate nohighlight">\(\mu\)</span><a class="headerlink" href="#calculando-a-predicao-para-todos-os-mu" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">HPDI</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">,</span> <span class="n">credible_mass</span><span class="p">):</span>
    
    <span class="c1"># Calcula o maior intervalo de probabilidades a partir de uma amostra</span>
    
    <span class="c1"># Fonte: https://stackoverflow.com/questions/22284502/highest-posterior-density-region-and-central-credible-region</span>
    <span class="c1"># ** Refazer essa função para entender **</span>
    
    <span class="n">sorted_points</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">)</span>
    <span class="n">ciIdxInc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">credible_mass</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_points</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="n">nCIs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_points</span><span class="p">)</span> <span class="o">-</span> <span class="n">ciIdxInc</span>
    <span class="n">ciWidth</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nCIs</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nCIs</span><span class="p">):</span>
        <span class="n">ciWidth</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">ciIdxInc</span><span class="p">]</span> <span class="o">-</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">HDImin</span> <span class="o">=</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">ciWidth</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ciWidth</span><span class="p">))]</span>
        <span class="n">HDImax</span> <span class="o">=</span> <span class="n">sorted_points</span><span class="p">[</span><span class="n">ciWidth</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ciWidth</span><span class="p">))</span><span class="o">+</span><span class="n">ciIdxInc</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">HDImin</span><span class="p">,</span> <span class="n">HDImax</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =====================================</span>
<span class="c1">#    Calculando o HPDI dos dados</span>
<span class="c1"># =====================================</span>

<span class="n">posterioris_dict_10</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>
<span class="n">posterioris_dict_50</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>
<span class="n">posterioris_dict_100</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>
<span class="n">posterioris_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Dicionário com todas as posterioris para cada um dos pesos (weight) variando de 25 á 70.</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">):</span>
    <span class="n">posterioris_dict_10</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_10</span> <span class="o">+</span> <span class="n">beta_10</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">posterioris_dict_50</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_50</span> <span class="o">+</span> <span class="n">beta_50</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">posterioris_dict_100</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha_100</span> <span class="o">+</span> <span class="n">beta_100</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    <span class="n">posterioris_dict</span><span class="p">[</span><span class="n">weight_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
<span class="n">posterioris_10</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict_10</span><span class="p">)</span>
<span class="n">posterioris_50</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict_50</span><span class="p">)</span>
<span class="n">posterioris_100</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict_100</span><span class="p">)</span>
<span class="n">posterioris</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">posterioris_dict</span><span class="p">)</span>

<span class="n">posterioris_means_10</span> <span class="o">=</span> <span class="n">posterioris_10</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">posterioris_means_50</span> <span class="o">=</span> <span class="n">posterioris_50</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">posterioris_means_100</span> <span class="o">=</span> <span class="n">posterioris_100</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">posterioris_means</span> <span class="o">=</span> <span class="n">posterioris</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">posterioris_HPDIs_10</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posterioris_HPDIs_50</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posterioris_HPDIs_100</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posterioris_HPDIs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">):</span>
    <span class="n">posterioris_HPDIs_10</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris_10</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    <span class="n">posterioris_HPDIs_50</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris_50</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    <span class="n">posterioris_HPDIs_100</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris_100</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    <span class="n">posterioris_HPDIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posterioris</span><span class="p">[</span><span class="n">weight_i</span><span class="p">],</span> <span class="mf">0.89</span><span class="p">))</span>
    
<span class="n">posterioris_HPDIs_10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs_10</span><span class="p">)</span>  <span class="c1"># Apenas a transformação em um array numpy</span>
<span class="n">posterioris_HPDIs_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs_50</span><span class="p">)</span>  <span class="c1"># Apenas a transformação em um array numpy</span>
<span class="n">posterioris_HPDIs_100</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs_100</span><span class="p">)</span>  <span class="c1"># Apenas a transformação em um array numpy</span>
<span class="n">posterioris_HPDIs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_HPDIs</span><span class="p">)</span>  <span class="c1"># Apenas a transformação em um array numpy</span>
</pre></div>
</div>
</div>
</div>
<p>Agora, assim como nos gráficos anteriores acima, iremos replotar os mesmos 4 gráficos, mas agora usando o gráfico mostrando o intervalo de compatilidade (<code class="docutils literal notranslate"><span class="pre">estilo</span> <span class="pre">gravata</span> <span class="pre">borboleta</span></code>).</p>
<a class="reference internal image-reference" href="_images/bow_tie.jpg"><img alt="Bow Tie" src="_images/bow_tie.jpg" style="width: 400px;" /></a>
<p>Ao olhar para esse gráfico é fácil carimos na tentação de acharmos que os limites que escolhemos significa alguma coisa, ele não tem nenhum significado a não ser os limites de corte pelo HPDI.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================================</span>
<span class="c1">#       Plotando os gráfico de gravata borboletas</span>
<span class="c1"># ==================================================</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">[[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">],</span> <span class="p">[</span><span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">]]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 10 amostras</span>
<span class="c1"># ===============================================</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_10</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs_10</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_10</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_10</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means_10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média altura com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_10</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 50 amostras</span>
<span class="c1"># ===============================================</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_50</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs_50</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_50</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_50</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means_50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média alturacom N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_50</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ===============================================</span>
<span class="c1">#    Estimando as curvas usando 100 amostras</span>
<span class="c1"># ===============================================</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs_100</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs_100</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">[:</span><span class="n">N_100</span><span class="p">],</span> <span class="n">height</span><span class="p">[:</span><span class="n">N_100</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means_100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média altura com N = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N_100</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ==================================================</span>
<span class="c1">#    Estimando as curvas usando todas as amostras</span>
<span class="c1"># ==================================================</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da média altura com todos os pontos de amostras&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_26_0.png" src="_images/parte_4_26_0.png" />
</div>
</div>
<p>Perceba que nos gráficos de borboletas nós usamos os cortes para os intervalos com <span class="math notranslate nohighlight">\(89%\)</span>. Isso é apenas para mostrar que não, isso mesmo, não existe nada especial nos cortes do HPDI. Mas os cortes mais usuais de <span class="math notranslate nohighlight">\(50%\)</span>, <span class="math notranslate nohighlight">\(80%\)</span> ou <span class="math notranslate nohighlight">\(95%\)</span>, corriqueiramente usados em outras escolas estatísticas, são apenas cortes que queremos visualizar. Nada mais!</p>
<p>Até agora nós fizemos os gráficos apenas usando os parâmetros da média, mas podemos construir o gráfico de envelope para o sigma também. Iremos construir ambos utilizando toda a nossa amostra.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================================================</span>
<span class="c1">#     Plotando o HPDI da distribuição preditiva da alutra e de sua média</span>
<span class="c1"># ============================================================================</span>
<span class="n">posterioris_height_HPDIs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">HPDI_range</span> <span class="o">=</span> <span class="mf">0.93</span>  <span class="c1"># Define o tamanho do intervalo do HPDI. Altere o valor para ver a diferença.</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">):</span>
    <span class="n">posteiori_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">weight_i</span> <span class="o">-</span> <span class="n">weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="n">sigma</span><span class="p">)</span>
    <span class="n">posterioris_height_HPDIs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posteiori_height</span><span class="p">,</span> <span class="n">HPDI_range</span><span class="p">))</span>
    
<span class="n">posterioris_height_HPDIs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posterioris_height_HPDIs</span><span class="p">)</span>

<span class="c1"># Plontando o gráfico</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_height_HPDIs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posterioris_HPDIs</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">),</span> <span class="n">posterioris_means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da altura - Usando  HPDI  com &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HPDI_range</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% d</span><span class="s1">e massa de probabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_29_0.png" src="_images/parte_4_29_0.png" />
</div>
</div>
<p>Como podemos ver no gráfico acima, temos duas regiões de confiança. A região mais interna, azul escura, nos indica que esse trecho contém <span class="math notranslate nohighlight">\(89\%\)</span> de probabilidade da média estar ali dentro, para cada um dos pesos medidos.
Já a região mais externa, aquele azul mais clara, nos indica que, com <span class="math notranslate nohighlight">\(93\%\)</span> probabilidade, será a região mais provável para altura da pessoa que tenha um peso espefícico.</p>
<p>Como teste para conseguir compreender melhor, faça o teste a altera a variável <code class="docutils literal notranslate"><span class="pre">HPDI_range</span></code> para valores bem altos, como por exemplo, <span class="math notranslate nohighlight">\(0.99\)</span> e veja o quanto a faixa mais externa  cobre os dados. Para valores menores, isso também ocorre, como por exemplo, <span class="math notranslate nohighlight">\(0.7\)</span>.</p>
<p>Obs: A utilização de valores muito baixos, demanda cálculos mais complexos e poor isso pode ser demorada.</p>
</div>
</div>
<div class="section" id="curvas-a-partir-das-linhas-retas">
<h2>Curvas a partir das Linhas Retas<a class="headerlink" href="#curvas-a-partir-das-linhas-retas" title="Permalink to this headline">¶</a></h2>
<p>O interessante de modelos lineares é que eles não são apenas lineares, podem ser curvas também. Isso é uma coisa meio enloquecedora sobre o termo que é convencionalmente  usado para desenhar linhas retas em gráficos.</p>
<p>Mas uma regressão linear é aditiva, você vai ter essa equação para média que é a soma de alguns parâmetros vezes algumas variável observada. Com a soma de um monte de termos como esse. É uma equação aditiva e coisas aditivas são lineares na matemática.</p>
<p>Mas para nós as palavras “adtivo” e linear são diferentes, então chamaremos esses modelos de <code class="docutils literal notranslate"><span class="pre">Regressões</span> <span class="pre">Aditivas</span></code>. Por que podemos usar coisas que não parecem linhas retas. E de agora até o final do capítulo iremos fazer isso,  <em>desenhar curvas a partir de linhas retas</em>.</p>
<p>Mas antes de fazer, por que é interessante aprendermos a fazer esse tipo de modelagem? Simples, por que a Natureza não se limita a se manifestar por relações lineares entre  duas variáveis! Os nossos ranges podem ser aproximações úteis, mas geralmente são bobos.</p>
<p>No nosso caso, nós usamos as variáveis <em>altura</em> e <em>peso</em>, porém apenas para indivíduos que tivessem <span class="math notranslate nohighlight">\(30\)</span> anos ou mais. Se fossêmos usar todos os indivíduos a relação de peso e altura não mais seria uma linha reta, mas sim uma curva.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">height_0_18</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_0_18</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">height_18_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_18_</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>


<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_0_18</span><span class="p">,</span> <span class="n">height_0_18</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;De 0 a 17 anos de idade&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_18_</span><span class="p">,</span> <span class="n">height_18_</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;(Adultos) 18+ anos de idade&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Altura x peso | Todos os indivíduos da amostra&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_33_0.png" src="_images/parte_4_33_0.png" />
</div>
</div>
<p>Vamos ver dois modos de construir os modelos de <code class="docutils literal notranslate"><span class="pre">Regressão</span> <span class="pre">Aditivos</span></code>:</p>
<ul class="simple">
<li><p><strong>Regressão Polinomial</strong></p>
<ul>
<li><p>Usada de forma comum</p></li>
<li><p>Geralmente aprensenta um comportamento bem ruim</p></li>
</ul>
</li>
</ul>
<p>Esse é um tipo bem comum de regressão, mas também é um modelo bem ruim. Não há nada de errado usar esse tipo de regressão supondo que você entenda o que golem está fazendo e assim usar de forma responsável. Geralmente se utilizam sem uma devida atenção. Iremos ver o motivo dele serem mal comportados.</p>
<ul class="simple">
<li><p><strong>Splines</strong></p>
<ul>
<li><p>São muito flexíveis</p></li>
<li><p>Altamente Geocêntrica</p></li>
</ul>
</li>
</ul>
<p>Existem muitos tipos de splines, mas nós iremos ver aqui as splines de base, que são provavélmente as mais comuns. Software de desenhos como <code class="docutils literal notranslate"><span class="pre">GIMP</span></code>, <code class="docutils literal notranslate"><span class="pre">Blender</span></code> e etc. que possuem a ferramenta <em>curvas de Bezier</em>, nada mais são do que splines de base.</p>
<p>As Splines são muito flexíveis, muito mais flexíveis do que as Regressões Polinomiais, porém não apresentam a patologia que os polinômios apresentam, e por isso são considerado na maioria dos casos melhores que as regressões polinômiais.</p>
<p>Porém tanto as splines quantos as regressões polinomiais são <code class="docutils literal notranslate"><span class="pre">estratégias</span> <span class="pre">geocêntrica</span></code>, não há nada de científico nelas, são apenas aproximações com epiciclos de Ptolomeu.</p>
<p>Extrapolações com esses modelos podem trazer desastres nas predições, por isso é necessário checar e entender o que está acontecendo com o modelo.</p>
</div>
<div class="section" id="regressao-polinomial">
<h2>Regressão Polinomial<a class="headerlink" href="#regressao-polinomial" title="Permalink to this headline">¶</a></h2>
<p>Estratégia puramente descritiva (<em>geocêntrico</em>) usando uma variável com preditor polinomial.</p>
<ul class="simple">
<li><p>1a Ordem (Linha): <span class="math notranslate nohighlight">\( \mu_i = \alpha + \beta_1x_i \)</span></p></li>
<li><p>2a Ordem (Parábola):  <span class="math notranslate nohighlight">\(\mu_i = \alpha + \beta_1x_i + \beta_2x^2_i\)</span></p></li>
</ul>
<div class="section" id="modelo-parabolico-da-altura">
<h3>Modelo Parabólico da Altura<a class="headerlink" href="#modelo-parabolico-da-altura" title="Permalink to this headline">¶</a></h3>
<p>O modelo parabólico pode ser definido da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ h_i \sim Normal(\mu_i, \sigma) \]</div>
<div class="math notranslate nohighlight">
\[ \mu_i =  \alpha + \beta_1x_i + \beta_2x^2_i \]</div>
<div class="math notranslate nohighlight">
\[ \alpha \sim Normal(178, 20) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_1 \sim  Log-Normal(0, 1) \]</div>
<div class="math notranslate nohighlight">
\[ \beta_2  \sim  Normal(0,  1) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma \sim Uniform(0,  50) \]</div>
<p>O problema desse modelo é que os termo <span class="math notranslate nohighlight">\(\beta_1\)</span> e <span class="math notranslate nohighlight">\(\beta_2\)</span> não tem um significado biológico, é apenas um ajuste na curvatura da função. Por esse motivo nós temos que simular para entender oque está acontecendo com a priori. Se não entendermos o que são essas variáveis, as nossa posterioris não teram sentido interpretativo.</p>
<p>Não é para não usar, mas usar com responsabilidade.</p>
</div>
<div class="section" id="padronizar-os-preditores">
<h3>Padronizar os Preditores<a class="headerlink" href="#padronizar-os-preditores" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>É muito útil padronizar as variáveis preditoras antes de ajustar o modelo.</p>
<ul>
<li><p>Torna a estimação mais simples</p></li>
<li><p>Auxília na interpretação (<em>alguma vezes</em>)</p></li>
</ul>
</li>
</ul>
<p>Para padronizar siga os seguinte passos para todos os dados:</p>
<ul class="simple">
<li><p>subtrair da média.</p></li>
<li><p>dividir pelo desvio padrão.</p></li>
<li><p>Resultando: Média = 0 e Desvio Padrão = 1</p></li>
</ul>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =================================================================</span>
<span class="c1">#       Construindo o Modelo de Regressão Parabólica | Parcial</span>
<span class="c1"># =================================================================</span>

<span class="n">weight_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># X_i</span>
<span class="n">height_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Y_i</span>

<span class="c1"># Ajustando o modelo para pessoas acimas dos 18 anos - Teste de ajuste</span>
<span class="n">height_full_30</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_full_30</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

<span class="n">weight_full_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>
<span class="n">weight_full_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>

<span class="n">weight_full_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_full_30</span> <span class="o">-</span> <span class="n">weight_full_mean</span><span class="p">)</span><span class="o">/</span><span class="n">weight_full_std</span>   <span class="c1"># Padronizando as variáveis explicativa</span>

<span class="n">model_stan_regression_parabolic</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">data {</span>
<span class="s2">    int N;</span>
<span class="s2">    vector[N] weight;</span>
<span class="s2">    vector[N] weight_2;</span>
<span class="s2">    vector[N] height;</span>
<span class="s2">}</span>

<span class="s2">parameters {</span>
<span class="s2">    real alpha;</span>
<span class="s2">    real&lt;lower=0&gt; beta_1;</span>
<span class="s2">    real beta_2;</span>
<span class="s2">    real&lt;lower=0, upper=50&gt; sigma;  // Priori Uniform (0, 50)</span>
<span class="s2">}</span>

<span class="s2">model {</span>
<span class="s2">    alpha ~ normal(178, 20);</span>
<span class="s2">    beta_1 ~ lognormal(0, 1);</span>
<span class="s2">    beta_2 ~ normal(0, 1);</span>
<span class="s2">    </span>
<span class="s2">    height ~ normal(alpha + beta_1*weight + beta_2*weight_2, sigma);</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="p">,</span>
    <span class="s1">&#39;weight_2&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_full_30</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_regression_parabolic</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>

<span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># rp := referênte ao modelo de Regressão Parabólica</span>
<span class="n">alpha_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_1_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_2_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===================================================</span>
<span class="c1">#   Probabilidade à Posteriori de mu</span>
<span class="c1"># ===================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mu_poli</span> <span class="o">=</span> <span class="n">alpha_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_1_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">beta_2_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>   
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_poli</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Pontos da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full_30</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ajuste do modelo de Regressão Polinonimal com N=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weight_full</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; pontos da amostra.&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_41_0.png" src="_images/parte_4_41_0.png" />
</div>
</div>
<p>Regressões Polinomiais tem esse tipo de anomalia implícita, dentro dentro da região dos pontos ela se comporta de modo aceitável, porém fora da região dos pontos, a função se torna descontrolada. Isso ocorre porque exitem muitas outras funcões de segundo grau que podem ser ajustadas nesse conjunto de pontos. Isso não ocorre com tanta intensidade nas regressões com splines.</p>
<p>Perceba que para a esquerda do <em>zero</em> no eixo do peso (peso está normalizado) a funcão começa perder o controle e atinge valores que podem ser verdadeiros.</p>
<p>Uma segundo incoveniente que ocorre com Regressões Polinomiais é sua própria estrutura matemática. Apenas três parâmetros, o <span class="math notranslate nohighlight">\(\alpha\)</span>, o <span class="math notranslate nohighlight">\(\beta_1\)</span> e o <span class="math notranslate nohighlight">\(\beta_2\)</span>, controlam todo o comportamento da curva. Isso a torna um pouco mais rígida para situações que precisamos de mais flexibilildade. As splines padrões tem a sua construção baseada em uma estrutura que evita esse tipo de inconveniente.</p>
<p>Lembre-se, ambos modelos, tanto os polinomiais quanto modelos com splines, são modelos <em>geocentricos</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parâmentros</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">alpha_rp</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori Alpha&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta_1_rp</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori $Beta_1$&#39;</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta_2_rp</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Posteriori $Beta_2$&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_43_0.png" src="_images/parte_4_43_0.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================================================================</span>
<span class="c1">#       Construindo o Modelo de Regressão Parabólica | Usando a Amostra Completa</span>
<span class="c1"># ==================================================================================</span>

<span class="n">weight_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># X_i</span>
<span class="n">height_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Y_i</span>

<span class="n">weight_full_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>
<span class="n">weight_full_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>

<span class="n">weight_full_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_full</span> <span class="o">-</span> <span class="n">weight_full_mean</span><span class="p">)</span><span class="o">/</span><span class="n">weight_full_std</span>   <span class="c1"># Padronizando as variáveis explicativa</span>

<span class="n">model_stan_regression_parabolic</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] weight;</span>
<span class="s2">        vector[N] weight_2;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real&lt;lower=0&gt; beta_1;</span>
<span class="s2">        real beta_2;</span>
<span class="s2">        real&lt;lower=0, upper=50&gt; sigma;  // Priori Uniform (0, 50)</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(178, 20);</span>
<span class="s2">        beta_1 ~ lognormal(0, 1);</span>
<span class="s2">        beta_2 ~ normal(0, 1);</span>

<span class="s2">        height ~ normal(alpha + beta_1*weight + beta_2*weight_2, sigma);</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="p">,</span>
    <span class="s1">&#39;weight_2&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_full</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_regression_parabolic</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>

<span class="n">fit</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># rp := referênte ao modelo de Regressão Parabólica</span>
<span class="n">alpha_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_1_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_2_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;beta_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_rp</span> <span class="o">=</span> <span class="n">fit</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===================================================</span>
<span class="c1">#   Probabilidade à Posteriori de mu</span>
<span class="c1"># ===================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mu_poli</span> <span class="o">=</span> <span class="n">alpha_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">beta_1_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">beta_2_rp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>   
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_poli</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Pontos da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ajuste do modelo de Regressão Polinonimal&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_45_0.png" src="_images/parte_4_45_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================</span>
<span class="c1">#      Probabilidade à Posteriori - HPDI</span>
<span class="c1"># ============================================</span>
<span class="n">posteriori_polinomial2_HPDI</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial2_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial2_sigma</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="n">mu_poli</span> <span class="o">=</span> <span class="n">alpha_rp</span> <span class="o">+</span> <span class="n">beta_1_rp</span> <span class="o">*</span> <span class="n">weight_i</span> <span class="o">+</span> <span class="n">beta_2_rp</span> <span class="o">*</span> <span class="n">weight_i</span><span class="o">**</span><span class="mi">2</span>  
    <span class="n">posteriori_polinomial2_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mu_poli</span><span class="p">))</span>  <span class="c1"># média</span>
    <span class="n">posteriori_polinomial2_HPDI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">mu_poli</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">))</span>  <span class="c1"># HPDI</span>
    <span class="n">posteriori_polinomial2_sigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu_poli</span><span class="p">,</span> <span class="n">sigma_rp</span><span class="p">),</span> <span class="mf">0.89</span><span class="p">))</span>
    
<span class="n">posteriori_polinomial2_HPDI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial2_HPDI</span><span class="p">)</span>
<span class="n">posteriori_polinomial2_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial2_sigma</span><span class="p">)</span>

<span class="c1"># Plontando o gráfico</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da altura - Usando  HPDI  com &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HPDI_range</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% d</span><span class="s1">e massa de probabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_4_46_0.png" src="_images/parte_4_46_0.png" />
</div>
</div>
</div>
<div class="section" id="modelos-cubicos">
<h3>Modelos Cúbicos<a class="headerlink" href="#modelos-cubicos" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==============================================================================================</span>
<span class="c1">#       Construindo o Modelo de Regressão Parabólica de 3 Grau | Usando a Amostra Completa</span>
<span class="c1"># ==============================================================================================</span>

<span class="n">weight_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># X_i</span>
<span class="n">height_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># Y_i</span>

<span class="n">weight_full_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>
<span class="n">weight_full_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_full</span><span class="p">)</span>

<span class="n">weight_full_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_full</span> <span class="o">-</span> <span class="n">weight_full_mean</span><span class="p">)</span><span class="o">/</span><span class="n">weight_full_std</span>   <span class="c1"># Padronizando as variáveis explicativa</span>



<span class="n">model_stan_regression_parabolic_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">data {</span>
<span class="s2">    int N;</span>
<span class="s2">    vector[N] weight;</span>
<span class="s2">    vector[N] weight_2;</span>
<span class="s2">    vector[N] weight_3;</span>
<span class="s2">    vector[N] height;</span>
<span class="s2">}</span>

<span class="s2">parameters {</span>
<span class="s2">    real alpha;</span>
<span class="s2">    real beta_1;</span>
<span class="s2">    real beta_2;</span>
<span class="s2">    real beta_3;</span>
<span class="s2">    real&lt;lower=0, upper=50&gt; sigma;  // Priori Uniform (0, 50)</span>
<span class="s2">}</span>

<span class="s2">model {</span>
<span class="s2">    alpha ~ normal(178, 20);</span>
<span class="s2">    beta_1 ~ lognormal(0, 1);</span>
<span class="s2">    beta_2 ~ normal(0, 1);</span>
<span class="s2">    beta_3 ~ normal(0, 1);</span>
<span class="s2">    </span>
<span class="s2">    height ~ normal(alpha + beta_1*weight + beta_2*weight_2 + beta_3*weight_3, sigma);</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">my_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="p">,</span>
    <span class="s1">&#39;weight_2&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;weight_3&#39;</span><span class="p">:</span> <span class="n">weight_full_std</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_full</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_p3</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_regression_parabolic_3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">my_data</span><span class="p">)</span>

<span class="n">fit_p3</span> <span class="o">=</span> <span class="n">posteriori_p3</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># rp := referênte ao modelo de Regressão Parabólica</span>
<span class="n">alpha_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_1_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;beta_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_2_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;beta_2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_3_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;beta_3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_rp3</span> <span class="o">=</span> <span class="n">fit_p3</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="o">%%</span><span class="k">hide</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===================================================</span>
<span class="c1">#   Probabilidade à Posteriori de mu</span>
<span class="c1"># ===================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">mu_poli3</span> <span class="o">=</span> <span class="n">alpha_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> \
              <span class="n">beta_1_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">+</span> \
              <span class="n">beta_2_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> \
              <span class="n">beta_3_rp3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
                
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_poli3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Pontos da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Ajuste do modelo de Regressão Polinonimal 3 Grau&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================</span>
<span class="c1">#      Probabilidade à Posteriori - HPDI </span>
<span class="c1"># ============================================</span>
<span class="n">posteriori_polinomial3_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial3_HPDI</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_polinomial3_sigma</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="n">mu_poli3</span> <span class="o">=</span> <span class="n">alpha_rp3</span> <span class="o">+</span> <span class="n">beta_1_rp3</span> <span class="o">*</span> <span class="n">weight_i</span> <span class="o">+</span> <span class="n">beta_2_rp3</span> <span class="o">*</span> <span class="n">weight_i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">beta_3_rp3</span> <span class="o">*</span> <span class="n">weight_i</span><span class="o">**</span><span class="mi">3</span> 
    <span class="n">posteriori_polinomial3_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mu_poli3</span><span class="p">))</span>  <span class="c1"># média</span>
    <span class="n">posteriori_polinomial3_HPDI</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">mu_poli3</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">))</span>  <span class="c1"># HPDI</span>
    <span class="n">posteriori_polinomial3_sigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu_poli3</span><span class="p">,</span> <span class="n">sigma_rp3</span><span class="p">),</span> <span class="mf">0.89</span><span class="p">))</span>
    
<span class="n">posteriori_polinomial3_HPDI</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial3_HPDI</span><span class="p">)</span>
<span class="n">posteriori_polinomial3_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_polinomial3_sigma</span><span class="p">)</span>

<span class="c1"># Plontando o gráfico</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intervalos HPDI da posteriori da altura - Usando  HPDI  com &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">HPDI_range</span><span class="o">*</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">% d</span><span class="s1">e massa de probabilidade&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==============================================================================</span>
<span class="c1">#     Construindo o modelo de 1 grau para a comparação | Regressão Linear</span>
<span class="c1"># ==============================================================================</span>

<span class="n">height_p1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">values</span>
<span class="n">weight_p1</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">values</span>

<span class="n">weight_p1_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">weight_p1</span> <span class="o">-</span> <span class="n">weight_p1</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">weight_p1</span><span class="p">)</span>

<span class="n">model_stan_polinomio_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        vector[N] weight;</span>
<span class="s2">        vector[N] height;</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real alpha;</span>
<span class="s2">        real beta;</span>
<span class="s2">        real&lt;lower=0, upper=50&gt; sigma;</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(178, 20);</span>
<span class="s2">        beta ~ lognormal(0, 1);</span>
<span class="s2">        </span>
<span class="s2">        height ~ normal(alpha + beta*weight, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">height_p1</span><span class="p">),</span>
    <span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="n">weight_p1_s</span><span class="p">,</span>
    <span class="s1">&#39;height&#39;</span><span class="p">:</span> <span class="n">height_p1</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori_p1</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_stan_polinomio_1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
<span class="n">fit_p1</span> <span class="o">=</span> <span class="n">posteriori_p1</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha_p1</span> <span class="o">=</span> <span class="n">fit_p1</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_p1</span> <span class="o">=</span> <span class="n">fit_p1</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma_p1</span> <span class="o">=</span> <span class="n">fit_p1</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterioris_height_HPDIs_p1_mean</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mu_HPDI_p1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">posteriori_HPDI_p1</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">for</span> <span class="n">weight_i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
    <span class="n">posterioris_height_HPDIs_p1_mean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">alpha_p1</span> <span class="o">+</span> <span class="n">beta_p1</span> <span class="o">*</span> <span class="n">weight_i</span><span class="p">))</span>
    <span class="n">mu_HPDI_p1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">alpha_p1</span> <span class="o">+</span> <span class="n">beta_p1</span> <span class="o">*</span> <span class="n">weight_i</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">))</span>
    <span class="n">posteriori_HPDI_p1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha_p1</span> <span class="o">+</span> <span class="n">beta_p1</span> <span class="o">*</span> <span class="n">weight_i</span><span class="p">,</span> <span class="n">sigma_p1</span><span class="p">),</span> <span class="mf">0.85</span><span class="p">))</span>
    
<span class="n">posterioris_height_HPDIs_p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu_HPDI_p1</span><span class="p">)</span>
<span class="n">mu_HPDI_p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu_HPDI_p1</span><span class="p">)</span>
<span class="n">posteriori_HPDI_p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">posteriori_HPDI_p1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================================</span>
<span class="c1">#     Comparativo dos três modelos polinomiais </span>
<span class="c1"># ==================================================</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="c1"># ===============================================================================</span>
<span class="c1">#     Plotando o gráfico de regressão polinomial de grau 1 - Modelo Linear</span>
<span class="c1"># ===============================================================================</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs_p1_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">mu_HPDI_p1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">mu_HPDI_p1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_HPDI_p1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_HPDI_p1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posterioris_height_HPDIs_p1_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regressão Polinomial de 1 Grau&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>


<span class="c1"># ===============================================================================</span>
<span class="c1">#     Plotando o gráfico de regressão polinomial de grau 2 - Parábola</span>
<span class="c1"># ===============================================================================</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial2_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial2_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regressão Polinomial de 2 Grau&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="c1"># ===============================================================================</span>
<span class="c1">#     Plotando o gráfico de regressão polinomial de grau 3</span>
<span class="c1"># ===============================================================================</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_HPDI</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">posteriori_polinomial3_sigma</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">weight_full_std</span><span class="p">,</span> <span class="n">height_full</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">posteriori_polinomial3_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Regressão Polinomial de 3 Grau&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Altura (height)&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Peso (weight)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>O que fizemos aqui foi escolher uma forma matemática (<em>um polinômio de primeiro, de segundo e de terceiro grau</em>) e ajustarmos a melhor forma de cada um deles nos dados.</p>
<p>Como temos muitos dados, a nossa incerteza tende a ficar muito pequena o que pode nos levar a achar que o modelo está bem ajustado. As linhas não endossa o modelo, o que faz mais sentido é o modelo endossar as linhas.</p>
<p>Por isso temos que saber ser críticos com os modelos e sobre a sua estrutura geral, por que o modelo nunca fará isso por si mesmo. Ele não tem responsabilidade e capacidade para fazer isso. É de nossa responsabilidade fazer essa crítica, senão iremos <em>destruir Praga</em>.</p>
<p>Podemos perceber que essas linhas não se ajustam também aos dados de modo geral, mas também não há muita incerteza de onde elas estão. Isso é interessante, os intervalos de confiabilidade são minúsculos mas o ajuste  nos dados foi um ajuste ruim, o modelo tem pouca incerteza mas é um modelo ruim.</p>
<p>Outro problema dos polinômios é que ele não são monotônicos, ou seja, depois de certo estágio eles tendem a seguir indefinidamente até o infinito. Não há oscilações desse modelo.</p>
</div>
<div class="section" id="dores-dos-polinomios">
<h3>Dores dos Polinômios<a class="headerlink" href="#dores-dos-polinomios" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Polinômios fazem previsões absurdas fora do range dos dados.</p></li>
<li><p>Os parâmetros influenciam cada parte do corpo da curva, isso torna difícil de se entender.</p></li>
<li><p>Não são muito flexíveis, não podem ter curvas monotônicas.</p></li>
</ul>
<p>Essas perdas de estabilidade também podem ocorrer dentro do range dos dados, iremos ver bem mais para frente um exemplo disso.</p>
</div>
</div>
<div class="section" id="splines">
<h2>Splines<a class="headerlink" href="#splines" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="_images/splines_boat.jpg"><img alt="splines in boat" src="_images/splines_boat.jpg" style="width: 1000px;" /></a>
<p>Então, o que fazer agora? Existem muitas outras opções, a que vamos ver aqui é uma que bastante comum e realmente útil no dia-a-dia. Mas, ainda assim, contínua sendo um modelo <em>geocentrico</em>. Assim como todos os outros modelos! Por isso, precisamos responsabilidade ter com o modelo e não interpreta-lo demais.</p>
<p>As splines sugiram de uma motivação física. <code class="docutils literal notranslate"><span class="pre">Spline</span></code> é nome bastante estranho, mas é apenas a barra na foto acima.  Essa barra é recuada e fixada pontualmente (<em>pivot point</em>) pelos pesos de metal ao longo de seu comprimento. Vamos chamar esses pesos de <code class="docutils literal notranslate"><span class="pre">nós</span></code> (<em><code class="docutils literal notranslate"><span class="pre">knots</span></code></em>). Essa estrutura ainda hoje é usada por desenhistas para traçar a curvas de um casco de barco.</p>
</div>
<div class="section" id="agindo-localmente-b-splines">
<h2>Agindo Localmente - <em>B-splines</em><a class="headerlink" href="#agindo-localmente-b-splines" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Splines</span> <span class="pre">de</span> <span class="pre">base</span></code>, ou no inglês <em>basis-splines</em>, naturalmente são chamadas de <code class="docutils literal notranslate"><span class="pre">B-splines</span></code>. São funções todos seus parâmetros tem efeitos apenas locais e não globalmente como nos polinômios. São funções <em>wiggly</em>. Essa classe de funções são construídas com outras funções <em>wigglys</em> locais.</p>
<p>Vamos ver um exemplo, mas devemos sempre nos lembrar de que estamos construindo um modelo <em>geocêntrico</em>, e que este está apenas descrevendo o comportamento dos dados na estrutura do nosso modelo e não explicando eles. Iremos esses resultados para fazer previsões e, portanto, devemos ter responsabilidades sobre como funciona um modelo.</p>
<p><code class="docutils literal notranslate"><span class="pre">Funções</span> <span class="pre">de</span> <span class="pre">base</span></code>são apenas funções locais, e toda a spline é construída com interpolações deslizando suavemente entre essas funções locais, ou seja, as funções de base (<em>basis functions</em>).</p>
<p>Nós iremos construir uma grande <em>wiggly functions</em> a partir de outras <em>wiggly functions</em> menores. Mas cada uma dessas funções wiggly menores tem parâmetros locais que descrevem a sua importância, nós iremos ajustá-los e poderemos observar que não ocorrerá aquelas oscilações bruscas como ocorreu nas regressões polinomiais.</p>
<p>Esses modelos são melhores do que os polinômios, mas igualmente <em>geocêntricos</em>.</p>
<p><code class="docutils literal notranslate"><span class="pre">B-Splines</span> <span class="pre">bayesianas</span></code> são geralmente chamadas de <code class="docutils literal notranslate"><span class="pre">P-splines</span></code>. É usado comumente em pessoas que usam machine learning. O <code class="docutils literal notranslate"><span class="pre">P</span></code> significa <em>penalidades</em> que a priori dá para os pesos, mas rotulado dessa forma em contexto não bayesianos.</p>
<p>Mais para frente no curso iremos ver melhor os conceitos de penalidades e ficará bem mais claro o uso.</p>
<p><code class="docutils literal notranslate"><span class="pre">B-splines</span></code> são apenas apenas uma variação dos modelos lineares que vimos anteriormente. É um modelo aditivo que tem algumas variáveis sintéticas estranhas (não observáveis):</p>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha + w_1B_{i, 1}+ w_2B_{i, 2}+ w_3B_{i, 3}+ ...  \]</div>
<p>Os pesos <span class="math notranslate nohighlight">\(w_i\)</span> são como as inclinações. Isso é meio estranho por que o preditor de interesse não irá aparecer no modelo, no entanto, teremos uma aproximação fantástica da relação entre os preditores de interesse e o resultado. Parece estranho, mas funciona super bem.</p>
<p>As funções de bases (<em>basis functions</em>) <span class="math notranslate nohighlight">\(B\)</span> são variáveis sintéticas. Internamente elas são termos quadráticos ou termos cúbicos. Mas note que os dados não foram usados para construir <span class="math notranslate nohighlight">\(B\)</span>. Os valores de <span class="math notranslate nohighlight">\(B\)</span> associam pesos em diferentes regiões da variável <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>Vamos construir um exemplo, passo-a-passo, de como construir um modelos assim.</p>
</div>
<div class="section" id="festival-das-flores-de-cerejeira">
<h2>Festival das Flores de Cerejeira<a class="headerlink" href="#festival-das-flores-de-cerejeira" title="Permalink to this headline">¶</a></h2>
<div class="section" id="b-splines-do-clima">
<h3><em>B-splines</em> do Clima<a class="headerlink" href="#b-splines-do-clima" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/cherry_blossoms.jpg"><img alt="Cherry Blossoms" src="_images/cherry_blossoms.jpg" style="width: 1000px;" /></a>
<p>Cherry blossoms at Sugimura park, Hashimoto
<a class="reference external" href="https://en.wikipedia.org/wiki/Cherry_blossom">Wikipedia</a></p>
<p>Agora iremos usar os dados do histórico festival japones das flores de cerejeiras. O primeiro registro da uma flor de cerejeira nesse festival foi registrada a mais de <span class="math notranslate nohighlight">\(1200\)</span> anos atrás e, agora, nós temos esses dados abaixo para podermos explorar e entendê-los melhor.</p>
<p>Nos dados temos a variável de tempo, <code class="docutils literal notranslate"><span class="pre">year</span></code>, correspondente a cada ano de coleta dos dados. Temos os dados da época da floração e também a temperatura de Março. A temperatura influencia diretamente na floração das árvores pelo processo biológico natural.</p>
<p>Como podemos imaginar, essa relação é afetada pelas oscilações dos processos climáticos ao longo dos anos. Por agora nós iremos olhar para os dados da temperatura ao longo dos anos. Mas para frente ao longo do curso, iremos relacionar mais variáveis.</p>
<p>Fique como exercício construir um modelo linear da <code class="docutils literal notranslate"><span class="pre">temperatura</span></code> explicando a <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">do</span> <span class="pre">florecimento</span></code> (<em>doy</em>), existe um relacionamento muito forte e entenderemos o porque disso.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cherry_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/cherry_blossoms.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">cherry_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cherry Blossom </span><span class="se">\n</span><span class="s1"> Festival das Flores de Cerejeiras no Japão&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperatura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Nosso objetivo aqui é construir uma tendência com esses registros de temperaturas, o que significa que queremos estimar uma spline para esses dados.</p>
<p>Se quisermos observar uma tendência em uma determinda escala para compará-lás a algum movimento, então iremos precisar contruir uma tendência em uma certa escala.</p>
<p>O que iremos fazer aqui é trabalhar com a ideia de obter alguma aproximação da série com alguma qualidade arbitrária. Nós iremos começar com uma aproximação bastante ruim para entender as <em>wiggly functions</em> e após isso iremos construir modelos mais complexos e com melhores aproximações usando uma <em><code class="docutils literal notranslate"><span class="pre">B-splines</span></code></em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===================================================</span>
<span class="c1">#     Gráfico de Primeiro dia de Floração x anos</span>
<span class="c1"># ===================================================</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">doy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cherry Blossom </span><span class="se">\n</span><span class="s1"> Festival das Flores de Cerejeiras no Japão&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Primeiro dia de Floração&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="como-as-splines-funcionam">
<h2>Como as splines funcionam?<a class="headerlink" href="#como-as-splines-funcionam" title="Permalink to this headline">¶</a></h2>
<p>Aqui está um passo a passo de como construirmos uma splines.</p>
<ul class="simple">
<li><p><strong>Escolha alguns nós (<em>knots</em>)</strong>: localização da variável preditora onde a spline é ancorada! Assim determinaremos o local onde aquelas peças pesadas irão estar ao longo da barra de aço. É as peças pesada matemáticas onde os pontos de base fazem o pivô e determinam as lacunas entre as splines de base.</p></li>
<li><p><strong>Escolha os graus da função de base</strong>: O quanto é <em>wiggly</em>. Iremos demonstrar gráficamente esse a utilização dos graus no decorrer da explicação.</p></li>
<li><p><strong>Encontre a distribuição posteriori dos pesos</strong>: Como anteriormente iremos fazer a estimativa bayesiana dos pesos, muito próximos como fizemos nos modelos de regressão.</p></li>
</ul>
<div class="section" id="knots-como-escolher-os-pontos">
<h3>Knots - Como escolher os pontos?<a class="headerlink" href="#knots-como-escolher-os-pontos" title="Permalink to this headline">¶</a></h3>
<p>Exite uma grande literatura de abordagens de como devemos escolhermos os pontos. Uma dos métodos mais comuns e eficientes são distribuí-los de acordo com seus <em>quantis</em>, pois assim podemos distribuir mais pontos onde há um acúmulo maior dos dados. Geralmente pacotes e livrarias computacionais já nos trazem esses dados de modo automático e de uma certa forma mágicos. Nós iremos construir todo esse modelo manualmente para que entendermos os detalhes de seu funcionamento.</p>
<p>O que vamos propor é colocar um <em>knot</em> na mediana, um <em>knot</em> em cada extremidade e outros dois no centros, conforme mostrado no gráfico abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configurando a variável de tempo.</span>
<span class="n">year</span> <span class="o">=</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">values</span>

<span class="n">qty_knots</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Quantidade de nós que iremos usar.</span>
<span class="n">knots_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">qty_knots</span><span class="p">)</span>

<span class="c1"># Ref: https://numpy.org/doc/stable/reference/generated/numpy.isfinite.html?highlight=isfinite#numpy.isfinite</span>
<span class="n">year</span> <span class="o">=</span> <span class="n">year</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">year</span><span class="p">)]</span>  <span class="c1"># Removendo os elementos NaN&#39;s</span>

<span class="c1"># Encontrando os knots tomando como base os quantiles</span>
<span class="n">knots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">knots_array</span><span class="p">)</span>
<span class="n">knots</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">knots</span><span class="p">]</span>  <span class="c1"># Convertendo os valores do Knots para inteiro</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">knots</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">knots</span><span class="p">))</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">[</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkred&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Cherry Blossom </span><span class="se">\n</span><span class="s1"> Festival das Flores de Cerejeiras no Japão&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Temperatura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Vamos agora construir as splines e os nós (<em>knots</em>). Iremos desenhar abaixo todas as variáveis sintéticas. Os valores das variáveis sintéticas são construídas ao longo de todo intervalo da variável <code class="docutils literal notranslate"><span class="pre">ano</span></code>. E então queremos interpolar os dados.</p>
<p>Uma das maneiras de pensar a respeito disso é pensar o ano como uma variável na qual nunca iremos usar novamente, usaremos apenas para definir os <em>knots</em> como âncoras sobre alguns anos específicos, mas nunca usaremos esses dados novamente.</p>
<p>Para começar iremos construir algumas funções de base (<em>basis functions</em>). Vamos começar com as funções de bases  mais simples, funções de base de grau 1, o que é uma linha reta. Com isso iremos contruir uma <em>wiggly functions</em> composta de várias funcões de base de primeiro grau que são as linhas retas.</p>
<a class="reference internal image-reference" href="_images/splines_2.jpg"><img alt="splines com pesos" src="_images/splines_2.jpg" style="width: 500px;" /></a>
<p><em>Os comentários das funções também serão escritos em português, assim como os textos e comentários de linhas de códigos estão sendo feitos. O objetivo agora é facilitar a explicação e não colocar esses código em produção! Mas algumas coisas podem ficar estranhas escritas em 2 linguas. Portanto, tentarei deixar o mais harmonioso possível.</em>
:-)</p>
<p>Para a construção das splines, iremos usar a função disponível na biblioteca <em>SciKit Learn</em> e sua documentação pode ser acessada <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.SplineTransformer.html#examples-using-">clicando aqui.</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">SplineTransformer</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ======================================</span>
<span class="c1">#     Construindo a Spline - Ordem 1</span>
<span class="c1"># ======================================</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">spline_1</span> <span class="o">=</span> <span class="n">SplineTransformer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_knots</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># É utilizado um intervalo equidistante entre os quantis, por padrão. </span>
<span class="n">spline_1</span> <span class="o">=</span> <span class="n">spline_1</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spline_1</span><span class="p">)</span>

<span class="n">marco_eixo_x</span> <span class="o">=</span> <span class="mi">1306</span>  <span class="c1"># Local no eixo X que a linha tracejada será plotada</span>
<span class="n">marco_eixo_y_cima</span> <span class="o">=</span> <span class="n">spline_1</span><span class="p">[</span><span class="n">marco_eixo_x</span> <span class="o">-</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">marco_eixo_y_baixo</span> <span class="o">=</span> <span class="n">spline_1</span><span class="p">[</span><span class="n">marco_eixo_x</span> <span class="o">-</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>  <span class="c1"># Linha tracejada vertical</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">,</span> <span class="n">marco_eixo_y_cima</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Ponto de marcação de cima</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">,</span> <span class="n">marco_eixo_y_baixo</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Ponto de marcação de baixo</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">marco_eixo_x</span> <span class="o">-</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">marco_eixo_x</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;B-Splines de grau 1&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Anos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1940</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Assim como as splines para os desenhistas como na imagens acima, nós, estatísticos, usamos elas de modo semelhantes em matemática. No gráfico acima plotamos <span class="math notranslate nohighlight">\(5\)</span> funções de bases (<em>basis-function</em>) tendo como ponto central os nós (<em>knots</em>) que definimos anteriormente.</p>
<p>Para entendermos o funcionamento dessa estrutura, temos que perceber 2 coisas: Os dois pontos pretos que estão plotados no gráfico acima, esses pontos sempre estarão sobre 2 funcões de base, como por exemplo na função referente ao nó 2 <em>(<span class="math notranslate nohighlight">\(knot_2\)</span>)</em> e ao nó 3 <em>(<span class="math notranslate nohighlight">\(knot_3\)</span>)</em>. Isso sempre será verdade, exceto quando a posição do <code class="docutils literal notranslate"><span class="pre">eixo</span> <span class="pre">x</span></code> estiver exatamente sobre a posição de alguns do nós.</p>
<p>A próxima observação é que cada uma das funções de base será multiplicada por um número, esse número irá modificar a sua estrutura podendo aumenta-lá ou a encurtar. Esse peso, como veremos mais adiante, será rotulado de <span class="math notranslate nohighlight">\(w\)</span>. Assim, após essa modificação ser aplicada em todas as curvas, iremos somar todos os pontos pretos e obteremos a nossa <em>B-spline</em>, ou seja, uma nova curva que é a resultante da soma de todas as curvas multiplicada por ser respectivos pesos.</p>
<p>O interessante que notamos aqui é que, na regressão polinomial usamos as variáveis explicativas (<em><span class="math notranslate nohighlight">\(X\)</span></em>) da nossa amostra com alguns ajustes, elevado ao quadrado ou elevado ao cubo, para construção do nosso modelo. No modelo de splines que iremos construir, a variável explicativa é uma variávei sintética, ou seja, uma variável que nós criamos e que não tem nenhuma relação com o modelo em si.</p>
<p>O que buscamos com o modelo de splines é estimar <strong>quais seriam os pesos mais plausíveis</strong> que melhor descreve nossos dados. Parece muito estranho fazer isso, mais funciona muito bem! Vamos ver um exemplo de como isso acontece.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Histograma da Temperatura do período de Floração das Cerejeiras&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Temperatura&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequências&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Com as splines definidas acima, iremos construir nosso modelo em <em>Stan</em> para estimar a temperatura em cada ano da floração das cerejeiras. Iremos supor que a temperatura é distribuída normalmente, conforme gráfico acima.</p>
<p>O modelo matemático será descrito como:</p>
<div class="math notranslate nohighlight">
\[ temperatura \sim normal(\mu, \sigma) \]</div>
<p>no qual a média, <span class="math notranslate nohighlight">\(\mu\)</span>, será construída da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ \mu = \alpha + w_1  B_{i, 1} + w_2  B_{i, 2} + w_3  B_{i, 3} + w_4  B_{i, 4} +  w_5  B_{i, 5}\]</div>
<p>Para evitarmos de termos que escrever todos os termos na mão dentro da <em>stan</em>, podemos reescrever a equação acima da seguinte forma:</p>
<div class="math notranslate nohighlight">
\[ \mu = \alpha + w_k  B_{i, k} \]</div>
<p>Essa notação matemática converte a equação acima para uma simples multiplicação de matrizes, conforme vimos no ensino médio, e assim, tanto evitamos reescrever todos os termos manualmente quanto conseguirmos otimizar os custos computacionais envolvidos nos cálculos. (<em>Geralmente é sempre uma boa ideia utilizar matrizes.</em>)</p>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==================================</span>
<span class="c1">#   Construindo o modelo b-spline</span>
<span class="c1"># ==================================</span>

<span class="n">model_spline_1</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int&lt;lower=0&gt; N;  // Número de observações</span>
<span class="s2">        int&lt;lower=0&gt; K;  // Número de Knots</span>
<span class="s2">        matrix[N, K] B;  // B-splines</span>
<span class="s2">        vector[N] temp;  // Variável resposta (y)</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">        real alpha;</span>
<span class="s2">        vector[K] w;  // Pesos</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(100, 10);  // Priori para alpha</span>
<span class="s2">        w ~ normal(0, 1);         // Priori para w</span>
<span class="s2">        sigma ~ exponential(1);   // Priori para sigma</span>
<span class="s2">        </span>
<span class="s2">        temp ~ normal(alpha + B * w, sigma);  // Verossimilhanças (Likelohood)</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spline_1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Número de amostras</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spline_1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Número de nós (knots)</span>

<span class="n">dados</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span>
    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">spline_1</span><span class="p">),</span>
    <span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># Colocando os valores NA como média da série.</span>
<span class="p">}</span>

<span class="n">posteriori_spline_1</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_spline_1</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dados</span><span class="p">)</span>
<span class="n">fit_spline_1</span> <span class="o">=</span> <span class="n">posteriori_spline_1</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha_spline_1</span> <span class="o">=</span> <span class="n">fit_spline_1</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
<span class="n">w_spline_1</span> <span class="o">=</span> <span class="n">fit_spline_1</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
<span class="n">sigma_spline_1</span> <span class="o">=</span> <span class="n">fit_spline_1</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">Bw_spline_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">spline_1</span><span class="p">,</span> <span class="n">w_spline_1</span><span class="p">)</span>  <span class="c1"># Fazendo a multiplicação das matrizes B * w </span>
</pre></div>
</div>
</div>
</div>
<p>Com o modelo ajustado, temos a estimativa do parâmetro <span class="math notranslate nohighlight">\(w\)</span>, que são os pesos de cada uma das funções de base. Para sabermos qual o efeito gerado de cada um desses pesos aplicados ao nas funções, multiplicamos ambos:</p>
<div class="math notranslate nohighlight">
\[ \mbox{Bw_spline_1} = w_k B_{i, k} \]</div>
<p>O resultado dessa operação pode ser visto no gráfico abaixo.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ====================================================</span>
<span class="c1">#    Plot da Posteriori do Mu da B-Spline de Grau 1</span>
<span class="c1"># ====================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>  <span class="n">Bw_spline_1</span><span class="p">,</span>  <span class="c1"># Plot do B * w</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
 
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;$B*w$ da B-Spline&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$B*w$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1940</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Para conseguirmos verificar a estimativa da temperatura de modo visual, somaremos ao valor de <code class="docutils literal notranslate"><span class="pre">Bw_spline_1</span></code> o valor <code class="docutils literal notranslate"><span class="pre">alpha_spline_1</span></code>, que é a estimativa do valor médio da temperatura. Veja a seguir o gráfico.</p>
<p>Assim como em outros modelos anteriores, temos a região de plausibilidade dada pelas retas em cada um do nós. Apesar de termos apenas <span class="math notranslate nohighlight">\(5\)</span> nós, a estimativa para <span class="math notranslate nohighlight">\(\mu\)</span> é muito boa.</p>
<p>Para termos uma estimativa mais detalhada, devemos aumentar o número de nós e também alterar o grau das funções de bases usada. Quando maior o número de nós e, também, maior o número do grau das funções de base, tendemos a ter um ajuste mais preciso.</p>
<p>Um ajuste preciso pode ser preocupante e estragar nosso dia, o motivo disso é um efeito conhecido como <code class="docutils literal notranslate"><span class="pre">overffiting</span></code>. Iremos tratar disso mais adiante, mas de modo geral <em>overffting</em>, ou sobreajuste, é a capacidade do modelo identificar detalhes minuciosos na amostra mas não consegue ser bom em identificar os detalhes na população. Por enquanto, iremos apenas entender como é o funcionamento de uma spline e em capítulos posteriores, veremos mais detalhes sobre o fantasma do <code class="docutils literal notranslate"><span class="pre">overffiting</span></code> em nossos modelo.</p>
<a class="reference internal image-reference" href="_images/overffiting.jpg"><img alt="overffiting example" src="_images/overffiting.jpg" style="width: 500px;" /></a>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ======================================================</span>
<span class="c1">#    Plot da Posteriori de mu da B-Spline de Grau 1</span>
<span class="c1"># ======================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">n_plot</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Define a quantidade de simulações para o plot</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Plot da amostra</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">alpha_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bw_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">],</span>  <span class="c1"># mu</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
 
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori de mu da B-Spline&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$\mu$ </span><span class="se">\n</span><span class="s1"> (Temperatura de Março)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span>  <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1940</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==========================================================</span>
<span class="c1">#      Reamostragem da Posteriori B-Spline de Grau 1 </span>
<span class="c1"># ==========================================================</span>

<span class="n">posteriori_spline_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha_spline_1</span> <span class="o">+</span> <span class="n">Bw_spline_1</span><span class="p">,</span> <span class="n">sigma_spline_1</span><span class="p">)</span>  <span class="c1"># Amostras normal(mu, sigma)</span>

<span class="n">intervalo_credibilidade</span> <span class="o">=</span> <span class="mf">0.88</span>  <span class="c1"># Intervalo de credibilidade - HPDI</span>

<span class="n">HPDI_posteriori_spline_1</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Vetor do HPDI</span>

<span class="k">for</span> <span class="n">year_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">posteriori_spline_1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># OBS: Essa operação é um pouco demorada. </span>
    <span class="n">HPDI_posteriori_spline_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posteriori_spline_1</span><span class="p">[</span><span class="n">year_i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">intervalo_credibilidade</span><span class="p">))</span>

<span class="n">HPDI_posteriori_spline_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HPDI_posteriori_spline_1</span><span class="p">)</span>
<span class="n">mean_posteriori_spline_1</span> <span class="o">=</span> <span class="n">posteriori_spline_1</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Média do HPDI por cada ano</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===============================================</span>
<span class="c1">#    Plot da Posteriori da B-Spline de Grau 1</span>
<span class="c1"># ===============================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Plot da amostra</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">HPDI_posteriori_spline_1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">HPDI_posteriori_spline_1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># Plot HPDI</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HPDI da Posteriori&#39;</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">mean_posteriori_spline_1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Média da posteriori&#39;</span><span class="p">)</span>  <span class="c1"># Plot da Média</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">alpha_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bw_spline_1</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">],</span>  <span class="c1"># Plot do Intevalo da Média (Sem o HPDI)</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori da B-Spline </span><span class="se">\n</span><span class="s1"> HPDI de &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intervalo_credibilidade</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Posteriori </span><span class="se">\n</span><span class="s1"> (Temperatura de Março)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">780</span><span class="p">,</span>  <span class="mf">7.7</span><span class="p">,</span><span class="s1">&#39;$Knot_1$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1050</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">,</span><span class="s1">&#39;$Knot_2$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1370</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span><span class="s1">&#39;$Knot_3$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1670</span><span class="p">,</span> <span class="mf">6.8</span><span class="p">,</span><span class="s1">&#39;$Knot_4$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span><span class="s1">&#39;$Knot_5$&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkgray&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ======================================</span>
<span class="c1">#      Construindo a Spline - Ordem 3</span>
<span class="c1"># ======================================</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">spline_3</span> <span class="o">=</span> <span class="n">SplineTransformer</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_knots</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># É utilizado um intervalo equidistante entre os quantis, por padrão. </span>
<span class="n">spline_3</span> <span class="o">=</span> <span class="n">spline_3</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spline_3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;B-Splines de grau 3&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Anos&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =======================================================</span>
<span class="c1">#   Construindo o modelo b-spline de grau 3 com 15 nós</span>
<span class="c1"># =======================================================</span>

<span class="c1"># Perceba que o modelo de grau 3 terá a mesma estrutura do modelo de grau 1 </span>
<span class="n">model_spline_3</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int&lt;lower=0&gt; N;  // Número de observações</span>
<span class="s2">        int&lt;lower=0&gt; K;  // Número de Knots</span>
<span class="s2">        matrix[N, K] B;  // B-splines</span>
<span class="s2">        vector[N] temp;  // Variável resposta (y)</span>
<span class="s2">    }</span>

<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">        real alpha;</span>
<span class="s2">        vector[K] w;  // Pesos</span>
<span class="s2">    }</span>

<span class="s2">    model {</span>
<span class="s2">        alpha ~ normal(100, 10);  // Priori para alpha</span>
<span class="s2">        w ~ normal(0, 1);         // Priori para w</span>
<span class="s2">        sigma ~ exponential(1);   // Priori para sigma</span>
<span class="s2">        </span>
<span class="s2">        temp ~ normal(alpha + B * w, sigma);  // Verossimilhanças (Likelohood)</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spline_3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Número de amostras</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spline_3</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Número de nós (knots)</span>

<span class="n">dados</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span>
    <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="n">K</span><span class="p">,</span>
    <span class="s1">&#39;B&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">spline_3</span><span class="p">),</span>
    <span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>  <span class="c1"># Colocando os valores NA como média da série.</span>
<span class="p">}</span>

<span class="n">posteriori_spline_3</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model_spline_3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dados</span><span class="p">)</span>
<span class="n">fit_spline_3</span> <span class="o">=</span> <span class="n">posteriori_spline_3</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">alpha_spline_3</span> <span class="o">=</span> <span class="n">fit_spline_3</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
<span class="n">w_spline_3</span> <span class="o">=</span> <span class="n">fit_spline_3</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
<span class="n">sigma_spline_3</span> <span class="o">=</span> <span class="n">fit_spline_3</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">Bw_spline_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">spline_3</span><span class="p">,</span> <span class="n">w_spline_3</span><span class="p">)</span>  <span class="c1"># Fazendo a multiplicação das matrizes B * w</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ====================================================</span>
<span class="c1">#    Plot da Posteriori do Mu da B-Spline de Grau 3</span>
<span class="c1"># ====================================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>  <span class="n">Bw_spline_3</span><span class="p">,</span>  <span class="c1"># Plot do B * w</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 
 
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;$B*w$ da B-Spline grau 3&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;$B*w$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==========================================================</span>
<span class="c1">#      Reamostragem da Posteriori B-Spline de Grau 3 </span>
<span class="c1"># ==========================================================</span>

<span class="n">posteriori_spline_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">alpha_spline_3</span> <span class="o">+</span> <span class="n">Bw_spline_3</span><span class="p">,</span> <span class="n">sigma_spline_3</span><span class="p">)</span>  <span class="c1"># Amostras normal(mu, sigma)</span>

<span class="c1"># Intervalo de credibilidade - HPDI</span>
<span class="c1">#  Lembre-se: a velocidade do cálculo do HPDI é tão mais rápido quando </span>
<span class="c1">#             mais próximo de 1 estiver o valor do intervalo_credibilidade</span>
<span class="c1">#  Altere esses valores para perceber a abertura do intevalo de credibilidade sobre os dados.</span>
<span class="n">intervalo_credibilidade</span> <span class="o">=</span> <span class="mf">0.89</span>

<span class="n">HPDI_posteriori_spline_3</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Vetor do HPDI</span>

<span class="k">for</span> <span class="n">year_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">posteriori_spline_3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># XXX: Essa operação é um pouco demorada. </span>
    <span class="n">HPDI_posteriori_spline_3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HPDI</span><span class="p">(</span><span class="n">posteriori_spline_3</span><span class="p">[</span><span class="n">year_i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">intervalo_credibilidade</span><span class="p">))</span>

<span class="n">HPDI_posteriori_spline_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HPDI_posteriori_spline_3</span><span class="p">)</span>
<span class="n">mean_posteriori_spline_3</span> <span class="o">=</span> <span class="n">posteriori_spline_3</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Média do HPDI por cada ano</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===============================================</span>
<span class="c1">#    Plot da Posteriori da B-Spline de Grau 3</span>
<span class="c1"># ===============================================</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">cherry_df</span><span class="o">.</span><span class="n">temp</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>  <span class="c1"># Plot da amostra</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">HPDI_posteriori_spline_3</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">HPDI_posteriori_spline_3</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># Plot HPDI</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;HPDI da Posteriori&#39;</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">mean_posteriori_spline_3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Média da posteriori&#39;</span><span class="p">)</span>  <span class="c1"># Plot da Média</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cherry_df</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">alpha_spline_3</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bw_spline_3</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_plot</span><span class="p">],</span>  <span class="c1"># Plot do Intevalo da Média (Sem o HPDI)</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteriori da B-Spline </span><span class="se">\n</span><span class="s1"> HPDI de &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">intervalo_credibilidade</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Ano&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Posteriori </span><span class="se">\n</span><span class="s1"> (Temperatura de Março)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mf">8.1</span><span class="p">,</span> <span class="s1">&#39;Um problema que pode acontecer </span><span class="se">\n</span><span class="s1"> quando geramos a spline com a </span><span class="se">\n</span><span class="s1"> última e a primeira ponta da função </span><span class="se">\n</span><span class="s1"> &quot;presa&quot;.&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="possibilidades-das-splines">
<h3>Possibilidades das Splines<a class="headerlink" href="#possibilidades-das-splines" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A quantidade de nós e os graus da funções de base são nossa escolhas</p></li>
</ul>
<p>Exitem muitas diferente maneiras de se definir uma spline, assim como existem muitos outros tipos de splines. As que vimos aqui foram as splines mais simples.</p>
<p>Obs: No curso a definição das b-splines são um pouco diferente das que usamos aqui. Para saber com é o formato das funções que o Richard usa ver a aula <a class="reference external" href="https://www.youtube.com/watch?v=ENxTrFf9a7c&amp;list=PLDcUM9US4XdNM4Edgs7weiyIguLSToZRI">Statistical Rethinking Winter 2019 Lecture 04</a> a partir dos 57 minutos.</p>
<ul class="simple">
<li><p>Devemos nos preocupar com o overfitting dos dados (Veremos isso no capíputo 7).</p></li>
<li><p>Outros tipos de splines não precisam de nós (<em>knots</em>)</p></li>
<li><p>Uma outra ideia de aproximação que veremos no capítulo 14 será as ideias dos <code class="docutils literal notranslate"><span class="pre">Processos</span> <span class="pre">Gaussianos</span></code>.</p></li>
<li><p>Todas as splines são descritivas e não mecanicista.</p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="parte_3.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">3- Modelos Geocêntricos</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="parte_5.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">5 - Muitas variáveis e os waffles espúrios</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Rodolpho Macedo dos Santos<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>