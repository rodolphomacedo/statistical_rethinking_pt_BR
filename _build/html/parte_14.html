
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>14 - Aventuras na CovariÃ¢ncias &#8212; Statistical Rethinking</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="13 - Modelos com MemÃ³ria" href="parte_13.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="capa.html">
   Estatistica Bayesiana
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_pt-BR.html">
   Intro - EstatÃ­stica Bayesiana (ðŸ‡§ðŸ‡·)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intro_en.html">
   Intro - Bayesian Statistics (ðŸ‡ºðŸ‡¸)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_1.html">
   1- IntroduÃ§Ã£o
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_2.html">
   2 - Engenharia de Golems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_3.html">
   3- Modelos GeocÃªntricos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_4.html">
   4 - FunÃ§Ãµes Wiggly
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_5.html">
   5 - Muitas VariÃ¡veis e os Waffles EspÃºrios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_6.html">
   6 - Os DAGs assombrados &amp; O Terror Causal
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_7.html">
   7 - Compasso de Ulisses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_8.html">
   8 - Os peixes-bois condicionais
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_9.html">
   9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_10.html">
   10 - Grande Entropia e Modelos Lineares Generalizados
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_11.html">
   11 - A cravada de Deus e Inteiros
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_12.html">
   12 - Monstros e Misturas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_13.html">
   13 - Modelos com MemÃ³ria
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   14 - Aventuras na CovariÃ¢ncias
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/parte_14.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR/issues/new?title=Issue%20on%20page%20%2Fparte_14.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/rodolphomacedo/statistical_rethinking_pt_BR/main?urlpath=tree/parte_14.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports-loadings-and-functions">
   Imports, loadings and functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#varing-slopes-by-contructions">
   14.1 Varing Slopes by Contructions
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-1">
     R Code 14.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-2">
     R Code 14.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-3">
     R Code 14.3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     R Code 14.3
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-4">
     R Code 14.4
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-5">
     R Code 14.5
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-6">
     R Code 14.6
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-7">
     R Code 14.7
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-8">
     R Code 14.8
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-9">
     R Code 14.9
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-10">
     R Code 14.10
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-varing-slope-model">
   14.1.3 The varing slope model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-11">
     R Code 14.11
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-12">
     R Code 14.12
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-13">
     R Code 14.13
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-14-r-code-14-15">
     R Code 14.14 &amp; R Code 14.15
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-16-r-code-14-17">
     R Code 14.16 &amp; R Code 14.17
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-varing-slopes">
   14.2 Advanced varing Slopes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-18">
     R Code 14.18
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#important-features-to-understanding-this-model">
   Important features to understanding this model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview-of-data-types">
     5.1 Overview of data types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#array-types-stan-docs-link">
       Array types (stan docs link)
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vector-and-matrix-data-types">
     5.5 Vector and matrix data types
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#array-data-type">
     5.6 Array data type
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#depreciated-features-in-stan-to-build-this-example">
     Depreciated Features in Stan to build this example:
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#explanation">
       Explanation:
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#response">
       Response:
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-19">
     R Code 14.19
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-this-model-is-works">
       How this model is works?
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-20">
     R Code 14.20
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-21">
     R Code 14.21
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-22">
     R Code 14.22
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#instrumental-and-causal-designs">
   14.3 Instrumental and Causal Designs
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-23">
     R Code 14.23
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-14-25">
     R Code 14.25
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="aventuras-na-covariancias">
<h1>14 - Aventuras na CovariÃ¢ncias<a class="headerlink" href="#aventuras-na-covariancias" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="imports-loadings-and-functions">
<h2>Imports, loadings and functions<a class="headerlink" href="#imports-loadings-and-functions" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Ellipse</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="c1"># from causalgraphicalmodels import CausalGraphicalModel</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="c1"># ArviZ ships with style sheets!</span>
<span class="c1"># https://python.arviz.org/en/stable/examples/styles.html#example-styles</span>
<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">import</span> <span class="nn">stan</span>
<span class="kn">import</span> <span class="nn">nest_asyncio</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span>

<span class="c1"># To DAG&#39;s</span>
<span class="kn">import</span> <span class="nn">daft</span>
<span class="kn">from</span> <span class="nn">causalgraphicalmodels</span> <span class="kn">import</span> <span class="n">CausalGraphicalModel</span>  <span class="c1"># Just work in &lt; python3.9 </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add fonts to matplotlib to run xkcd</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">font_manager</span>

<span class="n">font_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fonts/&quot;</span><span class="p">]</span>  <span class="c1"># The path to the custom font file.</span>
<span class="n">font_files</span> <span class="o">=</span> <span class="n">font_manager</span><span class="o">.</span><span class="n">findSystemFonts</span><span class="p">(</span><span class="n">fontpaths</span><span class="o">=</span><span class="n">font_dirs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">font_file</span> <span class="ow">in</span> <span class="n">font_files</span><span class="p">:</span>
    <span class="n">font_manager</span><span class="o">.</span><span class="n">fontManager</span><span class="o">.</span><span class="n">addfont</span><span class="p">(</span><span class="n">font_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To make plots like drawing </span>
<span class="c1"># plt.xkcd()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To running the stan in jupyter notebook</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># https://matplotlib.org/stable/gallery/statistics/confidence_ellipse.html</span>
<span class="k">def</span> <span class="nf">get_correlated_dataset</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dependency</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">latent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">dependent</span> <span class="o">=</span> <span class="n">latent</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
    <span class="n">scaled</span> <span class="o">=</span> <span class="n">dependent</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">scaled_with_offset</span> <span class="o">=</span> <span class="n">scaled</span> <span class="o">+</span> <span class="n">mu</span>
    <span class="c1"># return x and y of the new, correlated dataset</span>
    <span class="k">return</span> <span class="n">scaled_with_offset</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">scaled_with_offset</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># https://matplotlib.org/stable/gallery/statistics/confidence_ellipse.html</span>
<span class="k">def</span> <span class="nf">confidence_ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a plot of the covariance confidence ellipse of *x* and *y*.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x, y : array-like, shape (n, )</span>
<span class="sd">        Input data.</span>

<span class="sd">    ax : matplotlib.axes.Axes</span>
<span class="sd">        The axes object to draw the ellipse into.</span>

<span class="sd">    n_std : float</span>
<span class="sd">        The number of standard deviations to determine the ellipse&#39;s radiuses.</span>

<span class="sd">    **kwargs</span>
<span class="sd">        Forwarded to `~matplotlib.patches.Ellipse`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.patches.Ellipse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;x and y must be the same size&quot;</span><span class="p">)</span>

    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">pearson</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Using a special case to obtain the eigenvalues of this</span>
    <span class="c1"># two-dimensional dataset.</span>
    <span class="n">ell_radius_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">pearson</span><span class="p">)</span>
    <span class="n">ell_radius_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pearson</span><span class="p">)</span>
    <span class="n">ellipse</span> <span class="o">=</span> <span class="n">Ellipse</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">ell_radius_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">ell_radius_y</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Calculating the standard deviation of x from</span>
    <span class="c1"># the squareroot of the variance and multiplying</span>
    <span class="c1"># with the given number of standard deviations.</span>
    <span class="n">scale_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>
    <span class="c1">#scale_x = n_std</span>
    <span class="n">mean_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1"># calculating the standard deviation of y ...</span>
    <span class="n">scale_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">n_std</span>
    <span class="c1">#scale_y = n_std</span>
    <span class="n">mean_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="n">transf</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Affine2D</span><span class="p">()</span> \
        <span class="o">.</span><span class="n">rotate_deg</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale_x</span><span class="p">,</span> <span class="n">scale_y</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">mean_x</span><span class="p">,</span> <span class="n">mean_y</span><span class="p">)</span>

    <span class="n">ellipse</span><span class="o">.</span><span class="n">set_transform</span><span class="p">(</span><span class="n">transf</span> <span class="o">+</span> <span class="n">ax</span><span class="o">.</span><span class="n">transData</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">ellipse</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">draw_ellipse</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">plot_points</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax_nstd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

    <span class="n">dependency_nstd</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span>

    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">get_correlated_dataset</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">dependency_nstd</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax_nstd</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">plot_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">plot_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">level</span><span class="p">:</span>
        <span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax_nstd</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># ax_nstd.scatter(mu[0], mu[1], c=&#39;red&#39;, s=3)</span>
    <span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CafÃ©s sampled - Figure 14.2&#39;</span><span class="p">)</span>
    <span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;intercepts (a_cafe)&#39;</span><span class="p">)</span>
    <span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;slopes (b_cafe)&#39;</span><span class="p">)</span>
    
    <span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">6.2</span><span class="p">)</span>
    <span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.51</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="varing-slopes-by-contructions">
<h2>14.1 Varing Slopes by Contructions<a class="headerlink" href="#varing-slopes-by-contructions" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="r-code-14-1">
<h3>R Code 14.1<a class="headerlink" href="#r-code-14-1" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mf">3.5</span>        <span class="c1"># Average morning wait time</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># Average difference afternoon wait time</span>
<span class="n">sigma_a</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c1"># std dev in intercepts</span>
<span class="n">sigma_b</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># std in slopes</span>
<span class="n">rho</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.7</span><span class="p">)</span>   <span class="c1"># correlation between intercepts and slopes</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-2">
<h3>R Code 14.2<a class="headerlink" href="#r-code-14-2" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span>  <span class="c1"># Vector</span>
<span class="n">Mu</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 3.5, -1. ])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-3">
<h3>R Code 14.3<a class="headerlink" href="#r-code-14-3" title="Permalink to this headline">Â¶</a></h3>
<p>The matrix variance and covariance:</p>
<div class="math notranslate nohighlight">
\[\begin{split} 
\begin{pmatrix}
\mbox{variance of intercepts} &amp; \mbox{covariance of intercepts &amp; Slopes} \\
\mbox{covariance of intercepts &amp; Slopes} &amp; \mbox{variance of slopes}
\end{pmatrix}
\end{split}\]</div>
<p>And in math form:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{pmatrix}
\sigma^2_\alpha &amp; \sigma_\alpha\sigma_\beta\rho \\
\sigma_\alpha\sigma_\beta\rho &amp; \sigma^2_\beta
\end{pmatrix}
\end{split}\]</div>
</div>
<div class="section" id="id1">
<h3>R Code 14.3<a class="headerlink" href="#id1" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cov_ab</span> <span class="o">=</span> <span class="n">sigma_a</span> <span class="o">*</span> <span class="n">sigma_b</span> <span class="o">*</span> <span class="n">rho</span>
<span class="n">Sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span>
    <span class="p">[</span><span class="n">sigma_a</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">cov_ab</span><span class="p">],</span>
    <span class="p">[</span><span class="n">cov_ab</span><span class="p">,</span> <span class="n">sigma_b</span><span class="o">**</span><span class="mi">2</span><span class="p">]</span>
<span class="p">])</span>
<span class="n">Sigma</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[ 1.  , -0.35],
        [-0.35,  0.25]])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-4">
<h3>R Code 14.4<a class="headerlink" href="#r-code-14-4" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[1, 2],
        [3, 4]])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-5">
<h3>R Code 14.5<a class="headerlink" href="#r-code-14-5" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sigma_a</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">])</span>  <span class="c1"># Standart Deviations</span>

<span class="n">sigmas</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1. , 0.5])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span>
    <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">rho</span><span class="p">],</span>
    <span class="p">[</span><span class="n">rho</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">])</span>  <span class="c1"># Correlation Matrix</span>

<span class="n">Rho</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[ 1. , -0.7],
        [-0.7,  1. ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Multiply to get covariance matrix</span>
<span class="n">Sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span> <span class="o">*</span> <span class="n">Rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span>

<span class="n">Sigma</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[ 1.  , -0.35],
        [-0.35,  0.25]])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-6">
<h3>R Code 14.6<a class="headerlink" href="#r-code-14-6" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_cafe</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-7">
<h3>R Code 14.7<a class="headerlink" href="#r-code-14-7" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>   <span class="c1"># used to replicate example</span>

<span class="n">vary_effects</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">Mu</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">Sigma</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N_cafe</span><span class="p">)</span>
<span class="n">vary_effects</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 3.02149593, -0.9304358 ],
       [ 1.05666673, -0.12762876],
       [ 3.58546284, -0.46432203],
       [ 4.3297356 , -1.53991745],
       [ 3.27332508, -1.02933771],
       [ 4.65859716, -1.5303893 ],
       [ 3.93018946, -0.9524405 ],
       [ 5.06625508, -1.869279  ],
       [ 2.58529637,  0.0287956 ],
       [ 5.07890482, -1.39033508],
       [ 4.36801698, -1.65042937],
       [ 4.31342478, -1.47263713],
       [ 2.59854231, -0.38835499],
       [ 3.39670791, -1.09000246],
       [ 3.48373345, -1.03170127],
       [ 2.63542057, -0.88644913],
       [ 3.49374238, -1.03389681],
       [ 3.58250316, -0.94285315],
       [ 3.46768242, -0.50699357],
       [ 3.77789108, -0.54770738]])
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-8">
<h3>R Code 14.8<a class="headerlink" href="#r-code-14-8" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_cafe</span> <span class="o">=</span> <span class="n">vary_effects</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Intercepts samples</span>
<span class="n">b_cafe</span> <span class="o">=</span> <span class="n">vary_effects</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Slopes samples</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-9">
<h3>R Code 14.9<a class="headerlink" href="#r-code-14-9" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]</span>
<span class="n">draw_ellipse</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="n">Mu</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">Sigma</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span> <span class="n">plot_points</span><span class="o">=</span><span class="n">vary_effects</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_31_0.png" src="_images/parte_14_31_0.png" />
</div>
</div>
<p><strong>Overthinking</strong>: We define the <em>covariance</em> with 3 parameters: (pag 440)</p>
<ol class="simple">
<li><p>Firt variable standart deviations  <span class="math notranslate nohighlight">\(\sigma_\alpha\)</span></p></li>
<li><p>Second variable standart deviations  <span class="math notranslate nohighlight">\( \sigma_\beta \)</span></p></li>
<li><p>Correlation between two variables  <span class="math notranslate nohighlight">\(\rho_{\alpha\beta}\)</span></p></li>
</ol>
<p>Whu the covariance is equal to <span class="math notranslate nohighlight">\(\sigma_\alpha \sigma_\beta \rho_{\alpha\beta}\)</span>?</p>
<p>The usual definition of the covariance between two variables <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> is:</p>
<div class="math notranslate nohighlight">
\[ cov(x, y) = \mathbb{E}(xy) - \mathbb{E}(x)\mathbb{E}(y) \]</div>
<p>To simple variance this concept is the same:</p>
<div class="math notranslate nohighlight">
\[ var(x) = cov(x, x) = \mathbb{E}(x^2) - \mathbb{E}(x)^2\]</div>
<p>If the variable with only mean equal zero (<span class="math notranslate nohighlight">\(0\)</span>), then the variance to be:</p>
<div class="math notranslate nohighlight">
\[ var(x) = cov(x) = \mathbb{E}(x^2), \mbox{ if the } \mathbb{E}(x) = 0 \]</div>
<p>The correlation live in <span class="math notranslate nohighlight">\([-1, 1]\)</span>, this is only the covariance rescaled. To be rescaled covariance just:</p>
<div class="math notranslate nohighlight">
\[ cov(xy) = \sqrt{var(x)var(y)} \rho_{xy} \]</div>
<p>or better:</p>
<div class="math notranslate nohighlight">
\[ cov(xy) = \sigma_x \sigma_y \rho_{xy} \]</div>
</div>
<div class="section" id="r-code-14-10">
<h3>R Code 14.10<a class="headerlink" href="#r-code-14-10" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N_visit</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">afternoon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">reps</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="n">N_visit</span><span class="o">*</span><span class="n">N_cafe</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
<span class="n">cafe_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_cafe</span><span class="p">),</span> <span class="n">N_visit</span><span class="p">)</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">a_cafe</span><span class="p">[</span><span class="n">cafe_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">b_cafe</span><span class="p">[</span><span class="n">cafe_id</span><span class="p">]</span><span class="o">*</span><span class="n">afternoon</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># std dev within cafes</span>

<span class="n">wait</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N_visit</span><span class="o">*</span><span class="n">N_cafe</span><span class="p">)</span>
<span class="n">cafe_id</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># index from 1 to 20 cafe_id, need to Stan index</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;cafe&#39;</span><span class="p">:</span> <span class="n">cafe_id</span><span class="p">,</span> <span class="s1">&#39;afternoon&#39;</span><span class="p">:</span><span class="n">afternoon</span><span class="p">,</span> <span class="s1">&#39;wait&#39;</span><span class="p">:</span> <span class="n">wait</span><span class="p">})</span>
<span class="n">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cafe</th>
      <th>afternoon</th>
      <th>wait</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>0</td>
      <td>2.713830</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>1.965617</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>0</td>
      <td>3.261427</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1</td>
      <td>2.836598</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>0</td>
      <td>3.105162</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>195</th>
      <td>20</td>
      <td>1</td>
      <td>4.001264</td>
    </tr>
    <tr>
      <th>196</th>
      <td>20</td>
      <td>0</td>
      <td>3.991292</td>
    </tr>
    <tr>
      <th>197</th>
      <td>20</td>
      <td>1</td>
      <td>2.764103</td>
    </tr>
    <tr>
      <th>198</th>
      <td>20</td>
      <td>0</td>
      <td>3.507337</td>
    </tr>
    <tr>
      <th>199</th>
      <td>20</td>
      <td>1</td>
      <td>2.439118</td>
    </tr>
  </tbody>
</table>
<p>200 rows Ã— 3 columns</p>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="the-varing-slope-model">
<h2>14.1.3 The varing slope model<a class="headerlink" href="#the-varing-slope-model" title="Permalink to this headline">Â¶</a></h2>
<p>The likelihood:</p>
<div class="math notranslate nohighlight">
\[ W_i \sim Normal(\mu_i, \sigma) \]</div>
<p>and the linear model:</p>
<div class="math notranslate nohighlight">
\[ \mu_i = \alpha_{CAFÃ‰[i]} + \beta_{CAFÃ‰[i]}A_i \]</div>
<p>Then comes the matrix of varing intercepts and slopes, with itâ€™s covariance matrix:</p>
<p>Population of varying effects:
$$</p>
<div class="amsmath math notranslate nohighlight" id="equation-6eab902a-67d1-4f86-8275-43660f1eb057">
<span class="eqno">(1)<a class="headerlink" href="#equation-6eab902a-67d1-4f86-8275-43660f1eb057" title="Permalink to this equation">Â¶</a></span>\[\begin{bmatrix}
\alpha_{CAFÃ‰} \\
\beta_{CAFÃ‰}
\end{bmatrix}\]</div>
<p>\sim Normal</p>
<div class="amsmath math notranslate nohighlight" id="equation-745526d8-e300-4463-96cb-29a826b4a816">
<span class="eqno">(2)<a class="headerlink" href="#equation-745526d8-e300-4463-96cb-29a826b4a816" title="Permalink to this equation">Â¶</a></span>\[\begin{pmatrix}
\begin{bmatrix}
\alpha \\
\beta
\end{bmatrix}, S
\end{pmatrix}\]</div>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}construct covariance matrix:\\\begin{split}$$S = 
\begin{pmatrix} 
\sigma_\alpha &amp;  0 \\
0  &amp; \sigma_\beta
\end{pmatrix}
R
\begin{pmatrix} 
\sigma_\alpha &amp;  0 \\
0  &amp; \sigma_\beta
\end{pmatrix}
\end{split}\end{aligned}\end{align} \]</div>
<p>The <span class="math notranslate nohighlight">\(R\)</span> is the correlation matrix. In this simple case <span class="math notranslate nohighlight">\(R\)</span> is defined like:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
R = 
\begin{pmatrix}
1 &amp; \rho  \\
\rho &amp; 1
\end{pmatrix}
\end{split}\]</div>
<p>And the priors and hyper-priors:</p>
<ul class="simple">
<li><p>prior for intercept:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \alpha \sim Normal(5, 2) \]</div>
<ul class="simple">
<li><p>prior for average slope:</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \beta \sim Normal(-1, 0.5) \]</div>
<ul class="simple">
<li><p>prior for stddev within cafÃ©s</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\sigma \sim Exponential(1) \]</div>
<ul class="simple">
<li><p>prior for stddev among cafÃ©s</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \sigma_\alpha \sim Exponential(1) \]</div>
<ul class="simple">
<li><p>prior for stddev among slopes</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ \sigma_\beta \sim Exponential(1) \]</div>
<ul class="simple">
<li><p>prior for correlation  matrix</p></li>
</ul>
<div class="math notranslate nohighlight">
\[ R \sim LKJcorr(2) \]</div>
<div class="section" id="r-code-14-11">
<h3>R Code 14.11<a class="headerlink" href="#r-code-14-11" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Dont have the function LKJcorr implemented in numpy or scipy</span>
<span class="c1"># Stan implementation - https://mc-stan.org/docs/functions-reference/lkj-correlation.html</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-12">
<h3>R Code 14.12<a class="headerlink" href="#r-code-14-12" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># https://mc-stan.org/docs/stan-users-guide/multivariate-hierarchical-priors.html</span>

<span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int N_cafe;</span>
<span class="s2">        int N_periods;</span>
<span class="s2">        </span>
<span class="s2">        array[N] real wait;</span>
<span class="s2">        array[N] int cafe;</span>
<span class="s2">        array[N] int afternoon; </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">        vector&lt;lower=0&gt;[2] sigma_cafe;</span>
<span class="s2">        </span>
<span class="s2">        vector[N_cafe] alpha_cafe;</span>
<span class="s2">        vector[N_cafe] beta_cafe;</span>
<span class="s2">        </span>
<span class="s2">        real alpha;  // Like bar_alpha (hyper-prior)</span>
<span class="s2">        real beta;   // Like bar_beta (hyper-prior)</span>
<span class="s2">        </span>
<span class="s2">        corr_matrix[N_periods] Rho;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        vector[2] Y_cafe[N_cafe];</span>
<span class="s2">        vector[2] MU_cafe;</span>
<span class="s2">        </span>
<span class="s2">        //(sigma) - Prior to likelihood</span>
<span class="s2">        sigma ~ exponential(1);  </span>
<span class="s2">        </span>
<span class="s2">        </span>
<span class="s2">        // (sigma_cafe) - Hyper Prior</span>
<span class="s2">        sigma_cafe ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        // (Rho) - Hyper Prior</span>
<span class="s2">        Rho ~ lkj_corr(2);</span>
<span class="s2">        </span>
<span class="s2">        // (MU_cafe) - Hyper Prior</span>
<span class="s2">        alpha ~ normal(5, 2);</span>
<span class="s2">        beta ~ normal(-1, 0.5);</span>
<span class="s2">  </span>
<span class="s2">        MU_cafe = [alpha, beta]&#39;;</span>
<span class="s2">        </span>
<span class="s2">        // (alpha_cafe, beta_cafe) - Prior </span>
<span class="s2">        for (j in 1:N_cafe){</span>
<span class="s2">            Y_cafe[j] = [alpha_cafe[j], beta_cafe[j]]&#39; ; </span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        Y_cafe ~ multi_normal(MU_cafe, quad_form_diag(Rho, sigma_cafe));  // Prior to alpha_cafe and beta_cafe</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">        // (mu) - Linear model</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = alpha_cafe[ cafe[i] ] + beta_cafe[ cafe[i] ] * afternoon[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood </span>
<span class="s2">        wait ~ normal(mu, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">),</span>
    <span class="s1">&#39;N_cafe&#39;</span><span class="p">:</span> <span class="n">N_cafe</span><span class="p">,</span>
    <span class="s1">&#39;N_periods&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">afternoon</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span>
    <span class="s1">&#39;wait&#39;</span><span class="p">:</span>  <span class="n">d</span><span class="o">.</span><span class="n">wait</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;afternoon&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">afternoon</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;cafe&#39;</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">cafe</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_another_way</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int N_cafe;</span>
<span class="s2">        int N_periods;</span>
<span class="s2">        </span>
<span class="s2">        array[N] real wait;</span>
<span class="s2">        array[N] int cafe;</span>
<span class="s2">        array[N] int afternoon; </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">        vector&lt;lower=0&gt;[2] sigma_cafe;</span>
<span class="s2">        </span>
<span class="s2">        vector[N_cafe] alpha_cafe;</span>
<span class="s2">        vector[N_cafe] beta_cafe;</span>
<span class="s2">        </span>
<span class="s2">        real alpha;  // Like bar_alpha (hyper-prior)</span>
<span class="s2">        real beta;   // Like bar_beta (hyper-prior)</span>
<span class="s2">        </span>
<span class="s2">        corr_matrix[N_periods] Rho;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] mu;</span>
<span class="s2">        </span>
<span class="s2">        //(sigma) - Prior to likelihood</span>
<span class="s2">        sigma ~ exponential(1);  </span>
<span class="s2">        </span>
<span class="s2">        </span>
<span class="s2">        // (sigma_cafe) - Hyper Prior</span>
<span class="s2">        sigma_cafe ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        // (Rho) - Hyper Prior</span>
<span class="s2">        Rho ~ lkj_corr(2);</span>
<span class="s2">        </span>
<span class="s2">        // (MU_cafe) - Hyper Prior</span>
<span class="s2">        alpha ~ normal(5, 2);</span>
<span class="s2">        beta ~ normal(-1, 0.5);</span>

<span class="s2">        for (i in 1:N_cafe){</span>
<span class="s2">            [alpha_cafe[i], beta_cafe[i]]&#39; ~ multi_normal([alpha, beta]&#39;, quad_form_diag(Rho, sigma_cafe));</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">    </span>
<span class="s2">        // (mu) - Linear model</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = alpha_cafe[ cafe[i] ] + beta_cafe[ cafe[i] ] * afternoon[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Likelihood </span>
<span class="s2">        wait ~ normal(mu, sigma);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m14_1</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">m14_1</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sigma</th>
      <td>0.494</td>
      <td>0.027</td>
      <td>0.454</td>
      <td>0.541</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>5147.0</td>
      <td>3085.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_cafe[0]</th>
      <td>0.955</td>
      <td>0.163</td>
      <td>0.695</td>
      <td>1.187</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>5092.0</td>
      <td>3241.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_cafe[1]</th>
      <td>0.454</td>
      <td>0.107</td>
      <td>0.281</td>
      <td>0.616</td>
      <td>0.002</td>
      <td>0.002</td>
      <td>2209.0</td>
      <td>1995.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[0]</th>
      <td>2.944</td>
      <td>0.204</td>
      <td>2.608</td>
      <td>3.259</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5598.0</td>
      <td>3371.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[1]</th>
      <td>1.102</td>
      <td>0.213</td>
      <td>0.766</td>
      <td>1.445</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5163.0</td>
      <td>3691.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[2]</th>
      <td>3.714</td>
      <td>0.208</td>
      <td>3.384</td>
      <td>4.043</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4668.0</td>
      <td>2735.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[3]</th>
      <td>4.153</td>
      <td>0.199</td>
      <td>3.807</td>
      <td>4.447</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5745.0</td>
      <td>3062.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[4]</th>
      <td>3.306</td>
      <td>0.203</td>
      <td>2.976</td>
      <td>3.615</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4642.0</td>
      <td>3251.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[5]</th>
      <td>4.836</td>
      <td>0.202</td>
      <td>4.486</td>
      <td>5.135</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5839.0</td>
      <td>3544.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[6]</th>
      <td>4.259</td>
      <td>0.203</td>
      <td>3.948</td>
      <td>4.598</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5354.0</td>
      <td>3489.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[7]</th>
      <td>4.835</td>
      <td>0.215</td>
      <td>4.478</td>
      <td>5.165</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4494.0</td>
      <td>3171.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[8]</th>
      <td>2.744</td>
      <td>0.206</td>
      <td>2.436</td>
      <td>3.075</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5784.0</td>
      <td>2714.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[9]</th>
      <td>5.194</td>
      <td>0.204</td>
      <td>4.869</td>
      <td>5.515</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4640.0</td>
      <td>3116.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[10]</th>
      <td>3.951</td>
      <td>0.205</td>
      <td>3.654</td>
      <td>4.303</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4219.0</td>
      <td>2878.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[11]</th>
      <td>4.524</td>
      <td>0.208</td>
      <td>4.181</td>
      <td>4.844</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5084.0</td>
      <td>3117.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[12]</th>
      <td>2.557</td>
      <td>0.202</td>
      <td>2.230</td>
      <td>2.881</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4584.0</td>
      <td>2660.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[13]</th>
      <td>3.554</td>
      <td>0.210</td>
      <td>3.198</td>
      <td>3.864</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4083.0</td>
      <td>2590.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[14]</th>
      <td>3.806</td>
      <td>0.202</td>
      <td>3.487</td>
      <td>4.124</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5093.0</td>
      <td>3223.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[15]</th>
      <td>2.686</td>
      <td>0.206</td>
      <td>2.354</td>
      <td>3.012</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4761.0</td>
      <td>3236.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[16]</th>
      <td>3.537</td>
      <td>0.202</td>
      <td>3.228</td>
      <td>3.880</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5647.0</td>
      <td>3117.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[17]</th>
      <td>3.514</td>
      <td>0.204</td>
      <td>3.171</td>
      <td>3.821</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5429.0</td>
      <td>3417.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[18]</th>
      <td>3.718</td>
      <td>0.205</td>
      <td>3.395</td>
      <td>4.041</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5135.0</td>
      <td>3168.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha_cafe[19]</th>
      <td>3.453</td>
      <td>0.202</td>
      <td>3.135</td>
      <td>3.776</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5510.0</td>
      <td>3590.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[0]</th>
      <td>-0.766</td>
      <td>0.234</td>
      <td>-1.154</td>
      <td>-0.414</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5345.0</td>
      <td>3726.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[1]</th>
      <td>-0.119</td>
      <td>0.275</td>
      <td>-0.549</td>
      <td>0.324</td>
      <td>0.004</td>
      <td>0.004</td>
      <td>4223.0</td>
      <td>2961.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[2]</th>
      <td>-0.686</td>
      <td>0.259</td>
      <td>-1.080</td>
      <td>-0.271</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3532.0</td>
      <td>2484.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[3]</th>
      <td>-1.178</td>
      <td>0.231</td>
      <td>-1.534</td>
      <td>-0.799</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5704.0</td>
      <td>2683.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[4]</th>
      <td>-0.863</td>
      <td>0.228</td>
      <td>-1.222</td>
      <td>-0.490</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4366.0</td>
      <td>3321.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[5]</th>
      <td>-1.450</td>
      <td>0.238</td>
      <td>-1.821</td>
      <td>-1.070</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5271.0</td>
      <td>3484.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[6]</th>
      <td>-1.378</td>
      <td>0.240</td>
      <td>-1.762</td>
      <td>-0.991</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>4525.0</td>
      <td>3184.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[7]</th>
      <td>-1.673</td>
      <td>0.263</td>
      <td>-2.112</td>
      <td>-1.267</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3798.0</td>
      <td>3061.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[8]</th>
      <td>-0.619</td>
      <td>0.243</td>
      <td>-1.024</td>
      <td>-0.248</td>
      <td>0.003</td>
      <td>0.003</td>
      <td>5271.0</td>
      <td>3084.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[9]</th>
      <td>-1.446</td>
      <td>0.253</td>
      <td>-1.856</td>
      <td>-1.047</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>4326.0</td>
      <td>2741.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[10]</th>
      <td>-1.324</td>
      <td>0.245</td>
      <td>-1.719</td>
      <td>-0.944</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3760.0</td>
      <td>2877.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[11]</th>
      <td>-1.421</td>
      <td>0.243</td>
      <td>-1.819</td>
      <td>-1.054</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>4647.0</td>
      <td>3288.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[12]</th>
      <td>-0.591</td>
      <td>0.239</td>
      <td>-0.978</td>
      <td>-0.216</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4727.0</td>
      <td>3014.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[13]</th>
      <td>-1.357</td>
      <td>0.265</td>
      <td>-1.749</td>
      <td>-0.909</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>2824.0</td>
      <td>2721.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[14]</th>
      <td>-1.045</td>
      <td>0.229</td>
      <td>-1.428</td>
      <td>-0.709</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5144.0</td>
      <td>3521.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[15]</th>
      <td>-0.826</td>
      <td>0.244</td>
      <td>-1.234</td>
      <td>-0.458</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>4317.0</td>
      <td>3206.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[16]</th>
      <td>-0.966</td>
      <td>0.234</td>
      <td>-1.344</td>
      <td>-0.607</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4929.0</td>
      <td>3126.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[17]</th>
      <td>-0.826</td>
      <td>0.241</td>
      <td>-1.220</td>
      <td>-0.445</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>5018.0</td>
      <td>3167.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[18]</th>
      <td>-0.821</td>
      <td>0.244</td>
      <td>-1.203</td>
      <td>-0.425</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>4382.0</td>
      <td>2956.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta_cafe[19]</th>
      <td>-0.640</td>
      <td>0.251</td>
      <td>-1.071</td>
      <td>-0.268</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3712.0</td>
      <td>3520.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha</th>
      <td>3.632</td>
      <td>0.216</td>
      <td>3.293</td>
      <td>3.972</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>4168.0</td>
      <td>3264.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>beta</th>
      <td>-1.003</td>
      <td>0.120</td>
      <td>-1.196</td>
      <td>-0.814</td>
      <td>0.002</td>
      <td>0.001</td>
      <td>3412.0</td>
      <td>3079.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Rho[0, 0]</th>
      <td>1.000</td>
      <td>0.000</td>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>4000.0</td>
      <td>4000.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>Rho[0, 1]</th>
      <td>-0.743</td>
      <td>0.142</td>
      <td>-0.961</td>
      <td>-0.553</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>2243.0</td>
      <td>1976.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Rho[1, 0]</th>
      <td>-0.743</td>
      <td>0.142</td>
      <td>-0.961</td>
      <td>-0.553</td>
      <td>0.003</td>
      <td>0.002</td>
      <td>2243.0</td>
      <td>1976.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>Rho[1, 1]</th>
      <td>1.000</td>
      <td>0.000</td>
      <td>1.000</td>
      <td>1.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>3969.0</td>
      <td>3852.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">m14_1</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_44_0.png" src="_images/parte_14_44_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-14-13">
<h3>R Code 14.13<a class="headerlink" href="#r-code-14-13" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_density</span><span class="p">(</span><span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">Rho</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Rho_dim_0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rho_dim_1</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Correlation&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Density&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_46_0.png" src="_images/parte_14_46_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-14-14-r-code-14-15">
<h3>R Code 14.14 &amp; R Code 14.15<a class="headerlink" href="#r-code-14-14-r-code-14-15" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_alpha</span> <span class="o">=</span> <span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">post_beta</span> <span class="o">=</span> <span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="n">post_sigma_alpha</span> <span class="o">=</span> <span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sigma_cafe</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">sigma_cafe_dim_0</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">post_sigma_beta</span> <span class="o">=</span> <span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sigma_cafe</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">sigma_cafe_dim_0</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">post_rho</span> <span class="o">=</span> <span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">Rho</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">Rho_dim_0</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Rho_dim_1</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Posterior alpha:&#39;</span><span class="p">,</span> <span class="n">post_alpha</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Posterior beta:&#39;</span><span class="p">,</span> <span class="n">post_beta</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Posterior sigma alpha:&#39;</span><span class="p">,</span> <span class="n">post_sigma_alpha</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Posterior sigma beta:&#39;</span><span class="p">,</span> <span class="n">post_sigma_beta</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Posterior Rho:&#39;</span><span class="p">,</span> <span class="n">post_rho</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Posterior alpha: 3.6320048659560236
Posterior beta: -1.0031288413854578
Posterior sigma alpha: 0.9549508114681846
Posterior sigma beta: 0.4542529928057041
Posterior Rho: -0.7428039489326627
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_matrix_sigma_alpha_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="n">post_sigma_alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span> <span class="n">post_sigma_beta</span><span class="p">]])</span>
<span class="n">post_matrix_sigma_alpha_beta</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[0.95495081, 0.        ],
        [0.        , 0.45425299]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_matrix_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="n">post_rho</span><span class="p">],[</span><span class="n">post_rho</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">post_matrix_rho</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[ 1.        , -0.74280395],
        [-0.74280395,  1.        ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_Sigma</span> <span class="o">=</span> <span class="n">post_matrix_sigma_alpha_beta</span> <span class="o">*</span> <span class="n">post_matrix_rho</span> <span class="o">*</span> <span class="n">post_matrix_sigma_alpha_beta</span>
<span class="n">post_Sigma</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[ 0.91193105, -0.32222038],
        [-0.32222038,  0.20634578]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;afternoon&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cafe&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)][</span><span class="s1">&#39;wait&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_cafe</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">b1</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;afternoon&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;cafe&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)][</span><span class="s1">&#39;wait&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N_cafe</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>

<span class="c1"># Remember that in R Code 14.1 above, the data is build as</span>
<span class="c1"># a = 3.5        # Average morning wait time</span>
<span class="c1"># b = (-1)       # Average difference afternoon wait time</span>
<span class="c1"># because this, b value is b - a, like this</span>

<span class="n">b1</span> <span class="o">=</span> <span class="p">[</span><span class="n">b1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a1</span><span class="p">))]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract posterior means of partially polled estimates</span>
<span class="n">a2</span> <span class="o">=</span> <span class="p">[</span><span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha_cafe</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">alpha_cafe_dim_0</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_cafe</span><span class="p">)]</span>
<span class="n">b2</span> <span class="o">=</span> <span class="p">[</span><span class="n">m14_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">beta_cafe</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">beta_cafe_dim_0</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_cafe</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_nstd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">post_alpha</span><span class="p">,</span> <span class="n">post_beta</span><span class="p">])</span>
<span class="n">dependency_nstd</span> <span class="o">=</span> <span class="n">post_Sigma</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span>

<span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">get_correlated_dataset</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">dependency_nstd</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>


<span class="n">ax_nstd</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="n">ax_nstd</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">],</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    

<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">level</span><span class="p">:</span>
    <span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax_nstd</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># ax_nstd.scatter(mu[0], mu[1], c=&#39;red&#39;, s=3)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CafÃ©s sampled - Figure 14.5 | Left&#39;</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;intercepts (a_cafe)&#39;</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;slopes (b_cafe)&#39;</span><span class="p">)</span>


<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">6.2</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">1.9</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.51</span><span class="p">)</span>

<span class="c1"># ax_nstd.legend()</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Raw data&#39;</span><span class="p">,</span> <span class="s1">&#39;Partial polling&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_54_0.png" src="_images/parte_14_54_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-14-16-r-code-14-17">
<h3>R Code 14.16 &amp; R Code 14.17<a class="headerlink" href="#r-code-14-16-r-code-14-17" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wait_morning_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="n">wait_afternoon_1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">b1</span><span class="p">)]</span>
<span class="n">wait_morning_2</span> <span class="o">=</span> <span class="p">(</span><span class="n">a2</span><span class="p">)</span>
<span class="n">wait_afternoon_2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a2</span><span class="p">,</span> <span class="n">b2</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now shrinkage distribution by simulation  </span>

<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span> <span class="p">,</span><span class="n">post_Sigma</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">v</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">v</span><span class="p">]</span>  <span class="c1"># calculation afternoon wait</span>
<span class="n">Sigma_est2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">mu_est2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># Empty vector mu</span>
<span class="n">mu_est2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
<span class="n">mu_est2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax_nstd</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">scale</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span>
<span class="c1">#level = [0.1, 0.3, 0.5, 0.8, 0.99]</span>
<span class="n">level</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.69</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>

<span class="n">dependency_nstd</span> <span class="o">=</span> <span class="n">Sigma_est2</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">get_correlated_dataset</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">dependency_nstd</span><span class="p">,</span> <span class="n">mu_est2</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

<span class="n">ax_nstd</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wait_morning_1</span><span class="p">,</span> <span class="n">wait_afternoon_1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">wait_morning_2</span><span class="p">,</span> <span class="n">wait_afternoon_2</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="n">ax_nstd</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">wait_morning_1</span><span class="p">,</span> <span class="n">wait_morning_2</span><span class="p">],</span>
             <span class="p">[</span><span class="n">wait_afternoon_1</span><span class="p">,</span> <span class="n">wait_afternoon_2</span><span class="p">],</span> 
             <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">level</span><span class="p">:</span>
    <span class="n">confidence_ellipse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ax_nstd</span><span class="p">,</span> <span class="n">n_std</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;CafÃ©s Waiting - Figure 14.5 | Right&#39;</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;morning wait&#39;</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;afternoon wait&#39;</span><span class="p">)</span>

<span class="n">ax_nstd</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">3.75</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">,</span> <span class="s2">&quot;x==y&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">1.7</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1"># ax_nstd.legend()</span>
<span class="n">ax_nstd</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Raw data&#39;</span><span class="p">,</span> <span class="s1">&#39;Partial polling&#39;</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_58_0.png" src="_images/parte_14_58_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="advanced-varing-slopes">
<h2>14.2 Advanced varing Slopes<a class="headerlink" href="#advanced-varing-slopes" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="r-code-14-18">
<h3>R Code 14.18<a class="headerlink" href="#r-code-14-18" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Previous chimpanzees models is in chapter 11</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/chimpanzees.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build the treatment data</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prosoc_left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span>  
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>12</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>6</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>2</td>
      <td>14</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>2</td>
      <td>16</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>2</td>
      <td>18</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>2</td>
      <td>20</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>2</td>
      <td>22</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>2</td>
      <td>24</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>3</td>
      <td>26</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>3</td>
      <td>28</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>14</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>3</td>
      <td>30</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>15</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>3</td>
      <td>32</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>3</td>
      <td>34</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>17</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>3</td>
      <td>36</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>18</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>4</td>
      <td>38</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>4</td>
      <td>40</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>484</th>
      <td>7</td>
      <td>2.0</td>
      <td>1</td>
      <td>3</td>
      <td>34</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>485</th>
      <td>7</td>
      <td>3.0</td>
      <td>1</td>
      <td>3</td>
      <td>36</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>486</th>
      <td>7</td>
      <td>7.0</td>
      <td>1</td>
      <td>4</td>
      <td>38</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>487</th>
      <td>7</td>
      <td>2.0</td>
      <td>1</td>
      <td>4</td>
      <td>40</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>488</th>
      <td>7</td>
      <td>4.0</td>
      <td>1</td>
      <td>4</td>
      <td>42</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>489</th>
      <td>7</td>
      <td>5.0</td>
      <td>1</td>
      <td>4</td>
      <td>44</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>490</th>
      <td>7</td>
      <td>6.0</td>
      <td>1</td>
      <td>4</td>
      <td>46</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>491</th>
      <td>7</td>
      <td>3.0</td>
      <td>1</td>
      <td>4</td>
      <td>48</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>492</th>
      <td>7</td>
      <td>5.0</td>
      <td>1</td>
      <td>5</td>
      <td>50</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>493</th>
      <td>7</td>
      <td>4.0</td>
      <td>1</td>
      <td>5</td>
      <td>52</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>494</th>
      <td>7</td>
      <td>3.0</td>
      <td>1</td>
      <td>5</td>
      <td>54</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>495</th>
      <td>7</td>
      <td>2.0</td>
      <td>1</td>
      <td>5</td>
      <td>56</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>496</th>
      <td>7</td>
      <td>6.0</td>
      <td>1</td>
      <td>5</td>
      <td>58</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>497</th>
      <td>7</td>
      <td>7.0</td>
      <td>1</td>
      <td>5</td>
      <td>60</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>498</th>
      <td>7</td>
      <td>5.0</td>
      <td>1</td>
      <td>6</td>
      <td>62</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>499</th>
      <td>7</td>
      <td>4.0</td>
      <td>1</td>
      <td>6</td>
      <td>64</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>500</th>
      <td>7</td>
      <td>6.0</td>
      <td>1</td>
      <td>6</td>
      <td>66</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>501</th>
      <td>7</td>
      <td>3.0</td>
      <td>1</td>
      <td>6</td>
      <td>68</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>502</th>
      <td>7</td>
      <td>7.0</td>
      <td>1</td>
      <td>6</td>
      <td>70</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>503</th>
      <td>7</td>
      <td>2.0</td>
      <td>1</td>
      <td>6</td>
      <td>72</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="math notranslate nohighlight">
\[ L_i \sim  Binomial(1, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \gamma_{_{TID}[i]} + \alpha_{_{ACTOR}[I], _{TID}[I]} + \beta_{_{BLOCK}[I], _{TID}[I]} \]</div>
<div class="math notranslate nohighlight">
\[\gamma_{_{TID}} \sim Normal(0, 1)\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
\alpha_{j, 1} \\
\alpha_{j, 2} \\
\alpha_{j, 3} \\
\alpha_{j, 4} \end{bmatrix} \sim MVNormal
\begin{pmatrix}
\begin{bmatrix}
0 \\
0 \\
0 \\
0 
\end{bmatrix} , S_{_{ACTOR}}
\end{pmatrix}\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{bmatrix}
\beta_{j, 1} \\
\beta_{j, 2} \\
\beta_{j, 3} \\
\beta_{j, 4} \end{bmatrix} \sim MVNormal
\begin{pmatrix}
\begin{bmatrix}
0 \\
0 \\
0 \\
0 
\end{bmatrix} , S_{_{BLOCK}}
\end{pmatrix}\end{split}\]</div>
<p>Hyper-prior to <span class="math notranslate nohighlight">\(S_{_{ACTOR}}\)</span>:</p>
<div class="math notranslate nohighlight">
\[\sigma_{_{ACTOR}} \sim Exponential(1)\]</div>
<div class="math notranslate nohighlight">
\[ \rho_{_{ACTOR}} \sim dlkjcorr(4)  \]</div>
<p>Hyper-prior to <span class="math notranslate nohighlight">\(S_{_{BLOCK}}\)</span>:
$<span class="math notranslate nohighlight">\( \sigma_{_{BLOCK}} \sim Exponential(1) \)</span>$</p>
<div class="math notranslate nohighlight">
\[ \rho_{_{BLOCK}} \sim dlkjcorr(4)  \]</div>
<p>This is essentially an interaction model that allow the effect of each <strong>treatment</strong> to vary by <strong>actor</strong> and each <strong>block</strong>.</p>
</div>
</div>
<div class="section" id="important-features-to-understanding-this-model">
<h2>Important features to understanding this model<a class="headerlink" href="#important-features-to-understanding-this-model" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="overview-of-data-types">
<h3>5.1 Overview of data types<a class="headerlink" href="#overview-of-data-types" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="array-types-stan-docs-link">
<h4>Array types (<a class="reference external" href="https://mc-stan.org/docs/reference-manual/overview-of-data-types.html#array-types">stan docs link</a>)<a class="headerlink" href="#array-types-stan-docs-link" title="Permalink to this headline">Â¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="n">real</span> <span class="n">x</span><span class="p">;</span>
<span class="n">array</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="n">m</span><span class="p">;</span>
<span class="n">array</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">15</span><span class="p">]</span> <span class="nb">complex</span> <span class="n">z</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>declares <span class="math notranslate nohighlight">\(x\)</span> to be a <strong>one-dimensional</strong> array of size <span class="math notranslate nohighlight">\(10\)</span> containing real values.</p></li>
<li><p>declares <span class="math notranslate nohighlight">\(m\)</span> to be a <strong>two-dimensional</strong> array of size <span class="math notranslate nohighlight">\([6 \times 7]\)</span> containing values that are <span class="math notranslate nohighlight">\([3 \times 3]\)</span> matrices .</p></li>
<li><p>declares <span class="math notranslate nohighlight">\(z\)</span> to be a <span class="math notranslate nohighlight">\([12 \times 8 \times 15]\)</span> array of <strong>complex</strong> numbers.</p></li>
</ul>
<p>And read this two parts below</p>
</div>
</div>
<div class="section" id="vector-and-matrix-data-types">
<h3>5.5 <a class="reference external" href="https://mc-stan.org/docs/reference-manual/vector-and-matrix-data-types.html">Vector and matrix data types</a><a class="headerlink" href="#vector-and-matrix-data-types" title="Permalink to this headline">Â¶</a></h3>
<p>Stan provides three types of container objects: arrays, vectors, and matrices.</p>
</div>
<div class="section" id="array-data-type">
<h3>5.6 <a class="reference external" href="https://mc-stan.org/docs/reference-manual/array-data-types.html">Array data type</a><a class="headerlink" href="#array-data-type" title="Permalink to this headline">Â¶</a></h3>
<p>Stan supports arrays of arbitrary dimension.</p>
</div>
<div class="section" id="depreciated-features-in-stan-to-build-this-example">
<h3>Depreciated Features in Stan to build this example:<a class="headerlink" href="#depreciated-features-in-stan-to-build-this-example" title="Permalink to this headline">Â¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://mc-stan.org/docs/reference-manual/brackets-array-syntax.html">13.10 Brackets array syntax</a></p></li>
</ul>
<p>After Stan 2.26 the declarations below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="n">real</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
<span class="n">real</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">z</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">];</span>
<span class="n">vector</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">mu</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="n">matrix</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="n">mu</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">];</span>
<span class="n">cholesky_factor_cov</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="n">mu</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
</pre></div>
</div>
<p>was replaced to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="nb">int</span> <span class="n">n</span><span class="p">;</span>
<span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="n">real</span> <span class="n">a</span><span class="p">;</span>
<span class="n">array</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="n">real</span><span class="o">&lt;</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">z</span><span class="p">;</span>
<span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">vector</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="n">mu</span><span class="p">;</span>
<span class="n">array</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span> <span class="n">matrix</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="n">mu</span><span class="p">;</span>
<span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="n">cholesky_factor_cov</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="n">mu</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://mc-stan.org/docs/reference-manual/nested-multiple-indexing-in-assignments.html">13.12 Nested multiple indexing in assignments</a></p></li>
</ul>
<p>This statements</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">[:][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
</pre></div>
</div>
<p>was replaced by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="explanation">
<h4>Explanation:<a class="headerlink" href="#explanation" title="Permalink to this headline">Â¶</a></h4>
<p>Why this <code class="docutils literal notranslate"><span class="pre">alpha</span> <span class="pre">~</span> <span class="pre">multi_normal(rep_vector(0,</span> <span class="pre">4),</span> <span class="pre">quad_form_diag(Rho_actor,</span> <span class="pre">sigma_actor));</span></code> works in code below?</p>
</div>
<div class="section" id="response">
<h4>Response:<a class="headerlink" href="#response" title="Permalink to this headline">Â¶</a></h4>
<p>Let be the code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span><span class="p">{</span>
    <span class="o">...</span>
   <span class="n">vector</span><span class="p">[</span><span class="n">qty_treatments</span><span class="p">]</span> <span class="n">gamma</span><span class="p">;</span>
   <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are <span class="math notranslate nohighlight">\(4\)</span> positions in vector <code class="docutils literal notranslate"><span class="pre">gamma</span></code>, then when we atrribute the <code class="docutils literal notranslate"><span class="pre">normal(0,</span> <span class="pre">1)</span></code>, we realize make the broadcast:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gamma</span> <span class="o">~</span> <span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">qty_treatments</span><span class="p">){</span>
    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">~</span> <span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is the same reason that code with multi_normal works. Let see this in more details:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span><span class="p">{</span>
    <span class="o">...</span>
   <span class="n">array</span><span class="p">[</span><span class="n">qty_chimpanzees</span><span class="p">]</span> <span class="n">vector</span><span class="p">[</span><span class="n">qty_treatments</span><span class="p">]</span> <span class="n">alpha</span><span class="p">;</span>
   <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, the <code class="docutils literal notranslate"><span class="pre">alpha</span></code> have two dimensional structure.</p>
<p><em>Note: index in Stan start in 1, not in zero like python.</em></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">alpha[1,</span> <span class="pre">1]</span></code> is <code class="docutils literal notranslate"><span class="pre">alpha</span></code> to <code class="docutils literal notranslate"><span class="pre">chimpanzees=1</span></code> and to <code class="docutils literal notranslate"><span class="pre">treatment=1</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">alpha[1,</span> <span class="pre">2]</span></code> is <code class="docutils literal notranslate"><span class="pre">alpha</span></code> to <code class="docutils literal notranslate"><span class="pre">chimpanzees=1</span></code> and to <code class="docutils literal notranslate"><span class="pre">treatment=2</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">alpha[2,</span> <span class="pre">3]</span></code> is <code class="docutils literal notranslate"><span class="pre">alpha</span></code> to <code class="docutils literal notranslate"><span class="pre">chimpanzees=2</span></code> and to <code class="docutils literal notranslate"><span class="pre">treatment=3</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">alpha[7,</span> <span class="pre">4]</span></code> is <code class="docutils literal notranslate"><span class="pre">alpha</span></code> to <code class="docutils literal notranslate"><span class="pre">chimpanzees=7</span></code> and to <code class="docutils literal notranslate"><span class="pre">treatment=4</span></code></p></li>
</ul>
<p>And</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">alpha[1,</span> <span class="pre">:]</span></code> is <code class="docutils literal notranslate"><span class="pre">alpha</span></code> to <code class="docutils literal notranslate"><span class="pre">chimpanzees=1</span></code> and to all <code class="docutils literal notranslate"><span class="pre">treatments</span></code></p></li>
</ul>
<p>The type of data to <code class="docutils literal notranslate"><span class="pre">alpha[1,</span> <span class="pre">:]</span></code> is a <code class="docutils literal notranslate"><span class="pre">vector[qty_treatments]</span></code>.</p>
<p>This is the same type that <code class="docutils literal notranslate"><span class="pre">multi_normal</span></code> expected to attribuite the results.</p>
<p>Then, <em>the code works</em>!</p>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int qty_blocks;</span>
<span class="s2">        int qty_treatments;</span>
<span class="s2">        </span>
<span class="s2">        array[N] int pulled_left;</span>
<span class="s2">        array[N] int actor;</span>
<span class="s2">        array[N] int block;</span>
<span class="s2">        array[N] int treatment;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters{</span>
<span class="s2">        vector[qty_treatments] gamma;</span>
<span class="s2">        array[qty_chimpanzees] vector[qty_treatments] alpha;</span>
<span class="s2">        array[qty_blocks] vector[qty_treatments] beta;</span>
<span class="s2">        </span>
<span class="s2">        corr_matrix[qty_treatments] Rho_actor;</span>
<span class="s2">        vector&lt;lower=0&gt;[qty_treatments] sigma_actor;</span>
<span class="s2">        </span>
<span class="s2">        corr_matrix[qty_treatments] Rho_block;</span>
<span class="s2">        vector[qty_treatments] sigma_block;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">        </span>
<span class="s2">        // Fixed Priors</span>
<span class="s2">        Rho_actor ~ lkj_corr(4);</span>
<span class="s2">        sigma_actor ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        Rho_block ~ lkj_corr(4);</span>
<span class="s2">        sigma_block ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">    </span>
<span class="s2">        // Adaptatives Priors</span>
<span class="s2">        gamma ~ normal(0, 1);</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ multi_normal(rep_vector(0, 4), quad_form_diag(Rho_actor, sigma_actor));</span>
<span class="s2">        beta ~ multi_normal(rep_vector(0, 4), quad_form_diag(Rho_block, sigma_block));</span>
<span class="s2">        </span>
<span class="s2">        </span>
<span class="s2">        // Linear model</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = gamma[ treatment[i] ] + alpha[ actor[i], treatment[i] ] + beta[ block[i], treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);  // Link function</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2"> </span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_treatments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m_14_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">m_14_2</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                  mean     sd  hdi_3%  hdi_97%  mcse_mean  mcse_sd  ess_bulk  ess_tail  r_hat
gamma[0]         0.191  0.528  -0.741    1.254      0.034    0.024     229.0     444.0   1.04
gamma[1]         0.669  0.409  -0.141    1.366      0.021    0.015     353.0     800.0   1.02
gamma[2]         0.027  0.588  -1.045    1.192      0.039    0.028     231.0     242.0   1.01
gamma[3]         0.618  0.580  -0.546    1.639      0.034    0.026     288.0     282.0   1.01
alpha[0, 0]     -0.860  0.660  -2.257    0.235      0.040    0.030     275.0     302.0   1.03
alpha[0, 1]     -0.540  0.481  -1.472    0.334      0.020    0.015     574.0     758.0   1.01
alpha[0, 2]     -0.964  0.716  -2.409    0.406      0.040    0.030     329.0     362.0   1.01
alpha[0, 3]     -0.537  0.683  -1.698    0.813      0.040    0.034     308.0     435.0   1.01
alpha[1, 0]      3.124  1.366   1.057    5.688      0.080    0.062     346.0     170.0   1.02
alpha[1, 1]      2.046  1.087   0.447    4.116      0.046    0.034     545.0     524.0   1.01
alpha[1, 2]      4.042  1.512   1.278    6.895      0.077    0.055     370.0     346.0   1.01
alpha[1, 3]      3.206  1.562   0.730    5.942      0.081    0.058     335.0     197.0   1.00
alpha[2, 0]     -1.119  0.659  -2.436   -0.053      0.038    0.027     305.0     576.0   1.01
alpha[2, 1]     -0.290  0.531  -1.222    0.710      0.029    0.021     310.0     280.0   1.01
alpha[2, 2]     -1.562  0.764  -2.987   -0.035      0.039    0.027     386.0     651.0   1.01
alpha[2, 3]     -1.201  0.684  -2.455    0.016      0.036    0.025     363.0     906.0   1.01
alpha[3, 0]     -0.917  0.641  -2.132    0.234      0.028    0.020     533.0     599.0   1.02
alpha[3, 1]     -0.585  0.477  -1.479    0.239      0.023    0.017     423.0     655.0   1.01
alpha[3, 2]     -1.927  0.809  -3.411   -0.390      0.046    0.032     304.0     366.0   1.00
alpha[3, 3]     -0.904  0.691  -2.166    0.379      0.042    0.030     264.0     479.0   1.01
alpha[4, 0]     -0.863  0.656  -2.149    0.370      0.040    0.028     280.0     347.0   1.02
alpha[4, 1]     -0.403  0.471  -1.318    0.465      0.018    0.014     661.0     918.0   1.01
alpha[4, 2]     -0.991  0.760  -2.466    0.387      0.048    0.034     255.0     402.0   1.01
alpha[4, 3]     -0.646  0.684  -1.940    0.572      0.040    0.028     298.0     595.0   1.01
alpha[5, 0]      0.882  0.644  -0.373    2.055      0.031    0.022     407.0     675.0   1.02
alpha[5, 1]     -0.097  0.494  -0.961    0.854      0.025    0.018     383.0     784.0   1.01
alpha[5, 2]      0.190  0.730  -1.287    1.439      0.049    0.035     229.0     198.0   1.02
alpha[5, 3]     -0.107  0.698  -1.398    1.155      0.045    0.032     242.0     154.0   1.02
alpha[6, 0]      1.095  0.690  -0.242    2.356      0.040    0.029     287.0     431.0   1.01
alpha[6, 1]      0.914  0.617  -0.204    2.085      0.057    0.045     141.0      87.0   1.04
alpha[6, 2]      2.632  0.937   1.073    4.521      0.046    0.032     424.0     654.0   1.01
alpha[6, 3]      2.684  1.296   0.514    5.052      0.078    0.058     288.0     343.0   1.01
beta[0, 0]      -0.099  0.334  -0.817    0.501      0.013    0.009     581.0     841.0   1.01
beta[0, 1]      -0.054  0.327  -0.811    0.536      0.012    0.009     750.0     906.0   1.00
beta[0, 2]      -0.065  0.287  -0.618    0.473      0.011    0.008     611.0     811.0   1.02
beta[0, 3]      -0.441  0.509  -1.501    0.289      0.029    0.021     346.0     300.0   1.01
beta[1, 0]       0.075  0.349  -0.595    0.763      0.018    0.013     413.0     365.0   1.02
beta[1, 1]      -0.148  0.358  -0.854    0.500      0.018    0.013     474.0     547.0   1.01
beta[1, 2]       0.085  0.302  -0.478    0.664      0.012    0.009     451.0     745.0   1.01
beta[1, 3]       0.182  0.375  -0.488    0.855      0.018    0.014     489.0     748.0   1.01
beta[2, 0]       0.356  0.467  -0.228    1.361      0.032    0.023     275.0     281.0   1.01
beta[2, 1]      -0.241  0.385  -1.043    0.359      0.024    0.017     317.0     457.0   1.01
beta[2, 2]       0.011  0.312  -0.559    0.599      0.012    0.009     539.0     584.0   1.01
beta[2, 3]       0.166  0.401  -0.502    1.010      0.020    0.014     406.0     658.0   1.01
beta[3, 0]       0.147  0.354  -0.453    0.912      0.020    0.014     329.0     459.0   1.01
beta[3, 1]       0.107  0.355  -0.583    0.837      0.017    0.012     469.0     550.0   1.02
beta[3, 2]      -0.113  0.295  -0.758    0.352      0.011    0.008     700.0     798.0   1.01
beta[3, 3]      -0.002  0.399  -0.719    0.783      0.018    0.017     589.0     375.0   1.01
beta[4, 0]      -0.214  0.358  -0.922    0.409      0.020    0.014     354.0     508.0   1.01
beta[4, 1]       0.020  0.336  -0.566    0.785      0.015    0.011     425.0     705.0   1.01
beta[4, 2]       0.105  0.288  -0.402    0.719      0.010    0.008     714.0    1075.0   1.02
beta[4, 3]      -0.012  0.351  -0.662    0.733      0.016    0.013     524.0     212.0   1.01
beta[5, 0]      -0.112  0.342  -0.861    0.499      0.018    0.013     382.0     415.0   1.01
beta[5, 1]       0.421  0.487  -0.220    1.359      0.035    0.025     236.0     835.0   1.01
beta[5, 2]      -0.052  0.306  -0.671    0.530      0.014    0.010     487.0     825.0   1.01
beta[5, 3]       0.343  0.474  -0.366    1.294      0.023    0.018     493.0     686.0   1.01
Rho_actor[0, 0]  1.000  0.000   1.000    1.000      0.000    0.000    4000.0    4000.0    NaN
Rho_actor[0, 1]  0.327  0.247  -0.085    0.796      0.011    0.008     552.0     854.0   1.01
Rho_actor[0, 2]  0.375  0.234  -0.043    0.785      0.011    0.008     463.0     411.0   1.01
Rho_actor[0, 3]  0.321  0.237  -0.106    0.763      0.010    0.008     535.0     794.0   1.01
Rho_actor[1, 0]  0.327  0.247  -0.085    0.796      0.011    0.008     552.0     854.0   1.01
Rho_actor[1, 1]  1.000  0.000   1.000    1.000      0.000    0.000    1892.0    1217.0   1.00
Rho_actor[1, 2]  0.350  0.245  -0.106    0.770      0.014    0.010     319.0     674.0   1.02
Rho_actor[1, 3]  0.342  0.256  -0.108    0.804      0.015    0.012     302.0     281.0   1.01
Rho_actor[2, 0]  0.375  0.234  -0.043    0.785      0.011    0.008     463.0     411.0   1.01
Rho_actor[2, 1]  0.350  0.245  -0.106    0.770      0.014    0.010     319.0     674.0   1.02
Rho_actor[2, 2]  1.000  0.000   1.000    1.000      0.000    0.000    3280.0    2445.0   1.00
Rho_actor[2, 3]  0.423  0.232   0.000    0.844      0.009    0.007     596.0     792.0   1.01
Rho_actor[3, 0]  0.321  0.237  -0.106    0.763      0.010    0.008     535.0     794.0   1.01
Rho_actor[3, 1]  0.342  0.256  -0.108    0.804      0.015    0.012     302.0     281.0   1.01
Rho_actor[3, 2]  0.423  0.232   0.000    0.844      0.009    0.007     596.0     792.0   1.01
Rho_actor[3, 3]  1.000  0.000   1.000    1.000      0.000    0.000    1644.0    3040.0   1.00
sigma_actor[0]   1.408  0.533   0.621    2.358      0.030    0.021     288.0     255.0   1.03
sigma_actor[1]   0.934  0.413   0.310    1.690      0.017    0.012     565.0     965.0   1.01
sigma_actor[2]   1.881  0.589   0.957    2.952      0.028    0.019     481.0     591.0   1.01
sigma_actor[3]   1.580  0.624   0.643    2.794      0.035    0.025     330.0     336.0   1.01
Rho_block[0, 0]  1.000  0.000   1.000    1.000      0.000    0.000    4000.0    4000.0    NaN
Rho_block[0, 1] -0.040  0.281  -0.545    0.486      0.012    0.008     598.0    1148.0   1.00
Rho_block[0, 2] -0.040  0.310  -0.603    0.530      0.014    0.011     510.0     152.0   1.00
Rho_block[0, 3]  0.021  0.284  -0.500    0.547      0.011    0.008     743.0    1367.0   1.01
Rho_block[1, 0] -0.040  0.281  -0.545    0.486      0.012    0.008     598.0    1148.0   1.00
Rho_block[1, 1]  1.000  0.000   1.000    1.000      0.000    0.000    2940.0    2255.0   1.00
Rho_block[1, 2] -0.044  0.302  -0.541    0.522      0.017    0.012     309.0     402.0   1.01
Rho_block[1, 3]  0.021  0.298  -0.510    0.525      0.015    0.011     415.0     966.0   1.01
Rho_block[2, 0] -0.040  0.310  -0.603    0.530      0.014    0.011     510.0     152.0   1.00
Rho_block[2, 1] -0.044  0.302  -0.541    0.522      0.017    0.012     309.0     402.0   1.01
Rho_block[2, 2]  1.000  0.000   1.000    1.000      0.000    0.000    1818.0    3308.0   1.00
Rho_block[2, 3]  0.023  0.296  -0.547    0.542      0.014    0.010     438.0     680.0   1.02
Rho_block[3, 0]  0.021  0.284  -0.500    0.547      0.011    0.008     743.0    1367.0   1.01
Rho_block[3, 1]  0.021  0.298  -0.510    0.525      0.015    0.011     415.0     966.0   1.01
Rho_block[3, 2]  0.023  0.296  -0.547    0.542      0.014    0.010     438.0     680.0   1.02
Rho_block[3, 3]  1.000  0.000   1.000    1.000      0.000    0.000    2161.0    3213.0   1.00
sigma_block[0]   0.429  0.336   0.011    1.026      0.026    0.019     156.0     237.0   1.03
sigma_block[1]   0.420  0.331   0.006    0.980      0.023    0.017     154.0     158.0   1.02
sigma_block[2]   0.301  0.242   0.004    0.725      0.014    0.010     202.0     388.0   1.03
sigma_block[3]   0.476  0.369   0.009    1.124      0.026    0.018     169.0     138.0   1.02
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">m_14_2</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_71_0.png" src="_images/parte_14_71_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Like trankplot in this book</span>

<span class="n">az</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;plot.max_subplots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_ess</span><span class="p">(</span>
    <span class="n">m_14_2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span> <span class="n">drawstyle</span><span class="o">=</span><span class="s2">&quot;steps-mid&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_72_0.png" src="_images/parte_14_72_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-19">
<h3>R Code 14.19<a class="headerlink" href="#r-code-14-19" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Undertanding Cholesky</span>
<span class="n">rho_test</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">R_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="n">rho_test</span><span class="p">],</span> <span class="p">[</span><span class="n">rho_test</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
<span class="n">R_test</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[1. , 0.3],
        [0.3, 1. ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cholesky decomposition</span>
<span class="n">cholesky_matrix_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">R_test</span><span class="p">)</span>
<span class="n">cholesky_matrix_L</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[1.       , 0.       ],
        [0.3      , 0.9539392]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Testing that R=LL^t</span>
<span class="n">cholesky_matrix_L</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cholesky_matrix_L</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>matrix([[1. , 0.3],
        [0.3, 1. ]])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_uncorrelated_z_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">200</span><span class="p">])</span> <span class="c1"># ?</span>
<span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">sample_uncorrelated_z_score</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.        , -0.15506489],
       [-0.15506489,  1.        ]])
</pre></div>
</div>
</div>
</div>
<div class="section" id="how-this-model-is-works">
<h4>How this model is works?<a class="headerlink" href="#how-this-model-is-works" title="Permalink to this headline">Â¶</a></h4>
<p>To understanding the chunck of code below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">transformed</span> <span class="n">parameters</span><span class="p">{</span>
        <span class="n">matrix</span><span class="p">[</span><span class="n">qty_treatments</span><span class="p">,</span> <span class="n">qty_chimpanzees</span><span class="p">]</span> <span class="n">alpha</span><span class="p">;</span>
        <span class="n">matrix</span><span class="p">[</span><span class="n">qty_treatments</span><span class="p">,</span> <span class="n">qty_blocks</span><span class="p">]</span> <span class="n">beta</span><span class="p">;</span>
        
        <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">diag_pre_multiply</span><span class="p">(</span><span class="n">sigma_actor</span><span class="p">,</span> <span class="n">L_Rho_actor</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_actor</span><span class="p">)</span><span class="s1">&#39;;</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">diag_pre_multiply</span><span class="p">(</span><span class="n">sigma_block</span><span class="p">,</span> <span class="n">L_Rho_block</span><span class="p">)</span> <span class="o">*</span> <span class="n">z_block</span><span class="p">)</span><span class="s1">&#39;;   </span>
    <span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>PS: <span class="math notranslate nohighlight">\(qty\_actor\)</span> <em>is equal to</em> <span class="math notranslate nohighlight">\(qty\_chimpanzees\)</span> <em>for this example!</em></p></li>
</ul>
<p><strong>Firts, thinking about matrices dimensions:</strong></p>
<p>To zâ€™s (<span class="math notranslate nohighlight">\(z_{anything}\)</span>)</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">z_actor</span></code>: <span class="math notranslate nohighlight">\([qty\_treatment, qty\_actor]\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">z_block</span></code>: <span class="math notranslate nohighlight">\([qty\_treatment, qty\_block]\)</span></p></li>
</ul>
<p>To sigmas (<span class="math notranslate nohighlight">\(\sigma\)</span>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sigma_actor</span></code>: <span class="math notranslate nohighlight">\(\sigma_{_{ACTOR}}[qty\_treatments]\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sigma_block</span></code>: <span class="math notranslate nohighlight">\(\sigma_{_{BLOCK}}[qty\_treatments]\)</span></p></li>
</ul>
<p>To Rhoâ€™s (<span class="math notranslate nohighlight">\(\rho\)</span>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">L_Rho_actor</span></code>: <span class="math notranslate nohighlight">\(\rho_{_{ACTOR}}[qty\_treatments \times qty\_treatments]\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">L_Rho_block</span></code>: <span class="math notranslate nohighlight">\(\rho_{_{BLOCK}}[qty\_treatments \times qty\_treatments]\)</span></p></li>
</ul>
<p><strong>Now, understanding the stan functions:</strong></p>
<p>The Stan function <code class="docutils literal notranslate"><span class="pre">diag_pre_multiply</span></code> <a class="reference external" href="https://mc-stan.org/docs/functions-reference/dot-products-and-specialized-products.html">works</a>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">matrix</span> <span class="pre">diag_pre_multiply(vector</span> <span class="pre">v,</span> <span class="pre">matrix</span> <span class="pre">m)</span></code></p>
<p>Return the product of the diagonal matrix formed from the vector <code class="docutils literal notranslate"><span class="pre">v</span></code> and the matrix <code class="docutils literal notranslate"><span class="pre">m</span></code>, i.e., <code class="docutils literal notranslate"><span class="pre">diag_matrix(v)</span> <span class="pre">*</span> <span class="pre">m</span></code>.</p>
</li>
</ul>
<p>The Stan function <code class="docutils literal notranslate"><span class="pre">diag_matrix(v)</span></code> <a class="reference external" href="https://mc-stan.org/docs/functions-reference/diagonal-matrix-functions.html">works</a>:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">matrix</span> <span class="pre">diag_matrix(vector</span> <span class="pre">x)</span></code></p>
<p>The diagonal matrix with diagonal x.</p>
</li>
</ul>
<p>For example: <span class="math notranslate nohighlight">\(x = \begin{bmatrix}
0.25 \\
0.30 \\
0.25 \\
0.20
\end{bmatrix}\)</span> then <code class="docutils literal notranslate"><span class="pre">diag_matrix(x)</span></code> is equal <span class="math notranslate nohighlight">\(\begin{bmatrix}
0.25 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0.30 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0.25 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0.20
\end{bmatrix}\)</span>, this is a <span class="math notranslate nohighlight">\([4 \times 4]\)</span> matrix.</p>
<p><strong>Finally, understanding dimensions for alpha and beta:</strong></p>
<p>Then, this <code class="docutils literal notranslate"><span class="pre">diag_pre_multiply(sigma_actor,</span> <span class="pre">L_Rho_actor)</span></code> is:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">diag_matrix(sigma_actor)</span></code> <span class="math notranslate nohighlight">\(\times\)</span> <code class="docutils literal notranslate"><span class="pre">L_Rho_actor</span></code>
<span class="math notranslate nohighlight">\([qty\_treatments \times qty\_treatments] \times [qty\_treatments \times qty\_treatments] = [qty\_treatments \times qty\_treatments]\)</span></p></li>
</ul>
<p>The complete calculations, have this dimension:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">(diag_pre_multiply(sigma_actor,</span> <span class="pre">L_Rho_actor)</span> <span class="pre">*</span> <span class="pre">z_actor)</span></code></p>
<p><span class="math notranslate nohighlight">\([qty\_treatments \times qty\_treatments] \times [qty\_treatments \times qty\_chimpanzees] = 
[qty\_treatments \times qty\_chimpanzees]\)</span></p>
</li>
</ul>
<p>And to finish, transpose the matrix ( â€™ ):</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">(diag_pre_multiply(sigma_actor,</span> <span class="pre">L_Rho_actor)</span> <span class="pre">*</span> <span class="pre">z_actor)'</span></code></p>
<p><span class="math notranslate nohighlight">\([qty\_chimpanzees \times qty\_treatments]\)</span></p>
</li>
</ul>
<p>Each of the index in matrix above, is a prior to alpha (or beta) in the model. Make the model with this structure is not need using the <code class="docutils literal notranslate"><span class="pre">multi_normal()</span></code>, like the previous model <code class="docutils literal notranslate"><span class="pre">m_14_2</span></code>.</p>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int qty_blocks;</span>
<span class="s2">        int qty_treatments;</span>
<span class="s2">        </span>
<span class="s2">        array[N] int pulled_left;</span>
<span class="s2">        array[N] int actor;</span>
<span class="s2">        array[N] int block;</span>
<span class="s2">        array[N] int treatment;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters{</span>
<span class="s2">        vector[qty_treatments] gamma;</span>
<span class="s2">        </span>
<span class="s2">        matrix[qty_treatments, qty_chimpanzees] z_actor;</span>
<span class="s2">        cholesky_factor_corr[qty_treatments] L_Rho_actor;</span>
<span class="s2">        vector&lt;lower=0&gt;[qty_treatments] sigma_actor;</span>
<span class="s2">        </span>
<span class="s2">        matrix[qty_treatments, qty_blocks] z_block;</span>
<span class="s2">        cholesky_factor_corr[qty_treatments] L_Rho_block;</span>
<span class="s2">        vector&lt;lower=0&gt;[qty_treatments] sigma_block;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    transformed parameters{</span>
<span class="s2">        matrix[qty_chimpanzees, qty_treatments] alpha;</span>
<span class="s2">        matrix[qty_blocks, qty_treatments] beta;</span>
<span class="s2">        </span>
<span class="s2">        alpha = (diag_pre_multiply(sigma_actor, L_Rho_actor) * z_actor)&#39;;  // matrix[qty_actors, qty_treatments]</span>
<span class="s2">        beta = (diag_pre_multiply(sigma_block, L_Rho_block) * z_block)&#39;;   // Above explanations about this part</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">    </span>
<span class="s2">        // Adaptative Priors - Non-centered</span>
<span class="s2">        gamma ~ normal(0, 1);</span>
<span class="s2">    </span>
<span class="s2">        to_vector(z_actor) ~ normal(0, 1);</span>
<span class="s2">        L_Rho_actor ~ lkj_corr_cholesky(2);</span>
<span class="s2">        sigma_actor ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        to_vector(z_block) ~ normal(0, 1);</span>
<span class="s2">        L_Rho_block ~ lkj_corr_cholesky(2);</span>
<span class="s2">        sigma_block ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        // Linear model</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = gamma[ treatment[i] ] + alpha[ actor[i], treatment[i] ] + beta[ block[i], treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);  // Link function</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">    </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2"> </span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_treatments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span> <span class="n">m_14_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
     <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
     <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
     <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">m_14_3</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
/home/rodolpho/Projects/bayesian/BAYES/lib/python3.8/site-packages/arviz/stats/diagnostics.py:592: RuntimeWarning: invalid value encountered in double_scalars
  (between_chain_variance / within_chain_variance + num_samples - 1) / (num_samples)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                    mean     sd  hdi_5.5%  hdi_94.5%  mcse_mean  mcse_sd  ess_bulk  ess_tail  r_hat
gamma[0]           0.214  0.484    -0.542      1.008      0.010    0.007    2269.0    2705.0    1.0
gamma[1]           0.647  0.407     0.032      1.306      0.008    0.006    2707.0    2436.0    1.0
gamma[2]          -0.009  0.585    -0.864      0.968      0.010    0.008    3341.0    2985.0    1.0
gamma[3]           0.671  0.548    -0.172      1.536      0.009    0.007    3377.0    2959.0    1.0
z_actor[0, 0]     -0.658  0.470    -1.387      0.108      0.009    0.006    2676.0    2969.0    1.0
z_actor[0, 1]      2.352  0.703     1.268      3.497      0.012    0.008    3693.0    3535.0    1.0
z_actor[0, 2]     -0.860  0.497    -1.641     -0.076      0.010    0.007    2512.0    2995.0    1.0
z_actor[0, 3]     -0.736  0.493    -1.505      0.048      0.010    0.007    2441.0    2824.0    1.0
z_actor[0, 4]     -0.643  0.468    -1.395      0.070      0.009    0.006    2762.0    3063.0    1.0
z_actor[0, 5]      0.594  0.481    -0.177      1.337      0.009    0.006    2830.0    3060.0    1.0
z_actor[0, 6]      0.959  0.565     0.054      1.810      0.011    0.008    2879.0    2906.0    1.0
z_actor[1, 0]     -0.375  0.667    -1.421      0.704      0.010    0.009    4046.0    3209.0    1.0
z_actor[1, 1]      1.410  0.923    -0.070      2.856      0.015    0.011    3558.0    3111.0    1.0
z_actor[1, 2]     -0.040  0.679    -1.112      1.050      0.012    0.009    3032.0    2925.0    1.0
z_actor[1, 3]     -0.438  0.688    -1.586      0.616      0.012    0.009    3536.0    3026.0    1.0
z_actor[1, 4]     -0.200  0.653    -1.248      0.814      0.011    0.009    3465.0    3298.0    1.0
z_actor[1, 5]     -0.360  0.664    -1.430      0.663      0.010    0.009    4207.0    3114.0    1.0
z_actor[1, 6]      0.774  0.799    -0.428      2.097      0.014    0.010    3292.0    3337.0    1.0
z_actor[2, 0]     -0.095  0.658    -1.202      0.861      0.010    0.011    4251.0    3045.0    1.0
z_actor[2, 1]      0.854  0.954    -0.696      2.299      0.014    0.011    4868.0    3715.0    1.0
z_actor[2, 2]     -0.512  0.685    -1.579      0.576      0.011    0.009    3935.0    2990.0    1.0
z_actor[2, 3]     -0.650  0.685    -1.766      0.410      0.011    0.008    3896.0    3334.0    1.0
z_actor[2, 4]     -0.172  0.652    -1.186      0.869      0.010    0.009    4222.0    2968.0    1.0
z_actor[2, 5]     -0.102  0.669    -1.088      0.987      0.011    0.009    3832.0    3130.0    1.0
z_actor[2, 6]      0.988  0.853    -0.343      2.307      0.014    0.010    3600.0    3031.0    1.0
z_actor[3, 0]      0.071  0.750    -1.127      1.247      0.010    0.011    5689.0    2879.0    1.0
z_actor[3, 1]      0.466  0.929    -1.026      1.906      0.011    0.013    7144.0    3451.0    1.0
z_actor[3, 2]     -0.412  0.766    -1.645      0.780      0.011    0.010    5330.0    3191.0    1.0
z_actor[3, 3]      0.015  0.768    -1.291      1.159      0.010    0.013    5528.0    2981.0    1.0
z_actor[3, 4]     -0.088  0.715    -1.262      0.998      0.010    0.011    5285.0    3284.0    1.0
z_actor[3, 5]     -0.322  0.753    -1.551      0.835      0.010    0.010    5436.0    3206.0    1.0
z_actor[3, 6]      0.831  0.928    -0.635      2.293      0.011    0.011    6855.0    2990.0    1.0
L_Rho_actor[0, 0]  1.000  0.000     1.000      1.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_actor[0, 1]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_actor[0, 2]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_actor[0, 3]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_actor[1, 0]  0.431  0.276     0.007      0.855      0.005    0.004    2884.0    3014.0    1.0
L_Rho_actor[1, 1]  0.848  0.141     0.650      1.000      0.003    0.002    2922.0    3014.0    1.0
L_Rho_actor[1, 2]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_actor[1, 3]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_actor[2, 0]  0.532  0.248     0.164      0.903      0.004    0.003    3145.0    3045.0    1.0
L_Rho_actor[2, 1]  0.282  0.307    -0.181      0.784      0.006    0.005    2295.0    3168.0    1.0
L_Rho_actor[2, 2]  0.670  0.179     0.398      0.961      0.003    0.002    2869.0    3066.0    1.0
L_Rho_actor[2, 3]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_actor[3, 0]  0.452  0.262     0.050      0.849      0.005    0.004    2657.0    3037.0    1.0
L_Rho_actor[3, 1]  0.274  0.315    -0.185      0.806      0.006    0.004    2731.0    3051.0    1.0
L_Rho_actor[3, 2]  0.293  0.317    -0.204      0.790      0.006    0.004    2498.0    2774.0    1.0
L_Rho_actor[3, 3]  0.579  0.180     0.291      0.865      0.003    0.002    2690.0    3154.0    1.0
sigma_actor[0]     1.383  0.489     0.664      2.025      0.010    0.007    2353.0    3000.0    1.0
sigma_actor[1]     0.901  0.404     0.296      1.434      0.007    0.005    2969.0    2671.0    1.0
sigma_actor[2]     1.845  0.592     0.931      2.608      0.011    0.009    3250.0    2401.0    1.0
sigma_actor[3]     1.568  0.582     0.669      2.312      0.011    0.008    3144.0    2650.0    1.0
z_block[0, 0]     -0.279  0.844    -1.581      1.139      0.012    0.012    5021.0    2942.0    1.0
z_block[0, 1]      0.115  0.834    -1.279      1.396      0.011    0.013    5926.0    3115.0    1.0
z_block[0, 2]      0.664  0.865    -0.682      2.039      0.012    0.010    4964.0    3108.0    1.0
z_block[0, 3]      0.268  0.840    -1.125      1.535      0.011    0.014    5965.0    3090.0    1.0
z_block[0, 4]     -0.429  0.844    -1.837      0.803      0.012    0.012    5334.0    3088.0    1.0
z_block[0, 5]     -0.256  0.885    -1.622      1.198      0.012    0.013    5104.0    3190.0    1.0
z_block[1, 0]     -0.139  0.877    -1.574      1.206      0.012    0.014    5667.0    3063.0    1.0
z_block[1, 1]     -0.252  0.820    -1.567      1.065      0.010    0.014    6141.0    2950.0    1.0
z_block[1, 2]     -0.402  0.841    -1.747      0.953      0.011    0.012    5565.0    3300.0    1.0
z_block[1, 3]      0.240  0.853    -1.050      1.629      0.011    0.013    6536.0    3148.0    1.0
z_block[1, 4]      0.035  0.803    -1.282      1.268      0.010    0.012    6050.0    3079.0    1.0
z_block[1, 5]      0.795  0.882    -0.606      2.209      0.013    0.011    4431.0    3202.0    1.0
z_block[2, 0]     -0.128  0.942    -1.655      1.339      0.012    0.015    5812.0    3369.0    1.0
z_block[2, 1]      0.174  0.962    -1.432      1.656      0.011    0.016    7222.0    3020.0    1.0
z_block[2, 2]      0.019  0.938    -1.537      1.437      0.011    0.018    7040.0    2325.0    1.0
z_block[2, 3]     -0.268  0.893    -1.619      1.242      0.011    0.014    7031.0    3159.0    1.0
z_block[2, 4]      0.235  0.932    -1.228      1.746      0.011    0.015    7393.0    3028.0    1.0
z_block[2, 5]     -0.069  0.926    -1.558      1.387      0.012    0.016    6284.0    3006.0    1.0
z_block[3, 0]     -0.614  0.961    -2.149      0.915      0.012    0.012    6496.0    3194.0    1.0
z_block[3, 1]      0.258  0.907    -1.227      1.666      0.011    0.015    6812.0    2742.0    1.0
z_block[3, 2]      0.239  0.900    -1.211      1.650      0.011    0.014    6636.0    3177.0    1.0
z_block[3, 3]     -0.012  0.933    -1.528      1.462      0.011    0.016    6781.0    2974.0    1.0
z_block[3, 4]     -0.061  0.913    -1.435      1.453      0.011    0.016    7351.0    3078.0    1.0
z_block[3, 5]      0.454  0.930    -1.027      1.931      0.011    0.014    6617.0    2932.0    1.0
L_Rho_block[0, 0]  1.000  0.000     1.000      1.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_block[0, 1]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_block[0, 2]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_block[0, 3]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_block[1, 0] -0.062  0.374    -0.623      0.574      0.005    0.006    4592.0    3122.0    1.0
L_Rho_block[1, 1]  0.920  0.097     0.794      1.000      0.002    0.001    2692.0    3089.0    1.0
L_Rho_block[1, 2]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_block[1, 3]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_block[2, 0] -0.020  0.378    -0.649      0.557      0.004    0.007    7142.0    2844.0    1.0
L_Rho_block[2, 1] -0.035  0.365    -0.602      0.562      0.004    0.006    7624.0    3040.0    1.0
L_Rho_block[2, 2]  0.839  0.135     0.655      1.000      0.003    0.002    1757.0    2150.0    1.0
L_Rho_block[2, 3]  0.000  0.000     0.000      0.000      0.000    0.000    4000.0    4000.0    NaN
L_Rho_block[3, 0]  0.045  0.379    -0.552      0.663      0.005    0.006    5021.0    3052.0    1.0
L_Rho_block[3, 1]  0.056  0.373    -0.487      0.709      0.005    0.006    4887.0    3093.0    1.0
L_Rho_block[3, 2]  0.012  0.373    -0.572      0.627      0.005    0.006    4738.0    2872.0    1.0
L_Rho_block[3, 3]  0.739  0.166     0.508      0.986      0.004    0.003    2069.0    2228.0    1.0
sigma_block[0]     0.400  0.321     0.000      0.796      0.006    0.004    2252.0    2283.0    1.0
sigma_block[1]     0.445  0.344     0.000      0.892      0.007    0.005    1967.0    2353.0    1.0
sigma_block[2]     0.303  0.268     0.000      0.627      0.004    0.003    3314.0    2291.0    1.0
sigma_block[3]     0.473  0.375     0.000      0.938      0.007    0.005    1971.0    2057.0    1.0
alpha[0, 0]       -0.844  0.609    -1.798      0.138      0.011    0.008    3018.0    3108.0    1.0
alpha[0, 1]       -0.511  0.488    -1.332      0.210      0.008    0.006    3697.0    3196.0    1.0
alpha[0, 2]       -0.968  0.724    -2.073      0.196      0.012    0.009    3837.0    3287.0    1.0
alpha[0, 3]       -0.573  0.659    -1.688      0.384      0.011    0.008    3787.0    3380.0    1.0
alpha[1, 0]        3.152  1.250     1.301      4.881      0.020    0.015    4111.0    3012.0    1.0
alpha[1, 1]        2.005  0.994     0.487      3.404      0.017    0.012    3564.0    2907.0    1.0
alpha[1, 2]        4.309  1.662     1.993      6.688      0.026    0.019    4333.0    3691.0    1.0
alpha[1, 3]        3.406  1.531     1.284      5.719      0.024    0.018    4224.0    3729.0    1.0
alpha[2, 0]       -1.107  0.627    -2.048     -0.059      0.012    0.008    2984.0    2985.0    1.0
alpha[2, 1]       -0.326  0.475    -1.061      0.424      0.008    0.006    3701.0    3368.0    1.0
alpha[2, 2]       -1.537  0.758    -2.752     -0.397      0.012    0.009    3838.0    3581.0    1.0
alpha[2, 3]       -1.298  0.660    -2.315     -0.265      0.011    0.008    3689.0    3640.0    1.0
alpha[3, 0]       -0.937  0.609    -1.988     -0.034      0.011    0.008    2847.0    2833.0    1.0
alpha[3, 1]       -0.580  0.489    -1.425      0.103      0.008    0.006    3921.0    3536.0    1.0
alpha[3, 2]       -1.833  0.810    -3.070     -0.571      0.013    0.009    3685.0    3422.0    1.0
alpha[3, 3]       -0.976  0.655    -1.992      0.053      0.010    0.007    3970.0    3603.0    1.0
alpha[4, 0]       -0.830  0.606    -1.803      0.092      0.011    0.008    2947.0    3191.0    1.0
alpha[4, 1]       -0.376  0.476    -1.180      0.332      0.008    0.006    3636.0    3293.0    1.0
alpha[4, 2]       -0.970  0.726    -2.106      0.157      0.012    0.009    3644.0    3421.0    1.0
alpha[4, 3]       -0.701  0.649    -1.760      0.301      0.010    0.008    4094.0    3235.0    1.0
alpha[5, 0]        0.781  0.638    -0.226      1.775      0.013    0.009    2588.0    3109.0    1.0
alpha[5, 1]       -0.047  0.489    -0.838      0.713      0.008    0.006    3884.0    2572.0    1.0
alpha[5, 2]        0.247  0.705    -0.802      1.415      0.012    0.009    3467.0    3059.0    1.0
alpha[5, 3]       -0.099  0.654    -1.140      0.903      0.011    0.008    3396.0    3452.0    1.0
alpha[6, 0]        1.206  0.661     0.164      2.255      0.012    0.009    2952.0    3040.0    1.0
alpha[6, 1]        0.923  0.590    -0.008      1.821      0.010    0.007    3706.0    3387.0    1.0
alpha[6, 2]        2.644  0.948     1.114      4.069      0.015    0.010    4093.0    3203.0    1.0
alpha[6, 3]        2.583  1.238     0.819      4.327      0.021    0.015    3962.0    2851.0    1.0
beta[0, 0]        -0.128  0.347    -0.694      0.366      0.005    0.005    4443.0    3501.0    1.0
beta[0, 1]        -0.052  0.356    -0.625      0.522      0.005    0.004    5006.0    3834.0    1.0
beta[0, 2]        -0.051  0.296    -0.509      0.410      0.005    0.004    3767.0    3333.0    1.0
beta[0, 3]        -0.410  0.502    -1.230      0.177      0.009    0.006    2840.0    3496.0    1.0
beta[1, 0]         0.055  0.337    -0.446      0.622      0.005    0.005    4781.0    3152.0    1.0
beta[1, 1]        -0.133  0.354    -0.723      0.371      0.005    0.004    4166.0    3478.0    1.0
beta[1, 2]         0.083  0.319    -0.308      0.653      0.005    0.004    4656.0    3749.0    1.0
beta[1, 3]         0.170  0.382    -0.395      0.780      0.006    0.005    3841.0    3438.0    1.0
beta[2, 0]         0.317  0.425    -0.208      0.992      0.007    0.005    3416.0    3690.0    1.0
beta[2, 1]        -0.234  0.384    -0.862      0.274      0.006    0.004    4393.0    3765.0    1.0
beta[2, 2]         0.005  0.301    -0.433      0.478      0.005    0.004    4467.0    3665.0    1.0
beta[2, 3]         0.160  0.395    -0.419      0.786      0.007    0.005    3436.0    3374.0    1.0
beta[3, 0]         0.132  0.363    -0.347      0.765      0.006    0.005    4384.0    3346.0    1.0
beta[3, 1]         0.121  0.373    -0.460      0.688      0.006    0.005    4625.0    3475.0    1.0
beta[3, 2]        -0.118  0.299    -0.600      0.284      0.005    0.004    3625.0    3715.0    1.0
beta[3, 3]         0.020  0.397    -0.618      0.661      0.006    0.005    4497.0    3784.0    1.0
beta[4, 0]        -0.206  0.380    -0.852      0.282      0.006    0.005    3851.0    3106.0    1.0
beta[4, 1]         0.049  0.350    -0.496      0.606      0.005    0.004    4743.0    3521.0    1.0
beta[4, 2]         0.111  0.315    -0.276      0.632      0.005    0.004    4500.0    3759.0    1.0
beta[4, 3]        -0.027  0.363    -0.617      0.522      0.006    0.005    4160.0    3394.0    1.0
beta[5, 0]        -0.129  0.364    -0.757      0.365      0.005    0.005    4804.0    3337.0    1.0
beta[5, 1]         0.436  0.499    -0.158      1.206      0.010    0.007    2438.0    3590.0    1.0
beta[5, 2]        -0.047  0.299    -0.479      0.404      0.005    0.003    3962.0    3423.0    1.0
beta[5, 3]         0.328  0.482    -0.272      1.100      0.008    0.006    3374.0    3766.0    1.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">m_14_3</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">35</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_82_0.png" src="_images/parte_14_82_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="r-code-14-20">
<h3>R Code 14.20<a class="headerlink" href="#r-code-14-20" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="n">plt</span><span class="o">=</span><span class="n">reload</span><span class="p">(</span><span class="n">plt</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">alpha_ess_14_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">m_14_3</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_ess_14_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">m_14_3</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">alpha_ess_14_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">m_14_2</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">beta_ess_14_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">m_14_2</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">alpha_ess_14_2</span><span class="p">,</span> <span class="n">alpha_ess_14_3</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">beta_ess_14_2</span><span class="p">,</span> <span class="n">beta_ess_14_3</span><span class="p">[:</span><span class="mi">24</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5000</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1150</span><span class="p">,</span> <span class="mi">1250</span><span class="p">,</span> <span class="s1">&#39;x = y&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">900</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1500</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;ESS - Effective Simple Size Comparison&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Model centered (Default)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Model non-centered (Cholesky)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_85_0.png" src="_images/parte_14_85_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-14-21">
<h3>R Code 14.21<a class="headerlink" href="#r-code-14-21" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">m_14_3</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma_actor&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_block&#39;</span><span class="p">],</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>sigma_actor[0]</th>
      <td>1.383</td>
      <td>0.489</td>
      <td>0.664</td>
      <td>2.025</td>
      <td>0.010</td>
      <td>0.007</td>
      <td>2353.0</td>
      <td>3000.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_actor[1]</th>
      <td>0.901</td>
      <td>0.404</td>
      <td>0.296</td>
      <td>1.434</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>2969.0</td>
      <td>2671.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_actor[2]</th>
      <td>1.845</td>
      <td>0.592</td>
      <td>0.931</td>
      <td>2.608</td>
      <td>0.011</td>
      <td>0.009</td>
      <td>3250.0</td>
      <td>2401.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_actor[3]</th>
      <td>1.568</td>
      <td>0.582</td>
      <td>0.669</td>
      <td>2.312</td>
      <td>0.011</td>
      <td>0.008</td>
      <td>3144.0</td>
      <td>2650.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_block[0]</th>
      <td>0.400</td>
      <td>0.321</td>
      <td>0.000</td>
      <td>0.796</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>2252.0</td>
      <td>2283.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_block[1]</th>
      <td>0.445</td>
      <td>0.344</td>
      <td>0.000</td>
      <td>0.892</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>1967.0</td>
      <td>2353.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_block[2]</th>
      <td>0.303</td>
      <td>0.268</td>
      <td>0.000</td>
      <td>0.627</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3314.0</td>
      <td>2291.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma_block[3]</th>
      <td>0.473</td>
      <td>0.375</td>
      <td>0.000</td>
      <td>0.938</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>1971.0</td>
      <td>2057.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-14-22">
<h3>R Code 14.22<a class="headerlink" href="#r-code-14-22" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Like R Code 11.17</span>
<span class="c1"># ==================</span>

<span class="n">TODO</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">plt.figure(figsize=(18, 6))</span>

<span class="s2">plt.ylim(0, 1.3)</span>
<span class="s2">plt.xlim(0, 7)</span>
<span class="s2">plt.axhline(y=1, ls=&#39;-&#39;, c=&#39;black&#39;)</span>
<span class="s2">plt.axhline(y=0.5, ls=&#39;--&#39;, c=&#39;black&#39;)</span>


<span class="s2">for i in range(7):</span>
<span class="s2">    plt.axvline(x=i+1, c=&#39;black&#39;)</span>
<span class="s2">    plt.text(x=i + 0.25, y=1.1, s=f&#39;Actor {i + 1}&#39;, size=20)</span>
<span class="s2">    </span>
<span class="s2">    alpha_chimp = az.extract(samples_chimpanzees.posterior.alpha.sel(alpha_dim_0=i)).alpha.values</span>
<span class="s2">    </span>
<span class="s2">    RN = inv_logit(alpha_chimp + az.extract(samples_chimpanzees.posterior.beta.sel(beta_dim_0=0)).beta.values)</span>
<span class="s2">    LN = inv_logit(alpha_chimp + az.extract(samples_chimpanzees.posterior.beta.sel(beta_dim_0=1)).beta.values)</span>
<span class="s2">    RP = inv_logit(alpha_chimp + az.extract(samples_chimpanzees.posterior.beta.sel(beta_dim_0=2)).beta.values)</span>
<span class="s2">    LP = inv_logit(alpha_chimp + az.extract(samples_chimpanzees.posterior.beta.sel(beta_dim_0=3)).beta.values)</span>
<span class="s2">    </span>
<span class="s2">    # To R/N and R/P</span>
<span class="s2">    # ===============</span>
<span class="s2">    if not i == 1:</span>
<span class="s2">        plt.plot([0.2 + i, 0.8 + i], [RN.mean(), RP.mean()], color=&#39;black&#39;)</span>
<span class="s2">    </span>
<span class="s2">    # Plot hdi compatibility interval</span>
<span class="s2">    RN_hdi_min, RN_hdi_max = az.hdi(RN, hdi_prob=0.89)</span>
<span class="s2">    RP_hdi_min, RP_hdi_max = az.hdi(RP, hdi_prob=0.89)</span>
<span class="s2">    plt.plot([0.2 + i, 0.2 + i], [RN_hdi_min, RN_hdi_max], c=&#39;black&#39;)</span>
<span class="s2">    plt.plot([0.8 + i, 0.8 + i], [RP_hdi_min, RP_hdi_max], c=&#39;black&#39;)</span>
<span class="s2">    </span>
<span class="s2">    # Plot points</span>
<span class="s2">    plt.plot(0.2 + i, RN.mean(), &#39;o&#39;, markerfacecolor=&#39;white&#39;, color=&#39;black&#39;)</span>
<span class="s2">    plt.plot(0.8 + i, RP.mean(), &#39;o&#39;, markerfacecolor=&#39;black&#39;, color=&#39;white&#39;)</span>
<span class="s2">    </span>
<span class="s2">    # To L/N and L/P</span>
<span class="s2">    # ===============</span>
<span class="s2">    if not i == 1:</span>
<span class="s2">        plt.plot([0.3 + i, 0.9 + i], [LN.mean(), LP.mean()], color=&#39;black&#39;, linewidth=3)</span>

<span class="s2">    # Plot hdi compatibility interval</span>
<span class="s2">    LN_hdi_min, LN_hdi_max = az.hdi(LN, hdi_prob=0.89)</span>
<span class="s2">    LP_hdi_min, LP_hdi_max = az.hdi(LP, hdi_prob=0.89)</span>
<span class="s2">    plt.plot([0.3 + i, 0.3 + i], [LN_hdi_min, LN_hdi_max], c=&#39;black&#39;)</span>
<span class="s2">    plt.plot([0.9 + i, 0.9 + i], [LP_hdi_min, LP_hdi_max], c=&#39;black&#39;)</span>

<span class="s2">    plt.plot(0.3 + i, LN.mean(), &#39;o&#39;, markerfacecolor=&#39;white&#39;, color=&#39;black&#39;)</span>
<span class="s2">    plt.plot(0.9 + i, LP.mean(), &#39;o&#39;, markerfacecolor=&#39;black&#39;, color=&#39;white&#39;)</span>
<span class="s2">    </span>
<span class="s2">    # Labels for only first points</span>
<span class="s2">    if i == 0:</span>
<span class="s2">        plt.text(x=0.08, y=RN.mean() - 0.08, s=&#39;R/N&#39;)</span>
<span class="s2">        plt.text(x=0.68, y=RP.mean() - 0.08, s=&#39;R/P&#39;)</span>
<span class="s2">        plt.text(x=0.17, y=LN.mean() + 0.08, s=&#39;L/N&#39;)</span>
<span class="s2">        plt.text(x=0.77, y=LP.mean() + 0.08, s=&#39;L/P&#39;)</span>
<span class="s2">    </span>
<span class="s2">plt.title(&#39;Posterior Predictions&#39;)</span>
<span class="s2">plt.ylabel(&#39;Proportion left lever&#39;)</span>
<span class="s2">plt.yticks([0, 0.5, 1], [0, 0.5, 1])</span>
<span class="s2">plt.xticks([])</span>

<span class="s2">plt.show()</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># TODO: Rebuild to this example. </span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="instrumental-and-causal-designs">
<h2>14.3 Instrumental and Causal Designs<a class="headerlink" href="#instrumental-and-causal-designs" title="Permalink to this headline">Â¶</a></h2>
<p>The variable <span class="math notranslate nohighlight">\(^*U\)</span> is an unobserved.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_14_3_1</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;U*&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;U*&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;U*&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Drawing the DAG</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;U*&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_14_3_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_14_3_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_92_0.png" src="_images/parte_14_92_0.png" />
</div>
</div>
<p>Now, we add <em>Instrumental Variable</em> <strong>Q</strong>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dag_14_3_1</span> <span class="o">=</span> <span class="n">CausalGraphicalModel</span><span class="p">(</span>
    <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;U*&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">],</span>
    <span class="n">edges</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;U*&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;U*&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="c1"># Drawing the DAG</span>
<span class="n">pgm</span> <span class="o">=</span> <span class="n">daft</span><span class="o">.</span><span class="n">PGM</span><span class="p">()</span>
<span class="n">coordinates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;U*&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;e&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;Q&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag_14_3_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">coordinates</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
<span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dag_14_3_1</span><span class="o">.</span><span class="n">dag</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
    <span class="n">pgm</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
<span class="n">pgm</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_94_0.png" src="_images/parte_14_94_0.png" />
</div>
</div>
<div class="section" id="r-code-14-23">
<h3>R Code 14.23<a class="headerlink" href="#r-code-14-23" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">standartize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">get_parameters</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">get_parameters</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="n">std</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span><span class="o">/</span><span class="n">std</span><span class="p">),</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">U_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">Q_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">E_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">U_sim</span> <span class="o">+</span> <span class="n">Q_sim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># E is influencied by U and Q</span>
<span class="n">W_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">U_sim</span> <span class="o">+</span> <span class="mi">0</span><span class="o">*</span><span class="n">E_sim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>  <span class="c1"># W is influencied only by U, not by E</span>

<span class="n">dat_sim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">standartize</span><span class="p">(</span><span class="n">W_sim</span><span class="p">),</span>
    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">standartize</span><span class="p">(</span><span class="n">E_sim</span><span class="p">),</span>
    <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">standartize</span><span class="p">(</span><span class="n">Q_sim</span><span class="p">)</span>
<span class="p">})</span>

<span class="n">dat_sim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>W</th>
      <th>E</th>
      <th>Q</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.458919</td>
      <td>-1.050410</td>
      <td>-1.412495</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.367655</td>
      <td>0.827180</td>
      <td>1.390074</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.058669</td>
      <td>0.095503</td>
      <td>0.455884</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.139368</td>
      <td>1.715983</td>
      <td>0.455884</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.289500</td>
      <td>1.171285</td>
      <td>0.455884</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>495</th>
      <td>-1.661304</td>
      <td>0.222796</td>
      <td>0.455884</td>
    </tr>
    <tr>
      <th>496</th>
      <td>0.078534</td>
      <td>0.363780</td>
      <td>0.455884</td>
    </tr>
    <tr>
      <th>497</th>
      <td>-0.341889</td>
      <td>-1.104266</td>
      <td>-1.412495</td>
    </tr>
    <tr>
      <th>498</th>
      <td>0.326049</td>
      <td>-1.023097</td>
      <td>-0.478305</td>
    </tr>
    <tr>
      <th>499</th>
      <td>2.156961</td>
      <td>2.760130</td>
      <td>1.390074</td>
    </tr>
  </tbody>
</table>
<p>500 rows Ã— 3 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dat_sim</span><span class="o">.</span><span class="n">E</span><span class="p">,</span> <span class="n">dat_sim</span><span class="o">.</span><span class="n">W</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Wages explained by Education&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Education (std)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Wages (std)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_14_98_0.png" src="_images/parte_14_98_0.png" />
</div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        array[N] real W;</span>
<span class="s2">        array[N] real E;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real aW;</span>
<span class="s2">        real bEW;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        array[N] real mu;</span>
<span class="s2">        </span>
<span class="s2">        aW ~ normal(0, 0.2);</span>
<span class="s2">        bEW ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = aW + bEW*E[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        W ~ normal(mu, sigma);</span>
<span class="s2">    }</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat_sim</span><span class="p">),</span>
    <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">dat_sim</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">dat_sim</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_14_4</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_14_4</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>aW</th>
      <td>-0.000</td>
      <td>0.039</td>
      <td>-0.066</td>
      <td>0.057</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3968.0</td>
      <td>2939.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bEW</th>
      <td>0.413</td>
      <td>0.040</td>
      <td>0.349</td>
      <td>0.479</td>
      <td>0.001</td>
      <td>0.000</td>
      <td>3483.0</td>
      <td>2369.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.912</td>
      <td>0.030</td>
      <td>0.867</td>
      <td>0.961</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>4109.0</td>
      <td>2633.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-14-25">
<h3>R Code 14.25<a class="headerlink" href="#r-code-14-25" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        array[N] real W;</span>
<span class="s2">        array[N] real E;</span>
<span class="s2">        array[N] real Q;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        real aW;</span>
<span class="s2">        real bEW;</span>
<span class="s2">        real bQW;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        array[N] real mu;</span>
<span class="s2">        </span>
<span class="s2">        aW ~ normal(0, 0.2);</span>
<span class="s2">        bEW ~ normal(0, 0.5);</span>
<span class="s2">        bQW ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            mu[i] = aW + bEW*E[i] + bQW*Q[i];</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        W ~ normal(mu, sigma);</span>
<span class="s2">    }</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat_sim</span><span class="p">),</span>
    <span class="s1">&#39;W&#39;</span><span class="p">:</span> <span class="n">dat_sim</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;E&#39;</span><span class="p">:</span> <span class="n">dat_sim</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">dat_sim</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_14_5</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_14_5</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>aW</th>
      <td>-0.001</td>
      <td>0.038</td>
      <td>-0.062</td>
      <td>0.060</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3870.0</td>
      <td>2998.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bEW</th>
      <td>0.633</td>
      <td>0.050</td>
      <td>0.556</td>
      <td>0.712</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3293.0</td>
      <td>2912.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bQW</th>
      <td>-0.348</td>
      <td>0.050</td>
      <td>-0.421</td>
      <td>-0.257</td>
      <td>0.001</td>
      <td>0.001</td>
      <td>3419.0</td>
      <td>2644.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.870</td>
      <td>0.027</td>
      <td>0.828</td>
      <td>0.912</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>3886.0</td>
      <td>3023.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Include instrument variable <span class="math notranslate nohighlight">\(Q\)</span>, the bias increase. The <code class="docutils literal notranslate"><span class="pre">bEW</span></code> now is <span class="math notranslate nohighlight">\(0.6\)</span> instead of <span class="math notranslate nohighlight">\(0.4\)</span> from previous model. The results from the new model is <em>terrible</em>!</p>
<p>Now, we goes to use <em>instrument variable</em> correctly.</p>
<p>Letâ€™s wirter  four models, simples generative versions of the DAGâ€™s.</p>
<ol class="simple">
<li><p>The firt model for how wages <span class="math notranslate nohighlight">\(W\)</span> are caused by education <span class="math notranslate nohighlight">\(E\)</span> and the unobserverd confound <span class="math notranslate nohighlight">\(U\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[ W_i \sim Normal(\mu_{w,i}, \sigma_{w})\]</div>
<div class="math notranslate nohighlight">
\[ \mu_{w, i} = \alpha_{w} + \beta_{EW}E_i + U_i \]</div>
<ol class="simple">
<li><p>The second model, for education levels <span class="math notranslate nohighlight">\(E\)</span> are caused by quarter of birth <span class="math notranslate nohighlight">\(Q\)</span> and the same unobserved confound <span class="math notranslate nohighlight">\(U\)</span>.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[ E_i \sim Normal(\mu_{E, i}, \sigma_E) \]</div>
<div class="math notranslate nohighlight">
\[ \mu_{E, i} = \alpha_{E} + \beta_{QE}Q_i + U_i \]</div>
<ol class="simple">
<li><p>The thirt model is for <span class="math notranslate nohighlight">\(Q\)</span>, that says that one-quarter of all people born in each quarter of the year.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[ Q_i \sim Categorical([0.25, 0.25, 0.25, 0.25]) \]</div>
<ol class="simple">
<li><p>Finally, the model says that the unobserved confound <span class="math notranslate nohighlight">\(U\)</span> is normally distributed with mean standart gaussian.</p></li>
</ol>
<div class="math notranslate nohighlight">
\[ U_i \sim Normal(0, 1) \]</div>
<p>Now, we writer this generative model to statistical model, like multivariate normal distribution. Like this:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{pmatrix}
W_i \\
E_i
\end{pmatrix} \sim
 MVNormal\begin{pmatrix}
 \begin{bmatrix}
 \mu_{w, i} \\
 \mu_{E, i}
 \end{bmatrix}, S
 \end{pmatrix}
\end{split}\]</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="parte_13.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">13 - Modelos com MemÃ³ria</p>
        </div>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Rodolpho Macedo dos Santos<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>