
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>13 - Modelos com MemÃ³ria &#8212; Statistical Rethinking</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="14 - Aventuras na CovariÃ¢ncias" href="parte_14.html" />
    <link rel="prev" title="12 - Monstros e Misturas" href="parte_12.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Statistical Rethinking</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="capa.html">
   Estatistica Bayesiana
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro_pt-BR.html">
   Intro - EstatÃ­stica Bayesiana (ðŸ‡§ðŸ‡·)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="intro_en.html">
   Intro - Bayesian Statistics (ðŸ‡ºðŸ‡¸)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_1.html">
   1- IntroduÃ§Ã£o
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_2.html">
   2 - Engenharia de Golems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_3.html">
   3- Modelos GeocÃªntricos
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_4.html">
   4 - FunÃ§Ãµes Wiggly
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_5.html">
   5 - Muitas VariÃ¡veis e os Waffles EspÃºrios
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_6.html">
   6 - Os DAGs assombrados &amp; O Terror Causal
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_7.html">
   7 - Compasso de Ulisses
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_8.html">
   8 - Os peixes-bois condicionais
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_9.html">
   9 - Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_10.html">
   10 - Grande Entropia e Modelos Lineares Generalizados
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_11.html">
   11 - A cravada de Deus e Inteiros
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_12.html">
   12 - Monstros e Misturas
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   13 - Modelos com MemÃ³ria
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="parte_14.html">
   14 - Aventuras na CovariÃ¢ncias
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/parte_13.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/rodolphomacedo/statistical_rethinking_pt_BR/issues/new?title=Issue%20on%20page%20%2Fparte_13.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/rodolphomacedo/statistical_rethinking_pt_BR/main?urlpath=tree/parte_13.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#imports-loadings-and-functions">
   Imports, loadings and functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-multilevel-tadpoles">
   13.1 Example: Multilevel tadpoles
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-1">
     R Code 13.1
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-2">
     R Code 13.2
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-3">
     R Code 13.3
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#multilevel-model-tadpole">
       Multilevel model Tadpole
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-4">
     R Code 13.4
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-5">
     R Code 13.5
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-6">
     R Code 13.6
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#varing-effects-and-underfitting-overfitting-trade-off">
   13.2 Varing effects  and underfitting/overfitting trade-off
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-7">
     R Code 13.7
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-8">
     R Code 13.8
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-9">
     R Code 13.9
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-10">
     R Code 13.10
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-11">
     R Code 13.11
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-12">
     R Code 13.12
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-the-no-pooling-estimates">
       13.2.4 Compute the no-pooling estimates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-13">
     R Code 13.13
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#compute-the-partial-pooling-estimates">
       13.2.5 Compute the partial-pooling estimates
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-14">
     R Code 13.14
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-15">
     R Code 13.15
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-16">
     R Code 13.16
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-17">
     R Code 13.17
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-18">
     R Code 13.18
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-20">
     R Code 13.20
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-than-one-type-of-cluster">
   13.3 More than one type of cluster
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#multilevel-chimpanzees">
     Multilevel Chimpanzees
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-21">
     R Code 13.21
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-22">
     R Code 13.22
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-23">
     R Code 13.23
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-24">
     R Code 13.24
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-25">
     R Code 13.25
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#divergent-transitions-and-non-centered-priors">
   13.4 Divergent Transitions and non-centered priors
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-26">
     R Code 13.26
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-27">
     R Code 13.27
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#non-centered-chimpanzees">
       13.4.2 Non-centered chimpanzees
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-28">
     R Code 13.28
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-29">
     R Code 13.29
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#r-code-13-30">
     R Code 13.30
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="modelos-com-memoria">
<h1>13 - Modelos com MemÃ³ria<a class="headerlink" href="#modelos-com-memoria" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="imports-loadings-and-functions">
<h2>Imports, loadings and functions<a class="headerlink" href="#imports-loadings-and-functions" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="c1"># from causalgraphicalmodels import CausalGraphicalModel</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="c1"># ArviZ ships with style sheets!</span>
<span class="c1"># https://python.arviz.org/en/stable/examples/styles.html#example-styles</span>
<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<span class="kn">import</span> <span class="nn">stan</span>
<span class="kn">import</span> <span class="nn">nest_asyncio</span>

<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lightgray&#39;</span>

<span class="c1"># To DAG&#39;s</span>
<span class="kn">import</span> <span class="nn">daft</span>
<span class="c1"># from causalgraphicalmodels import CausalGraphicalModel  # Just work in &lt; python3.9 </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add fonts to matplotlib to run xkcd</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">font_manager</span>

<span class="n">font_dirs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;fonts/&quot;</span><span class="p">]</span>  <span class="c1"># The path to the custom font file.</span>
<span class="n">font_files</span> <span class="o">=</span> <span class="n">font_manager</span><span class="o">.</span><span class="n">findSystemFonts</span><span class="p">(</span><span class="n">fontpaths</span><span class="o">=</span><span class="n">font_dirs</span><span class="p">)</span>

<span class="k">for</span> <span class="n">font_file</span> <span class="ow">in</span> <span class="n">font_files</span><span class="p">:</span>
    <span class="n">font_manager</span><span class="o">.</span><span class="n">fontManager</span><span class="o">.</span><span class="n">addfont</span><span class="p">(</span><span class="n">font_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To make plots like drawing </span>
<span class="c1"># plt.xkcd()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To running the stan in jupyter notebook</span>
<span class="n">nest_asyncio</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Utils functions</span>

<span class="k">def</span> <span class="nf">logit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">inv_logit</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="example-multilevel-tadpoles">
<h2>13.1 Example: Multilevel tadpoles<a class="headerlink" href="#example-multilevel-tadpoles" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="r-code-13-1">
<h3>R Code 13.1<a class="headerlink" href="#r-code-13-1" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/reedfrogs.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;tank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;tank&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># index start from 1 like Stan works</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>density</th>
      <th>pred</th>
      <th>size</th>
      <th>surv</th>
      <th>propsurv</th>
      <th>tank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>9</td>
      <td>0.900000</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>10</td>
      <td>1.000000</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>7</td>
      <td>0.700000</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>10</td>
      <td>no</td>
      <td>big</td>
      <td>10</td>
      <td>1.000000</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
      <td>5</td>
    </tr>
    <tr>
      <th>5</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
      <td>6</td>
    </tr>
    <tr>
      <th>6</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>10</td>
      <td>1.000000</td>
      <td>7</td>
    </tr>
    <tr>
      <th>7</th>
      <td>10</td>
      <td>no</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
      <td>8</td>
    </tr>
    <tr>
      <th>8</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>4</td>
      <td>0.400000</td>
      <td>9</td>
    </tr>
    <tr>
      <th>9</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>9</td>
      <td>0.900000</td>
      <td>10</td>
    </tr>
    <tr>
      <th>10</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>7</td>
      <td>0.700000</td>
      <td>11</td>
    </tr>
    <tr>
      <th>11</th>
      <td>10</td>
      <td>pred</td>
      <td>big</td>
      <td>6</td>
      <td>0.600000</td>
      <td>12</td>
    </tr>
    <tr>
      <th>12</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>7</td>
      <td>0.700000</td>
      <td>13</td>
    </tr>
    <tr>
      <th>13</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>5</td>
      <td>0.500000</td>
      <td>14</td>
    </tr>
    <tr>
      <th>14</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
      <td>15</td>
    </tr>
    <tr>
      <th>15</th>
      <td>10</td>
      <td>pred</td>
      <td>small</td>
      <td>9</td>
      <td>0.900000</td>
      <td>16</td>
    </tr>
    <tr>
      <th>16</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>24</td>
      <td>0.960000</td>
      <td>17</td>
    </tr>
    <tr>
      <th>17</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>23</td>
      <td>0.920000</td>
      <td>18</td>
    </tr>
    <tr>
      <th>18</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>22</td>
      <td>0.880000</td>
      <td>19</td>
    </tr>
    <tr>
      <th>19</th>
      <td>25</td>
      <td>no</td>
      <td>big</td>
      <td>25</td>
      <td>1.000000</td>
      <td>20</td>
    </tr>
    <tr>
      <th>20</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>23</td>
      <td>0.920000</td>
      <td>21</td>
    </tr>
    <tr>
      <th>21</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>23</td>
      <td>0.920000</td>
      <td>22</td>
    </tr>
    <tr>
      <th>22</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>23</td>
      <td>0.920000</td>
      <td>23</td>
    </tr>
    <tr>
      <th>23</th>
      <td>25</td>
      <td>no</td>
      <td>small</td>
      <td>21</td>
      <td>0.840000</td>
      <td>24</td>
    </tr>
    <tr>
      <th>24</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>6</td>
      <td>0.240000</td>
      <td>25</td>
    </tr>
    <tr>
      <th>25</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>13</td>
      <td>0.520000</td>
      <td>26</td>
    </tr>
    <tr>
      <th>26</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>4</td>
      <td>0.160000</td>
      <td>27</td>
    </tr>
    <tr>
      <th>27</th>
      <td>25</td>
      <td>pred</td>
      <td>big</td>
      <td>9</td>
      <td>0.360000</td>
      <td>28</td>
    </tr>
    <tr>
      <th>28</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>13</td>
      <td>0.520000</td>
      <td>29</td>
    </tr>
    <tr>
      <th>29</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>20</td>
      <td>0.800000</td>
      <td>30</td>
    </tr>
    <tr>
      <th>30</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>8</td>
      <td>0.320000</td>
      <td>31</td>
    </tr>
    <tr>
      <th>31</th>
      <td>25</td>
      <td>pred</td>
      <td>small</td>
      <td>10</td>
      <td>0.400000</td>
      <td>32</td>
    </tr>
    <tr>
      <th>32</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>34</td>
      <td>0.971429</td>
      <td>33</td>
    </tr>
    <tr>
      <th>33</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>33</td>
      <td>0.942857</td>
      <td>34</td>
    </tr>
    <tr>
      <th>34</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>33</td>
      <td>0.942857</td>
      <td>35</td>
    </tr>
    <tr>
      <th>35</th>
      <td>35</td>
      <td>no</td>
      <td>big</td>
      <td>31</td>
      <td>0.885714</td>
      <td>36</td>
    </tr>
    <tr>
      <th>36</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>31</td>
      <td>0.885714</td>
      <td>37</td>
    </tr>
    <tr>
      <th>37</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>35</td>
      <td>1.000000</td>
      <td>38</td>
    </tr>
    <tr>
      <th>38</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>33</td>
      <td>0.942857</td>
      <td>39</td>
    </tr>
    <tr>
      <th>39</th>
      <td>35</td>
      <td>no</td>
      <td>small</td>
      <td>32</td>
      <td>0.914286</td>
      <td>40</td>
    </tr>
    <tr>
      <th>40</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>4</td>
      <td>0.114286</td>
      <td>41</td>
    </tr>
    <tr>
      <th>41</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>12</td>
      <td>0.342857</td>
      <td>42</td>
    </tr>
    <tr>
      <th>42</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>13</td>
      <td>0.371429</td>
      <td>43</td>
    </tr>
    <tr>
      <th>43</th>
      <td>35</td>
      <td>pred</td>
      <td>big</td>
      <td>14</td>
      <td>0.400000</td>
      <td>44</td>
    </tr>
    <tr>
      <th>44</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>22</td>
      <td>0.628571</td>
      <td>45</td>
    </tr>
    <tr>
      <th>45</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>12</td>
      <td>0.342857</td>
      <td>46</td>
    </tr>
    <tr>
      <th>46</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>31</td>
      <td>0.885714</td>
      <td>47</td>
    </tr>
    <tr>
      <th>47</th>
      <td>35</td>
      <td>pred</td>
      <td>small</td>
      <td>17</td>
      <td>0.485714</td>
      <td>48</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>density</th>
      <th>surv</th>
      <th>propsurv</th>
      <th>tank</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>48.000000</td>
      <td>48.000000</td>
      <td>48.000000</td>
      <td>48.00</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>23.333333</td>
      <td>16.312500</td>
      <td>0.721607</td>
      <td>24.50</td>
    </tr>
    <tr>
      <th>std</th>
      <td>10.382746</td>
      <td>9.884775</td>
      <td>0.266416</td>
      <td>14.00</td>
    </tr>
    <tr>
      <th>min</th>
      <td>10.000000</td>
      <td>4.000000</td>
      <td>0.114286</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>10.000000</td>
      <td>9.000000</td>
      <td>0.496429</td>
      <td>12.75</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>25.000000</td>
      <td>12.500000</td>
      <td>0.885714</td>
      <td>24.50</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>35.000000</td>
      <td>23.000000</td>
      <td>0.920000</td>
      <td>36.25</td>
    </tr>
    <tr>
      <th>max</th>
      <td>35.000000</td>
      <td>35.000000</td>
      <td>1.000000</td>
      <td>48.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-13-2">
<h3>R Code 13.2<a class="headerlink" href="#r-code-13-2" title="Permalink to this headline">Â¶</a></h3>
<div class="math notranslate nohighlight">
\[ S_i \sim Binomial(N_i, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{TANK[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(0, 1.5), \mbox{ for } j \in \{1, 48\}\]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int qty;</span>
<span class="s2">        array[qty] int N;  // Total quantities that have tadpoles in tank</span>
<span class="s2">        array[qty] int survival;  // How many tadpoles survival</span>
<span class="s2">        array[qty] int tank;  // Tank index</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty] alpha;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[qty] p;</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(0, 1.5);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:qty){</span>
<span class="s2">            p[i] = alpha[ tank[i] ];</span>
<span class="s2">            p[i] = inv_logit(alpha[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        survival ~ binomial(N, p);</span>
<span class="s2">        </span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
    <span class="s1">&#39;tank&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="s1">&#39;survival&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="p">}</span>


<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_1</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_13_1</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>1.729</td>
      <td>0.782</td>
      <td>0.473</td>
      <td>2.954</td>
      <td>0.011</td>
      <td>0.009</td>
      <td>5033.0</td>
      <td>2899.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>2.397</td>
      <td>0.896</td>
      <td>0.960</td>
      <td>3.810</td>
      <td>0.012</td>
      <td>0.010</td>
      <td>5933.0</td>
      <td>2874.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>0.761</td>
      <td>0.627</td>
      <td>-0.247</td>
      <td>1.749</td>
      <td>0.008</td>
      <td>0.008</td>
      <td>5851.0</td>
      <td>2858.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>2.397</td>
      <td>0.873</td>
      <td>0.989</td>
      <td>3.729</td>
      <td>0.010</td>
      <td>0.009</td>
      <td>7616.0</td>
      <td>2956.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>1.721</td>
      <td>0.768</td>
      <td>0.518</td>
      <td>2.939</td>
      <td>0.010</td>
      <td>0.009</td>
      <td>6444.0</td>
      <td>2264.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>1.697</td>
      <td>0.751</td>
      <td>0.465</td>
      <td>2.871</td>
      <td>0.009</td>
      <td>0.008</td>
      <td>6611.0</td>
      <td>2922.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>2.417</td>
      <td>0.891</td>
      <td>1.038</td>
      <td>3.823</td>
      <td>0.012</td>
      <td>0.010</td>
      <td>6037.0</td>
      <td>3012.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[7]</th>
      <td>1.724</td>
      <td>0.804</td>
      <td>0.382</td>
      <td>2.897</td>
      <td>0.010</td>
      <td>0.009</td>
      <td>6642.0</td>
      <td>2708.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[8]</th>
      <td>-0.369</td>
      <td>0.616</td>
      <td>-1.348</td>
      <td>0.580</td>
      <td>0.009</td>
      <td>0.009</td>
      <td>5099.0</td>
      <td>3129.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[9]</th>
      <td>1.729</td>
      <td>0.774</td>
      <td>0.468</td>
      <td>2.932</td>
      <td>0.011</td>
      <td>0.009</td>
      <td>5226.0</td>
      <td>2840.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[10]</th>
      <td>0.760</td>
      <td>0.649</td>
      <td>-0.294</td>
      <td>1.767</td>
      <td>0.008</td>
      <td>0.008</td>
      <td>6808.0</td>
      <td>2797.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[11]</th>
      <td>0.374</td>
      <td>0.618</td>
      <td>-0.615</td>
      <td>1.336</td>
      <td>0.008</td>
      <td>0.009</td>
      <td>6522.0</td>
      <td>2646.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[12]</th>
      <td>0.750</td>
      <td>0.624</td>
      <td>-0.232</td>
      <td>1.733</td>
      <td>0.008</td>
      <td>0.007</td>
      <td>6833.0</td>
      <td>2804.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[13]</th>
      <td>0.004</td>
      <td>0.593</td>
      <td>-0.923</td>
      <td>0.953</td>
      <td>0.008</td>
      <td>0.010</td>
      <td>5845.0</td>
      <td>2809.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[14]</th>
      <td>1.721</td>
      <td>0.780</td>
      <td>0.457</td>
      <td>2.893</td>
      <td>0.011</td>
      <td>0.009</td>
      <td>5877.0</td>
      <td>2668.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[15]</th>
      <td>1.731</td>
      <td>0.773</td>
      <td>0.549</td>
      <td>2.968</td>
      <td>0.011</td>
      <td>0.009</td>
      <td>5508.0</td>
      <td>2657.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[16]</th>
      <td>2.547</td>
      <td>0.675</td>
      <td>1.465</td>
      <td>3.591</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>6075.0</td>
      <td>2900.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[17]</th>
      <td>2.141</td>
      <td>0.606</td>
      <td>1.210</td>
      <td>3.112</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>4941.0</td>
      <td>2607.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[18]</th>
      <td>1.815</td>
      <td>0.533</td>
      <td>0.942</td>
      <td>2.630</td>
      <td>0.007</td>
      <td>0.006</td>
      <td>5376.0</td>
      <td>2942.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[19]</th>
      <td>3.100</td>
      <td>0.823</td>
      <td>1.861</td>
      <td>4.392</td>
      <td>0.011</td>
      <td>0.009</td>
      <td>5902.0</td>
      <td>2957.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[20]</th>
      <td>2.149</td>
      <td>0.619</td>
      <td>1.147</td>
      <td>3.097</td>
      <td>0.010</td>
      <td>0.008</td>
      <td>4751.0</td>
      <td>2430.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[21]</th>
      <td>2.124</td>
      <td>0.586</td>
      <td>1.215</td>
      <td>3.052</td>
      <td>0.008</td>
      <td>0.007</td>
      <td>5953.0</td>
      <td>2490.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[22]</th>
      <td>2.140</td>
      <td>0.613</td>
      <td>1.192</td>
      <td>3.098</td>
      <td>0.008</td>
      <td>0.007</td>
      <td>5610.0</td>
      <td>2987.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[23]</th>
      <td>1.551</td>
      <td>0.523</td>
      <td>0.695</td>
      <td>2.324</td>
      <td>0.007</td>
      <td>0.006</td>
      <td>6228.0</td>
      <td>2590.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[24]</th>
      <td>-1.089</td>
      <td>0.436</td>
      <td>-1.818</td>
      <td>-0.408</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>7119.0</td>
      <td>2925.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[25]</th>
      <td>0.076</td>
      <td>0.397</td>
      <td>-0.556</td>
      <td>0.701</td>
      <td>0.005</td>
      <td>0.007</td>
      <td>6264.0</td>
      <td>2929.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[26]</th>
      <td>-1.548</td>
      <td>0.505</td>
      <td>-2.323</td>
      <td>-0.709</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>6025.0</td>
      <td>2769.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[27]</th>
      <td>-0.554</td>
      <td>0.402</td>
      <td>-1.177</td>
      <td>0.100</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>6636.0</td>
      <td>2947.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[28]</th>
      <td>0.081</td>
      <td>0.407</td>
      <td>-0.593</td>
      <td>0.689</td>
      <td>0.005</td>
      <td>0.007</td>
      <td>5490.0</td>
      <td>2935.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[29]</th>
      <td>1.310</td>
      <td>0.480</td>
      <td>0.532</td>
      <td>2.039</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>7013.0</td>
      <td>2854.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[30]</th>
      <td>-0.732</td>
      <td>0.407</td>
      <td>-1.422</td>
      <td>-0.124</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>5134.0</td>
      <td>2874.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[31]</th>
      <td>-0.398</td>
      <td>0.387</td>
      <td>-1.026</td>
      <td>0.213</td>
      <td>0.005</td>
      <td>0.005</td>
      <td>5524.0</td>
      <td>2954.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[32]</th>
      <td>2.831</td>
      <td>0.651</td>
      <td>1.827</td>
      <td>3.820</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>5118.0</td>
      <td>3261.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[33]</th>
      <td>2.475</td>
      <td>0.600</td>
      <td>1.542</td>
      <td>3.414</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>5083.0</td>
      <td>2667.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[34]</th>
      <td>2.448</td>
      <td>0.581</td>
      <td>1.467</td>
      <td>3.332</td>
      <td>0.007</td>
      <td>0.006</td>
      <td>6680.0</td>
      <td>2426.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[35]</th>
      <td>1.905</td>
      <td>0.481</td>
      <td>1.161</td>
      <td>2.714</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>6105.0</td>
      <td>2837.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[36]</th>
      <td>1.906</td>
      <td>0.464</td>
      <td>1.139</td>
      <td>2.600</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>6146.0</td>
      <td>3053.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[37]</th>
      <td>3.352</td>
      <td>0.778</td>
      <td>2.097</td>
      <td>4.528</td>
      <td>0.011</td>
      <td>0.008</td>
      <td>5970.0</td>
      <td>2790.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[38]</th>
      <td>2.445</td>
      <td>0.583</td>
      <td>1.524</td>
      <td>3.334</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>6204.0</td>
      <td>3449.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[39]</th>
      <td>2.164</td>
      <td>0.524</td>
      <td>1.383</td>
      <td>3.051</td>
      <td>0.007</td>
      <td>0.006</td>
      <td>6301.0</td>
      <td>2722.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[40]</th>
      <td>-1.904</td>
      <td>0.479</td>
      <td>-2.635</td>
      <td>-1.122</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>7453.0</td>
      <td>2977.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[41]</th>
      <td>-0.637</td>
      <td>0.355</td>
      <td>-1.205</td>
      <td>-0.078</td>
      <td>0.004</td>
      <td>0.004</td>
      <td>6393.0</td>
      <td>3005.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[42]</th>
      <td>-0.511</td>
      <td>0.339</td>
      <td>-1.006</td>
      <td>0.074</td>
      <td>0.004</td>
      <td>0.004</td>
      <td>5884.0</td>
      <td>2943.0</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>alpha[43]</th>
      <td>-0.395</td>
      <td>0.336</td>
      <td>-0.930</td>
      <td>0.138</td>
      <td>0.004</td>
      <td>0.004</td>
      <td>5973.0</td>
      <td>2821.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[44]</th>
      <td>0.507</td>
      <td>0.347</td>
      <td>-0.033</td>
      <td>1.068</td>
      <td>0.004</td>
      <td>0.004</td>
      <td>6663.0</td>
      <td>2982.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[45]</th>
      <td>-0.631</td>
      <td>0.346</td>
      <td>-1.185</td>
      <td>-0.074</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>5811.0</td>
      <td>2715.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[46]</th>
      <td>1.905</td>
      <td>0.480</td>
      <td>1.152</td>
      <td>2.637</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>6090.0</td>
      <td>2761.0</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>alpha[47]</th>
      <td>-0.053</td>
      <td>0.334</td>
      <td>-0.546</td>
      <td>0.523</td>
      <td>0.004</td>
      <td>0.006</td>
      <td>6006.0</td>
      <td>2621.0</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_13_1</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_16_0.png" src="_images/parte_13_16_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-13-3">
<h3>R Code 13.3<a class="headerlink" href="#r-code-13-3" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="multilevel-model-tadpole">
<h4>Multilevel model Tadpole<a class="headerlink" href="#multilevel-model-tadpole" title="Permalink to this headline">Â¶</a></h4>
<div class="math notranslate nohighlight">
\[ S_i \sim Binomial(N_i, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{TANK[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha[j] \sim Normal(\bar{\alpha}, \sigma) \mbox{ - [Adaptative prior]} \]</div>
<div class="math notranslate nohighlight">
\[ \bar{\alpha} \sim Normal(0, 1.5) \mbox{ - [prior to average tank]} \]</div>
<div class="math notranslate nohighlight">
\[ \sigma \sim Exponential(1) \mbox{ - [prior for standard deviation of tanks]} \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int qty;</span>
<span class="s2">        array[qty] int N;</span>
<span class="s2">        array[qty] int survival;</span>
<span class="s2">        array[qty] int tank;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty] alpha;</span>
<span class="s2">        real bar_alpha;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[qty] p;</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(bar_alpha, sigma);</span>
<span class="s2">        </span>
<span class="s2">        bar_alpha ~ normal(0, 1.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        for (i in 1:qty){</span>
<span class="s2">            p[i] = alpha[ tank[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">    </span>
<span class="s2">        survival ~ binomial(N, p);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">dat_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;qty&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
    <span class="s1">&#39;tank&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="s1">&#39;survival&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;surv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="p">}</span>


<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_2</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_13_2</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>2.120</td>
      <td>0.878</td>
      <td>0.638</td>
      <td>3.364</td>
      <td>0.013</td>
      <td>0.011</td>
      <td>5103.0</td>
      <td>2774.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>3.042</td>
      <td>1.090</td>
      <td>1.234</td>
      <td>4.649</td>
      <td>0.017</td>
      <td>0.013</td>
      <td>4432.0</td>
      <td>3020.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>1.012</td>
      <td>0.678</td>
      <td>-0.009</td>
      <td>2.145</td>
      <td>0.009</td>
      <td>0.008</td>
      <td>5420.0</td>
      <td>2781.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>3.067</td>
      <td>1.134</td>
      <td>1.212</td>
      <td>4.680</td>
      <td>0.020</td>
      <td>0.017</td>
      <td>3701.0</td>
      <td>2066.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>2.143</td>
      <td>0.887</td>
      <td>0.787</td>
      <td>3.555</td>
      <td>0.013</td>
      <td>0.011</td>
      <td>5244.0</td>
      <td>2510.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>2.122</td>
      <td>0.864</td>
      <td>0.782</td>
      <td>3.457</td>
      <td>0.012</td>
      <td>0.010</td>
      <td>5285.0</td>
      <td>2885.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>3.076</td>
      <td>1.122</td>
      <td>1.159</td>
      <td>4.666</td>
      <td>0.017</td>
      <td>0.014</td>
      <td>5095.0</td>
      <td>2384.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[7]</th>
      <td>2.134</td>
      <td>0.871</td>
      <td>0.681</td>
      <td>3.370</td>
      <td>0.013</td>
      <td>0.010</td>
      <td>4979.0</td>
      <td>2943.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[8]</th>
      <td>-0.176</td>
      <td>0.624</td>
      <td>-1.097</td>
      <td>0.884</td>
      <td>0.009</td>
      <td>0.010</td>
      <td>4791.0</td>
      <td>2630.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[9]</th>
      <td>2.131</td>
      <td>0.856</td>
      <td>0.870</td>
      <td>3.516</td>
      <td>0.012</td>
      <td>0.010</td>
      <td>5257.0</td>
      <td>2688.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[10]</th>
      <td>1.009</td>
      <td>0.657</td>
      <td>-0.059</td>
      <td>2.031</td>
      <td>0.009</td>
      <td>0.008</td>
      <td>5011.0</td>
      <td>2379.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[11]</th>
      <td>0.578</td>
      <td>0.643</td>
      <td>-0.410</td>
      <td>1.625</td>
      <td>0.009</td>
      <td>0.008</td>
      <td>5160.0</td>
      <td>3014.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[12]</th>
      <td>1.002</td>
      <td>0.643</td>
      <td>0.018</td>
      <td>2.031</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>5615.0</td>
      <td>3058.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[13]</th>
      <td>0.205</td>
      <td>0.619</td>
      <td>-0.818</td>
      <td>1.132</td>
      <td>0.008</td>
      <td>0.010</td>
      <td>5383.0</td>
      <td>2795.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[14]</th>
      <td>2.144</td>
      <td>0.850</td>
      <td>0.811</td>
      <td>3.456</td>
      <td>0.013</td>
      <td>0.011</td>
      <td>4588.0</td>
      <td>2692.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[15]</th>
      <td>2.130</td>
      <td>0.888</td>
      <td>0.742</td>
      <td>3.503</td>
      <td>0.013</td>
      <td>0.011</td>
      <td>5481.0</td>
      <td>2815.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[16]</th>
      <td>2.930</td>
      <td>0.808</td>
      <td>1.772</td>
      <td>4.282</td>
      <td>0.012</td>
      <td>0.009</td>
      <td>5486.0</td>
      <td>2837.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[17]</th>
      <td>2.414</td>
      <td>0.673</td>
      <td>1.351</td>
      <td>3.467</td>
      <td>0.010</td>
      <td>0.008</td>
      <td>4980.0</td>
      <td>2624.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[18]</th>
      <td>2.029</td>
      <td>0.596</td>
      <td>1.078</td>
      <td>2.965</td>
      <td>0.010</td>
      <td>0.008</td>
      <td>3769.0</td>
      <td>2496.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[19]</th>
      <td>3.668</td>
      <td>0.998</td>
      <td>2.060</td>
      <td>5.129</td>
      <td>0.015</td>
      <td>0.012</td>
      <td>4742.0</td>
      <td>2956.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[20]</th>
      <td>2.401</td>
      <td>0.696</td>
      <td>1.294</td>
      <td>3.475</td>
      <td>0.010</td>
      <td>0.008</td>
      <td>5393.0</td>
      <td>2721.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[21]</th>
      <td>2.400</td>
      <td>0.652</td>
      <td>1.354</td>
      <td>3.378</td>
      <td>0.010</td>
      <td>0.008</td>
      <td>4742.0</td>
      <td>2220.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[22]</th>
      <td>2.402</td>
      <td>0.657</td>
      <td>1.379</td>
      <td>3.436</td>
      <td>0.011</td>
      <td>0.008</td>
      <td>4170.0</td>
      <td>2524.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[23]</th>
      <td>1.705</td>
      <td>0.540</td>
      <td>0.862</td>
      <td>2.557</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>4555.0</td>
      <td>2817.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[24]</th>
      <td>-0.999</td>
      <td>0.449</td>
      <td>-1.655</td>
      <td>-0.244</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>5423.0</td>
      <td>2412.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[25]</th>
      <td>0.163</td>
      <td>0.400</td>
      <td>-0.491</td>
      <td>0.800</td>
      <td>0.005</td>
      <td>0.006</td>
      <td>5549.0</td>
      <td>2698.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[26]</th>
      <td>-1.429</td>
      <td>0.503</td>
      <td>-2.269</td>
      <td>-0.687</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>4286.0</td>
      <td>2894.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[27]</th>
      <td>-0.483</td>
      <td>0.410</td>
      <td>-1.148</td>
      <td>0.160</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>5325.0</td>
      <td>3363.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[28]</th>
      <td>0.157</td>
      <td>0.388</td>
      <td>-0.489</td>
      <td>0.743</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>4797.0</td>
      <td>2966.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[29]</th>
      <td>1.438</td>
      <td>0.479</td>
      <td>0.657</td>
      <td>2.166</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>5631.0</td>
      <td>3250.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[30]</th>
      <td>-0.637</td>
      <td>0.412</td>
      <td>-1.259</td>
      <td>0.053</td>
      <td>0.006</td>
      <td>0.005</td>
      <td>5600.0</td>
      <td>2739.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[31]</th>
      <td>-0.317</td>
      <td>0.395</td>
      <td>-1.002</td>
      <td>0.256</td>
      <td>0.006</td>
      <td>0.006</td>
      <td>5105.0</td>
      <td>2842.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[32]</th>
      <td>3.188</td>
      <td>0.771</td>
      <td>1.963</td>
      <td>4.334</td>
      <td>0.012</td>
      <td>0.009</td>
      <td>4968.0</td>
      <td>2644.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[33]</th>
      <td>2.714</td>
      <td>0.639</td>
      <td>1.685</td>
      <td>3.693</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>4885.0</td>
      <td>3002.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[34]</th>
      <td>2.715</td>
      <td>0.657</td>
      <td>1.705</td>
      <td>3.773</td>
      <td>0.010</td>
      <td>0.008</td>
      <td>4591.0</td>
      <td>2027.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[35]</th>
      <td>2.072</td>
      <td>0.519</td>
      <td>1.255</td>
      <td>2.887</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>4743.0</td>
      <td>2557.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[36]</th>
      <td>2.061</td>
      <td>0.514</td>
      <td>1.291</td>
      <td>2.909</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>4889.0</td>
      <td>2645.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[37]</th>
      <td>3.893</td>
      <td>0.955</td>
      <td>2.436</td>
      <td>5.387</td>
      <td>0.015</td>
      <td>0.012</td>
      <td>4467.0</td>
      <td>2872.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[38]</th>
      <td>2.702</td>
      <td>0.641</td>
      <td>1.767</td>
      <td>3.752</td>
      <td>0.010</td>
      <td>0.008</td>
      <td>4560.0</td>
      <td>2247.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[39]</th>
      <td>2.354</td>
      <td>0.562</td>
      <td>1.433</td>
      <td>3.187</td>
      <td>0.009</td>
      <td>0.007</td>
      <td>4042.0</td>
      <td>2801.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[40]</th>
      <td>-1.799</td>
      <td>0.474</td>
      <td>-2.528</td>
      <td>-1.032</td>
      <td>0.007</td>
      <td>0.005</td>
      <td>4750.0</td>
      <td>2938.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[41]</th>
      <td>-0.573</td>
      <td>0.355</td>
      <td>-1.133</td>
      <td>-0.006</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>4697.0</td>
      <td>2564.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[42]</th>
      <td>-0.456</td>
      <td>0.345</td>
      <td>-1.001</td>
      <td>0.096</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>5231.0</td>
      <td>3157.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[43]</th>
      <td>-0.334</td>
      <td>0.343</td>
      <td>-0.872</td>
      <td>0.226</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>4927.0</td>
      <td>3032.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[44]</th>
      <td>0.582</td>
      <td>0.345</td>
      <td>0.041</td>
      <td>1.143</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>4770.0</td>
      <td>3146.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[45]</th>
      <td>-0.573</td>
      <td>0.366</td>
      <td>-1.163</td>
      <td>0.008</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>5334.0</td>
      <td>3158.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[46]</th>
      <td>2.069</td>
      <td>0.522</td>
      <td>1.285</td>
      <td>2.919</td>
      <td>0.008</td>
      <td>0.006</td>
      <td>4822.0</td>
      <td>2614.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[47]</th>
      <td>-0.000</td>
      <td>0.340</td>
      <td>-0.524</td>
      <td>0.552</td>
      <td>0.005</td>
      <td>0.006</td>
      <td>5063.0</td>
      <td>2720.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bar_alpha</th>
      <td>1.346</td>
      <td>0.260</td>
      <td>0.940</td>
      <td>1.758</td>
      <td>0.005</td>
      <td>0.003</td>
      <td>3131.0</td>
      <td>2923.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.618</td>
      <td>0.216</td>
      <td>1.263</td>
      <td>1.940</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>2491.0</td>
      <td>3083.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_13_2</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_22_0.png" src="_images/parte_13_22_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-4">
<h3>R Code 13.4<a class="headerlink" href="#r-code-13-4" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># az.compare(model_13_1, model_13_2)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-5">
<h3>R Code 13.5<a class="headerlink" href="#r-code-13-5" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">means</span> <span class="o">=</span> <span class="p">[</span> <span class="n">model_13_2</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">alpha_dim_0</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">tank</span> <span class="p">]</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># My test, this is not originaly in book</span>
<span class="n">means_13_1</span> <span class="o">=</span> <span class="p">[</span> <span class="n">model_13_1</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">alpha_dim_0</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">tank</span> <span class="p">]</span>
<span class="n">means_13_1</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">means_13_1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bar_alpha_log</span> <span class="o">=</span> <span class="n">model_13_2</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">bar_alpha</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">bar_alpha</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">bar_alpha_log</span><span class="p">)</span>
<span class="n">bar_alpha_mean</span> <span class="o">=</span> <span class="n">bar_alpha</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 

<span class="n">sigma_log</span> <span class="o">=</span> <span class="n">model_13_2</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sigma</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">sigma_log</span><span class="p">)</span>
<span class="n">sigma_mean</span> <span class="o">=</span> <span class="n">sigma</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">means_13_1</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">tank</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">propsurv</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">15.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">31.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">bar_alpha_mean</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;Small Tank&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;Medium Tank&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s1">&#39;Large Tank&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Tadpole survival Tanks&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Tank Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Porportion Survival&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_29_0.png" src="_images/parte_13_29_0.png" />
</div>
</div>
<ul class="simple">
<li><p><strong>Blue dot</strong>: Proportion survival s_i/N_i</p></li>
<li><p><strong>Black circle</strong>: Multilevel model estimative</p></li>
<li><p><strong>Light Yellow</strong>: No-pooling estimative</p></li>
</ul>
</div>
<div class="section" id="r-code-13-6">
<h3>R Code 13.6<a class="headerlink" href="#r-code-13-6" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">s_sampled</span> <span class="o">=</span> <span class="mi">500</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">log_odds_survival</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">log_odds_sampled_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bar_alpha_log</span><span class="p">)</span> <span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">s_sampled</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">log_odds_sampled_index</span><span class="p">:</span>
    <span class="n">log_odds_survival</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bar_alpha_log</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sigma_log</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_sampled</span><span class="p">):</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">log_odds_survival</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Survival across Tank&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;log_odds survival&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    

<span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">samples_log</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">bar_alpha_log</span><span class="p">,</span> <span class="n">sigma_log</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">samples_log</span><span class="p">),</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">samples_log</span><span class="p">)),</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">samples_log</span><span class="p">))</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="s1">&#39;Mean&#39;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Survival probabilities simulations&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Probability survival&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_32_0.png" src="_images/parte_13_32_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="varing-effects-and-underfitting-overfitting-trade-off">
<h2>13.2 Varing effects  and underfitting/overfitting trade-off<a class="headerlink" href="#varing-effects-and-underfitting-overfitting-trade-off" title="Permalink to this headline">Â¶</a></h2>
<p>The model</p>
<div class="math notranslate nohighlight">
\[ S_i \sim Binomial(N_i, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{POND[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(\bar{\alpha}, \sigma) \]</div>
<div class="math notranslate nohighlight">
\[ \bar{\alpha} \sim Normal(0, 1.5) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma \sim Exponential(1) \]</div>
<p><span class="math notranslate nohighlight">\(\bar{\alpha} := \)</span> the avegare log-oods fo survival in the entire population of ponds</p>
<p><span class="math notranslate nohighlight">\(\sigma := \)</span> the standard deviation of the distribution of log-oods of survivial among ponds</p>
<p><span class="math notranslate nohighlight">\(\alpha := \)</span> a vector of individual pond intercepts, one for each pond</p>
<div class="section" id="r-code-13-7">
<h3>R Code 13.7<a class="headerlink" href="#r-code-13-7" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_bar</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="n">nponds</span> <span class="o">=</span> <span class="mi">60</span>

<span class="n">repeats</span> <span class="o">=</span> <span class="mi">15</span>

<span class="n">Ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="n">repeats</span><span class="o">=</span><span class="n">repeats</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-8">
<h3>R Code 13.8<a class="headerlink" href="#r-code-13-8" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a_pond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">a_bar</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">nponds</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-9">
<h3>R Code 13.9<a class="headerlink" href="#r-code-13-9" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;pond&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nponds</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;Ni&#39;</span><span class="p">:</span><span class="n">Ni</span><span class="p">,</span>
    <span class="s1">&#39;true_a&#39;</span><span class="p">:</span> <span class="n">a_pond</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">dsim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>Ni</th>
      <th>true_a</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>1.812547</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>5</td>
      <td>0.484266</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>5</td>
      <td>2.273773</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>5</td>
      <td>1.495332</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>5</td>
      <td>1.674099</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-13-10">
<h3>R Code 13.10<a class="headerlink" href="#r-code-13-10" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Code in R -&gt; integer vs numeric</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-11">
<h3>R Code 13.11<a class="headerlink" href="#r-code-13-11" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;Si&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">],</span> <span class="n">p</span><span class="o">=</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;true_a&#39;</span><span class="p">]))</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>Ni</th>
      <th>true_a</th>
      <th>Si</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>1.812547</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>5</td>
      <td>0.484266</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>5</td>
      <td>2.273773</td>
      <td>3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>5</td>
      <td>1.495332</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>5</td>
      <td>1.674099</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-13-12">
<h3>R Code 13.12<a class="headerlink" href="#r-code-13-12" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="compute-the-no-pooling-estimates">
<h4>13.2.4 Compute the no-pooling estimates<a class="headerlink" href="#compute-the-no-pooling-estimates" title="Permalink to this headline">Â¶</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;p_nopool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;Si&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>Ni</th>
      <th>true_a</th>
      <th>Si</th>
      <th>p_nopool</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>1.812547</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>5</td>
      <td>0.484266</td>
      <td>4</td>
      <td>0.8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>5</td>
      <td>2.273773</td>
      <td>3</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>5</td>
      <td>1.495332</td>
      <td>3</td>
      <td>0.6</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>5</td>
      <td>1.674099</td>
      <td>5</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
</div>
<div class="section" id="r-code-13-13">
<h3>R Code 13.13<a class="headerlink" href="#r-code-13-13" title="Permalink to this headline">Â¶</a></h3>
<div class="section" id="compute-the-partial-pooling-estimates">
<h4>13.2.5 Compute the partial-pooling estimates<a class="headerlink" href="#compute-the-partial-pooling-estimates" title="Permalink to this headline">Â¶</a></h4>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        array[N] int pond;  // Pond index</span>
<span class="s2">        array[N] int Ni;  // Population in pond[i]</span>
<span class="s2">        array[N] int Si;  // Survivals from Ni pond</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[N] alpha;</span>
<span class="s2">        real bar_alpha;</span>
<span class="s2">        real&lt;lower=0&gt; sigma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] pi;</span>
<span class="s2">        </span>
<span class="s2">        // Link</span>
<span class="s2">            for (i in 1:N) {</span>
<span class="s2">                pi[i] = alpha[ pond[i] ];</span>
<span class="s2">                pi[i] = inv_logit(pi[i]);</span>
<span class="s2">            }</span>
<span class="s2">        </span>
<span class="s2">        // Prior</span>
<span class="s2">        alpha ~ normal(bar_alpha, sigma);</span>
<span class="s2">        </span>
<span class="s2">        // Hyper Prior</span>
<span class="s2">        bar_alpha ~ normal(0, 1.5);</span>
<span class="s2">        sigma ~ exponential(1);</span>
<span class="s2">    </span>
<span class="s2">        // Likelihood</span>
<span class="s2">        Si ~ binomial(Ni, pi);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">dat_list</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsim</span><span class="p">),</span>
    <span class="s1">&#39;Ni&#39;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="s1">&#39;pond&#39;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;pond&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
    <span class="s1">&#39;Si&#39;</span><span class="p">:</span> <span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;Si&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
<span class="p">}</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-14">
<h3>R Code 13.14<a class="headerlink" href="#r-code-13-14" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_3</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_13_3</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>alpha[0]</th>
      <td>2.787</td>
      <td>1.241</td>
      <td>0.919</td>
      <td>4.799</td>
      <td>0.019</td>
      <td>0.016</td>
      <td>4867.0</td>
      <td>2442.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>1.562</td>
      <td>0.969</td>
      <td>-0.034</td>
      <td>3.021</td>
      <td>0.014</td>
      <td>0.012</td>
      <td>5222.0</td>
      <td>2609.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>0.721</td>
      <td>0.865</td>
      <td>-0.728</td>
      <td>2.038</td>
      <td>0.012</td>
      <td>0.012</td>
      <td>5554.0</td>
      <td>2651.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>0.728</td>
      <td>0.854</td>
      <td>-0.587</td>
      <td>2.118</td>
      <td>0.013</td>
      <td>0.012</td>
      <td>4619.0</td>
      <td>2732.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>2.759</td>
      <td>1.252</td>
      <td>0.761</td>
      <td>4.686</td>
      <td>0.019</td>
      <td>0.015</td>
      <td>4595.0</td>
      <td>2736.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>alpha[57]</th>
      <td>4.017</td>
      <td>1.033</td>
      <td>2.446</td>
      <td>5.569</td>
      <td>0.017</td>
      <td>0.014</td>
      <td>4304.0</td>
      <td>2100.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[58]</th>
      <td>1.430</td>
      <td>0.410</td>
      <td>0.782</td>
      <td>2.105</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>5454.0</td>
      <td>3090.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>alpha[59]</th>
      <td>1.115</td>
      <td>0.384</td>
      <td>0.451</td>
      <td>1.690</td>
      <td>0.005</td>
      <td>0.004</td>
      <td>5327.0</td>
      <td>3270.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>bar_alpha</th>
      <td>1.442</td>
      <td>0.254</td>
      <td>1.026</td>
      <td>1.835</td>
      <td>0.004</td>
      <td>0.003</td>
      <td>3741.0</td>
      <td>2961.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>1.700</td>
      <td>0.236</td>
      <td>1.320</td>
      <td>2.046</td>
      <td>0.006</td>
      <td>0.004</td>
      <td>1522.0</td>
      <td>2025.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>62 rows Ã— 9 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-13-15">
<h3>R Code 13.15<a class="headerlink" href="#r-code-13-15" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;p_partpool&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inv_logit</span><span class="p">(</span><span class="n">model_13_3</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">alpha_dim_0</span><span class="o">=</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsim</span><span class="p">))]</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>Ni</th>
      <th>true_a</th>
      <th>Si</th>
      <th>p_nopool</th>
      <th>p_partpool</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>1.812547</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.941987</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>5</td>
      <td>0.484266</td>
      <td>4</td>
      <td>0.8</td>
      <td>0.826685</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>5</td>
      <td>2.273773</td>
      <td>3</td>
      <td>0.6</td>
      <td>0.672823</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>5</td>
      <td>1.495332</td>
      <td>3</td>
      <td>0.6</td>
      <td>0.674364</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>5</td>
      <td>1.674099</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.940440</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-13-16">
<h3>R Code 13.16<a class="headerlink" href="#r-code-13-16" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;p_true&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv_logit</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;true_a&#39;</span><span class="p">])</span>
<span class="n">dsim</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pond</th>
      <th>Ni</th>
      <th>true_a</th>
      <th>Si</th>
      <th>p_nopool</th>
      <th>p_partpool</th>
      <th>p_true</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>5</td>
      <td>1.812547</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.941987</td>
      <td>0.859669</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>5</td>
      <td>0.484266</td>
      <td>4</td>
      <td>0.8</td>
      <td>0.826685</td>
      <td>0.618755</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>5</td>
      <td>2.273773</td>
      <td>3</td>
      <td>0.6</td>
      <td>0.672823</td>
      <td>0.906681</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>5</td>
      <td>1.495332</td>
      <td>3</td>
      <td>0.6</td>
      <td>0.674364</td>
      <td>0.816877</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>5</td>
      <td>1.674099</td>
      <td>5</td>
      <td>1.0</td>
      <td>0.940440</td>
      <td>0.842122</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-13-17">
<h3>R Code 13.17<a class="headerlink" href="#r-code-13-17" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">no_pool_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;p_nopool&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;p_true&#39;</span><span class="p">])</span>
<span class="n">partpool_error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;p_partpool&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;p_true&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-18">
<h3>R Code 13.18<a class="headerlink" href="#r-code-13-18" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">max_lim_graph</span> <span class="o">=</span> <span class="mf">0.3</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">pond</span><span class="p">,</span> <span class="n">partpool_error</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dsim</span><span class="o">.</span><span class="n">pond</span><span class="p">,</span> <span class="n">no_pool_error</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>

<span class="n">qty_unique_ponds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsim</span><span class="p">[</span><span class="s1">&#39;Ni&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">qty_each_ponds</span> <span class="o">=</span> <span class="n">repeats</span>  <span class="c1"># The number of repetitions for each element in each pond.</span>


<span class="c1"># Vertical lines</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">qty_unique_ponds</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="n">partpool_error_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">partpool_error</span><span class="p">[(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="n">i</span><span class="p">):(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))])</span>
    <span class="n">no_pool_error_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">no_pool_error</span><span class="p">[(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="n">i</span><span class="p">):(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))])</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">partpool_error_mean</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">qty_each_ponds</span><span class="o">+</span><span class="p">(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">no_pool_error_mean</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">xmax</span><span class="o">=</span><span class="n">qty_each_ponds</span><span class="o">+</span><span class="p">(</span><span class="n">qty_each_ponds</span><span class="o">*</span><span class="n">i</span><span class="p">),</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">score_no_pooling</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">score_partial_pooling</span> <span class="o">=</span> <span class="mi">0</span>
    
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dsim</span><span class="o">.</span><span class="n">pond</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">no_pool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">partpool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># partial polling is better</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">no_pool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ymax</span><span class="o">=</span><span class="n">partpool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">score_partial_pooling</span> <span class="o">+=</span> <span class="n">no_pool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">partpool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># How partial pooling is better</span>
        
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># no pooling is better</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="n">no_pool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ymax</span><span class="o">=</span><span class="n">partpool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">score_no_pooling</span> <span class="o">+=</span> <span class="n">partpool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">no_pool_error</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># How no pooling is better</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">max_lim_graph</span><span class="p">,</span> <span class="s1">&#39;Tiny Ponds ($5$)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="n">max_lim_graph</span><span class="p">,</span> <span class="s1">&#39;Small Ponds ($10$)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="n">max_lim_graph</span><span class="p">,</span> <span class="s1">&#39;Medium Ponds ($25$)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_lim_graph</span><span class="p">,</span> <span class="s1">&#39;Large Ponds ($35$)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Partial pooling is better by = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">score_partial_pooling</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span> <span class="mf">0.24</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;No pooling is better by = </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">score_no_pooling</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">47</span><span class="p">,</span> <span class="mf">0.23</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Partial Polling/No polling = </span><span class="si">{</span><span class="nb">round</span><span class="p">((</span><span class="n">score_partial_pooling</span><span class="o">/</span><span class="n">score_no_pooling</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_lim_graph</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Pond survival error absolute </span><span class="se">\n\n</span><span class="s1"> Black dash line = partial pooling </span><span class="se">\n</span><span class="s1"> Blue line = no pooling&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Pond Index&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Absolute Error&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_62_0.png" src="_images/parte_13_62_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-13-20">
<h3>R Code 13.20<a class="headerlink" href="#r-code-13-20" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reuse code in using Rethinking packages in R, here is automatically reuse!</span>
<span class="c1"># Just re-run from R Code 13.7</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="more-than-one-type-of-cluster">
<h2>13.3 More than one type of cluster<a class="headerlink" href="#more-than-one-type-of-cluster" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="multilevel-chimpanzees">
<h3>Multilevel Chimpanzees<a class="headerlink" href="#multilevel-chimpanzees" title="Permalink to this headline">Â¶</a></h3>
<div class="math notranslate nohighlight">
\[ L_i \sim Binomial(1, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \alpha_{ACTOR[i]} + \gamma_{BLOCK[i]} + \beta_{TREATMENT[i]} \]</div>
<div class="math notranslate nohighlight">
\[ \beta_j \sim Normal(0, 0.5) \mbox{  , } j \in \{1, ... ,4\} \]</div>
<div class="math notranslate nohighlight">
\[ \alpha_j \sim Normal(\bar{\alpha}, \sigma_\alpha) \mbox{  , } j \in \{1, ... ,7\} \]</div>
<div class="math notranslate nohighlight">
\[ \gamma_j \sim Normal(0, \sigma_\gamma) \mbox{  , } j \in \{1, ... ,6\} \]</div>
<div class="math notranslate nohighlight">
\[ \bar{\alpha} \sim Normal(0, 1.5) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma_{\alpha} \sim Exponential(1) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma_{\gamma} \sim Exponential(1) \]</div>
</div>
<div class="section" id="r-code-13-21">
<h3>R Code 13.21<a class="headerlink" href="#r-code-13-21" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Previous chimpanzees models is in chapter 11</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./data/chimpanzees.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;prosoc_left&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>actor</th>
      <th>recipient</th>
      <th>condition</th>
      <th>block</th>
      <th>trial</th>
      <th>prosoc_left</th>
      <th>chose_prosoc</th>
      <th>pulled_left</th>
      <th>treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>6</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>8</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>NaN</td>
      <td>0</td>
      <td>1</td>
      <td>10</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int qty_blocks;</span>
<span class="s2">        int qty_treatments;</span>
<span class="s2">        </span>
<span class="s2">        array[N] int pulled_left;</span>
<span class="s2">        array[N] int actor;</span>
<span class="s2">        array[N] int block;</span>
<span class="s2">        array[N] int treatment;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_treatments] beta;</span>
<span class="s2">        </span>
<span class="s2">        vector[qty_chimpanzees] alpha;</span>
<span class="s2">        real bar_alpha;</span>
<span class="s2">        real&lt;lower=0&gt; sigma_alpha;</span>
<span class="s2">        </span>
<span class="s2">        vector[qty_blocks] gamma;</span>
<span class="s2">        real&lt;lower=0&gt;  sigma_gamma;</span>
<span class="s2">           </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">    </span>
<span class="s2">        // priors</span>
<span class="s2">        beta ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(bar_alpha, sigma_alpha);</span>
<span class="s2">        bar_alpha ~ normal(0, 1.5);</span>
<span class="s2">        sigma_alpha ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        gamma ~ normal(0, sigma_gamma);</span>
<span class="s2">        sigma_gamma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        // link</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ] + gamma[ block[i] ] + beta[ treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // linkelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_treatments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-22">
<h3>R Code 13.22<a class="headerlink" href="#r-code-13-22" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_4</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>beta[0]</th>
      <td>-0.178</td>
      <td>0.296</td>
      <td>-0.569</td>
      <td>0.352</td>
      <td>0.042</td>
      <td>0.030</td>
      <td>54.0</td>
      <td>1029.0</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>beta[1]</th>
      <td>0.332</td>
      <td>0.321</td>
      <td>-0.083</td>
      <td>0.828</td>
      <td>0.077</td>
      <td>0.056</td>
      <td>20.0</td>
      <td>1608.0</td>
      <td>1.14</td>
    </tr>
    <tr>
      <th>beta[2]</th>
      <td>-0.537</td>
      <td>0.308</td>
      <td>-0.994</td>
      <td>-0.069</td>
      <td>0.059</td>
      <td>0.043</td>
      <td>31.0</td>
      <td>1329.0</td>
      <td>1.09</td>
    </tr>
    <tr>
      <th>beta[3]</th>
      <td>0.232</td>
      <td>0.297</td>
      <td>-0.221</td>
      <td>0.702</td>
      <td>0.046</td>
      <td>0.033</td>
      <td>45.0</td>
      <td>1159.0</td>
      <td>1.06</td>
    </tr>
    <tr>
      <th>alpha[0]</th>
      <td>-0.263</td>
      <td>0.405</td>
      <td>-0.829</td>
      <td>0.320</td>
      <td>0.106</td>
      <td>0.077</td>
      <td>17.0</td>
      <td>1605.0</td>
      <td>1.17</td>
    </tr>
    <tr>
      <th>alpha[1]</th>
      <td>4.763</td>
      <td>1.249</td>
      <td>2.811</td>
      <td>6.460</td>
      <td>0.035</td>
      <td>0.025</td>
      <td>1182.0</td>
      <td>1293.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[2]</th>
      <td>-0.624</td>
      <td>0.347</td>
      <td>-1.205</td>
      <td>-0.104</td>
      <td>0.021</td>
      <td>0.024</td>
      <td>400.0</td>
      <td>1396.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[3]</th>
      <td>-0.588</td>
      <td>0.393</td>
      <td>-1.237</td>
      <td>-0.112</td>
      <td>0.085</td>
      <td>0.061</td>
      <td>24.0</td>
      <td>1595.0</td>
      <td>1.12</td>
    </tr>
    <tr>
      <th>alpha[4]</th>
      <td>-0.275</td>
      <td>0.387</td>
      <td>-0.899</td>
      <td>0.220</td>
      <td>0.092</td>
      <td>0.066</td>
      <td>20.0</td>
      <td>860.0</td>
      <td>1.14</td>
    </tr>
    <tr>
      <th>alpha[5]</th>
      <td>0.620</td>
      <td>0.353</td>
      <td>0.033</td>
      <td>1.161</td>
      <td>0.016</td>
      <td>0.011</td>
      <td>507.0</td>
      <td>1421.0</td>
      <td>1.03</td>
    </tr>
    <tr>
      <th>alpha[6]</th>
      <td>2.121</td>
      <td>0.437</td>
      <td>1.383</td>
      <td>2.782</td>
      <td>0.013</td>
      <td>0.009</td>
      <td>1137.0</td>
      <td>1182.0</td>
      <td>1.26</td>
    </tr>
    <tr>
      <th>bar_alpha</th>
      <td>0.678</td>
      <td>0.714</td>
      <td>-0.443</td>
      <td>1.795</td>
      <td>0.089</td>
      <td>0.063</td>
      <td>65.0</td>
      <td>1892.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>sigma_alpha</th>
      <td>2.069</td>
      <td>0.624</td>
      <td>1.058</td>
      <td>2.831</td>
      <td>0.036</td>
      <td>0.026</td>
      <td>135.0</td>
      <td>1582.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>gamma[0]</th>
      <td>-0.154</td>
      <td>0.208</td>
      <td>-0.471</td>
      <td>0.101</td>
      <td>0.025</td>
      <td>0.018</td>
      <td>76.0</td>
      <td>1477.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>gamma[1]</th>
      <td>0.038</td>
      <td>0.167</td>
      <td>-0.227</td>
      <td>0.299</td>
      <td>0.004</td>
      <td>0.006</td>
      <td>2537.0</td>
      <td>1366.0</td>
      <td>1.27</td>
    </tr>
    <tr>
      <th>gamma[2]</th>
      <td>0.043</td>
      <td>0.173</td>
      <td>-0.214</td>
      <td>0.319</td>
      <td>0.004</td>
      <td>0.006</td>
      <td>1370.0</td>
      <td>1513.0</td>
      <td>1.05</td>
    </tr>
    <tr>
      <th>gamma[3]</th>
      <td>0.005</td>
      <td>0.164</td>
      <td>-0.272</td>
      <td>0.248</td>
      <td>0.003</td>
      <td>0.005</td>
      <td>2437.0</td>
      <td>1654.0</td>
      <td>1.29</td>
    </tr>
    <tr>
      <th>gamma[4]</th>
      <td>-0.030</td>
      <td>0.172</td>
      <td>-0.286</td>
      <td>0.246</td>
      <td>0.003</td>
      <td>0.005</td>
      <td>2766.0</td>
      <td>1883.0</td>
      <td>1.28</td>
    </tr>
    <tr>
      <th>gamma[5]</th>
      <td>0.103</td>
      <td>0.187</td>
      <td>-0.160</td>
      <td>0.402</td>
      <td>0.014</td>
      <td>0.010</td>
      <td>395.0</td>
      <td>1375.0</td>
      <td>1.04</td>
    </tr>
    <tr>
      <th>sigma_gamma</th>
      <td>0.196</td>
      <td>0.173</td>
      <td>0.017</td>
      <td>0.405</td>
      <td>0.034</td>
      <td>0.025</td>
      <td>11.0</td>
      <td>4.0</td>
      <td>1.29</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_74_0.png" src="_images/parte_13_74_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_dist</span><span class="p">(</span>
    <span class="p">[</span><span class="n">model_13_4</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sigma_gamma</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">.05</span><span class="p">,</span> <span class="mf">.89</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_dist</span><span class="p">(</span>
    <span class="p">[</span><span class="n">model_13_4</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">bar_alpha</span> <span class="o">+</span> <span class="n">model_13_4</span><span class="o">.</span><span class="n">posterior</span><span class="o">.</span><span class="n">sigma_alpha</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">quantiles</span><span class="o">=</span><span class="p">[</span><span class="mf">.05</span><span class="p">,</span> <span class="mf">.89</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;Block&#39;</span><span class="p">,</span> <span class="s1">&#39;Actor&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Posteioris&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Standard Deviation&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_75_0.png" src="_images/parte_13_75_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-13-23">
<h3>R Code 13.23<a class="headerlink" href="#r-code-13-23" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int qty_blocks;</span>
<span class="s2">        int qty_treatments;</span>
<span class="s2">        </span>
<span class="s2">        array[N] int pulled_left;</span>
<span class="s2">        array[N] int actor;</span>
<span class="s2">        array[N] int block;</span>
<span class="s2">        array[N] int treatment;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_treatments] beta;</span>
<span class="s2">        </span>
<span class="s2">        vector[qty_chimpanzees] alpha;</span>
<span class="s2">        real bar_alpha;</span>
<span class="s2">        real&lt;lower=0&gt; sigma_alpha;   </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">    </span>
<span class="s2">        // priors</span>
<span class="s2">        beta ~ normal(0, 0.5);</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(bar_alpha, sigma_alpha);</span>
<span class="s2">        bar_alpha ~ normal(0, 1.5);</span>
<span class="s2">        sigma_alpha ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        // link</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ] + beta[ treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // linkelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_treatments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_5</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-24">
<h3>R Code 13.24<a class="headerlink" href="#r-code-13-24" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># az.compare(model_13_4, model_13_5)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-25">
<h3>R Code 13.25<a class="headerlink" href="#r-code-13-25" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int qty_blocks;</span>
<span class="s2">        int qty_treatments;</span>
<span class="s2">        </span>
<span class="s2">        array[N] int pulled_left;</span>
<span class="s2">        array[N] int actor;</span>
<span class="s2">        array[N] int block;</span>
<span class="s2">        array[N] int treatment;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        vector[qty_treatments] beta;</span>
<span class="s2">        real&lt;lower=0&gt;  sigma_beta;</span>

<span class="s2">        vector[qty_chimpanzees] alpha;</span>
<span class="s2">        real bar_alpha;</span>
<span class="s2">        real&lt;lower=0&gt; sigma_alpha;</span>
<span class="s2">        </span>
<span class="s2">        vector[qty_blocks] gamma;</span>
<span class="s2">        real&lt;lower=0&gt;  sigma_gamma;</span>
<span class="s2">        </span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">    </span>
<span class="s2">        // priors</span>
<span class="s2">        beta ~ normal(0, sigma_beta);</span>
<span class="s2">        sigma_beta ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        alpha ~ normal(bar_alpha, sigma_alpha);</span>
<span class="s2">        bar_alpha ~ normal(0, 1.5);</span>
<span class="s2">        sigma_alpha ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        gamma ~ normal(0, sigma_gamma);</span>
<span class="s2">        sigma_gamma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        // link</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = alpha[ actor[i] ] + gamma[ block[i] ] + beta[ treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // linkelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_treatments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_6</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">([</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">model_13_6</span><span class="p">],</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span>
              <span class="n">model_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;model_13_4&quot;</span><span class="p">,</span> <span class="s2">&quot;model_13_6&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_84_0.png" src="_images/parte_13_84_0.png" />
</div>
</div>
</div>
</div>
<div class="section" id="divergent-transitions-and-non-centered-priors">
<h2>13.4 Divergent Transitions and non-centered priors<a class="headerlink" href="#divergent-transitions-and-non-centered-priors" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="r-code-13-26">
<h3>R Code 13.26<a class="headerlink" href="#r-code-13-26" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    parameters {</span>
<span class="s2">        real v;</span>
<span class="s2">        real x;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        v ~ normal(0, 3);</span>
<span class="s2">        x ~ normal(0, exp(v));</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_5</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_13_5</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>v</th>
      <td>3.515</td>
      <td>1.508</td>
      <td>1.243</td>
      <td>5.486</td>
      <td>0.208</td>
      <td>0.148</td>
      <td>37.0</td>
      <td>26.0</td>
      <td>1.1</td>
    </tr>
    <tr>
      <th>x</th>
      <td>-34.371</td>
      <td>286.623</td>
      <td>-142.353</td>
      <td>209.821</td>
      <td>20.340</td>
      <td>14.404</td>
      <td>290.0</td>
      <td>232.0</td>
      <td>1.1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</div>
<div class="section" id="r-code-13-27">
<h3>R Code 13.27<a class="headerlink" href="#r-code-13-27" title="Permalink to this headline">Â¶</a></h3>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    parameters {</span>
<span class="s2">        real v;</span>
<span class="s2">        real z;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        v ~ normal(0, 3);</span>
<span class="s2">        z ~ normal(0, 1);</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    generated quantities {</span>
<span class="s2">        real x;</span>
<span class="s2">        </span>
<span class="s2">        x = z*exp(v);</span>
<span class="s2">    }</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_6</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">model_13_6</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_5.5%</th>
      <th>hdi_94.5%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>v</th>
      <td>0.055</td>
      <td>2.991</td>
      <td>-4.401</td>
      <td>5.018</td>
      <td>0.050</td>
      <td>0.048</td>
      <td>3573.0</td>
      <td>2181.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>z</th>
      <td>0.018</td>
      <td>0.998</td>
      <td>-1.515</td>
      <td>1.663</td>
      <td>0.018</td>
      <td>0.015</td>
      <td>3015.0</td>
      <td>2616.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>x</th>
      <td>4.028</td>
      <td>3223.155</td>
      <td>-22.220</td>
      <td>30.356</td>
      <td>50.982</td>
      <td>36.052</td>
      <td>2943.0</td>
      <td>2668.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="section" id="non-centered-chimpanzees">
<h4>13.4.2 Non-centered chimpanzees<a class="headerlink" href="#non-centered-chimpanzees" title="Permalink to this headline">Â¶</a></h4>
</div>
</div>
<div class="section" id="r-code-13-28">
<h3>R Code 13.28<a class="headerlink" href="#r-code-13-28" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Don&#39;t have apapt_delta in pystan3, until today.</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="r-code-13-29">
<h3>R Code 13.29<a class="headerlink" href="#r-code-13-29" title="Permalink to this headline">Â¶</a></h3>
<div class="math notranslate nohighlight">
\[ L_i \sim Binomial(1, p_i) \]</div>
<div class="math notranslate nohighlight">
\[ logit(p_i) = \bar{\alpha} + z_{ACTOR[i]} \sigma_\alpha + x_{BLOCK[i]}\sigma_\gamma + \beta_{TREATMENT[i]} \]</div>
<p>To Actor:
$<span class="math notranslate nohighlight">\( \bar{\alpha} \sim Normal(0, 1.5) \)</span>$</p>
<div class="math notranslate nohighlight">
\[ z_j \sim Normal(0, 1) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma_\alpha \sim Exponential(1) \]</div>
<p>To Block:</p>
<div class="math notranslate nohighlight">
\[ x_j \sim Normal(0, 1) \]</div>
<div class="math notranslate nohighlight">
\[ \sigma_\gamma \sim Exponential(1) \]</div>
<p>To Treatment:</p>
<div class="math notranslate nohighlight">
\[ \beta_j \sim Normal(0, 0.5) \]</div>
<p>Where, each actor is defined by:</p>
<div class="math notranslate nohighlight">
\[ \alpha_j = \bar{\alpha} + z_j\sigma_\alpha  \]</div>
<p>and, each block is defined by:</p>
<div class="math notranslate nohighlight">
\[ \gamma_j = x_j\sigma_\gamma \]</div>
<div class="cell tag_remove_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    data {</span>
<span class="s2">        int N;</span>
<span class="s2">        int qty_chimpanzees;</span>
<span class="s2">        int qty_blocks;</span>
<span class="s2">        int qty_treatments;</span>
<span class="s2">        </span>
<span class="s2">        array[N] int pulled_left;</span>
<span class="s2">        array[N] int actor;</span>
<span class="s2">        array[N] int block;</span>
<span class="s2">        array[N] int treatment;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    parameters {</span>
<span class="s2">        // To treatments</span>
<span class="s2">        vector[qty_treatments] beta;</span>
<span class="s2">        </span>
<span class="s2">        // To actors</span>
<span class="s2">        real bar_alpha;</span>
<span class="s2">        vector[qty_chimpanzees] z;</span>
<span class="s2">        real&lt;lower=0&gt; sigma_alpha;</span>
<span class="s2">        </span>
<span class="s2">        // To block</span>
<span class="s2">        vector[qty_blocks] x;</span>
<span class="s2">        real&lt;lower=0&gt;  sigma_gamma;</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    model {</span>
<span class="s2">        vector[N] p;</span>
<span class="s2">    </span>
<span class="s2">        // priors</span>
<span class="s2">        beta ~ normal(0, 0.5);  // treatment</span>
<span class="s2">        z ~ normal(0, 1);  // actor</span>
<span class="s2">        x ~ normal(0, 1);  // block </span>
<span class="s2">        </span>
<span class="s2">        bar_alpha ~ normal(0, 1.5);  // Intercept to alpha (actor)</span>
<span class="s2">        </span>
<span class="s2">        sigma_alpha ~ exponential(1);</span>
<span class="s2">        sigma_gamma ~ exponential(1);</span>
<span class="s2">        </span>
<span class="s2">        // Link</span>
<span class="s2">        for (i in 1:N){</span>
<span class="s2">            p[i] = bar_alpha  + z[ actor[i] ]*sigma_alpha +  x[ block[i] ]*sigma_gamma + beta[ treatment[i] ];</span>
<span class="s2">            p[i] = inv_logit(p[i]);</span>
<span class="s2">        }</span>
<span class="s2">        </span>
<span class="s2">        // Linkelihood</span>
<span class="s2">        pulled_left ~ binomial(1, p);</span>
<span class="s2">    }</span>
<span class="s2">    </span>
<span class="s2">    generated quantities {</span>
<span class="s2">        vector[qty_chimpanzees] alpha;</span>
<span class="s2">        vector[qty_blocks] gamma;</span>
<span class="s2">        </span>
<span class="s2">        alpha = bar_alpha + z*sigma_alpha;</span>
<span class="s2">        gamma = x*sigma_gamma;</span>
<span class="s2">    }</span>

<span class="s2">&quot;&quot;&quot;</span>

<span class="n">dat_list</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;pulled_left&#39;</span><span class="p">,</span> <span class="s1">&#39;actor&#39;</span><span class="p">,</span> <span class="s1">&#39;block&#39;</span><span class="p">,</span> <span class="s1">&#39;treatment&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_chimpanzees&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;actor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_blocks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">dat_list</span><span class="p">[</span><span class="s1">&#39;qty_treatments&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

<span class="n">posteriori</span> <span class="o">=</span> <span class="n">stan</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dat_list</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">posteriori</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">num_chains</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_13_4_nc</span> <span class="o">=</span> <span class="n">az</span><span class="o">.</span><span class="n">from_pystan</span><span class="p">(</span>
    <span class="n">posterior</span><span class="o">=</span><span class="n">samples</span><span class="p">,</span>
    <span class="n">posterior_model</span><span class="o">=</span><span class="n">posteriori</span><span class="p">,</span>
    <span class="n">observed_data</span><span class="o">=</span><span class="n">dat_list</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">model_13_4_nc</span><span class="p">,</span> <span class="n">hdi_prob</span><span class="o">=</span><span class="mf">0.89</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">13</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_101_0.png" src="_images/parte_13_101_0.png" />
</div>
</div>
</div>
<div class="section" id="r-code-13-30">
<h3>R Code 13.30<a class="headerlink" href="#r-code-13-30" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Extract features from ess</span>

<span class="c1"># non-centered</span>
<span class="n">ess_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4_nc</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_nc</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4_nc</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_nc</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4_nc</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_nc</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4_nc</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bar_alpha&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">bar_alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_nc</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4_nc</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma_alpha&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sigma_alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_nc</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4_nc</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma_gamma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sigma_gamma</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

<span class="c1"># centered</span>
<span class="n">ess_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_c</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_c</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_c</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bar_alpha&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">bar_alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_c</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma_alpha&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sigma_alpha</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
<span class="n">ess_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ess_c</span><span class="p">,</span> <span class="n">az</span><span class="o">.</span><span class="n">ess</span><span class="p">(</span><span class="n">model_13_4</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sigma_gamma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sigma_gamma</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ess_c</span><span class="p">,</span> <span class="n">ess_nc</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2500</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2500</span><span class="p">],</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">650</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Identity line ($x=y$)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Effective number samples&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;n_eff(centered)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;n_eff(non-centered)&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/parte_13_104_0.png" src="_images/parte_13_104_0.png" />
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="parte_12.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">12 - Monstros e Misturas</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="parte_14.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">14 - Aventuras na CovariÃ¢ncias</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Rodolpho Macedo dos Santos<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>